var ImajnetUserMessages={functionNotImplemented:function(a){console.warn(a+" function not implemented!")}};
var ImajnetPlugin={defaultObjectLayers:{},getMapScale:function(){ImajnetUserMessages.functionNotImplemented("getMapScale")},getCurrentZoomLevel:function(){ImajnetUserMessages.functionNotImplemented("getCurrentZoomLevel")},zoomMapTo:function(a){ImajnetUserMessages.functionNotImplemented("zoomMapTo")},zoomMapToFeatureWrapper:function(a){ImajnetUserMessages.functionNotImplemented("zoomMapToFeatureWrapper")},centerMapToPosition:function(a,b){ImajnetUserMessages.functionNotImplemented("centerMapToPosition")},
addWMSLayerToMap:function(a,b){ImajnetUserMessages.functionNotImplemented("addWMSLayerToMap")},addVectorLayerToMap:function(a){ImajnetUserMessages.functionNotImplemented("addVectorLayerToMap")},removeLayerFromMap:function(a){ImajnetUserMessages.functionNotImplemented("removeLayerFromMap")},addFeature:function(a,b,c){ImajnetUserMessages.functionNotImplemented("addFeature")},removeFeatures:function(a,b){ImajnetUserMessages.functionNotImplemented("removeFeatures")},removeAllFeatures:function(a){ImajnetUserMessages.functionNotImplemented("removeAllFeatures")},
selectFeature:function(a,b){ImajnetUserMessages.functionNotImplemented("selectFeature")},unselectFeature:function(a,b){ImajnetUserMessages.functionNotImplemented("unselectFeature")},selectPolygonFeature:function(a,b){},unselectPolygonFeature:function(a,b){},addMarkerLayerToMap:function(a){ImajnetUserMessages.functionNotImplemented("addMarkerLayerToMap")},setLayerZIndex:function(a,b){ImajnetUserMessages.functionNotImplemented("setLayerZIndex")},addMarker:function(a,b){ImajnetUserMessages.functionNotImplemented("addMarker")},
removeMarker:function(a,b){ImajnetUserMessages.functionNotImplemented("removeMarker")},removeAllMarkersFromLayer:function(a){ImajnetUserMessages.functionNotImplemented("removeAllMarkersFromLayer")},selectMarker:function(a,b){ImajnetUserMessages.functionNotImplemented("selectMarker")},unselectMarker:function(a,b){ImajnetUserMessages.functionNotImplemented("unselectMarker")},setFeatureColor:function(a,b,c){},setFeatureStrokeColor:function(a,b,c){},addImajnetLayerToMap:function(){ImajnetUserMessages.functionNotImplemented("addImajnetLayerToMap")},
onImageChange:function(a){ImajnetUserMessages.functionNotImplemented("onImageChange")},registerMapEvents:function(){ImajnetUserMessages.functionNotImplemented("registerMapEvents")},unregisterMapEvents:function(){ImajnetUserMessages.functionNotImplemented("unregisterMapEvents")},getProjectionCandidates:function(a,b){ImajnetUserMessages.functionNotImplemented("getProjetionCandidates");return jQuery.Deferred().resolve(null).promise()},drawUserProjections:function(){ImajnetUserMessages.functionNotImplemented("drawUserProjections");
return jQuery.Deferred().resolve(null).promise()},initProjectedLayers:function(){var a=Nigsys.getCookie("IMAJNET","PROJECTED_LAYERS");if(a){for(var b=0;b<a.length;b++){var c=new LayerWrapper;jQuery.extend(c,a[b]);a[b]=c}ImajnetProjection.projectedLayers=a}if(ImajnetUI.projectedLayersContainerId){jQuery("#"+ImajnetUI.projectedLayersContainerId).html("");c=ImajnetPlugin.getReadableLayers();a=[];for(b=0;b<c.length;b++){ImajnetPlugin.addToProjectedLayersHTML(c[b]);var d=ImajnetProjection.getProjectedLayerById(c[b].id);
ImajnetProjection.removeProjectedLayerById(c[b].id);d&&(jQuery("#layerProjected_"+c[b].id).trigger("click"),d.groundProjection&&(jQuery("#layerGroundProjection_"+c[b].id).trigger("click"),jQuery("#layerHeightSlider_"+c[b].id).val(d.heightOffset).trigger("change")),jQuery.extend(d,c[b]),a.push(d))}ImajnetProjection.projectedLayers=a}},addToProjectedLayersHTML:function(a){var b='\x3cdiv class\x3d"clearfix projectedLayerItem" id\x3d"layer_'+a.id+'"\x3e\x3cdiv class\x3d"clearfix"\x3e\x3cdiv class\x3d"left" style\x3d"width: 10%"\x3e\x3cinput id\x3d"layerProjected_'+
a.id+'" type\x3d"checkbox" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 90%"\x3e'+a.name+'\x3c/div\x3e\x3c/div\x3e\x3cdiv style\x3d"margin-left: 15%; display: none;" class\x3d"layerSettings" id\x3d"layerSettings_'+a.id+'"\x3e\x3cdiv class\x3d"clearfix"\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"checkbox" id\x3d"layerGroundProjection_'+a.id+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"margin-left: 5px;"\x3e'+jQuery.imajnet.projectedLayers.groundProjection+'\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"layerHeightContainer" id\x3d"layerHeightContainer_'+
a.id+'" style\x3d"display:none"\x3e\x3cdiv\x3e'+jQuery.imajnet.projectedLayers.heightOffset+': \x3cspan id\x3d"layerHeightValue_'+a.id+'"\x3e0\x3c/span\x3e '+jQuery.imajnet.settings.units.m+'\x3c/div\x3e\x3cdiv\x3e\x3cinput style\x3d"width: 90%;" type\x3d"range" min\x3d"-15" max\x3d"15" value\x3d"0" step\x3d"0.5" class\x3d"slider" id\x3d"layerHeightSlider_'+a.id+'"\x3e\x3c/div\x3e\x3c/div\x3e';"\x3c/div\x3e\x3c/div\x3e";jQuery("#"+ImajnetUI.projectedLayersContainerId).append(b);jQuery("#layerProjected_"+
a.id).data(a).on("click",function(){ImajnetPlugin.onLayerCheckboxChange(jQuery(this),a)});jQuery("#layerHeightSlider_"+a.id).data(a).on("change",function(){jQuery("#layerHeightValue_"+a.getId()).html(jQuery(this).val());ImajnetPlugin.onLayerSettingsChange(a)});jQuery("#layerGroundProjection_"+a.id).data(a).on("click",function(){jQuery(this).prop("checked")?jQuery("#layerHeightContainer_"+a.getId()).show():jQuery("#layerHeightContainer_"+a.getId()).hide();ImajnetPlugin.onLayerSettingsChange(a)})},
onLayerCheckboxChange:function(a,b){a.prop("checked")?(b.groundProjection=!1,b.heightOffset=0,ImajnetProjection.addProjectedLayer(b),jQuery("#layerSettings_"+b.getId()).show()):(jQuery("#layerSettings_"+b.getId()).hide(),jQuery("#layerHeightContainer_"+b.getId()).hide(),jQuery("#layerGroundProjection_"+b.getId()).prop("checked",!1),ImajnetProjection.removeProjectedLayerById(b.getId()));ImageControler.currentPhotogrammetry.redraw()},onLayerSettingsChange:function(a){var b=jQuery("#layerGroundProjection_"+
a.getId()).prop("checked"),c=0;b&&(c=parseFloat(jQuery("#layerHeightSlider_"+a.getId()).val()));a.groundProjection=b;a.heightOffset=c;ImajnetProjection.updateProjectedLayer(a);ImageControler.currentPhotogrammetry.redraw()},highlightFeatureOnImage:function(a){ImageControler.currentGraphic.highlightFeatureOnImage(a)},unHighlightFeatureOnImage:function(a){ImageControler.currentGraphic.unHighlightFeatureOnImage(a)},positionImageOnFeature:function(a){ImageControler.currentPhotogrammetry.openImageWithPhotogrammetryObject(a)},
onFeatureMouseOver:function(a,b,c){ImajnetUserMessages.functionNotImplemented("onFeatureMouseOver")},onFeatureMouseOut:function(a){ImajnetUserMessages.functionNotImplemented("onFeatureMouseOut")},onFeatureClick:function(a){ImajnetUserMessages.functionNotImplemented("onFeatureClick")},onMeasurementCreated:function(a){ImajnetUserMessages.functionNotImplemented("onMeasurementCreated")},onPinPointCreated:function(a){ImajnetUserMessages.functionNotImplemented("onPinPointCreated")},onPolyligneCreated:function(a){ImajnetUserMessages.functionNotImplemented("onPolyligneCreated")},
onObjectCreatedDefault:function(a){var b=ImajnetPlugin.getEditableLayers();if(0!=b.length){var c=a.type.toLowerCase(),d=!1,e='\x3cselect id\x3d"imajnetSelectLayer"\x3e';b.forEach(function(a){a.getGeometryType().toLowerCase()==c&&(e+='\x3coption value\x3d"'+a.getId()+'"\x3e'+a.getName()||a.getId()+"\x3c/option\x3e",d=!0)});if(d){e+="\x3c/select\x3e";ImajnetUI.addObjectToLayer.html("\x3cdiv\x3e"+jQuery.imajnet.addToLayer.selectLayer+"\x3c/div\x3e\x3cdiv\x3e"+e+'\x3c/div\x3e\x3cdiv\x3e\x3cinput type\x3d"button" value\x3d"'+
jQuery.imajnet.addToLayer.add+'" id\x3d"addObjectToLayerButton" /\x3e\x3cinput style\x3d"float:right" type\x3d"button" value\x3d"'+jQuery.imajnet.addToLayer.close+'" id\x3d"closeAddObjectToLayerButton" /\x3e\x3c/div\x3e');var f=document.getElementById("imajnetImageLayer").getBoundingClientRect(),b=f.top+jQuery("#imajnetImageLayer").height()/2-100,f=f.left+jQuery("#imajnetImageLayer").width()/2-125;ImajnetUI.addObjectToLayer.css({top:b,left:f}).show().draggable({containment:jQuery("#popupImajnet")});
jQuery("#addObjectToLayerButton").data(a).on("click",function(){for(var b=ImajnetPlugin.getEditableLayers(),c=0;c<b.length;c++)if(b[c].getId()==jQuery("#imajnetSelectLayer").val()){var d=b[c];break}ImajnetPlugin.addGeometryToLayer(d,a.geometry)?(console.log("object added"),ImajnetUI.addObjectToLayer.hide(),ImageControler.currentPhotogrammetry.deleteLastPhotogrammetryItem(),ImajnetPlugin.defaultObjectLayers[a.type]=jQuery("#imajnetSelectLayer").val()):(console.log("object not added"),ImajnetUI.addObjectToLayer.hide())});
jQuery("#closeAddObjectToLayerButton").on("click",function(){ImajnetUI.addObjectToLayer.hide()});jQuery("#imajnetSelectLayer").val(ImajnetPlugin.defaultObjectLayers[a.type]||jQuery("#imajnetSelectLayer option:first").val())}}},addGeometryToLayer:function(a,b){ImajnetUserMessages.functionNotImplemented("addGeometryToLayer")},onImajnetActivated:function(){ImajnetUserMessages.functionNotImplemented("onImajnetActivated")},onImajnetDeactivated:function(){ImajnetUserMessages.functionNotImplemented("onImajnetDeactivated")},
deletePhotogrammetryItem:function(a){ImageControler.currentPhotogrammetry.deletePhotogrammetryItem(a)},deleteLastPhotogrammetryItem:function(){ImageControler.currentPhotogrammetry.deleteLastPhotogrammetryItem()},afterImajnetLayersAddedToMap:function(){ImajnetUserMessages.functionNotImplemented("afterImajnetLayersAddedToMap")},showImajnetItem:function(a){ImajnetUserMessages.functionNotImplemented("showImajnetItem")},hideImajnetItem:function(a){ImajnetUserMessages.functionNotImplemented("hideImajnetItem")},
addActiveState:function(a){ImajnetUserMessages.functionNotImplemented("addActiveState")},removeActiveState:function(a){ImajnetUserMessages.functionNotImplemented("addActiveState")},imajnetLoginError:function(a){ImajnetUserMessages.functionNotImplemented("imajnetLoginError");a=ImajnetProtocol.getErrorMessage(a);console.warn("Imajnet login error reason:"+a)},imajnetLoginSuccess:function(){ImajnetUserMessages.functionNotImplemented("imajnetLoginSuccess")},imajnetLogoutComplete:function(){Nigsys.hideLoading(jQuery(Imajnet.containerId));
ImajnetUserMessages.functionNotImplemented("imajnetLogoutComplete")},redrawLayer:function(a){ImajnetUserMessages.functionNotImplemented("redrawLayer")},getEditableLayers:function(){ImajnetUserMessages.functionNotImplemented("getEditableLayers");return[]},getReadableLayers:function(){ImajnetUserMessages.functionNotImplemented("getReadableLayers");return[]}};
function FeatureWrapper(){this.type=this.id="";this.feature=null;this.layerName="";this.layer=null}FeatureWrapper.prototype.getFeatureId=function(){return 0};FeatureWrapper.prototype.getFeatureWKTGeometry=function(){return null};FeatureWrapper.prototype.getId=function(){return this.id};FeatureWrapper.prototype.setId=function(a){this.id=a};FeatureWrapper.prototype.getType=function(){return this.type};FeatureWrapper.prototype.setType=function(a){this.type=a};
FeatureWrapper.prototype.setGeometry=function(a){this.geometry=a};FeatureWrapper.prototype.getGeometry=function(){return this.geometry};FeatureWrapper.prototype.getType=function(){return this.type};FeatureWrapper.prototype.getFeature=function(){return this.feature};FeatureWrapper.prototype.setFeature=function(a){this.feature=a};FeatureWrapper.prototype.setStyle=function(a){this.style=a};FeatureWrapper.prototype.getStyle=function(a){return this.style};
FeatureWrapper.prototype.setLayerName=function(a){this.layerName=a};FeatureWrapper.prototype.getLayerName=function(){return this.layerName};FeatureWrapper.prototype.setLayer=function(a){this.layer=a};FeatureWrapper.prototype.getLayer=function(){return this.layer};FeatureWrapper.prototype.setStyleName=function(a){this.layerStyle=a};FeatureWrapper.prototype.getStyleName=function(){return this.layerStyle};function LayerWrapper(a,b,c){this.id=a;this.name=b;this.geometryType=c}
LayerWrapper.prototype.getId=function(){return this.id};LayerWrapper.prototype.setId=function(a){this.id=a};LayerWrapper.prototype.getName=function(){return this.name};LayerWrapper.prototype.setName=function(a){this.name=a};LayerWrapper.prototype.getGeometryType=function(){return this.geometryType};LayerWrapper.prototype.setGeometryType=function(a){this.geometryType=a};
var Imajnet={options:{},sequenceType:"ANY",imajnetPath:"",serverUrl:"",cartographicServerUrl:"",metadata:"",applicationKey:"",containerId:"",unit:"",wellKnownImajnetDomains:["imajnet.net","immergis.fr"],searchRadius:{0:2E4,1:2E4,2:2E4,3:2E4,4:2E4,5:2E4,6:15E3,7:1E4,8:4E3,9:3E3,10:2E3,11:1500,12:750,13:400,14:250,15:150,16:100,17:75,18:50,19:50,20:50,21:50,22:50,23:50,24:50,25:50},timeSearchRadius:{0:1E3,1:1E3,2:1E3,3:1E3,4:1E3,5:1E3,6:1E3,7:1E3,8:250,9:250,10:250,11:250,12:100,13:100,14:50,15:30,
16:10,17:5,18:3,19:3,20:3,21:3,22:0,23:0,24:0,25:0},IMAJNET_DATA_FORMAT:"JSON",clickMode:null,CLICK_MODE_CLOSEST_IMAGE:"closestImage",CLICK_MODE_ORIENTED_IMAGES:"clickMode",imageWidthChange:0,imageHeightChange:0,imajnetIsActiveBoolean:!1,locale:"",appendImajnetHTMLElements:function(a){ImajnetUI.imageContainer&&ImajnetUI.imageContainer.length||jQuery("#"+a).append('\x3cdiv id\x3d"'+ImajnetUI.imageContainerId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e\x3cdiv id\x3d"'+ImajnetUI.helpContainerId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e\x3cdiv id\x3d"'+
ImajnetUI.aboutImajnetContainerId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e\x3cdiv id\x3d"'+ImajnetUI.settingsContainerId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e\x3cdiv id\x3d"'+ImajnetUI.settingsLRSContainerId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e\x3cdiv id\x3d"'+ImajnetUI.sequenceDetailsId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e\x3cdiv id\x3d"'+ImajnetUI.imageDetailsId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e\x3cdiv id\x3d"'+ImajnetUI.groundPlaneDetailsId+'" class\x3d"imajnetItem"\x3e\x3c/div\x3e')},
setImajnetPath:function(){var a=this.imajnetPath.lastIndexOf("/");if(-1===a||a!==this.imajnetPath.length-1)this.imajnetPath+="/"},setLanguage:function(a){this.setImajnetPath();this.locale=a;jQuery.cachedScript=function(a,c){c=jQuery.extend(c||{},{dataType:"script",cache:!0,url:a});return jQuery.ajax(c)};return jQuery.cachedScript(Imajnet.imajnetPath+"js/i18n/locale-"+(a?a:"en")+".js?v\x3d"+Imajnet.buildDate)},init:function(a){this.options=a;var b=jQuery.Deferred();if(!a)return alert("No options supplied"),
ImajnetPlugin.imajnetLoginError(),b.reject(),b.promise();var c="";a.serverUrl?this.setServerUrl(a.serverUrl,a.cartographicServerUrl,a.imageServerDomains,a.apiServerDomains,a.cartographicServerDomains):c+="Parameter not supplied: serverUrl!\x3cbr/\x3e";if(ImajnetUser.data&&this.imajnetIsActive())return ImajnetPlugin.imajnetLoginSuccess(),ImajnetProtocol.imajnetLoginSuccess(a.activateImajnet),b.resolve(),b.promise();if(c)return alert(c),ImajnetPlugin.imajnetLoginError(),b.reject(),b.promise();a.imajnetPath&&
(this.imajnetPath=a.imajnetPath);a.loginRememberMe&&(ImajnetProtocol.loginRememberMe=a.loginRememberMe);a.language?this.setLanguage(a.language):jQuery.imajnet||this.setLanguage("en");a.containerId&&(this.containerId=a.containerId);a.unit&&(this.unit=a.unit);a.searchLRSContainerId&&(ImajnetUI.searchLRSContainerId=a.searchLRSContainerId);a.searchAddressContainerId&&(ImajnetUI.searchAddressContainerId=a.searchAddressContainerId);a.clipboardContainerId&&(ImajnetUI.clipboardContainerId=a.clipboardContainerId);
a.clipboardExportContainerId&&(ImajnetUI.clipboardExportContainerId=a.clipboardExportContainerId);a.newsContainerId&&(ImajnetUI.newsContainerId=a.newsContainerId);a.projectedLayersContainerId&&(ImajnetUI.projectedLayersContainerId=a.projectedLayersContainerId);Nigsys.initNotification();try{ImajnetMap.key="cartographicKey"}catch(d){}a.metadata?Imajnet.metadata=a.metadata:Imajnet.metadata||(Imajnet.metadata=document.domain);a.applicationKey&&(Imajnet.applicationKey=a.applicationKey);Nigsys.bindOnHashChange();
"object"===typeof ImajnetProtocol?ImajnetProtocol.imajnetLogin(a.username,a.password,a.activateImajnet).done(function(){b.resolve()}).fail(function(){b.reject()}):(ImajnetPlugin.imajnetLoginError(),b.reject());a.clipboardActive||Photogrammetry.disableClipboard();a.autoPhotogrammetryAdd&&(this.autoPhotogrammetryAdd=!0);return b.promise()},setServerUrl:function(a,b,c,d,f){this.serverUrl=a;-1==this.serverUrl.indexOf("http")&&(this.serverUrl=window.location.protocol+"//"+window.location.hostname+this.serverUrl);
this.serverUrl.lastIndexOf("/")===this.serverUrl.length-1&&this.serverUrl.substring(0,this.serverUrl.length-2);this.cartographicServerUrl=b;b=null;for(var e in Imajnet.wellKnownImajnetDomains)if(-1!=a.indexOf(Imajnet.wellKnownImajnetDomains[e])){b=Imajnet.wellKnownImajnetDomains[e];break}c?ImajnetAPI.imageServerDomains=c:b&&(ImajnetAPI.imageServerDomains=Nigsys.generateSubdomainList(a,"image",b,5));d?ImajnetAPI.apiServerDomains=d:b&&(ImajnetAPI.apiServerDomains=Nigsys.generateSubdomainList(a,"api",
b,5));f?ImajnetMap.cartographicServerDomains=f:b&&(ImajnetMap.cartographicServerDomains=Nigsys.generateSubdomainList(a,"carto",b,5))},imajnetClosestPositionIsActive:function(){return Imajnet.clickMode==Imajnet.CLICK_MODE_CLOSEST_IMAGE},imajnetOrientedImagesIsActive:function(){return Imajnet.clickMode==Imajnet.CLICK_MODE_ORIENTED_IMAGES},imajnetIsActive:function(){return this.imajnetIsActiveBoolean},activateImajnetControl:function(a,b){Imajnet.imajnetIsActive()||b===ImajnetUI.controlNames.searchLRS||
Imajnet.activateImajnet();for(var c=!1,d=0,f=ImajnetUI.controlActivatorContainers.length;d<f;++d)ImajnetUI.controlActivatorContainers[d].controlName==b&&(c=!0);b==Imajnet.CLICK_MODE_CLOSEST_IMAGE?(ImajnetUI.disableToolControls(),Imajnet.clickMode=Imajnet.CLICK_MODE_CLOSEST_IMAGE,ImajnetClickMode.hideOrientedImages(!0)):b==Imajnet.CLICK_MODE_ORIENTED_IMAGES?(ImajnetUI.disableToolControls(),Imajnet.clickMode=Imajnet.CLICK_MODE_ORIENTED_IMAGES,12>ImajnetPlugin.getCurrentZoomLevel()&&(ImajnetPlugin.zoomMapTo(12),
ImajnetMap.currentPosition&&ImajnetPlugin.centerMapToPosition(ImajnetMap.currentPosition))):b==ImajnetUI.controlNames.showClipboard?(ImajnetUI.showItem(ImajnetUI.clipboardContainerId,Nigsys.browserIsIE7()?350:null),ImajnetUI.addActiveState(a)):b==ImajnetUI.controlNames.searchLRS?LRS.openLRSDialog():"searchAddress"==b?Address.openSearchDialog():"showNews"==b&&ImajnetNews.init(!1);ImajnetUI.addActiveState(a);c||ImajnetUI.controlActivatorContainers.push({buttonElement:a,controlName:b})},deactivateImajnetControl:function(a,
b){if(!Imajnet.imajnetIsActive())return!1;b==Imajnet.CLICK_MODE_CLOSEST_IMAGE?Imajnet.clickMode=null:b==Imajnet.CLICK_MODE_ORIENTED_IMAGES?(ImajnetClickMode.hideOrientedImages(!0),Imajnet.clickMode=null):b==ImajnetUI.controlNames.showClipboard?(ImajnetUI.hideItem(ImajnetUI.clipboardExportContainerId),ImajnetUI.hideItem(ImajnetUI.clipboardContainerId)):b==ImajnetUI.controlNames.searchLRS?LRS.closeLRSDialog():"searchAddress"==b?Address.hideAddress():"showNews"==b&&ImajnetNews.close();ImajnetUI.removeActiveState(a)},
deactivateImajnetControls:function(){for(var a=0,b=ImajnetUI.controlActivatorContainers.length;a<b;++a)this.deactivateImajnetControl(ImajnetUI.controlActivatorContainers[a].buttonElement,ImajnetUI.controlActivatorContainers[a].controlName);ImajnetUI.disableToolControls()},activateImajnet:function(){Imajnet.imajnetIsActive()||(Imajnet.imajnetIsActiveBoolean=!0,"undefined"!==typeof ImajnetUI&&ImajnetUI&&ImajnetUI.addToolControls(),this.enableImajnetExtension(),"undefined"!==typeof ImajnetNews&&ImajnetNews.init(!0),
"undefined"!==typeof ImageControler.currentPhotogrammetry&&ImageControler.currentPhotogrammetry&&ImageControler.currentPhotogrammetry.init(),"undefined"!==typeof ImajnetPlugin&&("undefined"!==typeof ImajnetProjection&&ImajnetPlugin.initProjectedLayers(),ImajnetPlugin.onImajnetActivated()))},addImageDate:function(a){a?ImajnetUI.imajnetAddImageDate(a):ImajnetUI.hideDateContainer()},enableImajnetExtension:function(){"undefined"!==typeof ImajnetZoom&&ImajnetZoom&&jQuery(document).bind("vmouseup",ImajnetZoom.shiftZoomEnd);
"undefined"!==typeof ImajnetMap&&ImajnetMap&&ImajnetMap.registerToMap();Imajnet.clickMode=null},deactivateImajnet:function(a,b,c){var d=jQuery.Deferred();this.deactivateImajnetControls();if(!a&&!Imajnet.imajnetIsActive())return ImajnetPlugin.onImajnetDeactivated(),d.resolve(),d.promise();ImajnetAPI.abortAllRequests();Imajnet.imajnetIsActiveBoolean=!1;Imajnet.clickMode=null;jQuery(document).unbind("vmouseup",ImajnetZoom.shiftZoomEnd);c?(ImajnetUrl.changeUrlParam(ImajnetUrl.LOCATION_URL_PARAM_NAME,
"",!0),ImajnetUrl.changeUrlParam(ImajnetUrl.SURVEY_TRACE_URL_PARAM_NAME,"",!0)):ImajnetUrl.urlParams={};ImajnetMap.unregisterFromMap();ImageControler.currentGraphic&&(ImageControler.currentGraphic.svg=null);ImageControler.currentPhotogrammetry&&(ImageControler.currentPhotogrammetry.objects=[]);ImajnetAPI.setImajnetImage(null);ImajnetUI.hideImageElements();ImajnetUI.removeImageElements();Address.addressContainer=null;LRS.LRSContainer=null;ImajnetUI.docking.imageButtons&&ImajnetUI.docking.imageButtons.remove();
ImajnetUI.docking.imageLRSGUI&&ImajnetUI.docking.imageLRSGUI.remove();ImajnetUI.LRSGUI&&(ImajnetUI.LRSGUI.redrawRoad=!0);ImajnetUI.hideItem(ImajnetUI.imageContainerId);ImajnetUI.hideItem(ImajnetUI.clipboardContainerId);ImajnetUI.hideItem(ImajnetUI.clipboardExportContainerId);Nigsys.notification&&Nigsys.notification.hide();ImajnetProtocol.imajnetLogout(!1).done(function(){ImajnetPlugin.onImajnetDeactivated();d.resolve()}).fail(function(){ImajnetPlugin.onImajnetDeactivated();CommonCore.deactivateImajnetButton();
d.reject()});return d.promise()},initImajnetServerSubdomains:function(a,b,c,d,f){if(-1!==a.serverUrl.indexOf("test.imajnet.net")||-1!==a.serverUrl.indexOf("testservice.imajnet.net"))f&&(a.cartographicServerDomains=Nigsys.generateSubdomainList(a.serverUrl,"testcarto","imajnet.net",5)),a.imageServerDomains=Nigsys.generateSubdomainList(a.serverUrl,"testimage","imajnet.net",5),a.apiServerDomains=Nigsys.generateSubdomainList(a.serverUrl,"testapi","imajnet.net",5);else{if(f)for(var e in b)if(-1!==a.serverUrl.indexOf(b[e])){a.cartographicServerDomains=
Nigsys.generateSubdomainList(a.serverUrl,"carto",b[e],5);break}for(e in c)if(-1!==a.serverUrl.indexOf(c[e])){a.imageServerDomains=Nigsys.generateSubdomainList(a.serverUrl,"image",c[e],5);break}for(e in d)if(-1!==a.serverUrl.indexOf(d[e])){a.apiServerDomains=Nigsys.generateSubdomainList(a.serverUrl,"api",d[e],5);break}}}};jQuery(function(){"undefined"!==typeof Combobox&&"function"===typeof Combobox.init&&Combobox.init()});
Imajnet.version="1.1.2-SNAPSHOT";Imajnet.buildDate="2018-11-15T10:55:58Z";
var ApplicationStorage={writeObject:function(d,a,b,c){d=(b?b+"_":"")+(c?c+"_":"")+d;try{"undefined"===typeof a&&(console.error("Write to storage: "+a),a=null),window.localStorage.setItem(d,JSON.stringify(a))}catch(e){console.error("LocalStorage - Unable to serialize json: - "+e)}},readObject:function(d,a,b){try{return JSON.parse(window.localStorage.getItem((a?a+"_":"")+(b?b+"_":"")+d))}catch(c){return console.error("LocalStorage - Unable to parse json: "+c),null}},writeSessionObject:function(d,a,
b,c){try{window.sessionStorage.setItem((b?b+"_":"")+(c?c+"_":"")+d,JSON.stringify(a))}catch(e){console.error("SesisonStorage - Unable to serialize json: - "+e)}},readSessionObject:function(d,a,b){try{return JSON.parse(window.sessionStorage.getItem((a?a+"_":"")+(b?b+"_":"")+d))}catch(c){return console.error("SessionStorage - Unable to parse json: "+c),null}},writeObjectInCookie:function(d,a,b,c){try{window.localStorage.setItem((b?b+"_":"")+(c?c+"_":"")+d,JSON.stringify(a))}catch(e){console.error("LocalStorage - Unable to serialize json: - "+
e)}},readObjectFromCookie:function(d,a,b){try{return JSON.parse(window.localStorage.getItem((a?a+"_":"")+(b?b+"_":"")+d))}catch(c){return console.error("LocalStorage - Unable to parse json: "+c),null}}};
var ImajnetUrl={WORKSPACE_URL_PARAM_NAME:"wid",GROUP_URL_PARAM_NAME:"tgid",POSITION_URL_PARAM_NAME:"pos",LOCALE_URL_PARAM_NAME:"locale",IMAGE_URL_PARAM_NAME:"image",LOCATION_URL_PARAM_NAME:"loc",TIME_URL_PARAM_NAME:"time",MAP_URL_PARAM_NAME:"map",ZOOM_URL_PARAM_NAME:"zoom",SURVEY_TRACE_URL_PARAM_NAME:"trace",OSM_LAYER_PARAM_NAME:"OSM",OSMMAPNIK_LAYER_PARAM_NAME:"OSMMAPNIK",OCM_LAYER_PARAM_NAME:"OCM",OTM_LAYER_PARAM_NAME:"OTM",BING_ROAD_LAYER_PARAM_NAME:"B_MAP",BING_SATELLITE_LAYER_PARAM_NAME:"B_SAT",
BING_HYBRID_LAYER_PARAM_NAME:"B_HYBRID",GOOGLE_ROAD_LAYER_PARAM_NAME:"G_MAP",GOOGLE_SATELLITE_LAYER_PARAM_NAME:"G_SAT",GOOGLE_HYBRID_LAYER_PARAM_NAME:"G_HYBRID",DEFAULT_ZOOM_LEVEL:10,SURVEY_TRACE_ACTIVE_PARAM_VALUE:"yes",urlParams:{},paramsSeparator:";",paramsAssign:"\x3d",saveToLocalStorage:!1,getUrlParamValue:function(b){var a="";try{a=jQuery.url().fparam(b)}catch(c){}return a},readUrl:function(b){var a={};a[this.WORKSPACE_URL_PARAM_NAME]=this.getUrlParamValue(this.WORKSPACE_URL_PARAM_NAME);a[this.GROUP_URL_PARAM_NAME]=
this.getUrlParamValue(this.GROUP_URL_PARAM_NAME);a[this.POSITION_URL_PARAM_NAME]=this.getUrlParamValue(this.POSITION_URL_PARAM_NAME);a[this.LOCALE_URL_PARAM_NAME]=this.getUrlParamValue(this.LOCALE_URL_PARAM_NAME);a[this.IMAGE_URL_PARAM_NAME]=this.getUrlParamValue(this.IMAGE_URL_PARAM_NAME);a[this.LOCATION_URL_PARAM_NAME]=this.getUrlParamValue(this.LOCATION_URL_PARAM_NAME);a[this.TIME_URL_PARAM_NAME]=this.getUrlParamValue(this.TIME_URL_PARAM_NAME);var c=this.getUrlParamValue(this.MAP_URL_PARAM_NAME);
c==this.GOOGLE_ROAD_LAYER_PARAM_NAME?c=this.BING_ROAD_LAYER_PARAM_NAME:c==this.GOOGLE_SATELLITE_LAYER_PARAM_NAME?c=this.BING_SATELLITE_LAYER_PARAM_NAME:c==this.GOOGLE_HYBRID_LAYER_PARAM_NAME&&(c=this.BING_HYBRID_LAYER_PARAM_NAME);a[this.MAP_URL_PARAM_NAME]=c;a[this.ZOOM_URL_PARAM_NAME]=this.getUrlParamValue(this.ZOOM_URL_PARAM_NAME);a[this.ZOOM_URL_PARAM_NAME]&&(c=parseInt(a[this.ZOOM_URL_PARAM_NAME]),0>c||25<c)&&(a[this.ZOOM_URL_PARAM_NAME]=this.urlParams[this.ZOOM_URL_PARAM_NAME],b&&this.changeUrlParam(this.ZOOM_URL_PARAM_NAME,
a[this.ZOOM_URL_PARAM_NAME],!0));a[this.SURVEY_TRACE_URL_PARAM_NAME]=this.getUrlParamValue(this.SURVEY_TRACE_URL_PARAM_NAME);a[this.SURVEY_TRACE_URL_PARAM_NAME]&&a[this.SURVEY_TRACE_URL_PARAM_NAME]!=this.SURVEY_TRACE_ACTIVE_PARAM_VALUE&&(a[this.SURVEY_TRACE_URL_PARAM_NAME]=this.urlParams[this.SURVEY_TRACE_URL_PARAM_NAME],b&&this.changeUrlParam(this.SURVEY_TRACE_URL_PARAM_NAME,a[this.SURVEY_TRACE_URL_PARAM_NAME],!0));return a},applyCenterFromUrl:function(b){var a=this.getUrlParamValue(this.POSITION_URL_PARAM_NAME).split(",");
ImajnetPlugin.centerMapToPosition({lon:a[1],lat:a[0]});b&&ImajnetPlugin.zoomMapTo(b)},onGoToLocation:function(b){b=b.split(",");ImajnetAPI.getClosestPosition(b[0],b[1],ImajnetSettings.rangeClosestPositionUrl,ImajnetSettings.NO_TIME_RANGE);ImajnetUrl.getUrlParamValue(this.POSITION_URL_PARAM_NAME)||ImajnetPlugin.centerMapToPosition({lon:b[1],lat:b[0]})},goToLocation:function(b){this.onGoToLocation(b)},changeLocale:function(b){if(b!=Imajnet.locale){this.urlParams[this.LOCALE_URL_PARAM_NAME]=b;b="";var a=
window.location.search;if(-1===a.indexOf(this.LOCALE_URL_PARAM_NAME))b=(a?b+(a+"\x26"):b+"?")+(this.LOCALE_URL_PARAM_NAME+"\x3d"+this.urlParams[this.LOCALE_URL_PARAM_NAME]+"\x26");else for(var a=a.split("\x26"),c=0;c<a.length;c++)-1!==a[c].indexOf(this.LOCALE_URL_PARAM_NAME)?(0==c&&(b+="?"),b+=this.LOCALE_URL_PARAM_NAME+"\x3d"+this.urlParams[this.LOCALE_URL_PARAM_NAME]+"\x26"):b+=a[c]+"\x26";window.location.search=CommonCore.deleteLastChar(b)}},applyImajnetLocation:function(b){this.goToLocation(b)},
applyUrlParams:function(b){try{var a=ImajnetUrl.readUrl(b);a[this.LOCALE_URL_PARAM_NAME]&&a[this.LOCALE_URL_PARAM_NAME]!=this.urlParams[this.LOCALE_URL_PARAM_NAME]&&ImajnetUrl.changeLocale(a[this.LOCALE_URL_PARAM_NAME]);if(a[this.MAP_URL_PARAM_NAME]!=this.urlParams[this.MAP_URL_PARAM_NAME]){this.urlParams[this.MAP_URL_PARAM_NAME]=a[this.MAP_URL_PARAM_NAME];try{window["set"+this.urlParams[this.MAP_URL_PARAM_NAME]+"BaseLayer"]()}catch(e){}this.changeUrlParam(this.MAP_URL_PARAM_NAME,this.urlParams[this.MAP_URL_PARAM_NAME])}if(a[this.ZOOM_URL_PARAM_NAME]!=
this.urlParams[this.ZOOM_URL_PARAM_NAME]){this.urlParams[this.ZOOM_URL_PARAM_NAME]=a[this.ZOOM_URL_PARAM_NAME];var c=parseInt(this.urlParams[this.ZOOM_URL_PARAM_NAME]);ImajnetPlugin.zoomMapTo(c)}a[this.SURVEY_TRACE_URL_PARAM_NAME]!=this.urlParams[this.SURVEY_TRACE_URL_PARAM_NAME]&&(this.urlParams[this.SURVEY_TRACE_URL_PARAM_NAME]=a[this.SURVEY_TRACE_URL_PARAM_NAME],a[this.SURVEY_TRACE_URL_PARAM_NAME]==this.SURVEY_TRACE_ACTIVE_PARAM_VALUE?SurveyTrace.surveyTraceIsActive=!0:b&&(SurveyTrace.surveyTraceIsActive=
!1,ImageControler.currentSurveyTrace&&ImageControler.currentSurveyTrace.hideTrace()));if(a[this.IMAGE_URL_PARAM_NAME]){this.urlParams[this.IMAGE_URL_PARAM_NAME]=a[this.IMAGE_URL_PARAM_NAME];var d={id:this.urlParams[this.IMAGE_URL_PARAM_NAME]};ImajnetZoom.left=-1;Nigsys.showLoading(ImajnetUI.imageContainer);ImajnetAPI.setImajnetImage({position:d});ImajnetUrl.changeUrlParam(this.IMAGE_URL_PARAM_NAME,"")}else a[this.LOCATION_URL_PARAM_NAME]&&a[this.LOCATION_URL_PARAM_NAME]!=this.urlParams[this.LOCATION_URL_PARAM_NAME]&&
(this.urlParams[this.LOCATION_URL_PARAM_NAME]=a[this.LOCATION_URL_PARAM_NAME],this.applyImajnetLocation(this.urlParams[this.LOCATION_URL_PARAM_NAME]))}catch(e){console.error(e)}},changeUrlParam:function(b,a){this.urlParams[b]=a;var c=this.readUrl(!1);c[b]=a;this.writeUrl(c);ImajnetUrl.saveToLocalStorage&&Nigsys.setCookie("IMAJNET","URL_PARAMS",c)},setUrlParamsFromLocalstorage:function(){ImajnetUrl.saveToLocalStorage=!0;var b=Nigsys.getCookie("IMAJNET","URL_PARAMS");0==window.location.hash.length&&
b&&ImajnetUrl.writeUrl(b)},getUrlHash:function(){return window.location.hash},setUrlHash:function(b){window.location.hash=b},deleteUrlParams:function(){this.setUrlHash("")},writeUrl:function(b){var a="";b[this.WORKSPACE_URL_PARAM_NAME]&&(a+=this.WORKSPACE_URL_PARAM_NAME+this.paramsAssign+b[this.WORKSPACE_URL_PARAM_NAME]+this.paramsSeparator);b[this.GROUP_URL_PARAM_NAME]&&(a+=this.GROUP_URL_PARAM_NAME+this.paramsAssign+b[this.GROUP_URL_PARAM_NAME]+this.paramsSeparator);b[this.POSITION_URL_PARAM_NAME]&&
(a+=this.POSITION_URL_PARAM_NAME+this.paramsAssign+b[this.POSITION_URL_PARAM_NAME]+this.paramsSeparator);b[this.LOCATION_URL_PARAM_NAME]&&(a+=this.LOCATION_URL_PARAM_NAME+this.paramsAssign+b[this.LOCATION_URL_PARAM_NAME]+this.paramsSeparator);b[this.TIME_URL_PARAM_NAME]&&(a+=this.TIME_URL_PARAM_NAME+this.paramsAssign+b[this.TIME_URL_PARAM_NAME]+this.paramsSeparator);b[this.MAP_URL_PARAM_NAME]&&(a+=this.MAP_URL_PARAM_NAME+this.paramsAssign+b[this.MAP_URL_PARAM_NAME]+this.paramsSeparator);if(b[this.ZOOM_URL_PARAM_NAME]||
0==b[this.ZOOM_URL_PARAM_NAME])a+=this.ZOOM_URL_PARAM_NAME+this.paramsAssign+b[this.ZOOM_URL_PARAM_NAME]+this.paramsSeparator;b[this.SURVEY_TRACE_URL_PARAM_NAME]&&(a+=this.SURVEY_TRACE_URL_PARAM_NAME+this.paramsAssign+b[this.SURVEY_TRACE_URL_PARAM_NAME]+this.paramsSeparator);var c=this.getUrlHash();b="";if(c&&"#"!=c)for(var c=c.replace("#","").split(this.paramsSeparator),d=0;d<c.length;d++)c[d]&&-1===c[d].indexOf(this.IMAGE_URL_PARAM_NAME+this.paramsAssign)&&-1===c[d].indexOf(this.WORKSPACE_URL_PARAM_NAME+
this.paramsAssign)&&-1===c[d].indexOf(this.GROUP_URL_PARAM_NAME+this.paramsAssign)&&-1===c[d].indexOf(this.POSITION_URL_PARAM_NAME+this.paramsAssign)&&-1===c[d].indexOf(this.LOCATION_URL_PARAM_NAME+this.paramsAssign)&&-1===c[d].indexOf(this.TIME_URL_PARAM_NAME+this.paramsAssign)&&-1===c[d].indexOf(this.MAP_URL_PARAM_NAME+this.paramsAssign)&&-1===c[d].indexOf(this.ZOOM_URL_PARAM_NAME+this.paramsAssign)&&-1===c[d].indexOf(this.SURVEY_TRACE_URL_PARAM_NAME+this.paramsAssign)&&(b+=c[d]+this.paramsSeparator);
this.setUrlHash("#"+a+b)}};
var ImajnetResponse={NO_INTERNET_CONNECTION:0,ACCEPTED:202,BAD_GATEWAY:502,BAD_REQUEST:400,CONFLICT:409,CONTINUE:100,CREATED:201,EXPECTATION_FAILED:417,FORBIDDEN:403,GATEWAY_TIMEOUT:405,GONE:410,HTTP_VERSION_NOT_SUPPORTED:505,INTERNAL_SERVER_ERROR:500,LENGTH_REQUIRED:411,METHOD_NOT_ALLOWED:405,MOVED_PERMANENTLY:301,MOVED_TEMPORARILY:302,MULTIPLE_CHOICES:300,NO_CONTENT:204,NON_AUTHORITATIVE_INFORMATION:203,NOT_ACCEPTABLE:406,NOT_FOUND:404,NOT_IMPLEMENTED:501,NOT_MODIFIED:304,OK:200,PARTIAL_CONTENT:206,
PAYMENT_REQUIRED:402,PRECONDITION_FAILED:412,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_ENTITY_TOO_LARGE:413,REQUESTED_RANGE_NOT_SATISFIABLE:416,RESET_CONTENT:205,SEE_OTHER:303,SERVICE_UNAVAILABLE:503,SC_SWITCHING_PROTOCOLS:101,TEMPORARY_REDIRECT:307,UNAUTHORIZED:401,UNSUPPORTED_MEDIA_TYPE:415,USE_PROXY:305,header:{AUTHENTICATED:"AUTHENTICATED",UNAUTHETICATED:"UNAUTHETICATED",UNAUTHORISED:"UNAUTHORISED",ACCOUNT_LOCKED:"ACCOUNT_LOCKED",ACCOUNT_DISABLED:"ACCOUNT_DISABLED",ACCOUNT_EXPIRED:"ACCOUNT_EXPIRED",
CREDENTIALS_EXPIRED:"CREDENTIALS_EXPIRED",INVALID_APPLICATION_KEY:"INVALID_APPLICATION_KEY",INVALID_SESSION_TYPE:"INVALID_SESSION_TYPE",UNAUTHORIZED_SESSION_TYPE:"UNAUTHORIZED_SESSION_TYPE"}};
window.console||(window.console={log:function(){},warn:function(){},debug:function(){},error:function(){}});
var _A=6378137,_F=.00335281067598882,_E2=.00669437999013,_INVPI=.0174532925199433,_PIs180=57.2957795130823,Nigsys={dateZ:"Z",dateT:"T",confirmDialog:null,logoOverlayDiv:'\x3cdiv id\x3d"logoOverlay"\x3e\x3c/div\x3e',logoOverlay:null,modalOverlayDiv:'\x3cdiv id\x3d"modalOverlay" class\x3d"modalOverlay opacity80"\x3e\x3c/div\x3e',modalOverlay:null,sessionExpired:!1,notification:null,errorNotification:null,sessionExpiredNotification:null,requestsTimeout:3E3,scrollbarSize:0,SVGNamespace:"http://www.w3.org/2000/svg",
timeFormat:"HH:mm",defaultObjectsColor:"rgba(0, 255, 0, 0.67)",defaultPolygonObjectsColor:"rgba(38, 131, 239, 0.67)",hoverObjectsColor:"#EE9900",differentTracePinPointColor:"#00AA00",differentTracePinPointHoverColor:"#EE9911",base64Header:"data:image/png;base64,",sessionTimeout:1795,loginNotificationWidth:450,zoomMap:{1:50,2:70,3:100,4:120,5:150,6:170,7:200,8:250,9:300,10:350,11:430,12:520,13:620,14:750,15:900,16:1070,17:1290,18:1550,19:1850,20:2200,21:2670,22:3200,23:3800,24:4600,25:5500,26:6600},
compareStringAscending:function(a,c,d){a=a[d].toLowerCase();c=c[d].toLowerCase();return a<c?-1:a>c?1:0},compareIntAscending:function(a,c,d){return parseInt(a[d])-parseInt(c[d])},isOutsideViewport:function(a){var c=ImajnetPlugin.getMapExtent();return c?a[0]<c[0]||a[0]>c[2]||a[1]<c[1]||a[1]>c[3]:!1},isValidImajnetAddress:function(a){"/"!=a.substr(-1)&&(a+="/");return/(https|http):\/\/+(.*).imajnet.net\/+?(.*)/.test(a)||/(https|http):\/\/+(.*).imajbox.com\/+?(.*)/.test(a)},getHighestUnit:function(a,
c,d,e){if("m"==c){if(1E3<a)return(a/1E3).toFixed(d)+" KM"}else if("feet"==c&&a>LRS.feetInAMile)return(a/LRS.feetInAMile).toFixed(d)+(e?" M":" mile");return a.toFixed(d)+" "+Nigsys.getUnitText(c,e)},getMeasurementUnitFromImajnet:function(){return ImajnetSettings.imajnetSettings&&ImajnetSettings.imajnetSettings.unit?ImajnetSettings.imajnetSettings.unit:ImajnetUser.data.unit},getMeasurementUnit:function(){return Imajnet.unit?Imajnet.unit:"undefined"!==typeof isImajnetMode&&isImajnetMode()?Nigsys.getMeasurementUnitFromImajnet():
"undefined"!==typeof CommonCore&&CommonCore.userInfo&&CommonCore.userInfo.customer&&CommonCore.userInfo.customer.unit?CommonCore.userInfo.customer.unit:Nigsys.getMeasurementUnitFromImajnet()},getHighestSquareUnit:function(a,c){if("m"==c){if(1E6<a)return(a/1E6).toFixed(3)+" km\x3csup\x3e2\x3c/sup\x3e"}else if("feet"==c){var d=Math.pow(LRS.feetInAMile,2);if(a>d)return(a/d).toFixed(3)+" mile\x3csup\x3e2\x3c/sup\x3e"}return a.toFixed(3)+" "+Nigsys.getUnitText(c)+"\x3csup\x3e2\x3c/sup\x3e"},lonLatToXY:function(a){return{x:a.lon,
y:a.lat}},waitForAllDeferred:function(a,c){var d=jQuery.Deferred();jQuery.when.apply(jQuery,jQuery.map(a,function(a){var c=jQuery.Deferred();a.always(function(){c.resolve()});return c.promise()})).done(function(){if(c){var a=c();Nigsys.isDeferred(a)?a.done(function(){d.resolve()}).fail(function(){d.resolve()}):d.resolve()}else d.resolve()});return d.promise()},getDegreeFromMeters:function(a){return parseFloat(a)/111111},getElementWidth:function(a){return a.style.width?parseInt(a.style.width.replace("px",
"")):0},graphicIsFont:function(a){return a&&-1!==a.indexOf("ttf://")},endsWith:function(a,c){return-1!==a.indexOf(c,a.length-c.length)},getDelta:function(a,c){Nigsys.browserIsMozilla()?c=-40*(0!=a.originalEvent.detail?a.originalEvent.detail:a.originalEvent.deltaY):c||(c=a.originalEvent.wheelDelta);if(0>c)return-window.devicePixelRatio;if(0<=c)return window.devicePixelRatio},scrollDeltaIsValid:function(a){return-1==a||1==a||a==-window.devicePixelRatio||a==window.devicePixelRatio},degreeToRadians:function(a){return a*
Math.PI/180},getProtocolString:function(a){a||(a=Imajnet.serverUrl);return"undefined"!==typeof Imajnet&&a?OpenLayersForProjection.String.startsWith(a,"https:")?"https:":"http:":!CommonCore.isMobile||MainCore.isWeb?window.location.protocol:"http:"},isNumber:function(a){return a-0==a&&0<(""+a).trim().length},getCheckboxHTML:function(a,c,d,e,f,k){c||(c="");d||(d="");e||(e="");return"undefined"!==typeof CommonCore&&CommonCore.isMobile?'\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"checkbox" name\x3d"'+
a+'" id\x3d"'+a+'" class\x3d"'+c+'" '+e+(f?' checked\x3d"checked"':"")+(k?' disabled\x3d"disabled"':"")+' /\x3e\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"height: 20px; line-height: 20px;"\x3e\x3clabel for\x3d"'+a+'"'+(d?"":'class\x3d"noTextCheckbox"')+"\x3e"+d+'\x3c/label\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e':'\x3cinput type\x3d"checkbox" id\x3d"'+a+'" class\x3d"'+c+'" '+e+(f?' checked\x3d"checked"':"")+(k?' disabled\x3d"disabled"':"")+" /\x3e"},bindClickEvent:function(a,
c,d){var e="click";if("undefined"!==typeof CommonCore&&CommonCore.isMobile||Nigsys.onMobile())e="tap";a.on(e,d,function(a){Nigsys.disableEventPropagation(a);c(a)});if(Nigsys.isTouchDevice()&&"tap"!==e)a.on("tap",d,function(a){Nigsys.disableEventPropagation(a);c(a)})},unbindClickEvent:function(a){var c="click";if("undefined"!==typeof CommonCore&&CommonCore.isMobile||Nigsys.onMobile())c="tap";a.off(c)},bindEnterEvent:function(a){jQuery(document).bind("keydown",function(c){13==c.keyCode&&a(c)})},getStatusErrorText:function(a){return a==
ImajnetResponse.UNAUTHORIZED?jQuery.imajnet.login.error.header.unauthorized:a==ImajnetResponse.FORBIDDEN?jQuery.imajnet.login.error.header.unauthenticated:a==ImajnetResponse.MOVED_TEMPORARILY?jQuery.imajnet.login.error.movedTemporarily:a==ImajnetResponse.SERVICE_UNAVAILABLE?"undefined"===typeof isImajnetMode||isImajnetMode()?jQuery.imajnet.login.error.serviceUnavailable:jQuery.app.login.serviceUnavailable:a==ImajnetResponse.NO_INTERNET_CONNECTION?"undefined"!==typeof CommonCore&&CommonCore.isMobile?
jQuery.imajnet.login.error.noInternetConnection:jQuery.imajnet.login.error.unableToConnect:jQuery.imajnet.login.error.unknown},initLogoOverlay:function(){"undefined"===typeof isImajnetMode||isImajnetMode()||(jQuery("body").append(Nigsys.logoOverlayDiv),Nigsys.logoOverlay=jQuery("#logoOverlay"))},getCookieWarningNotificationInfoOkHTML:function(){return'\x3cdiv id\x3d"cookieWarningNotification"\x3e'+jQuery.imajnetweb.cookieWarning+'\x3cinput type\x3d"button" id\x3d"cookieWarningNotificationOk" value\x3d"'+
jQuery.imajnet.button.ok+'" /\x3e\x3c/div\x3e'},getNotificationInfoOkHTML:function(a){return'\x3cdiv id\x3d"'+a+'"\x3e\x3cinput type\x3d"hidden" value\x3d"notificationInfoOk" /\x3e\x3ca class\x3d"ui-notify-cross ui-notify-close" href\x3d"javascript: void(0);"\x3ex\x3c/a\x3e\x3ch1\x3e#{title}\x3c/h1\x3e\x3cdiv\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+'img/warningNotify.png" class\x3d"notificationImage" align\x3d"top"/\x3e\x26nbsp;#{text}\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3cinput type\x3d"button" value\x3d"'+
jQuery.imajnet.button.ok+'" /\x3e\x3c/div\x3e\x3c/div\x3e'},getNotificationHTML:function(){return'\x3cdiv id\x3d"notification" class\x3d"notification"\x3e\x3cdiv id\x3d"notificationInfo"\x3e\x3cinput type\x3d"hidden" value\x3d"notificationInfo" /\x3e\x3ca class\x3d"ui-notify-cross ui-notify-close" href\x3d"javascript: void(0);"\x3ex\x3c/a\x3e\x3ch1\x3e#{title}\x3c/h1\x3e\x3cdiv\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+'img/warningNotify.png" class\x3d"notificationImage" align\x3d"top"/\x3e\x26nbsp;#{text}\x3c/div\x3e\x3c/div\x3e'+
Nigsys.getNotificationInfoOkHTML("notificationInfoOk")+'\x3cdiv id\x3d"notificationSessionExpired"\x3e\x3cinput type\x3d"hidden" value\x3d"notificationSessionExpired" /\x3e\x3cdiv\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+'img/warningNotify.png" class\x3d"notificationImage" align\x3d"top"/\x3e\x26nbsp;#{text}\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3cinput id\x3d"confirmYes_#{type}" type\x3d"button" value\x3d"'+jQuery.imajnet.button.ok+'" onclick\x3d"Nigsys.closeConfirmDialog();" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"notificationError"\x3e\x3cinput type\x3d"hidden" value\x3d"notificationError" /\x3e\x3ca class\x3d"ui-notify-cross ui-notify-close" href\x3d"javascript: void(0);"\x3ex\x3c/a\x3e\x3ch1\x3e#{title}\x3c/h1\x3e\x3cdiv\x3e\x3cimg src\x3d"'+
Imajnet.imajnetPath+'img/warningNotify.png" class\x3d"notificationImage" align\x3d"top"/\x3e\x26nbsp;#{text}\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3cinput type\x3d"button" value\x3d"'+jQuery.imajnet.button.ok+'" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"persistentNotificationError"\x3e\x3cinput type\x3d"hidden" value\x3d"notificationError" /\x3e\x3ch1\x3e#{title}\x3c/h1\x3e\x3cdiv\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+'img/warningNotify.png" class\x3d"notificationImage" align\x3d"top"/\x3e\x26nbsp;#{text}\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3cinput type\x3d"button" value\x3d"'+
jQuery.imajnet.button.ok+'" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"notificationImageSwitcherBigMode"\x3e#{text}\x3c/div\x3e\x3cdiv id\x3d"notificationOkConfirm"\x3e\x3cinput type\x3d"hidden" value\x3d"notificationOkConfirm" /\x3e\x3ch1\x3e#{title}\x3c/h1\x3e\x3cdiv\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+'img/warningNotify.png" class\x3d"notificationImage" align\x3d"top"/\x3e\x26nbsp;#{text}\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3cinput id\x3d"confirmOk_#{type}" type\x3d"button" value\x3d"'+
jQuery.imajnet.button.ok+'" onclick\x3d"Nigsys.closeConfirmDialog();" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"notificationConfirm"\x3e\x3cinput type\x3d"hidden" value\x3d"notificationConfirm" /\x3e\x3ch1\x3e#{title}\x3c/h1\x3e\x3cdiv\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+'img/warningNotify.png" class\x3d"notificationImage" align\x3d"top"/\x3e\x26nbsp;#{text}\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3cinput id\x3d"confirmYes_#{type}" type\x3d"button" value\x3d"'+jQuery.imajnet.button.yes+
'" onclick\x3d"Nigsys.closeConfirmDialog();" /\x3e\x3cinput id\x3d"confirmNo_#{type}" type\x3d"button" value\x3d"'+jQuery.imajnet.button.no+'" onclick\x3d"Nigsys.closeConfirmDialog();" /\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e'},initNotification:function(){Nigsys.notification||("undefined"!==typeof CommonCore&&CommonCore.isMobile||jQuery("body").append(this.getNotificationHTML()),Nigsys.notification=jQuery("#notification").notify({click:function(a,c){c.close()}}))},showNotificationError:function(a,
c,d,e,f,k){Nigsys.notification.html("");return Nigsys.notification.notify("create","notificationError",{title:a,text:c},{beforeopen:function(a,c){Nigsys.positionNotification(d);"function"===typeof e&&e(a,c)},open:function(a,c){"function"===typeof f&&f(a,c)},click:function(a,c){"function"===typeof k&&k(a,c)}})},showLoginError:function(a){a&&("undefined"===typeof isImajnetMode||isImajnetMode()?jQuery(Nigsys.loginNotification.element).show():Login.hideLoginLoading(),Nigsys.errorNotification=Nigsys.showNotificationError("",
a,"centerLoginError",function(a,d){var e=jQuery(".olControlImajnetPluginItemInactive").offset();e&&jQuery("#notification").offset(e)},null,function(a,d){d.close()}))},appendColorPicker:function(a,c){jQuery("#"+a).css("background-color",c).ColorPicker({color:c,onChange:function(c,e,f){jQuery("#"+a).css("background-color","#"+e);jQuery("#"+a).val("#"+e)}}).ColorPickerSetColor(c)},showLoading:function(a){a&&a.length&&(a.mask("\x26nbsp;"),a.find(".loadmask").height(a[0].scrollHeight))},hideLoading:function(a){a&&
a.length&&a.unmask()},initModalOverlay:function(a){Nigsys.modalOverlay&&Nigsys.modalOverlay.remove();jQuery(a).append(Nigsys.modalOverlayDiv);Nigsys.modalOverlay=jQuery("#modalOverlay")},initLoginContainers:function(){"undefined"!==typeof CommonCore&&CommonCore.isMobile?Nigsys.initModalOverlay("#content"):Nigsys.initModalOverlay("body");Nigsys.initLogoOverlay();Nigsys.notificationLoginContainer=jQuery("#notificationLoginContainer").notify({click:function(a,c){c.close()}})},getLoginContent:function(){return'\x3cdiv\x3e\x3cdiv class\x3d"imajnetLoginItem"\x3e\x3cdiv class\x3d"left imajnetLoginLeft"\x3e\x3clabel for\x3d"username"\x3e'+
jQuery.imajnet.login.username+':\x3c/label\x3e\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" name\x3d"username" id\x3d"username" class\x3d"loginInput" autocapitalize\x3d"none" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetLoginItem"\x3e\x3cdiv class\x3d"left imajnetLoginLeft"\x3e\x3clabel for\x3d"password"\x3e'+jQuery.imajnet.login.password+':\x3c/label\x3e\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"password" name\x3d"password" id\x3d"password" class\x3d"loginInput" autocapitalize\x3d"none" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3cdiv id\x3d"notificationLoginRememberMe" style\x3d"'+
("undefined"!==typeof CommonCore&&CommonCore.isMobile?" display: none;":"")+'"\x3e\x3cdiv class\x3d"left" style\x3d"height: 30px; line-height: 30px;"\x3e\x3cinput type\x3d"checkbox" name\x3d"remember-me" id\x3d"rememberMe" class\x3d"loginInput" style\x3d"margin-top: 0; padding: 0;"'+("undefined"!==typeof CommonCore&&CommonCore.isMobile?'checked\x3d"checked"':"")+' /\x3e\x3c/div\x3e\x3cdiv id\x3d"rememberMeLabel" class\x3d"left"\x3e'+jQuery.imajnet.login.rememberMe+'\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e'},
getLoginWithHTML:function(){return'\x3cdiv id\x3d"notificationLoginInnerContainer"\x3e\x3cdiv class\x3d"imajnetLoginTitle"\x3e\x3ch1\x3e'+jQuery.imajnet.login.title+"\x3c/h1\x3e\x3c/div\x3e\x3cdiv\x3e"+Nigsys.getLoginContent()+'\x3cdiv style\x3d"margin-top: 10px;"\x3e\x3cinput type\x3d"button" id\x3d"imajnetLoginButton" value\x3d"'+jQuery.imajnet.login.button+'" /\x3e\x3ca href\x3d"" id\x3d"imajnetLoginForgotPassword" onclick\x3d"ImajnetProtocol.forgotPassword();"\x3e'+jQuery.imajnet.login.forgotPassword.title+
'\x3c/a\x3e\x3ca href\x3d"" id\x3d"imajnetLoginRequestAccess" onclick\x3d"ImajnetProtocol.requestAccess();"\x3e'+jQuery.imajnet.login.requestAccess.title+'\x3c/a\x3e\x3cdiv class\x3d"clear"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e'},showImajnetLoading:function(){var a=Nigsys.getWindowSize();jQuery("body").append('\x3cdiv id\x3d"imajnetLoadingImageContainer"\x3e\x3cdiv class\x3d"imajnetLoadingImage" style\x3d"padding-top: '+(a.height/2-27)+'px;"\x3e\x3cimg src\x3d"'+ImajnetUI.getImagesPath()+
'img/loading.gif" id\x3d"imajnetLoadingImage" class\x3d"imajnetLoadingImage" width\x3d"54" height\x3d"55" /\x3e\x3c/div\x3e\x3c/div\x3e')},hideImajnetLoading:function(){jQuery("#imajnetLoadingImageContainer").remove()},transform:function(a,c,d,e){a=CommonCore.projHash[a];c=CommonCore.projHash[c];d=new Proj4js.Point(d+","+e);return Proj4js.transform(a,c,d)},transformBetweenProjections:function(a,c,d,e,f,k){d=Nigsys.transform(a,c,d,e);a=Nigsys.transform(a,c,f,k);return{left:d.x,bottom:d.y,right:a.x,
top:a.y}},extentToPolygon:function(a){return new ol.geom.Polygon([[[a[0],a[1]],[a[2],a[1]],[a[2],a[3]],[a[0],a[3]],[a[0],a[1]]]])},positionLoginNotification:function(){var a=Nigsys.loginNotificationWidth;jQuery("#notificationLoginContainer").width(a);Nigsys.positionLoginNotificationCenter(a)},showLoginNotification:function(a){Nigsys.loginNotification&&jQuery(Nigsys.loginNotification.element).is(":visible")||(Nigsys.initLoginContainers(),"undefined"!==typeof isImajnetMode&&!isImajnetMode()&&Nigsys.logoOverlay&&
Nigsys.logoOverlay.show(),"undefined"!==typeof CommonCore&&CommonCore.isMobile&&Nigsys.initModalOverlay("#content"),Nigsys.modalOverlay.show(),Nigsys.loginNotification?jQuery(Nigsys.loginNotification.element).show():Nigsys.loginNotification=Nigsys.notificationLoginContainer.notify("create","notificationLogin",{text:a},{expires:!1,beforeopen:function(a,d){Nigsys.positionLoginNotification()},open:function(a,d){try{jQuery("#rememberMe").checkboxradio().checkboxradio("refresh")}catch(f){}var e=jQuery("#imajnetLoginButton");
"undefined"===typeof isImajnetMode?(Nigsys.bindClickEvent(e,ImajnetProtocol.doLogin),Nigsys.bindEnterEvent(ImajnetProtocol.doLogin)):isImajnetMode()?Nigsys.bindClickEvent(e,ImajnetProtocol.doLogin):(Nigsys.bindClickEvent(e,Login.doLogin),Nigsys.bindEnterEvent(Login.doLogin),"undefined"!==typeof CommonCore&&CommonCore.isMobile&&e.button().button("refresh"))},click:function(a,d){return!1}}))},getPinchCenter:function(a,c){var d={x:0,y:0};d.x=a.x<c.x?a.x+(c.x-a.x)/2:c.x+(a.x-c.x)/2;d.y=a.y<c.y?a.y+(c.y-
a.y)/2:c.y+(a.y-c.y)/2;return d},isTouchDevice:function(){return"ontouchstart"in window},disableEventPropagation:function(a){a&&(a.stopPropagation?a.stopPropagation():window.event&&(window.event.cancelBubble=!0))},disableEventPropagationFull:function(a){if(a){if(a.stopPropagation)try{a.stopPropagation()}catch(c){}if(a.stopImmediatePropagation)try{a.stopImmediatePropagation()}catch(c){}if(a.preventDefault)try{a.preventDefault()}catch(c){}if(window.event)try{window.event.cancelBubble=!0}catch(c){}}},
radiansToDegrees:function(a){return 180*a/Math.PI},getRad:function(a){return a*Math.PI/180},distanceBetweenPoints:function(a,c){if(a.lat==c.lat&&a.lon==c.lon)return 0;for(var d=Object({a:6378137,b:6356752.3142,f:.0033528106647474805}),e=d.a,f=d.b,d=d.f,k=this.getRad(c.lon-a.lon),h=Math.atan((1-d)*Math.tan(this.getRad(a.lat))),l=Math.atan((1-d)*Math.tan(this.getRad(c.lat))),n=Math.sin(h),h=Math.cos(h),t=Math.sin(l),l=Math.cos(l),q=k,u=2*Math.PI,p=20;1E-12<Math.abs(q-u)&&0<--p;){var m=Math.sin(q),v=
Math.cos(q),w=Math.sqrt(l*m*l*m+(h*t-n*l*v)*(h*t-n*l*v));if(0==w)return 0;var v=n*t+h*l*v,A=Math.atan2(w,v),y=Math.asin(h*l*m/w),x=Math.cos(y)*Math.cos(y),m=v-2*n*t/x,z=d/16*x*(4+d*(4-3*x)),u=q,q=k+(1-z)*d*Math.sin(y)*(A+z*w*(m+z*v*(-1+2*m*m)))}if(0==p)return NaN;e=x*(e*e-f*f)/(f*f);d=e/1024*(256+e*(-128+e*(74-47*e)));return 1E3*((f*(1+e/16384*(4096+e*(-768+e*(320-175*e))))*(A-d*w*(m+d/4*(v*(-1+2*m*m)-d/6*m*(-3+4*w*w)*(-3+4*m*m))))).toFixed(3)/1E3)},getDistanceFromLatLonInM:function(a,c){var d=Nigsys.degreeToRadians(Math.abs(c.lat-
a.lat)),e=Nigsys.degreeToRadians(Math.abs(c.lon-a.lon)),d=Math.sin(d/2)*Math.sin(d/2)+Math.cos(Nigsys.degreeToRadians(a.lat))*Math.cos(Nigsys.degreeToRadians(c.lat))*Math.sin(e/2)*Math.sin(e/2);return 12742E3*Math.atan2(Math.sqrt(d),Math.sqrt(1-d))},distanceBetweenPointsOL:function(a,c){return a.lat==c.lat&&a.lon==c.lon?0:Nigsys.distanceTo({x:a.lon,y:a.lat},{x:c.lon,y:c.lat})},getUnitText:function(a,c){return" "+(c?jQuery.imajnet.units[a+"_short"]?jQuery.imajnet.units[a+"_short"]:jQuery.imajnet.units[a].substring(0,
1):jQuery.imajnet.units[a])},getClosestPoint:function(a,c,d){var e=Nigsys.distanceBetweenPoints(c,a);a=Nigsys.distanceBetweenPoints(d,a);return e<a?c:d},isWindows:function(){return-1!=navigator.appVersion.indexOf("Win")},isIOS:function(){return/iPad|iPhone|iPod/.test(navigator.platform)},browserIsChrome:function(){return-1<navigator.userAgent.toLowerCase().indexOf("chrome")},browserIsIE:function(){return"Microsoft Internet Explorer"==navigator.appName||navigator.userAgent.match(/Trident/)||navigator.userAgent.match(/rv:11/)||
"undefined"!==typeof jQuery.browser&&1==jQuery.browser.msie?!0:!1},browserIsIE7:function(){return-1!==navigator.appVersion.indexOf("MSIE 7.")},browserIsIE8:function(){return-1!==navigator.appVersion.indexOf("MSIE 8.")},browserIsIE9:function(){return-1!==navigator.appVersion.indexOf("MSIE 9.")},browserIsWebkit:function(){return"WebkitAppearance"in document.documentElement.style},browserIsMozilla:function(){return null!=window.mozInnerScreenX},browserIsOpera:function(){return navigator.userAgent.match(/Opera|OPR\//)?
!0:!1},browserIsEdge:function(){return-1<window.navigator.userAgent.indexOf("Edge")},browserIsSafari:function(){var a=navigator.userAgent.toLowerCase();if(-1!=a.indexOf("safari"))return-1<a.indexOf("chrome")?!1:!0},isPositionMode:function(){return"undefined"!==typeof ImajnetUI&&"imajnetPosition"==ImajnetUI.activeControlButton},isMeasurementMode:function(){return"undefined"!==typeof ImajnetUI&&"imajnetMeasurement"==ImajnetUI.activeControlButton},isPolyligneMode:function(){return"undefined"!==typeof ImajnetUI&&
"imajnetPolyligne"==ImajnetUI.activeControlButton},cloneObject:function(a){var c={};0<=a.length&&(c=[]);return jQuery.extend(!0,c,a)},getEventRelativeCoordinates:function(a){return a.xy?{x:a.xy.x,y:a.xy.y}:a.layerX&&a.layerY?{x:a.layerX,y:a.layerY}:a.x&&a.y?{x:a.x,y:a.y}:{x:0,y:0}},getSVGChildElementSize:function(a){var c=a[0].getAttribute("width");a=a[0].getAttribute("height");return c&&a?{width:parseInt(c),height:parseInt(a)}:{width:LRSSchematic.featurePointSize,height:LRSSchematic.featurePointSize}},
positionExistingElement:function(a,c,d,e,f){var k=10;f&&(k=-10);f=!1;var h=a.clientY?a.clientY:a.target?a.target.offsetTop:0,l=0,l=("undefined"===typeof isImajnetMode||isImajnetMode()||"undefined"!==typeof MapMethodsCore&&MapMethodsCore.layoutData)&&("map"==d||d.selector&&-1!==d.selector.indexOf("LRSSchematicItemLayerData"))?a.offsetX:a.clientX?a.clientX:a.target?a.target.offsetLeft:0;if("map"!=d){var n=null;"string"===typeof d?n="popupImajnetControlsLayer"==d?jQuery("#imajnetImageLayer"):jQuery("#"+
d):(0===d.prop("id").indexOf("LRSSchematicId")&&(f=!0,"portrait"==LRSSchematic.orientation?(h=a.offsetY+LRSSchematic.titleHeight+LRSSchematic.titleHeightPaddingTop,l=a.offsetX):h=a.offsetY),n=d);f||(h-=n.offset().top,l-=n.offset().left)}a=h-k;var t=k,q=k;c&&(a=c.position(),t=c.width(),q=c.height(),t&&q||(q=Nigsys.getSVGChildElementSize(c),t=q.width,q=q.height),a=a.top);var h=h+q,l=l+t,u=0,p=0,m=null;if("string"===typeof d)m=jQuery("#"+d);else{if(f){isLRSItem=!0;p=jQuery(".LRSSchematicItemLayerData");
for(u=m=0;u<p.length&&d.prop("id")!=p[u].id;u++)m++;"landscape"==LRSSchematic.orientation?(u=d.parent().parent().parent().width(),p=ImajnetLRSGUIWidth*p.length,h+=m*ImajnetLRSGUIWidth):(u=ImajnetLRSGUIWidth*p.length,p=d.parent().parent().parent().height(),l+=m*ImajnetLRSGUIWidth)}m=d}d=(u?u:m.width())-k;u=(p?p:m.height())-k;p=e.width();m=e.height();f?(h+m>u?h="landscape"==LRSSchematic.orientation?LRSSchematic.container.scrollTop():h-(m+q+3*k):h+m>LRSSchematic.container.scrollTop()+LRSSchematic.container.height()&&
(h=LRSSchematic.container.scrollTop()),l+p>d||l?l="portrait"==LRSSchematic.orientation?LRSSchematic.container.scrollLeft():l-p-t-3*k:p>LRSSchematic.container.scrollLeft()+LRSSchematic.container.width()&&(l=LRSSchematic.container.scrollLeft()),e.css({top:0<h?h:0,left:0<l?l:0})):(u<h+m&&(h-=m+q+3*k),d<l+p&&(l=l-p-t-3*k,c&&c.position().left>l&&l+n.offset().left+p>c.position().left&&(l=c.position().left-n.offset().left-p-t)),h>a&&h<a+q&&(h=a-m-2*k,0>h&&(h=a+q+k)),0>h&&(h=0),e.css("max-height",u-h),e.css("top",
0<h?h:0),e.css("max-width",d-l),e.css("left",0<l?l:0),Nigsys.browserIsIE8()||Nigsys.browserIsIE7()||e.corner())},addElement:function(a,c,d,e){Nigsys.positionExistingElement(a,c,d,jQuery(e).appendTo("#"+d))},formatServerDate:function(a){a=a.split("-");return a[0]+" "+Nigsys.getMonthFromNumber(a[1])+" "+a[2]},stringContains:function(a,c){return"string"==typeof a&&-1!==a.indexOf(c)},getAllCookiesArray:function(){var a={},c=0;if(document.cookie&&""!=document.cookie)for(var d=document.cookie.split(";"),
e=0;e<d.length;e++){var f=d[e].split("\x3d");f[0]=f[0].replace(/^ /,"");a[decodeURIComponent(f[0])]=decodeURIComponent(f[1]);c++}return{cookies:a,length:c}},deleteCookie:function(a){jQuery.cookie(a,null)},deleteCookies:function(a){var c="";if(c="undefined"!==typeof ImajnetUser?ImajnetUser.getUsername():CommonCore.userInfo?CommonCore.userInfo.username:null){var d=Nigsys.getAllCookiesArray();if(d&&!(11>d.length))for(var e in d.cookies)if(0===e.indexOf(a+"_")&&e!=a+"_"+c&&(Nigsys.deleteCookie(e),d.length--,
11>d.length))break}},getUserCookies:function(a,c){a=ImajnetUser.getUsername();if(!a)return null;var d=jQuery.cookie(c+"_"+a);return d?JSON.parse(d):null},getCookie:function(a,c){var d=ImajnetUser.getUsername();if(!d)return null;if("undefined"!==typeof Storage)return ApplicationStorage.readObject(c,d,a);d=jQuery.cookie(a+"_"+d);if(!d)return null;var d=JSON.parse(d),e;for(e in d)if(e==c)return d[e];return null},setCookie:function(a,c,d){var e=ImajnetUser.getUsername();if(e)if("undefined"!==typeof Storage)ApplicationStorage.writeObject(c,
d,e,a);else{var f=Nigsys.getUserCookies(e,a);f||(f={});f[c]=d;jQuery.cookie(a+"_"+e,JSON.stringify(f),{expires:30})}},removeCookie:function(a,c){var d=ImajnetUser.getUsername();d&&window.localStorage.removeItem(d+"_"+a+"_"+c)},setIPLocationCookie:function(a,c){if(c){var d=Nigsys.getCookie("IMAJNET","IP_LOCATIONS");d||(d={});d[a]=c;Nigsys.setCookie("IMAJNET","IP_LOCATIONS",d)}},getCurrentYear:function(){return(new Date).getFullYear()},getViewportSize:function(){var a,c;"undefined"!=typeof window.innerWidth?
(a=window.innerWidth,c=window.innerHeight):"undefined"!=typeof document.documentElement&&"undefined"!=typeof document.documentElement.clientWidth&&0!=document.documentElement.clientWidth?(a=document.documentElement.clientWidth,c=document.documentElement.clientHeight):(a=document.getElementsByTagName("body")[0].clientWidth,c=document.getElementsByTagName("body")[0].clientHeight);return{w:a,h:c}},getWindowSize:function(){var a=0,c=0;1!=(window.devicePixelRatio||1)?(c=Nigsys.getViewportSize(),a=c.w,
c=c.h):window.innerWidth?(a=window.innerWidth,c=window.innerHeight):0!=document.documentElement.clientWidth?(a=document.documentElement.clientWidth,c=document.documentElement.clientHeight):(a=document.body.clientWidth,c=document.body.clientHeight);return{width:a,height:c}},getUserPositionError:function(){Nigsys.showLoading(ImajnetUI.imageContainer);ImajnetZoom.left=-1;ImajnetMap.POIArray&&ImajnetMap.POIArray[0]?(ImajnetAPI.setImajnetImage({position:ImajnetMap.POIArray[0].position}),ImajnetPlugin.centerMapToPosition(ImajnetMap.POIArray[0].position)):
ImajnetUrl.goToLocation("43.59936957234748,1.43908554574678")},goToClosestPOI:function(a){if(!ImajnetMap.POIArray)return!1;for(var c=-1,d=-1,e=0;e<ImajnetMap.POIArray.length;e++){var f=Nigsys.distanceBetweenPoints(a,ImajnetMap.POIArray[e].position);if(f<c||-1==c)c=f,d=e}if(-1!=d)return ImajnetZoom.left=-1,Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetAPI.setImajnetImage({position:ImajnetMap.POIArray[d].position}),ImajnetPlugin.centerMapToPosition(ImajnetMap.POIArray[d].position),!0;Nigsys.getUserPositionError();
return!1},getUserPositionSuccess:function(a,c){var d=JSON.parse(a.responseText),e=null;d.lon&&(e=Object({lon:d.lon,lat:d.lat}),Nigsys.setIPLocationCookie(c,e));return e?Nigsys.goToClosestPOI(e):(Nigsys.getUserPositionError(),!1)},getUserPositionAjaxRequest:function(a){var c=!1,d=Imajnet.serverUrl.replace(/\/service$/,"");jQuery.ajax({type:"GET",url:d+"/service/api/iplookup?ip\x3d"+a,timeout:5E3,async:!1,beforeSend:function(a){a.setRequestHeader("Accept","application/json")},success:function(d,f,k){c=
Nigsys.getUserPositionSuccess(k,a)},error:function(){Nigsys.setIPLocationCookie(a,null)}});return c},getUserPosition:function(){"undefined"===typeof remoteAddress&&(remoteAddress="client");var a=remoteAddress.split(","),c=Nigsys.getCookie("IMAJNET","IP_LOCATIONS");if(c)for(var d=a.length-1;0<=d;d--)if(void 0!==c[a[d]]){if(c[a[d]]&&Nigsys.goToClosestPOI(c[a[d]]))return;a.splice(d,1)}for(d=a.length-1;0<=d;d--)if(Nigsys.getUserPositionAjaxRequest(a[d]))return;Nigsys.getUserPositionError()},getRadioValue:function(a){return jQuery("input:radio[name\x3d"+
a+"]:checked").val()},setRadioValue:function(a,c){for(var d=jQuery("input:radio[name\x3d"+a+"]"),e=0;e<d.length;e++)d[e].checked=d[e].value==c,CommonCore.updateCustomCheckbox(jQuery(d[e]))},positionNotificationInCenter:function(a,c,d,e){d=Nigsys.getWindowSize();e.width()>d.width-10&&(a=d.width-10,e.width(a));a||(a=e.width());c||(c=e.height());a=parseInt((d.width-a)/2);5>a&&(a=5);c=parseInt((d.height-c)/2);5>c&&(c=5);e.offset({left:a,top:c})},positionNotificationCenter:function(a,c){Nigsys.positionNotificationInCenter(a,
c,jQuery(document),jQuery("#notification"))},positionLoginNotificationErrorCenter:function(a,c){Nigsys.positionNotificationInCenter(a,c,jQuery(document),jQuery("#notification"))},positionLoginNotificationCenter:function(a){if("undefined"!==typeof CommonCore&&CommonCore.isMobile){var c=Nigsys.getWindowSize();a=(c.width-a)/2;5>a&&(a=5);c=(c.height-206)/2;5>c&&(c=5);jQuery("#notificationLoginContainer").offset({left:a,top:c})}else Nigsys.positionNotificationInCenter(a,206,jQuery(document),jQuery("#notificationLoginContainer"))},
positionNotification:function(a){if(a&&"center"!=a)if("centerLoginError"==a)if("undefined"!==typeof CommonCore&&CommonCore.isMobile){a=jQuery("#notification");var c=Nigsys.getWindowSize();a.offset({top:420,left:(c.width-a.width())/2})}else Nigsys.positionLoginNotificationErrorCenter(null,-220);else"rightBottom"==a&&(a=jQuery("#notification"),c=Nigsys.getWindowSize(),a.offset({top:c.height-a.height()-10,left:c.width-a.width()-10}));else Nigsys.positionNotificationCenter()},showConfirmDialog:function(a,
c,d,e,f){var k=jQuery.Deferred();"undefined"!==typeof CommonCore&&CommonCore.isMobile&&Nigsys.initModalOverlay("#content");Nigsys.modalOverlay.show();Nigsys.notification.html("");jQuery("#notification").show();Nigsys.confirmDialog=Nigsys.notification.notify("create","notificationConfirm",{text:a,type:c},{expires:!1,beforeopen:function(a,c){Nigsys.positionNotification(d)},click:function(a,c){return!1},close:function(a,c){-1!==Nigsys.notification.html().indexOf("Nigsys.closeConfirmDialog")&&Nigsys.notification.height()||
Nigsys.modalOverlay.hide()}});jQuery("#confirmYes_"+c).bind("click",function(a){"function"===typeof e&&e();Nigsys.confirmDialog.close();k.resolve()});jQuery("#confirmNo_"+c).bind("click",function(a){"function"===typeof f&&f();Nigsys.confirmDialog.close();k.reject()});return k.promise()},showNotificationOkConfirm:function(a,c,d,e,f,k,h){"undefined"!==typeof CommonCore&&CommonCore.isMobile&&Nigsys.initModalOverlay("#content");Nigsys.modalOverlay.show();Nigsys.notification.html("");Nigsys.confirmDialog=
Nigsys.notification.notify("create","notificationOkConfirm",{title:a,text:c,type:d},{expires:!1,beforeopen:function(a,c){jQuery("#notification").width(310);Nigsys.positionNotification(e)},click:function(a,c){return!1},close:function(a,c){Nigsys.modalOverlay.hide()}});jQuery("#confirmOk_"+d).bind("click",function(a){h()})},closeConfirmDialog:function(){try{Nigsys.confirmDialog.close(),Nigsys.modalOverlay.hide()}catch(a){}},showSessionExpiredNotification:function(a,c,d,e,f){Nigsys.sessionExpired||("undefined"!==
typeof CommonCore&&CommonCore.isMobile&&Nigsys.initModalOverlay("#content"),Nigsys.modalOverlay.show(),Nigsys.notification.html(""),Nigsys.sessionExpiredNotification=Nigsys.notification.notify("create","notificationSessionExpired",{text:a,type:c},{expires:!1,beforeopen:function(a,c){jQuery("#notification").width(310).show();Nigsys.positionNotification(d)},click:function(a,c){return!1}}),jQuery("#confirmYes_"+c).bind("click",function(a){e()}))},reloadAfterSessionExpires:function(){location.reload()},
onIddle:function(a){if(map)try{map.destroy()}catch(c){}Nigsys.showSessionExpiredNotification(jQuery.imajnet.security.sessionExpired,"sessionExpired","center",Nigsys.reloadAfterSessionExpires);Nigsys.sessionExpired=!0;return!1},addIddleTimeout:function(){try{jQuery.idleTimeout(document,null,{idleAfter:Nigsys.sessionTimeout,titleMessage:"",onIdle:Nigsys.onIddle})}catch(a){}},positionExistingElementBackEnd:function(a,c,d){var e=a.clientY+20;a=a.clientX+20;var f=c.width()-20;c=c.height()-20;var k=d.width(),
h=d.height();c<e+h&&(e=e-h-60);f<a+k&&(a=a-k-60);d.css("max-height",c);d.css("top",0<e?e:0);d.css("max-width",f);d.css("left",0<a?a:0);Nigsys.browserIsIE8()||Nigsys.browserIsIE7()||d.corner()},getMonthDigit:function(a){switch(a.toLowerCase()){case jQuery.imajnet.dateTime.month1.toLowerCase():return"01";case jQuery.imajnet.dateTime.month2.toLowerCase():return"02";case jQuery.imajnet.dateTime.month3.toLowerCase():return"03";case jQuery.imajnet.dateTime.month4.toLowerCase():return"04";case jQuery.imajnet.dateTime.month5.toLowerCase():return"05";
case jQuery.imajnet.dateTime.month6.toLowerCase():return"06";case jQuery.imajnet.dateTime.month7.toLowerCase():return"07";case jQuery.imajnet.dateTime.month8.toLowerCase():return"08";case jQuery.imajnet.dateTime.month9.toLowerCase():return"09";case jQuery.imajnet.dateTime.month10.toLowerCase():return"10";case jQuery.imajnet.dateTime.month11.toLowerCase():return"11";case jQuery.imajnet.dateTime.month12.toLowerCase():return"12"}},addYearsToJavaFormattedDate:function(a,c){if(!a)return"";var d=a.indexOf("-");
return(parseInt(a.substring(0,d))+parseInt(c)).toString()+a.substring(d,a.length)},removeMilisecondsFromDateTime:function(a){var c=a.indexOf(".");return-1!==c?a.substring(0,c)+Nigsys.dateZ:a},formatGeoserverDateTimeToJavascriptObject:function(a,c,d){return"xsd:date"==c?Nigsys.formatGeoserverDateToJavascriptObject(a,d):"xsd:dateTime"==c?Nigsys.formatGeoserverDateAndTimeToJavascriptObject(a,d):a},formatGeoserverDateAndTimeToJavascriptObject:function(a,c){if(!a)return"";var d=a.split(Nigsys.dateT);if(!d[1])return Nigsys.formatGeoserverDateToJavascriptObject(a,
c);var e=d[0].split("-"),d=d[1].split(":");return new Date(e[c?2:0],parseInt(e[1])-1,e[c?0:2],d[0],d[1],Nigsys.removeMilisecondsFromDateTime(d[2]).replace(Nigsys.dateZ,""))},formatGeoserverDateToJavascriptObject:function(a,c){if(!a)return"";a.replace(Nigsys.dateZ,"");var d=geoserverDate.split(Nigsys.dateT)[0].split("-");return new Date(d[c?2:0],d[1],d[c?0:2])},formatGeoserverDateTime:function(a,c,d){return"xsd:date"==c?Nigsys.formatGeoserverDate(a):"xsd:dateTime"==c?Nigsys.formatGeoserverDateAndTime(a,
d):a},formatGeoserverDateAndTime:function(a,c){if(!a)return"";if(-1===a.indexOf(Nigsys.dateT))return Nigsys.formatGeoserverDate(a);var d=a.split(Nigsys.dateT)[0].split("-"),e=a.split(Nigsys.dateT);if(!e[1])return a;e=e[1].split(":");return c?(d=Nigsys.getJavascriptDateObject(d[0],d[1],d[2],e[0],e[1]),d=new Date(d.getTime()-6E4*d.getTimezoneOffset()),d.getFullYear()+" "+Nigsys.getMonthFromNumber(d.getMonth()+1)+" "+d.getDate()+" "+d.getHours()+Nigsys.timeFormat.charAt(2)+Nigsys.addZero(d.getMinutes())):
d[2]+" "+Nigsys.getMonthFromNumber(d[1])+" "+d[0]+" "+e[0]+Nigsys.timeFormat.charAt(2)+e[1]},formatGeoserverDate:function(a){if(!a)return"";if(-1===a.indexOf("-"))return a;a=a.replace(Nigsys.dateZ,"");a=a.split(Nigsys.dateT)[0].split("-");return a[2]+" "+Nigsys.getMonthFromNumber(a[1])+" "+a[0]},getJavascriptDateObject:function(a,c,d,e,f,k,h){return new Date(parseInt(a),parseInt(c)-1,parseInt(d),e?parseInt(e):0,f?parseInt(f):0,k?parseInt(k):0,h?parseInt(h):0)},getJavascriptDateObjectFromUserFormattedString:function(a){a=
a.split(" ");var c=a[3].split(":");return Nigsys.getJavascriptDateObject(a[2],Nigsys.getMonthDigit(a[1]),a[0],c[0],c[1],0)},formatJavascriptDateToFormat:function(a,c){if(!a)return"";if("undefined"!==typeof CommonCore&&CommonCore.isMobile){var d=a.split("-");return d[2]+c+d[1]+c+d[0]}var d=a.split(" "),e=Nigsys.getMonthDigit(d[1]);return d[0]+c+e+c+d[2]},formatJavascriptDateToFormatAndInverse:function(a,c){if(!a)return"";if("undefined"!==typeof CommonCore&&CommonCore.isMobile){var d=a.split("-");return d[2]+
c+d[1]+c+d[0]}var d=a.split(" "),e=Nigsys.getMonthDigit(d[1]);return d[2]+c+e+c+d[0]},formatJavascriptDateToJava:function(a){if(!a)return"";a=a.split(" ");var c=Nigsys.getMonthDigit(a[1]);return a[2]+"-"+c+"-"+Nigsys.addZero(a[0])+Nigsys.dateZ},formatJavascriptDateAndTimeToJava:function(a){if(!a)return"";a=a.split(" ");var c=a[1];isNaN(parseInt(c))&&(c=Nigsys.getMonthDigit(c));var d=":";Nigsys.timeFormat&&(d=Nigsys.timeFormat.charAt(2));var e=["00","00","00"];a[3]&&(e=a[3].split(d));return a[2]+"-"+
c+"-"+Nigsys.addZero(a[0])+Nigsys.dateT+e[0]+":"+e[1]+":"+(e[2]?e[2]:"00")+Nigsys.dateZ},formatJavascriptDateObjectToJava:function(a){return a?a.getFullYear()+"-"+Nigsys.addZero(a.getMonth()+1)+"-"+Nigsys.addZero(a.getDate())+Nigsys.dateT+Nigsys.addZero(a.getHours())+":"+Nigsys.addZero(a.getMinutes())+":"+Nigsys.addZero(a.getSeconds())+Nigsys.dateZ:""},addZero:function(a){return 10>a?"0"+parseInt(a):a},getDateObject:function(a){a=a.split("-");return new Date(parseInt(a[0],10),parseInt(a[1],10)-1,
parseInt(a[2],10))},getDateNormalObject:function(a,c){var d=Object({day:0,month:0,year:0,time:0});try{var e=a.split(c),d=Object({year:parseInt(e[0]),month:parseInt(e[1]),day:parseInt(e[2]),time:e[3]})}catch(f){}return d},valueIsValidDateTimepicker:function(a){var c=!1;try{var d=a.split(" "),e=parseInt(d[0]),f=parseInt(Nigsys.getMonthDigit(d[1])),k=parseInt(d[2]),h=d[3];a=!0;if(h){var l=h.split(Nigsys.timeFormat.charAt(2)),n=parseInt(l[0]),t=parseInt(l[1]);a=0<=n&&24>=n&&0<=t&&59>=t}c=1<=e&&31>=e&&
1<=f&&12>=f&&0<=k&&a}catch(q){}return c},endDateIsBeforeStartDate:function(a,c){var d=!1;try{var e=Nigsys.getDateNormalObject(a,"-"),f=Nigsys.getDateNormalObject(c,"-"),d=f.year<e.year||f.year==e.year&&(f.month<e.month||f.month==e.month&&f.day<e.day)}catch(k){}return d},getFormInput:function(a,c){return'\x3cinput type\x3d"hidden" name\x3d"'+a+'" value\x3d"'+c+'" /\x3e'},getCurrentDateFormattedddMMyyyy:function(a){var c=new Date;return Nigsys.addZero(c.getDate())+a+Nigsys.addZero(c.getMonth()+1)+a+
c.getFullYear()},getCurrentDateFormattedForInput:function(){var a=new Date;return a.getDate()+" "+Nigsys.getMonthFromNumber((a.getMonth()+1).toString())+" "+a.getFullYear()},getCurrentDateTimeFormattedForInput:function(){var a=new Date;return a.getDate()+" "+Nigsys.getMonthFromNumber((a.getMonth()+1).toString())+" "+a.getFullYear()+" "+Nigsys.addZero(a.getHours())+":"+Nigsys.addZero(a.getMinutes())+":"+Nigsys.addZero(a.getSeconds())},getGeometryCQlFilterString:function(a,c){var d=new ol.format.WKT;
return a+" ("+CommonCore.geometryPropertyName+", "+d.writeGeometry(c)+")"},getGeometryCQlDWithinFilterString:function(a,c,d){var e=new ol.format.WKT;return a+" ("+CommonCore.geometryPropertyName+", "+e.writeGeometry(c)+", "+d+", kilometers)"},formattedDateToInput:function(a){if(!a)return"";a=a.split(" ");var c=Nigsys.getMonthDigit(a[1]);return a[2]+"-"+c+"-"+a[0]},appendDateTimePickerToElement:function(a,c,d,e,f,k,h){"xsd:dateTime"!=c||"equalTo"!=jQuery("#"+h+"_LimitConditionOperator_"+k).val()&&
"\x3d\x3d"!=jQuery("#"+h+"_LimitConditionOperator_"+k).val()&&"notEqualTo"!=jQuery("#"+h+"_LimitConditionOperator_"+k).val()&&"!\x3d"!=jQuery("#"+h+"_LimitConditionOperator_"+k).val()||(c="xsd:date");a=jQuery(a);a.length&&(k=a.prop("id"),-1===k.indexOf("_created")&&-1===k.indexOf("_modified")&&(!d&&a.val()&&(d=a.val()),"xsd:date"==c||"xsd:dateTime"==c?"undefined"===typeof CommonCore||!CommonCore.isMobile||"xsd:date"!=c&&"xsd:dateTime"!=c?(f=jQuery.extend(Object({dateFormat:"dd MM yy",timeFormat:Nigsys.timeFormat,
showOn:"focus",useLocalTimezone:!0,constrainInputType:!0,autoOpen:!1,changeMonth:!0,changeYear:!0,monthNames:[jQuery.imajnet.dateTime.month1,jQuery.imajnet.dateTime.month2,jQuery.imajnet.dateTime.month3,jQuery.imajnet.dateTime.month4,jQuery.imajnet.dateTime.month5,jQuery.imajnet.dateTime.month6,jQuery.imajnet.dateTime.month7,jQuery.imajnet.dateTime.month8,jQuery.imajnet.dateTime.month9,jQuery.imajnet.dateTime.month10,jQuery.imajnet.dateTime.month11,jQuery.imajnet.dateTime.month12],dayNamesMin:[jQuery.imajnet.dateTime.day1Min,
jQuery.imajnet.dateTime.day2Min,jQuery.imajnet.dateTime.day3Min,jQuery.imajnet.dateTime.day4Min,jQuery.imajnet.dateTime.day5Min,jQuery.imajnet.dateTime.day6Min,jQuery.imajnet.dateTime.day7Min],timeText:jQuery.imajnet.dateTime.timeText,hourText:jQuery.imajnet.dateTime.hourText,minuteText:jQuery.imajnet.dateTime.minuteText,currentText:jQuery.imajnet.dateTime.currentText,closeText:jQuery.imajnet.dateTime.closeText}),f),"xsd:date"==c&&(f.showTimepicker=!1),a.datetimepicker("destroy"),a.datetimepicker(f),
e||(d=Nigsys.formatGeoserverDateTime(d,c,!0)),Nigsys.valueIsValidDateTimepicker(d)?a.datetimepicker("setDate",d):a.val(""),a.keypress(function(a){return!1}),a.click(function(a){jQuery(a.target).datepicker("show")})):(d&&(d=d.replace(Nigsys.dateZ,"")),e=a.attr("onchange"),a.parent().html('\x3cinput type\x3d"date" data-clear-btn\x3d"false" id\x3d"'+k+'" class\x3d"'+("xsd:date"==c?"datePicker":"")+("xsd:dateTime"==c?"dateTimePicker":"")+'" size\x3d"39" value\x3d"'+Nigsys.formattedDateToInput(d)+'"'+
(e?' onchange\x3d"'+e+'"':"")+"\x3e")):(a.unbind("keypress"),a.unbind("click"),"undefined"!==typeof CommonCore&&CommonCore.isMobile||a.datetimepicker("destroy"))))},getMonthsSelect:function(a){for(var c="",d=1;13>d;d++)c+='\x3coption value\x3d"'+Nigsys.addZero(d)+'"'+(d==a?"selected":"")+"\x3e"+d+"\x3c/option\x3e";return c},formatImajnetImageDate:function(a){if(!a)return"";a=a.split("-");return a[2]+" "+Nigsys.getMonthFromNumber(a[1])+" "+a[0]},getMonthFromNumber:function(a){switch(String(a)){case "1":case "01":return jQuery.imajnet.dateTime.month1;
case "2":case "02":return jQuery.imajnet.dateTime.month2;case "3":case "03":return jQuery.imajnet.dateTime.month3;case "4":case "04":return jQuery.imajnet.dateTime.month4;case "5":case "05":return jQuery.imajnet.dateTime.month5;case "6":case "06":return jQuery.imajnet.dateTime.month6;case "7":case "07":return jQuery.imajnet.dateTime.month7;case "8":case "08":return jQuery.imajnet.dateTime.month8;case "9":case "09":return jQuery.imajnet.dateTime.month9;case "10":return jQuery.imajnet.dateTime.month10;
case "11":return jQuery.imajnet.dateTime.month11;case "12":return jQuery.imajnet.dateTime.month12}},distanceTo:function(a,c){return Math.sqrt(Math.pow(c.x-a.x,2)+Math.pow(c.y-a.y,2))},rotatePoint:function(a,c,d){a*=Math.PI/180;var e=this.distanceTo(c,d);a+=Math.atan2(d.y-c.y,d.x-c.x);d.x=c.x+e*Math.cos(a);d.y=c.y+e*Math.sin(a)},transformImajnetOrientationPoint:function(a,c,d){return Proj4js.transform(c,d,a)},getEmptyCombobox:function(){return{val:function(){return""}}},disableCombobox:function(a){a.parent().find("input.ui-autocomplete-input").autocomplete("option",
"disabled",!0).prop("disabled",!0);a.parent().find("a.ui-button").button("disable")},getComboboxInputContainer:function(a){a=a.parent();if(!a||!a[0]||!a[0].children)return Nigsys.getEmptyCombobox();for(var c=0;c<a[0].children.length;c++)if(a[0].children[c].children[0]&&-1!==a[0].children[c].children[0].className.indexOf("ui-combobox-input"))return jQuery(a[0].children[c].children[0]);return Nigsys.getEmptyCombobox()},setComboboxInputValue:function(a,c){var d=Nigsys.getComboboxInputContainer(a);d&&
d.val(c)},refreshComboboxContainer:function(a,c){var d=Nigsys.getComboboxInputContainer(a);d&&d.val(c||0==c?c:a.find("option:selected").text())},getComboboxValue:function(a){var c=Nigsys.getComboboxInputContainer(a);return c&&c[0]?c.hasClass("ui-combobox-input-nopermisive")?a.val():c.val():""},changeComboboxDisabledState:function(a,c){c?(a.parent().find("input.ui-autocomplete-input").autocomplete("option","disabled",!0).prop("disabled",!0),a.parent().find("a.ui-button").button("disable")):(a.parent().find("input.ui-autocomplete-input").autocomplete("option",
"disabled",!1).prop("disabled",!1),a.parent().find("a.ui-button").button("enable"))},bindComboboxToSelect:function(a,c,d){a.combobox({permisive:d&&d.permisive?!0:!1,selected:function(a,f){"function"===typeof c&&(d.selectedValue=f.item.value,c(a,d))}})},bindMultipleSelectToSelect:function(a,c,d){a.multipleSelect({placeholder:"Select a value",width:d.width,selectAll:d.hideSelectAll?!1:!0,onClick:function(a){"function"===typeof c&&c(a,d)}});d.uncheckAll&&a.multipleSelect("uncheckAll")},showTooltip:function(a,
c){var d=jQuery(".popup");d.html(c.substring(0,c.length-6));Nigsys.positionExistingElementBackEnd(a,jQuery(window),d);d.show()},hideTooltip:function(){var a=jQuery(".popup");a.hide();a.html("")},enableContainer:function(a){try{jQuery("#"+a+" :input").prop("disabled",!1)}catch(c){}try{jQuery("#"+a).prop("disabled",!1)}catch(c){console.error("Id in wrong format: enable container")}},disableContainer:function(a){try{jQuery("#"+a+" :input").prop("disabled",!0)}catch(c){}try{jQuery("#"+a).prop("disabled",
!0)}catch(c){console.error("Id in wrong format: disable container")}},confirmAction:function(a,c,d,e){confirm(d)&&c(a,e);Nigsys.disableEventPropagation(a)},removeFirstCharacter:function(a){return a.substring(1,a.length)},getLastCharacter:function(a){return a.substr(-1)},removeLastCharacter:function(a){return a.substring(0,a.length-1)},showDialogError:function(a,c){jQuery("#"+a+"Errors").html(c);jQuery("#"+a+"DialogErrorsContainer").show();"popupCreateNewLayer"==a&&jQuery("#popupCreateNewLayerDialogErrorsContainer").css("top",
-(jQuery("#popupCreateNewLayerDialogErrorsContainer .dialogErrorsInnerContainer").height()+40))},hideDialogError:function(a){jQuery("#"+a+"Errors").html("");jQuery("#"+a+"DialogErrorsContainer").hide()},addStringToArray:function(a,c){for(var d=0;d<a.length;d++)if(a[d]==c)return!1;a.push(c)},addObjectToArray:function(a,c){for(var d=0;d<a.length;d++)if(a[d].id==c.id)return!1;a.push(c)},onComboboxDestroy:function(a,c){Feature.onComboboxDestroy(a,c)},escapeHtml:function(a){return"string"!==typeof a?a:
a.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26gt;").replace(/"/g,"\x26quot;").replace(/'/g,"\x26#039;")},getScrollbarSize:function(){if("undefined"!==typeof CommonCore&&CommonCore.isMobile)return 14;if(this.scrollbarSize)return this.scrollbarSize;var a=jQuery("\x3cdiv\x3e").css({visibility:"hidden",width:100,overflow:"scroll"}).appendTo("body"),c=jQuery("\x3cdiv\x3e").css({width:"100%"}).appendTo(a).outerWidth();a.remove();this.scrollbarSize=100-c;Nigsys.isWindows()&&15<this.scrollbarSize&&
(this.scrollbarSize=15);return this.scrollbarSize},bindOnHashChange:function(){"undefined"===typeof ImajnetUrl||!ImajnetUrl||"undefined"!==typeof CommonCore&&(CommonCore.isMobile||"computeDiag"==CommonCore.page)||window.onhashchange||(window.onhashchange=function(){"undefined"===typeof isImajnetMode||isImajnetMode()?ImajnetUrl.applyUrlParams(!0):MainMethodsCore.allWorkspacesDeferred.done(function(){ImajnetUrl.applyUrlParams(!0)}).fail(function(){ImajnetUrl.applyUrlParams(!0)})})},isDeferred:function(a){return"undefined"!==
typeof a&&a?"function"===typeof a.state:!1},tabActiveIndex:function(a){return a.tabs("option","active")},activateTabIndex:function(a,c){a.tabs("option","selected",c);if(CommonCore.isMobile)try{jQuery(a.find(".ui-tabs-nav")[0].childNodes[c].childNodes[0]).trigger("click")}catch(d){}},replaceAll:function(a,c,d){return a.replace(new RegExp(c,"g"),d)},getFunctionNameAndArguments:function(a){a=a.split("(");var c=a[1].replace(")","");return{name:a[0],arguments:Nigsys.replaceAll(Nigsys.replaceAll(c,", ",
","),"'","").split(",")}},callFunctionFromString:function(a){a=Nigsys.getFunctionNameAndArguments(a);var c=a.name.split(".");if(1==c.length)return window[c[0]].apply(this,a.arguments);if(2==c.length)return window[c[0]][c[1]].apply(this,a.arguments)},prepareSelectorString:function(a){return a.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^{|}~]/g,"\\$\x26")},compareAscending:function(a,c,d){return a[d]-c[d]},onMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},
SVGToXML:function(a){return(new XMLSerializer).serializeToString(document.querySelector("#"+a))},encodeXMLToBase64:function(a){return"base64,"+btoa(unescape(encodeURIComponent(a)))},SVGToBase64XML:function(a){return"data:image/svg+xml;"+Nigsys.encodeXMLToBase64(Nigsys.SVGToXML(a))},convertToHexFromRgba:function(a,c){if(a){if(-1!==a.indexOf("rgb"))return a;c||(c=1);a=a.replace("#","");r=parseInt(a.substring(0,2),16);g=parseInt(a.substring(2,4),16);b=parseInt(a.substring(4,6),16);return result="rgba("+
r+","+g+","+b+","+c+")"}},ajaxMustAppendDataToUrl:function(a){return"post"!=a.toLowerCase()&&"put"!=a.toLowerCase()},doAjaxRequest:function(a,c,d,e,f,k,h){d="string"==typeof d?d:void 0!==d&&null!==d?JSON.stringify(d):"";var l="",l=!Nigsys.ajaxMustAppendDataToUrl(a)||h&&h.postData?c:c+d;-1===l.indexOf("http")&&(l=applicationUrl+l.replace("platform-web/mvc",""));return jQuery.ajax({type:a,url:l,contentType:"application/json",Accept:"application/json",dataType:"json",cache:"undefined"!==typeof h&&h&&
h&&h.cache?h.cache:!1,data:!Nigsys.ajaxMustAppendDataToUrl(a)||h&&h.postData?d:"",complete:function(a,c){void 0!==k&&null!==k&&k(a,h);200==a.status||201==a.status||204==a.status?void 0!==e&&null!==e&&e(a.responseText,h):void 0!==f&&null!==f&&f(a,h)}})},doAjaxRequestDeferred:function(a,c,d,e,f,k,h){var l=jQuery.Deferred();d=void 0!==d&&null!==d?JSON.stringify(d):"";var n="",n=!Nigsys.ajaxMustAppendDataToUrl(a)||h&&h.postData?c:c+d;-1===n.indexOf("http")&&(n=applicationUrl+n);c=h&&h.filePath?h.filePath:
!1;CommonCore.isMobile&&c&&!MainCore.isWeb?appCache.loadFileContent(null,c,n,h&&h.forceServerReload?h.forceServerReload:!1).done(function(a){a=MainMethodsCore.parseResponse(h.responseType,a);"function"===typeof k&&k(a,h);"function"===typeof e&&e(a,h);l.resolve(a)}).fail(function(){"function"===typeof f&&f(null,h);l.reject()}):jQuery.ajax({type:a,url:n,contentType:"application/json",Accept:"application/json",dataType:"json",cache:h&&h.cache?h.cache:!1,data:!Nigsys.ajaxMustAppendDataToUrl(a)||h&&h.postData?
d:"",complete:function(a,c){var d=a.responseText;h&&h.responseType&&(d=MainMethodsCore.parseResponse(h.responseType,d));"function"===typeof k&&k(a,h);200==a.status||201==a.status||204==a.status?("function"===typeof e&&e(d,h),l.resolve(d,h)):("function"===typeof f&&f(a,h),l.reject(a,h))}});return l.promise()},getAjaxRequest:function(a,c,d,e,f){var k=jQuery.Deferred();jQuery.ajax({type:"GET",url:applicationUrl+a,cache:!1,success:function(a){if("function"!=typeof c)k.resolve(a,f);else try{c(a,f).done(function(){k.resolve(a,
f)}).fail(function(){k.reject(a,f)})}catch(d){k.resolve(a,f)}},complete:function(a){"function"==typeof d&&d(a,f)},error:function(a){if("function"!=typeof e)k.reject(a,f);else try{e(a,f).done(function(){k.resolve(a,f)}).fail(function(){k.reject(a,f)})}catch(c){k.reject(a,f)}}});return k.promise()},getHostName:function(){return location&location.hostname?location.hostname:""},getArea:function(a){var c=0;if(a&&2<a.length){for(var d=c=0,e=a.length;d<e-1;d++)var f=a[d],k=a[d+1],c=c+(f.x+k.x)*(k.y-f.y);
c=-c/2}return c},getGeodesicArea:function(a){return""},getGeodesicAreaNotFinished:function(a){for(var c=0,d=0,e=a.length;e--;)c+=a.lat[e],d+=a.lon[e];for(var c=c/a.length,e=d/a.length,d=Array(a.length),f=a.length;f--;)a.lat[f]-=c,a.lon[f]-=e,0<=lons[f]&&0<=a.lat[f]?d[f]=Math.abs(180*Math.atan(lat[f]/lons[f])/Math.PI):0>lons[f]&&0<=lat[f]?d[f]=90+Math.abs(180*Math.atan(lat[f]/lons[f])/Math.PI):0>lons[f]&&0>lats[f]?d[f]=180+Math.abs(180*Math.atan(lat[f]/lons[f])/Math.PI):0<=lons[f]&&0>lats[f]&&(d[f]=
270+Math.abs(180*Math.atan(lat[f]/lons[f])/Math.PI));for(f=0;f<d.length;f++)for(var k=0;k<d.length-1;k++)a=d[k],c=lat[k],e=lon[k],a<d[k+1]&&(d[k]=d[k+1],lat[k]=lat[k+1],lons[k]=lons[k+1],d[k+1]=a,lat[k+1]=c,lon[k+1]=e);for(c=a=d=0;c<lats.length;c++)c!=lats.length-1?(d+=lats[c]*lons[c+1],a+=lons[c]*lats[c+1]):(d+=lats[c]*lons[0],a+=lons[c]*lats[0]);console.log("Area: "+(d-a)/2)},signedArea:function(a){for(var c=0,d=a[0].x,e=1;e<a.length-1;e++)c+=(a[e].x-d)*(a[e-1].y-a[e+1].y);return c/2},computeLonLatPointsArea:function(a){for(var c=
new jsts.geom.GeometryFactory,d=[],e=0;e<a.length;e++)d.push(new jsts.geom.Coordinate(a[e].lon,a[e].lat));a=c.createLinearRing(d);return 1E6*c.createPolygon(a).getArea()},addRandomToUrl:function(a){var c="",c=-1===a.indexOf("?")?"?":"\x26";return a+c+"_\x3d"+Nigsys.getRandomString()},getRandomString:function(){return Math.floor(1E6*Math.random())},downloadFromURL:function(a){var c=document.createElement("A");c.href=a;c.download=a.substr(a.lastIndexOf("/")+1);document.body.appendChild(c);c.click();
document.body.removeChild(c)},getGeometryLength:function(a){a=(new jsts.io.WKTReader).read(a);return a.getLength()},getOLGeometryFromWKTString:function(a){return(new jsts.io.WKTReader).read(a)},objectsAreEqual:function(a,c){if(!a&&!c)return!0;if(!a||!c)return!1;for(var d in a)if(a[d]!==c[d])return!1;return!0},getCircleFromPoint:function(a,c){return new ol.geom.MultiPolygon([[[[a[0]-c,a[1]-c],[a[0]-c,a[1]],[a[0]-c,a[1]+c],[a[0],a[1]+c],[a[0]+c,a[1]+c],[a[0]+c,a[1]],[a[0]+c,a[1]-c],[a[0],a[1]-c],[a[0]-
c,a[1]-c]]]])},createMatrix:function(a,c){for(var d=Array(a),e=0;e<d.length;e++)d[e]=Array(c);return d},isMobileBrowser:function(){return"undefined"!==typeof window.orientation||-1!==navigator.userAgent.indexOf("IEMobile")},generateSubdomainList:function(a,c,d,e){for(var f=[],k=0;k<e;k++)f[k]=Nigsys.getProtocolString(a)+"//"+c+(k+1)+"."+d;return f},getBearing:function(a,c){var d=Nigsys.degreeToRadians(a.lat),e=Nigsys.degreeToRadians(c.lat),f=Nigsys.degreeToRadians(c.lon-a.lon);return(Nigsys.radiansToDegrees(Math.atan2(Math.sin(f)*
Math.cos(e),Math.cos(d)*Math.sin(e)-Math.sin(d)*Math.cos(e)*Math.cos(f)))+360)%360},getOrientationAngle:function(a,c,d){return a-c-d},pointPositionInExtent:function(a,c){return ol.extent.containsCoordinate(a,c)}};
var ImajnetUser={data:null,resetUserData:function(a){ImajnetUser.data=null},setData:function(a){ImajnetUser.data=a},getUsername:function(){return ImajnetUser.data?ImajnetUser.data.login:""},getEmail:function(){return ImajnetUser.data?ImajnetUser.data.email:""}};
var dockingLeftContainerSize=20,dockingRightContainerSize=36,ImajnetDocking=function(b,d,g,k,e,m){this.isHidden=!1;onParentScroll=null;var l=Nigsys.getCookie("IMAJNET","DOCKING_"+k+"_position");l&&(delete e.left,delete e.top,delete e.right,delete e.bottom,"undefined"!==typeof l.left&&(e.left=l.left),"undefined"!==typeof l.top&&(e.top=l.top),"undefined"!==typeof l.right&&(e.right=l.right),"undefined"!==typeof l.bottom&&(e.bottom=l.bottom),0==e.left&&0!=e.bottom?g="Left":0==e.top?g="Top":0==e.right?
g="Right":0==e.bottom&&(g="Bottom"));this.container=b;this.previousCss=e;this.direction=g;this.type=k;this.css=e;this.options=m;b='\x3cdiv id\x3d"imajnetDockingLeftContainer_'+k+'" class\x3d"'+(this.css.notResizable?"":g)+'"\x3e'+("header"!=k?'\x3cdiv id\x3d"imajnetDockingButton_'+k+'" class\x3d"imageDockingButton left"\x3e\x3c/div\x3e':"")+'\x3cdiv id\x3d"imajnetDockingLeftTitleContainer_'+k+'" class\x3d"imajnetDockingLeftTitleContainer left"\x3e\x3c/div\x3e\x3c/div\x3e';d='\x3cdiv id\x3d"imajnetDockingRightContainer_'+
k+'" class\x3d"'+(this.css.notResizable?"":g)+'"\x3e'+d+"\x3c/div\x3e";m="";m="Bottom"==this.direction?d+b:b+d;jQuery("#imajnetDockingMainContainer_"+k).remove();this.container.append('\x3cdiv id\x3d"imajnetDockingMainContainer_'+k+'" class\x3d"imajnetDockingMainContainer imajnetDockingMainContainer_'+this.direction+'" style\x3d"'+(e.left||0==e.left?"left: "+e.left+"px;":"")+(e.right||0==e.right?"right: "+e.right+"px;":"")+(e.top||0==e.top?"top: "+e.top+"px;":"")+(e.bottom||0==e.bottom?"bottom: "+
e.bottom+"px;":"")+'"\x3e'+m+'\x3cdiv class\x3d"clear'+g+'"\x3e\x3c/div\x3e\x3c/div\x3e');resizeChildElements(this);this.positionOnTop=function(h){this.mainContainer.css("top",h)};this.setPinCollapsedImageUrl=function(h){h.css("background-image","url('"+ImajnetUI.getImagesPath()+"img/imageIcons/toolbarPinPointCollapsed.png')")};this.setPinExpandedImageUrl=function(h){h.css("background-image","url('"+ImajnetUI.getImagesPath()+"img/imageIcons/toolbarPinPointExpanded.png')")};this.onDockingButtonDisabled=
function(h,c){ImajnetUI.disableDraggable(this.mainContainer);Nigsys.setCookie("IMAJNET","DOCKING_"+this.type,"false");this.setPinCollapsedImageUrl(h);this.css.notResizable?this.collapseContainer({data:{type:c}}):Nigsys.onMobile()||("header"==this.type?(this.rightContainer.removeClass("overflowVisible"),this.mainContainer.bind("mouseenter",{type:this.type},this.expandTopContainer),this.mainContainer.bind("mouseleave",{type:this.type},this.collapseTopContainer),CommonCore.applyContainerDimension(0,
!0),jQuery(".menu").blur()):(this.mainContainer.bind("mouseenter",{type:this.type},this.expandContainer),this.mainContainer.bind("mouseleave",{type:this.type},this.collapseContainer)))};this.onDockingButtonEnabled=function(h,c){ImajnetUI.enableDraggable(this.mainContainer);Nigsys.setCookie("IMAJNET","DOCKING_"+this.type,"true");this.setPinExpandedImageUrl(h);this.css.notResizable?this.expandContainer({data:{type:c}}):"header"==this.type?(this.rightContainer.addClass("overflowVisible"),this.mainContainer.unbind({mouseenter:this.expandTopContainer,
mouseleave:this.collapseTopContainer}),CommonCore.applyContainerDimension(this.css.width,!0),jQuery(".menu").blur()):this.mainContainer.unbind({mouseenter:this.expandContainer,mouseleave:this.collapseContainer})};this.dockingButtonIsEnabled=function(h){return-1!==h.css("background-image").indexOf("Expanded")};this.onDockingButtonPressed=function(h){var c=jQuery(h.target),a=c.attr("id").replace("imajnetDockingButton_",""),f=ImajnetUI.docking[a];f.dockingButtonIsEnabled(c)?(f.onDockingButtonDisabled(c,
a),Nigsys.onMobile()&&(h.preventDefault(),f.collapseContainer({data:{type:a}}))):(f.onDockingButtonEnabled(c,a),Nigsys.onMobile()&&(h.preventDefault(),f.expandContainer({data:{type:a}})))};Nigsys.bindClickEvent(jQuery("#imajnetDockingButton_"+k),this.onDockingButtonPressed);this.mainContainer=jQuery("#imajnetDockingMainContainer_"+k);this.leftContainer=jQuery("#imajnetDockingLeftContainer_"+k);this.rightContainer=jQuery("#imajnetDockingRightContainer_"+k);this.leftContainer.addClass("imajnetDockingLeftContainer");
this.rightContainer.addClass("imajnetDockingRightContainer");"header"!=this.type&&(this.getDirectionData=function(h){var c={direction:"",css:null},a=this.mainContainer.parent(),f=a.width(),a=a.height(),b=h.position.left-this.mainContainer.parent().scrollLeft(),d=h.position.top-this.mainContainer.parent().scrollTop();this.rightContainer.width()&&this.rightContainer.height()&&(this.leftContainer.hasClass("Left")||this.leftContainer.hasClass("Right")?(b+=this.css.width/2,d+=this.css.height/2):(b+=this.css.height/
2,d+=this.css.width/2));b<=f/2&&d<=a/2?b<d?(c.direction="Left",c.css={left:0,top:h.position.top}):(c.direction="Top",c.css={left:h.position.left,top:0}):b>=f/2&&d<=a/2?f-b<d?(c.direction="Right",c.css={right:0,top:h.position.top}):(c.direction="Top",c.css={left:h.position.left,top:0}):b<=f/2&&d>=a/2?b<a-d?(c.direction="Left",c.css={left:0,top:h.position.top}):(c.direction="Bottom",c.css={left:h.position.left,bottom:0}):b>=f/2&&d>=a/2&&(f-b<a-d?(c.direction="Right",c.css={right:0,top:h.position.top}):
(c.direction="Bottom",c.css={left:h.position.left,bottom:0}));return c},this.mainContainer.draggable({delay:400,containment:"parent",snap:"#"+this.mainContainer.parent().attr("id"),scroll:!1,start:function(h,c){jQuery(h.target).attr("id").replace("imajnetDockingMainContainer_","");h.target&&jQuery(h.target).css("right","auto")},drag:function(h,c){0>c.position.left&&(c.position.left=0)},stop:function(h,c){var a=ImajnetUI.docking[jQuery(h.target).attr("id").replace("imajnetDockingMainContainer_","")],
f=a.getDirectionData(c);if(f.direction&&f.css&&("mobileGPSCoordinates"!=a.type&&"mobileLRS"!=a.type||"Top"!=f.direction&&"Bottom"!=f.direction)){var b=a.direction;a.direction=f.direction;if("imageLRSGUI"==a.type){var d=a.getOrientation();ImajnetUI.LRSGUI.orientation!=d&&(ImajnetUI.LRSGUI.orientation=d,ImajnetUI.LRSGUI.redraw())}a.css.left=f.css.left;a.css.top=f.css.top;a.css.right=f.css.right;a.css.bottom=f.css.bottom;("Bottom"==b&&"Bottom"!=a.direction||"Bottom"!=b&&"Bottom"==a.direction)&&a.mainContainer.children().each(function(){jQuery(this).prependTo(a.mainContainer)});
b=f=0;"Left"!=a.direction&&"Right"!=a.direction||a.css.notResizable?(f=a.css.height,b=a.css.width):(f=a.css.width,b=a.css.height);resizeChildElements(a);var e=a.mainContainer.parent(),d=e.width(),g=e.height(),e={};"undefined"===typeof a.css.left?a.mainContainer.css("left","auto"):(a.css.left+f>d&&(a.css.left=d-f),a.mainContainer.css("left",a.css.left),e.left=a.css.left);"undefined"===typeof a.css.top?a.mainContainer.css("top","auto"):(a.css.top+b>g&&(a.css.top=g-b),a.mainContainer.css("top",a.css.top),
e.top=a.css.top);"undefined"===typeof a.css.right?a.mainContainer.css("right","auto"):(a.css.right+f>d&&(a.css.right=d-f),a.mainContainer.css("right",a.css.right),e.right=a.css.right);"undefined"===typeof a.css.bottom?a.mainContainer.css("bottom","auto"):(a.css.bottom+b>g&&(a.css.bottom=g-b),a.mainContainer.css("bottom",a.css.bottom),e.bottom=a.css.bottom);a.previousCss=a.css;f=jQuery("#imajnetDockingButton_"+a.type);-1!==f.prop("style").background.indexOf("Collapsed")?a.setPinCollapsedImageUrl(f):
a.setPinExpandedImageUrl(f);Nigsys.setCookie("IMAJNET","DOCKING_"+a.type+"_position",e);if(a.css.notResizable)f=0<a.rightContainer.height(),a.cornerTitle(f),"Left"!=a.direction&&"Right"!=a.direction||f?removeVertically(a):setVertically(a);else if(a.leftContainer.uncorner(),a.rightContainer.uncorner(),a.corner(),a.rightContainer.height()?(a.leftContainer.uncorner(),f=null,b=!1,"Left"==a.direction||"Right"==a.direction?(b=a.leftContainer.hasClass("Top")||a.leftContainer.hasClass("Bottom"),onExpandComplete(a)):
(f=onExpandComplete,b=a.leftContainer.hasClass("Left")||a.leftContainer.hasClass("Right")),b&&a.expandContainer({data:{type:a.type}},f)):onExpandComplete(a),a.mainContainer.removeClass("imajnetDockingMainContainer_Left").removeClass("imajnetDockingMainContainer_Right").removeClass("imajnetDockingMainContainer_Top").removeClass("imajnetDockingMainContainer_Bottom").addClass("imajnetDockingMainContainer_"+a.direction),a.onParentScroll)a.onParentScroll()}}}));this.corner=function(){Nigsys.browserIsIE7()||
Nigsys.browserIsIE8()||"header"==this.type||("Left"==this.direction?(this.leftContainer.corner("5px right"),this.rightContainer.corner("5px right")):"Top"==this.direction?(this.leftContainer.corner("5px bottom"),this.rightContainer.corner("5px bottom")):"Right"==this.direction?(this.leftContainer.corner("5px left"),this.rightContainer.corner("5px left")):"Bottom"==this.direction&&(this.leftContainer.corner("5px top"),this.rightContainer.corner("5px top")))};this.cornerTitle=function(b){Nigsys.browserIsIE7()||
Nigsys.browserIsIE8()||"header"==this.type||(this.leftContainer.uncorner(),this.rightContainer.uncorner(),"Left"==this.direction?(this.leftContainer.corner("tr"),b||this.leftContainer.corner("br"),this.rightContainer.corner("br")):"Top"==this.direction?b?this.rightContainer.corner("bottom"):this.leftContainer.corner("bottom"):"Right"==this.direction?(this.leftContainer.corner("tl"),b||this.leftContainer.corner("bl"),this.rightContainer.corner("bl")):"Bottom"==this.direction&&(b?this.rightContainer.corner("top"):
this.leftContainer.corner("top")))};this.corner();this.resize=function(b){var c=ImajnetUI.docking[this.type],a;for(a in b)c.css[a]=b[a];thisObject.expandContainer({data:{type:thisObject.type}})};this.getOrientation=function(){return"Left"==this.direction||"Right"==this.direction?"portrait":"landscape"};this.expandContainer=function(b,c){if(b.data.type){var a=ImajnetUI.docking[b.data.type];a.isHidden=!1;Nigsys.browserIsIE7()||Nigsys.browserIsIE8()||a.leftContainer.uncorner();a.leftContainer.stop(1);
a.rightContainer.stop(1);var d=0,e=0,g=0,k=0;a.css.notResizable?(a.cornerTitle(!0),removeVertically(a),d=a.css.height,a.leftContainer.animate({width:d},0),e=dockingLeftContainerSize,g=a.css.height,k=a.css.width):"Left"==a.direction||"Right"==a.direction?(e=a.css.height,g=a.css.width,k=a.css.height):(e=dockingLeftContainerSize,g=a.css.height,k=a.css.width);d=d?d:a.leftContainer.width();0>=d&&("imageButtons"==a.type||"imageLRSGUI"==a.type)&&(d=dockingLeftContainerSize);a.leftContainer.animate({height:e},
getAnimateTime(a),function(){"Right"==a.direction&&("imajnetTimeframe"==a.type?a.mainContainer.width(g):a.mainContainer.width(d+g))});e=Object({height:k});"header"!=a.type&&jQuery.extend(e,Object({width:g}));a.rightContainer.animate(e,getAnimateTime(a),function(){"mapControls"==b.data.type&&jQuery("#mapControlsContainer").css("position","absolute");"function"===typeof c&&c(a);if(a.options&&"function"===typeof a.options.onShow)a.options.onShow(b)});"Right"!=a.direction&&a.mainContainer.css("width",
"auto")}};this.collapseContainer=function(b){if(b.data.type){var c=ImajnetUI.docking[b.data.type];c.isHidden=!0;c.rightContainer.stop(1);c.leftContainer.stop(1);if("mapControls"==b.data.type)jQuery("#mapControlsContainer").css("position","static");else if(c.css.notResizable){var a=c.leftContainer.children(".imajnetDockingLeftTitleContainer"),d=a.html();d&&(-1===d.indexOf("\x26nbsp;")&&a.html(d+"\x26nbsp;"),c.leftContainer.css("width","auto"))}c.css.notResizable?(c.cornerTitle(!1),"Left"==c.direction||
"Right"==c.direction?setVertically(c):removeVertically(c),c.mainContainer.css("width","auto")):c.leftContainer.animate({height:dockingLeftContainerSize},null,function(){c.corner()});a=Object({height:0});"header"!=c.type&&jQuery.extend(a,Object({width:0}));c.rightContainer.animate(a,null,function(){if(c.options&&"function"===typeof c.onHide)c.options.onHide(b)})}};this.expandTopContainer=function(b){if(0!=b.pageY){jQuery("#imajnetSettingsMenu li div select").show();var c=ImajnetUI.docking[b.data.type];
c.isHidden=!1;c.rightContainer.stop(1);c.rightContainer.height(0);c.rightContainer.show();c.rightContainer.animate({height:"Left"==c.direction||"Right"==c.direction?c.css.height:c.css.width},null,function(){if(c.options&&"function"===typeof c.options.onShow)c.options.onShow(b)})}};this.collapseTopContainer=function(b){if(!b.isTriggered&&jQuery(".imajnetSettingsMenuSelectOptions")&&(0<jQuery("#imajnetSettingsMenuLocaleSelectAutocomplete:visible").length||0<jQuery("#imajnetPOIAutocomplete:visible").length))return!1;
var c=ImajnetUI.docking[b.data.type];c.isHidden=!0;c.leftContainer.stop(1);c.rightContainer.animate({height:0},{complete:function(){jQuery("#imajnetSettingsMenu li ul.menuItem").hide();jQuery("#imajnetSettingsMenu li div select").hide();if(c.options&&"function"===typeof c.options.onHide)c.options.onHide(b);c.rightContainer.hide()},always:function(){if(c.options&&"function"===typeof c.options.onHide)c.options.onHide(b);setTimeout(function(){c.rightContainer.height(0)},300);c.rightContainer.hide()}})};
this.remove=function(){this.mainContainer.remove();ImajnetUI.docking[this.type]=null};return this};
function keepDockingInsideParent(){for(var b in ImajnetUI.docking)if(ImajnetUI.docking[b]){var d=ImajnetUI.docking[b],g=d.container.width();if(g){var k=d.css.height;if(("Top"==d.direction||"Bottom"==d.direction)&&d.css.left+k>g){var e=g-k;0>e?d.mainContainer.css("left",0):d.mainContainer.css("left",g-k)}}if(g=d.container.height()-("imageLRSGUI"==d.type?55:0))k=d.css.height,("Left"==d.direction||"Right"==d.direction)&&d.css.top+k>g&&(e=g-k,0>e&&(e=0),d.mainContainer.css("top",e));d.mainContainer.width()<
d.mainContainer.parent().width()&&d.mainContainer.position().left+d.mainContainer.width()>d.mainContainer.parent().width()&&d.mainContainer.css("right",0)}}function resizeChildElements(b){"mapEditButtons"==b.type&&("Left"!=b.direction&&"Right"!=b.direction||b.css.notResizable?jQuery(".mustResize").css("width","auto"):jQuery(".mustResize").width(b.css.width-5))}
function onExpandComplete(b){b.leftContainer.removeClass("Left").removeClass("Top").removeClass("Right").removeClass("Bottom").addClass(b.direction);b.rightContainer.removeClass("Left").removeClass("Top").removeClass("Right").removeClass("Bottom").addClass(b.direction)}function getAnimateTime(b){return b.css.notResizable?0:400}
function setVertically(b){var d=b.leftContainer.children(".imajnetDockingLeftTitleContainer"),g=15*d.html().length;d.height(g).addClass("textVertically");b.leftContainer.addClass("textVertically");b.leftContainer.animate({height:g+dockingLeftContainerSize},null,function(){b.corner()})}
function removeVertically(b){b.leftContainer.children(".imajnetDockingLeftTitleContainer").height(dockingLeftContainerSize).removeClass("textVertically");b.leftContainer.height(dockingLeftContainerSize).removeClass("textVertically")}
CheckDockingCookie=function(b){var d=ImajnetUI.docking[b];if(d){var g=Nigsys.getCookie("IMAJNET","DOCKING_"+b);"true"==g||null===g&&!d.css.notResizable?(d.isHidden=!1,d.expandContainer({data:{type:b}}),d.onDockingButtonEnabled(jQuery("#imajnetDockingButton_"+b),b)):(d.isHidden=!0,d.onDockingButtonDisabled(jQuery("#imajnetDockingButton_"+b),b));keepDockingInsideParent()}};
var ImajnetTimeframe={previousTo:null,setTimeframeFrom:function(a){a=jQuery("#imajnetTimeframeFromDate");var b=jQuery("#imajnetTimeframeToDate");Nigsys.endDateIsBeforeStartDate(Nigsys.formatJavascriptDateToJava(a.val()).replace(Nigsys.dateZ,""),Nigsys.formatJavascriptDateToJava(b.val()).replace(Nigsys.dateZ,""))&&b.val(a.val())},setTimeframeTo:function(a){a=jQuery("#imajnetTimeframeFromDate");var b=jQuery("#imajnetTimeframeToDate");Nigsys.endDateIsBeforeStartDate(Nigsys.formatJavascriptDateToJava(a.val()).replace(Nigsys.dateZ,
""),Nigsys.formatJavascriptDateToJava(b.val()).replace(Nigsys.dateZ,""))&&(ImajnetTimeframe.previousTo?a.val(b.val()):b.val(a.val()));ImajnetTimeframe.previousTo=b.val()},getTimeframeText:function(a){return a?Nigsys.formatGeoserverDate(a.from)+" - "+Nigsys.formatGeoserverDate(a.to):jQuery.imajnet.timeframe.title},setTimeframeText:function(a){jQuery("#imajnetDockingLeftTitleContainer_imajnetTimeframe").html(this.getTimeframeText(a))},getNextDayDate:function(a){a=a.split("-");a=new Date(a[0],a[1]-1,
a[2]);a=new Date(a.setDate(a.getDate()+1));var b=a.getMonth()+1;10>b&&(b="0"+b);return a.getFullYear()+"-"+b+"-"+a.getDate()},getTimeframe:function(){return ImajnetSettings.timeframe?Object({from:ImajnetSettings.timeframe.from,to:this.getNextDayDate(ImajnetSettings.timeframe.to)}):null},getTimeframeFromInput:function(){var a=jQuery("#imajnetTimeframeFromDate").val(),b=jQuery("#imajnetTimeframeToDate").val();return a&&b?Object({from:Nigsys.formatJavascriptDateToJava(a).replace(Nigsys.dateZ,""),to:Nigsys.formatJavascriptDateToJava(b).replace(Nigsys.dateZ,
"")}):null},setTimeframe:function(a){this.setTimeframeText(a);(ImajnetSettings.timeframe=a)&&a.from&&a.to?(ImajnetPlugin.redrawLayer(ImajnetMap.imajnetLayer),ImajnetMap.currentPosition&&(ImajnetZoom.left=-1,Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetAPI.setImajnetImage({position:ImajnetMap.currentPosition}))):ImajnetPlugin.redrawLayer(ImajnetMap.imajnetLayer)}};
var ImajnetEvents={mappingObject:{},positionChangeEventName:"POI_IMAGE_CHANGE",languageChanageEventName:"LANGUAGE_CANGE"};
var ImajnetUI={imageContainer:null,imageSwitcherContainer:null,helpContainer:null,aboutImajnetContainer:null,settingsContainer:null,sequenceDetails:null,imageDetails:null,groundPlaneDetails:null,LRSGUI:null,imajnetImageContainer:null,imajnetImageContainerSize:{width:480,height:400},imajnetImageContainerInitialSize:{width:480,height:400},imageAspectRatio:1,imajnetImage:null,previewImageContainer:null,previewImage:null,imajnetZoomOnShiftBox:null,imajnetZoomOnShiftBoxOffset:{x:0,y:0},imajnetToolbarButtons:null,
btnImajnetPlugin:null,activeControlButton:null,btnClosestImage:null,btnClosestImageDiv:null,btnClickMode:null,btnClickModeDiv:null,btnEnableClipboard:null,btnEnableClipboardDiv:null,btnLayoutImageSmall:null,btnLayoutImageSmallDiv:null,btnLayoutImageHalf:null,btnLayoutImageHalfDiv:null,btnLayoutImageBig:null,btnLayoutImageBigDiv:null,btnLayoutNoImage:null,btnLayoutNoImageDiv:null,btnLayoutCustom:null,btnLayoutCustomDiv:null,btnLayoutResetToDefault:null,btnLayoutResetToDefaultDiv:null,imageContainerId:"popupImajnet",
clientLogoContainer:null,searchLRSContainer:null,searchLRSContainerId:null,searchLRSContainerIdDefault:"searchLRSContainer",searchAddressContainer:null,searchAddressContainerId:null,searchAddressContainerIdDefault:"searchAddressPopup",clipboardContainer:null,clipboardContainerId:null,clipboardContainerIdDefault:"popupPhotogrammetryClipboard",clipboardExportContainer:null,clipboardExportContainerId:null,clipboardExportContainerIdDefault:"popupPhotogrammetryClipboardExport",newsContainer:null,newsContainerId:null,
newsContainerIdDefault:"popupNews",addObjectToLayerIdDefault:"addObjectToLayer",helpContainerId:"popupHelp",aboutImajnetContainerId:"popupAboutImajnet",settingsContainerId:"popupImajnetSettings",settingsLRSContainerId:"popupImajnetLRSSettings",sequenceDetailsId:"popupSequenceDetails",imageDetailsId:"popupImageDetails",groundPlaneDetailsId:"popupGroundPlaneDetails",popupImajnetControlsLayer:null,imageSwitcherImageContainer:null,imageSwitcherImage:null,imajnetImageSliderContainer:null,imajnetImageSliderInnerContainer:null,
sliderLeftImageContainer:null,sliderRightImageContainer:null,sliderLeftImage:null,sliderRightImage:null,allowKeyUp:!0,zoomCancel:!1,controlActivatorContainers:[],LRSGUIcontainerHTML:'\x3cdiv id\x3d"imajnetLRSGUI" class\x3d"imajnetLRSGUI"\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetLRSDragGUI" class\x3d"imajnetLRSGUI"\x3e\x3c/div\x3e',imageDate:"",imageDateContainer:null,imageNavigationTimer:null,swipeImageTimeout:100,dragImageSliderPrevX:-1,lastMouseCoordinates:null,imagesLoadQueue:[],clipboardOpenCommentId:"",
isDragMode:!1,isAfterSliderDrag:!1,isAfterSwipe:!1,isAfterLRSSearch:!1,controlNames:{searchLRS:"searchLRS",showClipboard:"showClipboard"},docking:{header:null,imageButtons:null,imageLRSGUI:null,imajnetButtons:null,imajnetMapButtons:null,imajnetTimeframe:null,mapToolsButtons:null,mapEditButtons:null},getImagesPath:function(){return Imajnet.imajnetPath},initContainer:function(a){ImajnetUI[a+"Id"]||(ImajnetUI[a+"Id"]=ImajnetUI[a+"IdDefault"],jQuery("body").append('\x3cdiv id\x3d"'+ImajnetUI[a+"Id"]+
'"\x3e\x3c/div\x3e'));ImajnetUI[a]=jQuery("#"+ImajnetUI[a+"Id"]);ImajnetUI[a].addClass("imajnetItem")},addMobileCss:function(){if(Nigsys.isMobileBrowser()){var a=Nigsys.getWindowSize().width;1150<a||(jQuery("#imajnetSettingsMenu").width(930<a?a:930),jQuery("#imajnetDockingRightContainer_header").css({"overflow-x":"auto","overflow-y":"hidden"}),jQuery("#imajnetPOI").width(80),jQuery("#logoutButton").css("margin-top",-1))}},init:function(){ImajnetUI.imageContainer&&(Photogrammetry.exportToItemContent=
'\x3cdiv class\x3d"leftLabel left"\x3e'+jQuery.imajnet.map.clipboard.popupExport.to+':\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput oninput\x3d"ImageControler.currentPhotogrammetry.onExportToItemKeyup()" type\x3d"text" class\x3d"imajnetExportTo" /\x3e\x3c/div\x3e',FlatPhotogrammetry.exportToItemContent=Photogrammetry.exportToItemContent,CubePhotogrammetry.exportToItemContent=Photogrammetry.exportToItemContent,this.createImageContainer(),this.initLRSGUIDocking(ImajnetLRSGUIWidth,ImajnetLRSGUIHeight),
this.LRSGUI=ImajnetLRSGUI({id:"imajnetLRSGUI",dragId:"imajnetLRSDragGUI",orientation:ImajnetUI.docking.imageLRSGUI.getOrientation()}))},initAddressContainer:function(){ImajnetUI.initContainer("searchAddressContainer")},initLRSContainer:function(){ImajnetUI.initContainer("searchLRSContainer");LRS.addLRSDialog()},initContainers:function(){ImajnetUI.imageContainer||(CubePlugin&&CubePlugin.cubeGeometry&&(CubePlugin.cubeGeometry=null),ImajnetUI.imageContainer=jQuery("#"+ImajnetUI.imageContainerId),ImajnetUI.imageContainer.hide(),
ImajnetUI.imageContainer.addClass("imajnetImageContainer").css("position","relative"),ImajnetUI.initContainer("clipboardContainer"),ImajnetUI.initContainer("clipboardExportContainer"),Imajnet.autoPhotogrammetryAdd&&ImajnetUI.initContainer("addObjectToLayer"),ImajnetUI.initAddressContainer(),ImajnetUI.initLRSContainer(),ImajnetUI.clipboardExportContainer.hide(),ImajnetUI.initContainer("newsContainer"),ImajnetUI.clipboardContainer.hide(),ImajnetUI.helpContainer=jQuery("#"+ImajnetUI.helpContainerId),
ImajnetUI.helpContainer.hide(),ImajnetUI.aboutImajnetContainer=jQuery("#"+ImajnetUI.aboutImajnetContainerId),ImajnetUI.aboutImajnetContainer.hide(),ImajnetUI.settingsContainer=jQuery("#"+ImajnetUI.settingsContainerId),ImajnetUI.settingsContainer.addClass("popupImajnetSettings"),ImajnetUI.settingsContainer.hide(),ImajnetUI.settingsLRSContainer=jQuery("#"+ImajnetUI.settingsLRSContainerId),ImajnetUI.settingsLRSContainer.hide(),ImajnetUI.sequenceDetails=jQuery("#"+ImajnetUI.sequenceDetailsId),ImajnetUI.sequenceDetails.hide(),
ImajnetUI.imageDetails=jQuery("#"+ImajnetUI.imageDetailsId),ImajnetUI.imageDetails.hide(),ImajnetUI.groundPlaneDetails=jQuery("#"+ImajnetUI.groundPlaneDetailsId),ImajnetUI.groundPlaneDetails.hide(),ImajnetUI.appendClipboarContainerHTML(),"function"===typeof ImajnetUI.imageContainer.disableSelection&&(ImajnetUI.imageContainer.disableSelection(),ImajnetUI.imageContainer.parent().disableSelection()))},initLRSGUIDocking:function(a,b){ImajnetUI.docking.imageLRSGUI&&ImajnetUI.docking.imageLRSGUI.remove();
ImajnetUI.docking.imageLRSGUI=new ImajnetDocking(ImajnetUI.imageContainer,this.LRSGUIcontainerHTML,"Left","imageLRSGUI",{width:a,height:b,left:0,top:40});CheckDockingCookie("imageLRSGUI");this.LRSGUI&&this.LRSGUI.positionTop()},showNotificationInfo:function(a,b,c,d,e,f){b||(b="");this.showNotificationInfoOk(a,b,c,d,e,f)},showNotificationInfoOk:function(a,b,c,d,e,f){Nigsys.notification.html("");a=Nigsys.notification.notify("create","notificationInfoOk",{title:a,text:b},{expires:!1,beforeopen:function(a,
b){Nigsys.positionNotification(c);"function"===typeof d&&d(a,b)},open:function(a,b){Nigsys.positionNotification(c);"function"===typeof e&&e(a,b)},click:function(a,b){b.close();"function"===typeof f&&f(a,b)}});Nigsys.notification.show();return a},hideNotificationInfoOk:function(){Nigsys.notification&&Nigsys.notification.hide()},highlightContainer:function(a){a&&(a.removeClass("opacity100"),a.addClass("opacity60"))},unHighlightContainer:function(a){a&&(a.removeClass("opacity60"),a.addClass("opacity100"))},
getSequenceDeatilsHTML:function(){return'\x3cdiv\x3e\x3cdiv class\x3d"left sequenceDetailsLeft"\x3e'+jQuery.imajnet[ImajnetUI.sequenceDetailsId].name+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"sequenceDetailsName" size\x3d"45" /\x3e\x3c/div\x3e\x3cdiv class\x3d" clear"\x3e\x3c/div\x3e\x3cdiv class\x3d"left sequenceDetailsLeft"\x3e'+jQuery.imajnet[ImajnetUI.sequenceDetailsId].project+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"sequenceDetailsProject" size\x3d"45" /\x3e\x3c/div\x3e\x3cdiv class\x3d" clear"\x3e\x3c/div\x3e\x3cdiv class\x3d"left sequenceDetailsLeft"\x3e'+
jQuery.imajnet[ImajnetUI.sequenceDetailsId].operator+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"sequenceDetailsOperator" size\x3d"45" /\x3e\x3c/div\x3e\x3cdiv class\x3d" clear"\x3e\x3c/div\x3e\x3cdiv class\x3d"left sequenceDetailsLeft"\x3e'+jQuery.imajnet[ImajnetUI.sequenceDetailsId].repository+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"sequenceDetailsRepository" size\x3d"45" /\x3e\x3c/div\x3e\x3cdiv class\x3d" clear"\x3e\x3c/div\x3e\x3cdiv class\x3d"left sequenceDetailsLeft"\x3e'+
jQuery.imajnet[ImajnetUI.sequenceDetailsId].location+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"sequenceDetailsLocation" size\x3d"45" /\x3e\x3c/div\x3e\x3cdiv class\x3d" clear"\x3e\x3c/div\x3e\x3cdiv style\x3d"width: 100%; text-align: center"\x3e\x3cinput type\x3d"button" value\x3d"'+jQuery.imajnet.button.close+'" onclick\x3d"ImajnetUI.hideItem(ImajnetUI.sequenceDetailsId);" /\x3e\x3c/div\x3e\x3c/div\x3e'},sequenceDetailsReceived:function(a){ImajnetUI.sequenceDetails.html(ImajnetUI.getSequenceDeatilsHTML());
a=JSON.parse(a);jQuery("#sequenceDetailsName").val(a.sequence.name);jQuery("#sequenceDetailsProject").val(a.sequence.projectInfo);jQuery("#sequenceDetailsOperator").val(a.sequence.operator);jQuery("#sequenceDetailsRepository").val(a.sequence.repositoryLocation);jQuery("#sequenceDetailsLocation").val(a.sequence.location);ImajnetUI.showItem(ImajnetUI.sequenceDetailsId)},showSequenceDetails:function(){ImajnetUI.closeAllMenus();ImajnetMap.currentPosition?ImajnetAPI.doImajnetRequest("GET","/api/sequence/details?image\x3d"+
ImajnetMap.currentPosition.id,null,ImajnetUI.sequenceDetailsReceived):(jQuery("#sequenceDetailsName").val(""),jQuery("#sequenceDetailsProject").val(""),jQuery("#sequenceDetailsOperator").val(""),jQuery("#sequenceDetailsRepository").val(""),jQuery("#sequenceDetailsLocation").val(""))},showReimportSequence:function(){ImajnetUI.closeAllMenus();ImajnetMap.currentPosition&&ImajnetAPI.doImajnetRequest("GET","/api/sequence/details?image\x3d"+ImajnetMap.currentPosition.id,null,function(a){window.open(ImajnetUI.getManagerUrl()+
"app/data/sequence?operation\x3dreimport\x26sequenceid\x3d"+JSON.parse(a).sequence.id,"_blank")})},showDeleteSequence:function(){ImajnetUI.closeAllMenus();ImajnetMap.currentPosition&&ImajnetAPI.doImajnetRequest("GET","/api/sequence/details?image\x3d"+ImajnetMap.currentPosition.id,null,function(a){window.open(ImajnetUI.getManagerUrl()+"app/data/sequence?operation\x3ddelete\x26sequenceid\x3d"+JSON.parse(a).sequence.id,"_blank")})},showCreatePOI:function(){ImajnetUI.closeAllMenus();ImajnetMap.currentPosition&&
window.open(ImajnetUI.getManagerUrl()+"app/poi?imageid\x3d"+ImajnetMap.currentPosition.id,"_blank")},showArchiveSequence:function(){ImajnetUI.closeAllMenus();ImajnetMap.currentPosition&&ImajnetAPI.doImajnetRequest("GET","/api/sequence/details?image\x3d"+ImajnetMap.currentPosition.id,null,function(a){window.open(ImajnetUI.getManagerUrl()+"app/data/sequence?operation\x3darchive\x26sequenceid\x3d"+JSON.parse(a).sequence.id,"_blank")})},showUnarchiveSequence:function(){ImajnetUI.closeAllMenus();ImajnetMap.currentPosition&&
ImajnetAPI.doImajnetRequest("GET","/api/sequence/details?image\x3d"+ImajnetMap.currentPosition.id,null,function(a){window.open(ImajnetUI.getManagerUrl()+"app/data/sequence?operation\x3dunarchive\x26sequenceid\x3d"+JSON.parse(a).sequence.id,"_blank")})},unarchiveSequence:function(){ImajnetMap.currentPosition&&Nigsys.showConfirmDialog(jQuery.imajnet.management.unarchiveSequence.confirmMessage,"unarchiveConfirmation","center",function(){Nigsys.showLoading(ImajnetUI.imageContainer);ImajnetAPI.doImajnetRequest("POST",
"/api/sequence/archiving?traceId\x3d"+ImajnetMap.currentPosition.traceId+"\x26state\x3dUnarchived",null,ImajnetUI.onUnarchiveSequenceSuccess,ImajnetUI.onUnarchiveSequenceError,function(){Nigsys.hideLoading(ImajnetUI.imageContainer)})},function(){})},onUnarchiveSequenceSuccess:function(){ImajnetUI.sequenceIsNotArchived();ImajnetUI.showError(jQuery.imajnet.management.unarchiveSequence.success,!0);ImageControler.currentImageControl.setCurrentImage(ImajnetMap.currentPosition,{requestUrl:Nigsys.addRandomToUrl(ImajnetAPI.buildImageURL(ImajnetMap.currentPosition))})},
onUnarchiveSequenceError:function(){ImajnetUI.showError(jQuery.imajnet.management.unarchiveSequence.error,!0)},getManagerUrl:function(){return-1!=applicationDomain.indexOf("test.imajnet.net")?"https://testmanager.imajnet.net/":-1!=applicationDomain.indexOf(".imajnet.net")?"https://management.imajnet.net/":applicationDomain+"imajnet-manager/"},closeAllMenus:function(){jQuery(".menu").menu("collapseAll",null,!0)},checkEmbedReady:function(){null==document.getElementById("imajnetHelpPDFView")?setTimeout("Attachments.checkEmbedReady()",
3E3):Nigsys.hideLoading(jQuery("#"+ImajnetUI.helpContainerId))},showHelp:function(){Nigsys.showLoading(jQuery("#"+ImajnetUI.helpContainerId));var a=Nigsys.getWindowSize().height;ImajnetUI.showItem(ImajnetUI.helpContainerId,860,a-35);var b="https://imajnet.net/userguide/UG_IMAJNET_"+Imajnet.locale.toUpperCase()+".pdf";ImajnetUI.helpContainer.html('\x3cobject width\x3d"840" height\x3d"'+(a-100)+'"  data\x3d"'+b+'" type\x3d"application/pdf"\x3e\x3cp style\x3d"text-align:center; margin-top:'+(a-100)/
2+'px; font-size: 18px"\x3e'+jQuery.imajnet.helpWarning+'\x3ca style\x3d"font-size: 18px" href\x3d"'+b+'"\x3e'+jQuery.imajnet.helpDownload+'\x3c/a\x3e\x3c/p\x3e\x3cembed id\x3d"imajnetHelpPDFView" src\x3d"'+b+'" type\x3d"application/pdf" width\x3d"840" height\x3d"'+(a-100)+'" /\x3e\x3c/object\x3e');ImajnetUI.checkEmbedReady();ImajnetUI.closeAllMenus()},showAboutImajnet:function(){var a='\x3cdiv style\x3d"width: 200px; height: 60px; margin: auto;"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/imajnetLogoMediumBlue.png?"+
Imajnet.version+'" width\x3d"200" height\x3d"60" /\x3e\x3c/div\x3e\x3cdiv\x3e'+jQuery.imajnet.aboutImajnet+'\x3c/div\x3e\x3cdiv style\x3d"text-align: center; font-size: 15px; font-weight: bold; margin: 10px 0 0 0;"\x3e\x3cspan\x3e'+jQuery.imajnet.productOf+'\x26nbsp;\x3c/span\x3e\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3ca href\x3d"http://'+jQuery.imajnet.link+'" target\x3d"_blank" class\x3d"imajnetLink"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/imajingLogo.png?"+Imajnet.version+
'" align\x3d"top" /\x3e\x3c/a\x3e\x3c/div\x3e\x3cdiv style\x3d"text-align: center;"\x3e\x3ca href\x3d"http://'+jQuery.imajnet.link+'" target\x3d"_blank" class\x3d"imajnetLink"\x3e'+jQuery.imajnet.link+'\x3c/a\x3e\x3c/div\x3e\x3cdiv style\x3d"font-size: 14px; height: 40px; margin-top: 5px;"\x3e'+jQuery.imajnet.version+":\x26nbsp;\x3cb\x3e"+VERSION+"\x3c/b\x3e\x3cbr/\x3e"+jQuery.imajnet.buildDate+":\x26nbsp;\x3cb\x3e"+BUILD_DATE+"\x3c/b\x3e\x3c/div\x3e";ImajnetUI.showItem(ImajnetUI.aboutImajnetContainerId,
500,380);ImajnetUI.aboutImajnetContainer.html(a);ImajnetUI.closeAllMenus()},repoortBug:function(){var a="",b="";try{a="\x26username\x3d"+ImajnetUser.getUsername(),b+="sdk-version:"+Imajnet.version+"\x3cbr/\x3e",b+="url:"+window.location.href+"\x3cbr/\x3e",b+="locale:"+window.locale+"\x3cbr/\x3e",b+="agent:"+navigator.userAgent+"\x3cbr/\x3e",b+="date:"+(new Date).toUTCString()+"\x3cbr/\x3e",b=encodeURIComponent(b),b="\x26metadata\x3d"+b}catch(c){}window.open(ImajnetUI.getManagerUrl()+"app/bugreport?action\x3dnew"+
a+b)},getPreviewImageResolution:function(){var a=ImajnetSettings.imajnetImageResolutions[ImajnetSettings.imajnetSettings.imageQuality],b=ImajnetUI.imajnetImage.attr("src"),c;for(c in ImajnetSettings.imajnetImageResolutions)if(-1!=b.indexOf(ImajnetSettings.imajnetImageResolutions[c])){a=ImajnetSettings.imajnetImageResolutions[c];break}return a},getImageAspectRatio:function(){return ImajnetUI.imageAspectRatio},updateElementsWithAspectRatio:function(){ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH=Math.round((jQuery("body").width()-
150)/ImajnetImageSwitcher.ORDERED_IMAGES_NO);ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT=Math.round(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH*(1/ImajnetUI.getImageAspectRatio()));ImajnetImageSwitcher.isBigMode&&ImajnetImageSwitcher.hideBigMode()},computeImageAspectRatio:function(){var a=ImajnetSettings.getImageResolution();if(a){var a=a.toUpperCase(),b=ImajnetZoom[a+"_RESOLUTION_WIDTH"],a=ImajnetZoom[a+"_RESOLUTION_HEIGHT"];if(b&&a){ImajnetUI.imageAspectRatio=b/a;if(1.2<ImajnetUI.imageAspectRatio||
"CUBE"==ImageControler.currentImageType)ImajnetUI.imageAspectRatio=1.1941463414634146;ImajnetUI.updateElementsWithAspectRatio()}}},getImageDimensions:function(a,b){var c=a/ImajnetUI.getImageAspectRatio();c>b&&(c=b,a=c*ImajnetUI.getImageAspectRatio());return Object({width:parseInt(a),height:parseInt(c)})},getImageContainerDimesions:function(){var a=this.imajnetImageContainerSize;if(ImajnetPlugin.getMapSize){var b=ImajnetPlugin.getMapSize();if(b&&b.h){var c=ImajnetUI.getImageAspectRatio();c&&(a.height=
b.h-150,a.width=a.height?parseInt(a.height*c)-2:Nigsys.browserIsIE7()?480:null)}}a.height<this.imajnetImageContainerInitialSize.height&&(a.height=this.imajnetImageContainerInitialSize.height);a.width<this.imajnetImageContainerInitialSize.width&&(a.width=this.imajnetImageContainerInitialSize.width);return a},setSliderScrollLeft:function(a){this.imajnetImageSliderInnerContainer.css("left",-(ImajnetUI.imajnetImageContainerSize.width+ImajnetImageSwitcher.dragArrowWidth))},setSliderDraggableContainment:function(){if(ImajnetUI.imajnetImageContainer){var a=
ImajnetUI.imajnetImageContainer.offset(),b=ImajnetUI.imajnetImageContainerSize.width+ImajnetImageSwitcher.dragArrowWidth,c=a.left-b,d=c;ImajnetImageSwitcher.dragLeftPosition&&(d+=b);ImajnetImageSwitcher.dragRightPosition&&(c-=b);this.imajnetImageSliderInnerContainer.draggable("option","containment",[c,a.top,d,a.top])}},getSliderLeftImage:function(a){return'\x3cimg id\x3d"imajnetLayerLeftImage" src\x3d"'+a+'" class\x3d"imajnetLayerSliderImage" /\x3e'},getSliderRightImage:function(a){return'\x3cimg id\x3d"imajnetLayerRightImage" src\x3d"'+
a+'" class\x3d"imajnetLayerSliderImage" /\x3e'},stopSwipeNavigation:function(a,b){if(ImajnetUI.imageNavigationTimer||b)ImajnetUI.imajnetImageContainer.off("vmousedown",ImajnetUI.onImageMouseDown),clearTimeout(ImajnetUI.imageNavigationTimer),ImajnetUI.imageNavigationTimer=null,ImajnetAPI.imajnetOrderRequest&&(ImajnetAPI.imajnetOrderRequest.abort(),ImajnetAPI.imajnetOrderRequest=null),ImajnetAPI.lastNavigationPositionImageId=""},onImageMouseDown:function(){ImajnetUI.stopSwipeNavigation(!0);ImageControler.currentImageControl.resetFastNavigation();
ImajnetUI.isAfterMouseDown=!0;for(var a=0;a<ImajnetUI.imagesLoadQueue.length;)ImajnetUI.imagesLoadQueue[a].onload=null,a++;ImajnetUI.imagesLoadQueue=[];ImajnetMap.currentPosition&&(ImajnetMap.setCurrentPosition(ImajnetMap.currentPosition),ImajnetMap.setImajboxMarkerPosition({position:ImajnetMap.currentPosition},!0));ImajnetUI.isAfterSwipe=!1},onImageClick:function(a){Nigsys.disableEventPropagationFull(a);if(1!==a.which||ImageControler.currentPhotogrammetry.photogrammetryIsDenied())console.log("event which");
else if(ImajnetUI.contextMenuContainer.is(":visible"))ImajnetUI.hideContextMenu(a),console.log("context menu");else if(ImajnetUI.zoomCancel)ImajnetUI.zoomCancel=!1,console.log("zoomCancel");else if(ImajnetZoom.imageWasDragged&&Nigsys.browserIsIE7())console.error(0),ImajnetZoom.imageWasDragged=!1;else if(ImageControler.currentPhotogrammetry.clearCommentTextarea(a),"TEXTAREA"==a.target.nodeName)console.log("textarea");else if("imajnetErrorsPopupOKButton"==a.target.id)console.log("imajnetErrorsPopupOKButton");
else{var b=ImajnetUI.imajnetImageContainer.offset(),c=a.pageX-b.left,b=a.pageY-b.top;"IMG"!==a.target.nodeName&&"path"!==a.target.nodeName&&"circle"!==a.target.nodeName&&Imajnet3dPosition.clickToNavigate(c,b);if(!ImageControler.currentImageControl.isFastNavigation&&!ImajnetUI.isAfterSwipe)switch(ImajnetUI.activeControlButton){case "imajnetPosition":ImajnetPosition.positionObject(c,b);break;case "imajnetPolyligne":ImajnetPolyligne.positionObject(c,b)}ImajnetZoom.imageWasDragged=!1;ImajnetUI.isAfterSwipe=
!1;ImageControler.currentImageControl.resetFastNavigation()}},onContextMenu:function(a){if(!Nigsys.isPositionMode()&&!Nigsys.isPolyligneMode()||"IMG"==a.target.nodeName||"measurementText"==a.target.className||jQuery("#imajnetErrorsPopup").is(":visible"))return!1;ImageControler.currentPhotogrammetry.setContextMenuHTML();var b=ImajnetUI.contextMenuContainer.outerWidth(),c=ImajnetUI.contextMenuContainer.outerHeight(),d=a.pageX-jQuery(this).offset().left;a=a.pageY-jQuery(this).offset().top;d+b>=jQuery("#"+
ImajnetUI.imageContainerId).width()&&(d-=b);a+c>=jQuery("#"+ImajnetUI.imageContainerId).height()&&(a-=c);ImajnetUI.contextMenuContainer.show().css({left:d,top:a});return!1},hideContextMenu:function(a){a&&3==a.which||ImajnetUI.contextMenuContainer&&ImajnetUI.contextMenuContainer.hide()},onImageDblClick:function(a){if(a.target&&("popupImajnetImage"==a.target.id||"zMapCanvas"==a.target.id||"svg"==a.target.nodeName.toLowerCase())&&!Nigsys.isPositionMode()&&!Nigsys.isPolyligneMode())if(1==ImageControler.currentSurveyTrace.moveImageToClickPosition)ImageControler.currentSurveyTrace.onImageDbClick(a);
else ImageControler.currentPhotogrammetry.addImageTag(a)},imajnetImageLayerMouseOver:function(a){ImajnetUI.registerKeyboardEvents(a);LRS.onImageLRSMouseOut();ImajnetUI.imajnetImageSliderContainer.focus()},imajnetImageLayerMouseOut:function(a){Imajnet3dPosition.clearCanvas();a.toElement&&!jQuery.contains(document.getElementById(ImajnetUI.imageContainerId),a.toElement)&&jQuery(document).trigger("mouseup")},mouseMoveTimeout:null,imageContainerMouseMove:function(a){Imajnet3dPosition.lastMouseEvent=a;
if(Imajnet3dPosition.isActive)Imajnet3dPosition.onImageContainerMousemove(a)},showNavigationCircle:function(a){Imajnet3dPosition.clearCanvas();var b=ImajnetUI.imajnetImageContainer.offset(),b=ImajnetZoom.getRealImageCoordinates(a.pageX-b.left,a.pageY-b.top);if(a=Imajnet3dPosition.getGroundPoint({mPts:[{mPixel_pt:b}]}))b=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(b),Imajnet3dPosition.drawEllipseByCenter(Imajnet3dPosition.canvasCtx,b.x,b.y,150/a.mPts[0].mDist*2,75/a.mPts[0].mDist*2),Imajnet3dPosition.canvasCtx.fillStyle=
"rgba(0, 0, 255, 0.25)",Imajnet3dPosition.canvasCtx.fill(),Imajnet3dPosition.mapMarker=ImajnetPlugin.addMarker(ImajnetMap.imajnetDragFeaturesLayer,{lon:a.mPos_llh[0],lat:a.mPos_llh[1],type:ImajnetMap.markerType.IMAGE_POINT,imagePath:Imajnet.imajnetPath+"img/map3dPositionBlue.png?"+Imajnet.version,size:{width:10,height:10}})},onDragEnd:function(a,b,c){ImajnetUI.isAfterLRSSearch?(ImajnetUI.isAfterLRSSearch=!1,ImageControler.currentImageControl.resetFastNavigation()):(a=parseInt(a),b=parseInt(b),a>=
b?(ImageControler.currentImageControl.resetFastNavigation(),ImajnetUI.stopSwipeNavigation(!0)):(ImageControler.currentImageControl.setFastNavigation(),a==b-1&&ImageControler.currentImageControl.resetFastNavigation(),window.ImageControler.currentImageControl[c](!1),a++,ImajnetUI.imageNavigationTimer=setTimeout("ImajnetUI.onDragEnd('"+a+"', '"+b+"', '"+c+"')",ImajnetUI.swipeImageTimeout)))},enableSwipeHandlers:function(){ImajnetUI.imajnetImageContainer.swipe("enable")},disableSwipeHandlers:function(){Nigsys.onMobile()||
ImajnetUI.imajnetImageContainer.swipe("disable")},navigateOnSwipe:function(a,b,c,d,e){if(1<e||3==a.which)return!0;ImajnetUI.imageNavigationTimer&&(clearTimeout(ImajnetUI.imageNavigationTimer),ImajnetUI.imageNavigationTimer=null);if("up"!==b&&"down"!==b||0<ImajnetZoom.zoomLevel||ImajnetUI.imajnetZoomOnShiftBox.is(":visible"))return!0;ImajnetUI.isAfterSwipe=!0;a=1;c*=1E3/window.screen.availHeight;100<c&&(d=(c/d).toFixed(4),a=Math.floor(30*d+.5),1>a&&(a=1));1<a&&(ImageControler.currentImageControl.setFastNavigation(),
ImajnetUI.imajnetImageContainer.on("vmousedown",ImajnetUI.onImageMouseDown));if("down"==b)ImajnetUI.onDragEnd(0,a,"getNext");else if("up"==b)ImajnetUI.onDragEnd(0,a,"getPrevious")},addSwipeHandlers:function(){if(Nigsys.onMobile()||Nigsys.isTouchDevice())if(ImajnetUI.imajnetImageContainer.swipe({swipe:function(a,b,c,d,e){ImajnetUI.navigateOnSwipe(a,b,c,d,e)},threshold:10,pinchIn:function(a,b,c,d,e,f,g){ImajnetZoom.zoomOnPinch(a,g,1,c)},pinchOut:function(a,b,c,d,e,f,g){ImajnetZoom.zoomOnPinch(a,g,-1,
c)},fingers:jQuery.fn.swipe.fingers.ALL}),Nigsys.onMobile())return;ImajnetUI.imajnetImageSliderContainer.on({vmousedown:function(a){if("svg"==a.target.nodeName||"CANVAS"==a.target.nodeName||"popupImajnetImage"==a.target.id)ImajnetUI.swipeDragXStartPosition=a.offsetY,ImajnetUI.swipeDragXStartTime=new Date,a.preventDefault()},vmouseup:function(a){if("svg"==a.target.nodeName||"CANVAS"==a.target.nodeName||"popupImajnetImage"==a.target.id){var b=Math.abs(a.offsetY-ImajnetUI.swipeDragXStartPosition);40<
b&&ImajnetUI.navigateOnSwipe(a,a.offsetY<ImajnetUI.swipeDragXStartPosition?"up":"down",b,new Date-ImajnetUI.swipeDragXStartTime,1)}}})},createImageContainer:function(){if(this.imageContainer){this.imageContainer.html('\x3cdiv id\x3d"imajnetImageSliderContainer" tabindex\x3d"-1"\x3e\x3cdiv id\x3d"imajnetImageSliderInnerContainer"\x3e\x3cdiv id\x3d"imajnetLayerLeft" class\x3d"left imajnetImageSliderItem imajnetLoading"\x3e'+ImajnetUI.getSliderLeftImage("")+'\x3c/div\x3e\x3cdiv id\x3d"imajnetLayerLeftArrow" class\x3d"left imajnetImageSliderArrowContainer"\x3e\x3cimg id\x3d"imajnetLayerLeftArrowImage" class\x3d"imajnetImageSliderArrow" src\x3d"" class\x3d"popupImajnetImage" /\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetImageLayer" class\x3d"left" data-ythreshold\x3d"15"\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetLayerRightArrow" class\x3d"left imajnetImageSliderArrowContainer"\x3e\x3cimg id\x3d"imajnetLayerRightArrowImage" class\x3d"imajnetImageSliderArrow" src\x3d"" class\x3d"popupImajnetImage" /\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetLayerRight" class\x3d"left imajnetImageSliderItem imajnetLoading"\x3e'+
ImajnetUI.getSliderRightImage("")+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e");this.imajnetImageSliderContainer=jQuery("#imajnetImageSliderContainer");this.imajnetImageSliderInnerContainer=jQuery("#imajnetImageSliderInnerContainer");this.sliderLeftImageContainer=jQuery("#imajnetLayerLeft");this.sliderRightImageContainer=jQuery("#imajnetLayerRight");this.sliderLeftImage=jQuery("#imajnetLayerLeftImage");this.sliderRightImage=jQuery("#imajnetLayerRightImage");this.imajnetImageContainer=jQuery("#imajnetImageLayer");
this.imajnetImageContainer.on({mouseup:function(){ImajnetUI.isAfterMouseDown&&(ImageControler.currentImageControl.doRequests(ImajnetMap.currentPosition),ImajnetUI.isAfterMouseDown=!1)},dblclick:this.onImageDblClick,vmouseover:this.imajnetImageLayerMouseOver,mousemove:this.imageContainerMouseMove,vmouseup:ImajnetZoom.shiftZoomEnd,vmouseout:this.imajnetImageLayerMouseOut});if(Nigsys.isMobileBrowser())this.imajnetImageContainer.on("vclick",this.onImageClick);else this.imajnetImageContainer.on("click",
this.onImageClick);this.imajnetImageContainer.on("contextmenu",ImajnetUI.onContextMenu);jQuery(document).on("click",ImajnetUI.hideContextMenu);this.imajnetImageContainer.append('\x3cdiv id\x3d"imajnetSurveyTraceLayer"\x3e\x3c/div\x3e');this.imajnetSurveyTraceContainer=jQuery("#imajnetSurveyTraceLayer");this.imajnetImageContainer.append('\x3cimg id\x3d"popupImajnetImage" src\x3d"" class\x3d"popupImajnetImage" /\x3e');jQuery("#popupImajnetImage").css({width:"100%",height:"100%"});this.imajnetImageContainer.append('\x3cdiv id\x3d"imajnetZoomOnShiftBox"\x3e\x3c/div\x3e');
this.imajnetZoomOnShiftBox=jQuery("#imajnetZoomOnShiftBox");this.imajnetImage=jQuery("#popupImajnetImage");try{this.imajnetImageSliderInnerContainer.draggable({disabled:!0,start:function(a,c){if(ImageControler.currentImageControl.isFastNavigation)return!1;ImajnetZoom.imageWasDragged=!0;ImajnetUI.isAfterSliderDrag=!0;ImajnetUI.dragImageSliderCount=0},drag:function(a,c){if(-1!=ImajnetUI.dragImageSliderPrevX){var d="";ImajnetUI.dragImageSliderPrevX>a.pageX?d="left":ImajnetUI.dragImageSliderPrevX<a.pageX&&
(d="right");ImajnetUI.dragImageSliderPrevX=a.pageX;if(ImajnetUI.imajnetImage.width()>ImajnetUI.imajnetImageContainerSize.width&&1==ImajnetUI.dragImageSliderCount&&("left"==d&&0==ImajnetUI.imajnetImage.position().left||"right"==d&&ImajnetZoom.imageDragRightReachEnd()))return ImajnetUI.disableDraggable(ImajnetUI.imajnetImageSliderInnerContainer),ImajnetUI.enableImageDrag(),ImajnetUI.dragImageSliderPrevX=-1,!1}ImajnetUI.dragImageSliderPrevX=a.pageX;ImajnetUI.dragImageSliderCount++;ImajnetUI.imajnetImage.removeClass("opacity30");
d=c.position.left-c.originalPosition.left;if(0<d&&ImajnetImageSwitcher.dragLeftPosition)ImajnetUI.sliderLeftImage&&ImajnetUI.sliderLeftImage.attr("src")||ImajnetUI.sliderLeftImageContainer.hasClass("imajnetLayerNoImage")||(ImajnetUI.sliderLeftImageContainer.html(ImajnetUI.getSliderLeftImage("")),ImajnetUI.sliderLeftImage=jQuery("#imajnetLayerLeftImage"),ImajnetImageSwitcher.loadImageForSlider(ImajnetUI.sliderLeftImage,ImajnetImageSwitcher.dragLeftPosition)),d>ImajnetUI.imajnetImageContainerSize.width/
3&&ImajnetUI.imajnetImage.addClass("opacity30");else if(0>d&&ImajnetImageSwitcher.dragRightPosition)return ImajnetUI.sliderRightImage&&ImajnetUI.sliderRightImage.attr("src")||ImajnetUI.sliderLeftImageContainer.hasClass("imajnetLayerNoImage")||(ImajnetUI.sliderRightImageContainer.html(ImajnetUI.getSliderRightImage("")),ImajnetUI.sliderRightImage=jQuery("#imajnetLayerRightImage"),ImajnetImageSwitcher.loadImageForSlider(ImajnetUI.sliderRightImage,ImajnetImageSwitcher.dragRightPosition)),-1*d>ImajnetUI.imajnetImageContainerSize.width/
3&&ImajnetUI.imajnetImage.addClass("opacity30"),!0},stop:function(a,c){var d=ImajnetUI.imajnetImage.offset();if(0>d.left&&d.left>-(ImajnetUI.imajnetImage.width()-ImajnetUI.popupImajnetControlsLayer.width()))ImajnetZoom.imageDrag(a,c);else{ImajnetUI.imajnetImage.removeClass("opacity30");var d=!1,e=c.position.left-c.originalPosition.left;e>ImajnetUI.imajnetImageContainerSize.width/3?(ImajnetImageSwitcher.dragSliderLeft(),d=!0):-1*e>ImajnetUI.imajnetImageContainerSize.width/3&&(ImajnetImageSwitcher.dragSliderRight(),
d=!0);d?ImajnetZoom.imageWasDragged=!1:ImajnetUI.setSliderScrollLeft(ImajnetUI.imajnetImageContainerSize.width);Nigsys.getElementWidth(ImajnetUI.imajnetImage[0])>Nigsys.getElementWidth(ImajnetUI.imajnetImageContainer[0])&&ImajnetUI.enableImageDrag();setTimeout("ImajnetUI.isAfterSliderDrag \x3d false;",200);return!0}}})}catch(b){}Nigsys.isIOS()&&(ImajnetUI.swipeImageTimeout=600);ImajnetUI.addSwipeHandlers();this.imajnetImageContainer.append('\x3cdiv id\x3d"popupImajnetControlsLayer"\x3e\x3c/div\x3e');
this.popupImajnetControlsLayer=jQuery("#popupImajnetControlsLayer");this.imajnetImageContainer.append('\x3cdiv id\x3d"imajnetErrorsPopup" onclick\x3d"ImajnetUI.hideError();"\x3e\x3cdiv id\x3d"imajnetErrorsPopupText"\x3e\x3c/div\x3e\x3cbr/\x3e\x3cinput type\x3d"button" id\x3d"imajnetErrorsPopupOKButton" value\x3d"'+jQuery.imajnet.button.ok+'" onclick\x3d"jQuery(\'#imajnetErrorsPopup\').hide(); ImajnetUI.errorOkClick()"/\x3e\x3c/div\x3e');try{this.imajnetImage.draggable({disabled:!0,start:function(a,
c){ImajnetZoom.imageDragStart(a,c)},drag:function(a,c){ImajnetZoom.imageDrag(a,c)},stop:function(a,c){ImajnetUI.isDragMode=!1;ImajnetZoom.dragDirection="";ImajnetZoom.dragDirectionVertical="";ImajnetZoom.imageDragStop(a,c)}}),this.popupImajnetControlsLayer.draggable({disabled:!0,start:function(a,c){ImajnetZoom.imageDragStart(a,c)},drag:function(a,c){ImajnetZoom.imageDrag(a,c)},stop:function(a,c){ImajnetUI.isDragMode=!1;ImajnetZoom.imageWasDragged=!0;ImajnetZoom.dragDirection="";ImajnetZoom.dragDirectionVertical=
"";if(!ImageControler.currentGraphic.constraintSVG)ImajnetZoom.onImageDragStop(a,c)}})}catch(b){}var a=this.getImageContainerDimesions();this.resizeImageElements(a.width,a.height,!0);ImajnetZoom.init(a.width,a.height);this.imajnetImageContainer.addClass("scrollable");ImajnetUI.appendControls();this.imajnetImage.attr("alt","");ImajnetUI.appendImajnetClientLogo();Nigsys.browserIsSafari()&&(jQuery("#popupImajnet, #map").addClass("overflowVisible"),jQuery("body").addClass("isSafari"))}},appendImajnetClientLogo:function(){0==
jQuery("#imajnetClientLogo").length&&(ImajnetUI.imageContainer.append('\x3cdiv id\x3d"imajnetClientLogo"\x3e\x3c/div\x3e'),ImajnetUI.clientLogoContainer=jQuery("#imajnetClientLogo"));if(Nigsys.browserIsIE()){var a=jQuery("\x3cimg /\x3e");ImajnetUI.clientLogoContainer.html(a);jQuery.ajax({type:"GET",url:ImajnetProtocol.getUsernameForUrl(ImajnetAPI.getImajnetRequestUrl("/api/user/logo")),crossDomain:{crossDomain:!0},xhrFields:{withCredentials:!0},beforeSend:function(a){a.setRequestHeader("metadata",
Imajnet.metadata);a.setRequestHeader("imajnet-app-key",Imajnet.applicationKey);a.overrideMimeType("text/plain; charset\x3dx-user-defined")},timeout:2E5,cache:!1,success:function(b,d,e){if(!(1>b.length)){b="";e=e.responseText;d=e.length;for(i=0;i<d;i++)b+=String.fromCharCode(e.charCodeAt(i)&255);e=btoa(b);b="image/png";"/"==e.charAt(0)?b="image/jpeg":"R"==e.charAt(0)?b="image/gif":"i"==e.charAt(0)&&(b="image/png");a.attr("src","data:"+b+";base64,"+e).css({height:"100%",width:"auto"})}}})}else{var b=
new Image;b.onload=function(){if(this.complete&&"undefined"!=typeof this.naturalWidth&&0!=this.naturalWidth){var a;a=this.naturalWidth/this.naturalHeight;var d=ImajnetUI.clientLogoContainer.width()/ImajnetUI.clientLogoContainer.height();a=a<d?{width:"auto",height:"100%"}:{width:"100%",height:"auto"};jQuery(this).css(a);ImajnetUI.clientLogoContainer.html(b)}else console.log("broken image!")};b.src=ImajnetProtocol.getUsernameForUrl(ImajnetAPI.getImajnetRequestUrl("/api/user/logo"))}},errorOkClick:function(){},
donwloadImajnetImage:function(){ImajnetMap.currentPosition&&window.open(ImajnetAPI.buildImageURLWithResolution(ImajnetMap.currentPosition,ImajnetSettings.imajnetImageResolutions[3]))},appendControls:function(){ImajnetUI.popupImajnetControlsLayer.append('\x3cdiv id\x3d"imajnetImageSwitcherImageContainer"\x3e\x3cimg id\x3d"imajnetImageSwitcherImage" /\x3e\x3c/div\x3e');ImajnetUI.popupImajnetControlsLayer.append('\x3ccanvas id\x3d"zMapCanvas"\x3e\x3c/canvas\x3e');Imajnet3dPosition.canvas=jQuery("#zMapCanvas")[0];
Imajnet3dPosition.canvasCtx=Imajnet3dPosition.canvas.getContext("2d");this.imageSwitcherImageContainer=jQuery("#imajnetImageSwitcherImageContainer");this.imageSwitcherImageContainer.on({vmouseover:function(){jQuery(this).hide()}});this.imageSwitcherImage=jQuery("#imajnetImageSwitcherImage");ImajnetUI.docking.imageButtons&&ImajnetUI.docking.imageButtons.mainContainer.remove();ImajnetUI.docking.imageButtons=new ImajnetDocking(ImajnetUI.imageContainer,'\x3cdiv class\x3d"imajnetControlsLayerButtonsItem" id\x3d"imajnetPositionButtonContainer"\x3e\x3cimg src\x3d"'+
Imajnet.imajnetPath+"img/imageIcons/imajnet3dPosition.png?"+Imajnet.version+'" onclick\x3d"ImajnetPosition.showHidePosition(); ImajnetUI.onImajnetControlsButtonsClick(event);"  title\x3d"'+jQuery.imajnet.map.position.title+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetControlsLayerButtonsItem" id\x3d"imajnetPolyligneButtonContainermeasurement"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/imageIcons/imajnetRuler.png?"+Imajnet.version+'" onclick\x3d"ImajnetPolyligne.showHide(\'polyligne\', true); ImajnetUI.onImajnetControlsButtonsClick(event);" title\x3d"'+
jQuery.imajnet.map.measurement.title+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetControlsLayerButtonsItem" id\x3d"imajnetPolyligneButtonContainerpolyligne"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/imageIcons/imajnetPolyligne.png?"+Imajnet.version+'" onclick\x3d"ImajnetPolyligne.showHide(\'polyligne\'); ImajnetUI.onImajnetControlsButtonsClick(event);" title\x3d"'+jQuery.imajnet.map.polyligne.title+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetControlsLayerButtonsItem" id\x3d"imajnetPolyligneButtonContainerpolygon"\x3e\x3cimg src\x3d"'+
Imajnet.imajnetPath+"img/imageIcons/imajnetPolygon.png?"+Imajnet.version+'" onclick\x3d"ImajnetPolyligne.showHide(\'polygon\'); ImajnetUI.onImajnetControlsButtonsClick(event);" title\x3d"'+jQuery.imajnet.map.polygon.title+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetControlsLayerButtonsItem" id\x3d"imajnetTraceSurveyButtonContainer" onclick\x3d"ImajnetUI.onImajnetControlsButtonsClick(event);" title\x3d"'+jQuery.imajnet.settings.surveyTrace+'"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/imageIcons/imajnetTrace.png?"+
Imajnet.version+'" onclick\x3d"ImageControler.currentSurveyTrace.showHideSurveyTrace(); ImajnetUI.onImajnetControlsButtonsClick(event);" /\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetControlsLayerButtonsItem" id\x3d"imajnetZoomButtonContainer"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/imageIcons/imajnetZoom.png?"+Imajnet.version+'" onclick\x3d"ImajnetZoom.activateDeactivateZoom(); ImajnetUI.onImajnetControlsButtonsClick(event);" title\x3d"'+jQuery.imajnet.image.zoomButton+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetControlsLayerButtonsItem" id\x3d"imajnetSaveImage" style\x3d"margin-bottom: 4px;"\x3e\x3cimg src\x3d"'+
Imajnet.imajnetPath+"img/imageIcons/imajnetSnapshot.png?"+Imajnet.version+'"  onclick\x3d"ImajnetUI.donwloadImajnetImage(); ImajnetUI.onImajnetControlsButtonsClick(event);"  title\x3d"'+jQuery.imajnet.image.save+'" /\x3e\x3c/div\x3e',"Right","imageButtons",{width:32,height:200,right:0,top:ImajnetUI.imageContainer.height()/2-100});CheckDockingCookie("imageButtons");ImajnetUI.imageContainer.append('\x3cdiv id\x3d"imajnetPreviewPanel"\x3e\x3c/div\x3e');ImajnetUI.imageContainer.append('\x3cdiv id\x3d"imajnetImageContextMenu"\x3e\x3c/div\x3e');
ImajnetUI.contextMenuContainer=jQuery("#imajnetImageContextMenu");ImajnetUI.imageContainer.append('\x3cdiv id\x3d"imajnetImageSwitcher"\x3e\x3c/div\x3e');ImajnetUI.popupImajnetControlsLayer.append('\x3cdiv id\x3d"imajnetPhotogrammetryZoomedImageContainer"\x3e\x3cimg id\x3d"imajnetPhotogrammetryZoomedImage" src\x3d"" onmouseover\x3d"ImageControler.currentPhotogrammetry.previewPanelMouseOver();" /\x3e\x3c/div\x3e');ImajnetUI.previewImageContainer=jQuery("#imajnetPhotogrammetryZoomedImageContainer");
ImajnetUI.previewImage=jQuery("#imajnetPhotogrammetryZoomedImage");Imajnet.options.archiving&&(ImajnetUI.imageContainer.append('\x3cdiv id\x3d"imajnetUnarchiveContainer" style\x3d"display: none"\x3e'+jQuery.imajnet.management.unarchiveSequence.title+"\x3c/div\x3e"),ImajnetUI.imajnetUnarchiveContainer=jQuery("#imajnetUnarchiveContainer"),ImajnetUI.imajnetUnarchiveContainer.on("click",ImajnetUI.unarchiveSequence));Address.init();LRS.init()},onImajnetControlsButtonsClick:function(a){Nigsys.disableEventPropagation(a);
jQuery("#imajnetErrorsPopup").hide();ImajnetUI.hideContextMenu(a)},isPreviewPanelDisabled:function(){var a="";return(a=Nigsys.isPositionMode()?"position":ImajnetPolyligne.getType())?Nigsys.getCookie("IMAJNET","PREVIEW_PANEL_"+a)?!0:!1:!1},disablePreviewPanel:function(){var a="";if(a=Nigsys.isPositionMode()?"position":ImajnetPolyligne.getType())Nigsys.setCookie("IMAJNET","PREVIEW_PANEL_"+a,(new Date).getTime()),jQuery("#imajnetPreviewPanel").hide()},showImajnetControls:function(){ImajnetUI.popupImajnetControlsLayer&&
ImajnetUI.popupImajnetControlsLayer.show()},hideImajnetControls:function(){ImajnetUI.popupImajnetControlsLayer&&ImajnetUI.popupImajnetControlsLayer.hide()},showImage:function(){this.imajnetImage.css("display","block");ImajnetZoom.imageIsZoomed()?(this.setImageContainerSize(this.imajnetImageContainer.width(),this.imajnetImageContainer.height()),ImajnetZoom.resetZoom()):ImajnetZoom.setDraggableContainment()},hideImage:function(){this.imajnetImage.hide()},appendDefaultImage:function(){this.appendImage(Imajnet.imajnetPath+
"img/noVideo.png?"+Imajnet.version);this.imajnetImage.addClass("popupImajnetDefaultImage");this.imajnetImage.css("margin-top",(this.imageContainer.height()-445)/2);this.imajnetImageContainer.addClass("imajnetDefaultImageLayer")},appendImage:function(a){this.imajnetImage.removeClass("popupImajnetDefaultImage");this.imajnetImageContainer.removeClass("imajnetDefaultImageLayer");this.imajnetImage.attr("src",a);this.imajnetImage.css("margin-top",0);this.showImage()},showError:function(a,b,c){b?(jQuery("#imajnetErrorsPopupOKButton").show(),
ImajnetUI.errorOkClick="function"==typeof c?c:function(){}):jQuery("#imajnetErrorsPopupOKButton").hide();jQuery("#imajnetErrorsPopupText").html(a);jQuery("#imajnetErrorsPopup").show()},hideError:function(){jQuery("#imajnetErrorsPopupText").html("");jQuery("#imajnetErrorsPopup").hide()},setImageContainerSize:function(a,b){this.imajnetImageContainerSize.width=a;this.imajnetImageContainerSize.height=b;ImajnetUI.imageContainer.width(a);ImajnetUI.imageContainer.height(b)},setSlidersWidth:function(a){this.imajnetImageSliderInnerContainer.css("width",
Math.floor(3*a+2*ImajnetImageSwitcher.dragArrowWidth+1));ImajnetUI.imajnetImageSliderContainer.css("width",a);jQuery(".imajnetImageSliderItem").css("width",a);jQuery(".imajnetLayerSliderImage").css("width",a);ImajnetUI.setSliderScrollLeft(a)},resizeSliders:function(a,b){this.imajnetImageSliderInnerContainer.css("height",b);ImajnetUI.imajnetImageSliderContainer.css("height",b);jQuery(".imajnetImageSliderItem").css("height",b);jQuery(".imajnetLayerSliderImage").css("height",b);jQuery(".imajnetImageSliderArrowContainer").css("height",
b);jQuery(".imajnetImageSliderArrow").css("margin-top",b/2-23);ImajnetUI.setSlidersWidth(a)},getLargeImageWidthOverflow:function(){return!ImajnetUI.fullSizeAspectRatio||1.2>ImajnetUI.fullSizeAspectRatio?0:ImajnetZoom.HIGH_RESOLUTION_WIDTH/ImajnetZoom.HIGH_RESOLUTION_HEIGHT-ImajnetUI.imageAspectRatio},onImageResize:function(a){if(ImajnetUI.imageContainer){var b=ImajnetUI.imageContainer.parent().width(),c=ImajnetUI.imageContainer.parent().height();jQuery(".imajnetPopupTitleBar").length&&(c-=jQuery(".imajnetPopupTitleBar").height());
b&&c||(b=ImajnetUI.imajnetImageContainerSize.width,c=ImajnetUI.imajnetImageContainerSize.height);ImajnetUI.resizeImageElements(b,c,!1,a)}},moveSurveyTraceContainerToLeft:function(a){ImajnetUI.imajnetSurveyTraceContainer.css("left",parseInt(a))},resizeImageElement:function(a,b){if(ImajnetUI.fullSizeAspectRatio){var c=a*this.getLargeImageWidthOverflow();a=parseInt(a+c);this.imajnetImage.css("width",a);var d=-(c/2);if(!ImajnetAPI.isSameSequence||ImajnetUI.getLargeImageWidthOverflow()&&(-1==ImajnetZoom.left||
ImajnetZoom.left<2*d))ImajnetZoom.left=d;-0==ImajnetZoom.left&&(ImajnetZoom.left=0);ImajnetZoom.left&&-1!=ImajnetZoom.left?ImajnetZoom.moveToLeft(ImajnetZoom.left):c||ImajnetZoom.moveToLeft(0);this.imajnetImage.css("height",b);this.imajnetSurveyTraceContainer.css("width",a);this.imajnetSurveyTraceContainer.css("height",b);this.imajnetImageContainerInitialSize={width:a,height:b}}},resizeImageElements:function(a,b,c,d){this.imajnetImageContainer.css("width",a);this.imajnetImageContainer.css("height",
b);this.setImageContainerSize(a,b);ImajnetUI.resizeImageElement(a,b);this.imajnetImage.hasClass("popupImajnetDefaultImage")&&this.imajnetImage.css("margin-top",(b-445)/2);Imajnet3dPosition.realImageToContainerRatio=(a/ImajnetZoom.HIGH_RESOLUTION_WIDTH+b/ImajnetZoom.HIGH_RESOLUTION_HEIGHT)/2;Imajnet3dPosition.setCanvasSize(a,b);ImajnetZoom.imageIsZoomed()?ImajnetZoom.left<-(a*this.getLargeImageWidthOverflow())?(ImajnetZoom.resetZoom(),ImajnetZoom.left=-(a*this.getLargeImageWidthOverflow())):ImajnetZoom.resetZoom(d):
(ImajnetZoom.width=ImajnetUI.imajnetImageContainerInitialSize.width,ImajnetZoom.height=ImajnetUI.imajnetImageContainerInitialSize.height);ImajnetUI.resizeSliders(a,b);SurveyTrace.onImageResize(ImajnetUI.imajnetImageContainerInitialSize.width,ImajnetUI.imajnetImageContainerInitialSize.height);ImageControler.currentPhotogrammetry.onResize(a,b);ImajnetZoom.setDraggableContainment();if(this.LRSGUI)this.LRSGUI.onResize();if("CUBE"==ImageControler.currentImageType)CubePlugin.onWindowResize()},buttonIsActive:function(a){return a?
a.hasClass("opacity60"):!1},addActiveState:function(a){a&&ImajnetPlugin.addActiveState(a)},removeActiveState:function(a){a&&ImajnetPlugin.removeActiveState(a)},showAndPositionInside:function(a,b){var c=a.position();c.top+b.height()>CommonCore.mapContainer.height()?b.css("top",-(b.height()-20)):b.css("top",0);c.left<b.width()?b.css("left",20+(Nigsys.onMobile()?10:0)):b.css("left",-(b.width()-5+(Nigsys.onMobile()?15:0)));b.show()},showAndPositionInsideNear:function(a,b,c){b.top+c.height()+b.height>
a.height()?c.css("top",b.top-c.height()-10):c.css("top",b.top+b.height+5);b.left+c.width()>a.width()?c.css("left",a.width()-c.width()-20):c.css("left",b.left);c.show()},activateImajnetToolbarButtons:function(){jQuery(this.btnClosestImageDiv).removeClass("opacity30");jQuery(this.btnClickModeDiv).removeClass("opacity30");jQuery(this.btnEnableClipboardDiv).removeClass("opacity30");jQuery("#imajnetSettingsButton").removeClass("opacity30");jQuery("#imajnetHelpButton").removeClass("opacity30")},deactivateImajnetToolbarButtons:function(){jQuery(this.btnClosestImageDiv).removeClass("opacity60").addClass("opacity30");
jQuery(this.btnClickModeDiv).removeClass("opacity60").addClass("opacity30");jQuery(this.btnEnableClipboardDiv).removeClass("opacity60").addClass("opacity30");jQuery("#imajnetSettingsButton").removeClass("opacity60").addClass("opacity30");jQuery("#imajnetHelpButton").removeClass("opacity60").addClass("opacity30")},addToolControls:function(){this.activateImajnetToolbarButtons()},disableToolControls:function(){for(var a=0,b=this.controlActivatorContainers.length;a<b;++a)this.controlActivatorContainers[a].controlName!=
ImajnetUI.controlNames.showClipboard&&this.controlActivatorContainers[a].controlName!=ImajnetUI.controlNames.searchLRS&&this.removeActiveState(this.controlActivatorContainers[a].buttonElement)},hideShiftBox:function(){ImajnetUI.imajnetZoomOnShiftBox&&(ImajnetUI.imajnetZoomOnShiftBox.width(0),ImajnetUI.imajnetZoomOnShiftBox.height(0),ImajnetUI.imajnetZoomOnShiftBox.hide())},showItem:function(a,b,c){ImajnetPlugin.showImajnetItem(a,b,c)},hideItem:function(a){ImajnetPlugin.hideImajnetItem(a)},hideImageElements:function(){jQuery("#popupImajnetDate").html("");
ImageControler.currentSurveyTrace&&ImageControler.currentSurveyTrace.hideTrace();"undefined"!==typeof ImajnetPosition&&ImajnetPosition.hidePosition(!0);"undefined"!==typeof ImajnetMeasurement&&ImajnetMeasurement.hideMeasurement(!0);"undefined"!==typeof ImajnetPolyligne&&ImajnetPolyligne.hide(!0);Address.hideAddress();LRS.removeLRS();ImajnetUI.docking.imageButtons&&ImajnetUI.docking.imageButtons.mainContainer.hide();ImajnetUI.hideImajnetControls()},removeImageElements:function(){jQuery("#"+ImajnetUI.imageContainerId).remove();
ImajnetUI.imageContainer=null;ImajnetUI.clipboardContainerId==ImajnetUI.clipboardContainerIdDefault?jQuery("#"+ImajnetUI.clipboardContainerId).remove():jQuery("#"+ImajnetUI.clipboardContainerId).html("");ImajnetUI.clipboardContainer=null;ImajnetUI[ImajnetUI.clipboardContainerId]=null;ImajnetUI.clipboardContainerId=null;ImajnetUI.clipboardExportContainerId==ImajnetUI.clipboardExportContainerIdDefault?jQuery("#"+ImajnetUI.clipboardExportContainerId).remove():jQuery("#"+ImajnetUI.clipboardExportContainerId).html("");
ImajnetUI.clipboardExportContainer=null;ImajnetUI[ImajnetUI.clipboardExportContainerId]=null;ImajnetUI.clipboardExportContainerId=null;jQuery("#"+ImajnetUI.helpContainerId).remove();ImajnetUI.helpContainer=null;jQuery("#"+ImajnetUI.aboutImajnetContainerId).remove();ImajnetUI.aboutImajnetContainer=null;jQuery("#"+ImajnetUI.settingsContainerId).remove();ImajnetUI.settingsContainer=null;jQuery("#"+ImajnetUI.settingsLRSContainerId).remove();ImajnetUI.settingsLRSContainer=null;jQuery("#"+ImajnetUI.sequenceDetailsId).remove();
ImajnetUI.sequenceDetails=null;jQuery("#"+ImajnetUI.imageDetailsId).remove();ImajnetUI.imageDetails=null;jQuery("#"+ImajnetUI.groundPlaneDetailsId).remove();ImajnetUI.groundPlaneDetails=null},enableDraggable:function(a){try{a.draggable("enable")}catch(b){}},disableDraggable:function(a){try{a.draggable("disable").removeClass("ui-state-disabled")}catch(b){}},enableImageDrag:function(){ImajnetUI.enableDraggable(ImajnetUI.imajnetImage);ImajnetUI.enableDraggable(ImajnetUI.popupImajnetControlsLayer)},enableImageAllDrag:function(){ImajnetZoom.zKeyPressed=
!1;ImajnetUI.hideShiftBox();ImajnetUI.enableImageDrag()},disableImageDrag:function(){ImajnetUI.disableDraggable(ImajnetUI.imajnetImage);ImajnetUI.disableDraggable(ImajnetUI.popupImajnetControlsLayer)},disableImageAllDrag:function(){ImajnetUI.disableImageDrag();ImajnetUI.disableDraggable(ImajnetUI.imajnetImageSliderInnerContainer)},imajnetKeydownHandler:function(a){try{"textareaEditComment"!=a.target.className&&(ImajnetUI.allowKeyUp=!0,90==a.keyCode?(ImajnetUI.imajnetImageContainer.off("vclick",ImajnetUI.onImageClick),
ImajnetZoom.isZoomMode()||(ImajnetAPI.lastNavigationPositionImageId="",ImajnetZoom.zKeyPressed=!0,ImajnetZoom.doWhenActivateZoom())):16==a.keyCode&&(ImageControler.currentPhotogrammetry.hideObjects(),ImajnetZoom.isZoomMode()||(ImajnetAPI.lastNavigationPositionImageId="",ImajnetZoom.shiftKeyPressed=!0,ImajnetZoom.doWhenActivateZoom())))}catch(b){}},imajnetKeyupHandler:function(a){try{ImageControler.currentImageControl.isFastNavigation&&(ImageControler.currentImageControl.resetFastNavigation(),ImageControler.currentImageControl.doRequests(ImajnetMap.currentPosition)),
ImajnetZoom.zKeyPressed=!1,ImajnetZoom.shiftKeyPressed=!1,!ImajnetUI.allowKeyUp||16!=a.keyCode&&90!=a.keyCode||(ImageControler.currentPhotogrammetry.showObjects(),ImajnetUI.allowKeyUp=!1,ImajnetUI.imajnetZoomOnShiftBox.is(":visible")&&(ImajnetUI.zoomCancel=!0),ImajnetUI.imajnetImageContainer.off("vclick").on("vclick",ImajnetUI.onImageClick),ImajnetZoom.isZoomMode()||(jQuery(".popupImajnetImage").removeClass("zoomCursor"),ImajnetZoom.doWhenDeactivateZoom(),ImajnetUI.imajnetImageContainer.off("vmousedown",
ImajnetZoom.onShiftZoomStart),ImajnetUI.imajnetImageContainer.off("vmousemove",ImajnetZoom.shiftZoomMouseMove),0==ImajnetZoom.zoomLevel?ImajnetUI.enableDraggable(ImajnetUI.imajnetImageSliderInnerContainer):(ImajnetUI.enableImageAllDrag(),jQuery(".popupImajnetImage").removeClass("zoomCursor"),ImajnetZoom.imageWasDragged=!1)))}catch(b){}},clickLogin:function(a){13==a.keyCode&&(Nigsys.errorNotification&&Nigsys.errorNotification.close(),jQuery("#imajnetLoginButton").click())},registerKeyboardEvents:function(a){jQuery("select").blur();
jQuery("input").blur();jQuery(".menu").blur()},showDateContainer:function(){ImajnetUI.imageContainer&&ImajnetUI.imageContainer.length&&ImajnetUI.imageDateContainer&&!Nigsys.isPositionMode()&&!Nigsys.isPolyligneMode()&&ImajnetUI.imageDateContainer.show()},hideDateContainer:function(){ImajnetUI.imageContainer&&ImajnetUI.imageContainer.length&&ImajnetUI.imageDateContainer&&ImajnetUI.imageDateContainer.hide()},imajnetAddImageDate:function(a){if(ImajnetUI.imageContainer&&ImajnetUI.imageContainer.length){this.imageDateContainer||
(ImajnetUI.imageContainer.append('\x3cdiv id\x3d"imageDateContainer" class\x3d"addressAndLRS"\x3e\x3c/div\x3e'),this.imageDateContainer=jQuery("#imageDateContainer"));a=Nigsys.formatImajnetImageDate(a);if(!jQuery("#imajnetImageLRSInTitle").length){var b=ImajnetUI.imageContainer.parent().children(":first"),c=b.attr("class");c&&-1!==c.indexOf("ui-dialog-titlebar")&&(b.append('\x3cspan id\x3d"imajnetImageLRSInTitle"\x3e\x3c/span\x3e'),Nigsys.browserIsIE7()&&jQuery("#imajnetImageLRSInTitle").css("margin-top",
7))}b=jQuery("#popupImajnetDate");b.length?b.html(a):(b=ImajnetUI.imageContainer.parent().children(":first").children(":first"),(c=b.attr("class"))&&-1!==c.indexOf("ui-dialog-title")&&b.html(b.html()+'\x3cspan id\x3d"popupImajnetDate" class\x3d"left"\x3e'+a+"\x3c/span\x3e"));a?(this.imageDateContainer.html(a),this.showDateContainer()):this.hideDateContainer();ImajnetUI.imageDate=a}else this.hideDateContainer()},appendClipboarContainerHTML:function(){ImajnetUI.clipboardContainer.append('\x3cdiv id\x3d"'+
ImajnetUI.clipboardContainerId+'Content" class\x3d"scrollable"\x3e\x3cdiv style\x3d"width: 100%; text-align: center; margin-top: 10px;"\x3e'+jQuery.imajnet.map.clipboard.noItems+'\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"popupImajnetClipboardButtonsContainer"\x3e\x3cinput type\x3d"button" id\x3d"popupImajnetClipboardClearButton" value\x3d"'+jQuery.imajnet.map.clipboard.clearButton+'" onclick\x3d"ImageControler.currentPhotogrammetry.deletePhotogrammetryObjects();" disabled\x3d"disabled" class\x3d"dialogButton buttonDelete" /\x3e\x3cinput type\x3d"button" id\x3d"popupImajnetClipboardExportButton" value\x3d"'+
jQuery.imajnet.map.clipboard.exportButton+'" onclick\x3d"ImageControler.currentPhotogrammetry.showExport();" disabled\x3d"disabled" class\x3d"dialogButton buttonExport" /\x3e\x3c/div\x3e')},sequenceIsArchived:function(a){"HotArchive"==a&&(jQuery("#menuShowArchiveSequence").parent().hide(),jQuery("#menuShowUnarchiveSequence").parent().show(),ImajnetUI.imajnetUnarchiveContainer.show(),ImajnetAPI.stopImageCache=!0)},sequenceIsNotArchived:function(){jQuery("#menuShowArchiveSequence").parent().show();
jQuery("#menuShowUnarchiveSequence").parent().hide();ImajnetUI.imajnetUnarchiveContainer.hide();ImajnetAPI.stopImageCache=!1},doOnKeyDown:function(a){"imajnetPOI"==a.target.id&&(a.preventDefault(),a.stopImmediatePropagation(),a.stopPropagation());if("HTML"==a.target.tagName||"BODY"==a.target.tagName||"DIV"==a.target.tagName||"IMG"==a.target.tagName||"BUTTON"==a.target.tagName)ImajnetUI.hideContextMenu(a),38==a.keyCode?(ImageControler.currentImageControl&&(ImajnetAPI.lastLoadedImageId="",ImageControler.currentImageControl.setFastNavigation(),
ImageControler.currentImageControl.getNext(!1)),a=jQuery(".menu"),a.length&&a.menu("collapseAll",null,!0)):40==a.keyCode?(ImageControler.currentImageControl&&(ImajnetAPI.lastLoadedImageId="",ImageControler.currentImageControl.setFastNavigation(),ImageControler.currentImageControl.getPrevious(!1)),a=jQuery(".menu"),a.length&&a.menu("collapseAll",null,!0)):37==a.keyCode?ImajnetImageSwitcher.dragSliderLeft():39==a.keyCode&&ImajnetImageSwitcher.dragSliderRight()},onKeyDown:function(a){ImajnetUI.doOnKeyDown(a)}};
jQuery(function(){jQuery(document).on("keydown.onKeyDown",ImajnetUI.onKeyDown);jQuery(document).on("keydown",ImajnetUI.imajnetKeydownHandler);jQuery(document).on("keyup",ImajnetUI.imajnetKeyupHandler)});
var ImajnetLRSGUIWidth=100,ImajnetLRSGUIHeight=400,ImajnetLRSGUICommon={roadsPRData:{},getContainerSize:function(c,a,b){return"portrait"==c?{width:a,height:b}:{width:b,height:a}},onImajnetImageRoadChange:function(c){if(c===ImajnetUI.LRSGUI){if("undefined"!==typeof LRSSchematic&&LRSSchematic.LRSGUI){var a=ImajnetLRSGUICommon.roadsPRData[c.currentRoadId].roadId;c.linearPosition&&(LRSSchematic.LRSGUI.linearPosition=Nigsys.cloneObject(c.linearPosition));LRSSchematic.onRoadChange(a,LRSSchematic.LRSGUI.linearPosition.road);
Nigsys.getComboboxInputContainer(jQuery("#LRSSchematicRoads"))&&(jQuery("#LRSSchematicRoads").append('\x3coption value\x3d"'+LRSSchematic.LRSGUI.linearPosition.road.id+'" title\x3d"'+LRSSchematic.LRSGUI.linearPosition.road.name+'" selected\x3d"selected"\x3e'+LRSSchematic.LRSGUI.linearPosition.road.name+"\x3c/option\x3e"),Nigsys.refreshComboboxContainer(jQuery("#LRSSchematicRoads"),LRSSchematic.LRSGUI.linearPosition.road.name))}}else c.computetMiddlePRIfNotDefined()}},ImajnetLRSGUI=function(c){c={LRSGUISVG:null,
linearPosition:null,container:null,canvasId:c.canvasId?c.canvasId:"",dragContainer:null,containerId:c.id,dragContainerId:c.dragId,orientation:c.orientation?c.orientation:"portrait",containerOffset:0,currentRoadId:-1,lastRoadId:-2,minBound:null,maxBound:null,minBoundOffset:0,maxBoundOffset:0,isZoomMode:!1,zoomBoxIndex:0,zoomRatio:1.2,defaultZoomLevel:9,lastZoomLevel:9,startZoomLevel:0,currentZoomLevel:0,zeroBasedMaxZoomLevel:25,isFirstDraw:!0,prLength:0,sign:0,lastSign:0,centerLinearPosition:0,zoolLevelOnSamePosition:0,
zoomPositionOffset:0,lastZoomPositionOffset:0,lastZoomOffset:0,lastZoomDelta:0,zoomOffset:0,roadRedraw:!0,isDragMode:!1,isAfterDrag:!1,dragZoomLevel:0,dragPositionOffset:0,lastDragPositionOffset:0,dragOffset:0,touchTracks:[],containerWidth:c.width?c.width:ImajnetLRSGUIWidth,containerHeight:c.height?c.height:ImajnetLRSGUIHeight,containerMinHeight:270,roadStrokeWidth:6,trainStrokeWidth:5,roadXOffset:30,prSize:19,positionCircleRadius:8,orientationSize:15,PRLineLineIndicatorWidth:60,PRTextLineIndicatorWidth:30,
PRTextOffset:8,PRFontSize:9,PRDivisionWidth:8,PRDivisionOffset:40,PRDivisionsFontSize:9,lineIndicatorStrokeWidth:2,redrawRoad:!1,roadType:1,LRSResponse:null,PRStart:0,PREnd:0,unit:"m",onDrawRoadEnd:function(){return jQuery.Deferred().resolve().promise()},onGoToClickedPoint:function(a){LRS.onSearch(Object({roadIdentifier:this.linearPosition.road.id,prNumber:a.prNumber,relativeAbscisa:a.relativeAbscisa}),null,!0)},goToClickedPoint:function(a){if(a=this.getClickedPosition(a,!0))this.onGoToClickedPoint(a)},
mouseDownHandler:function(a){Nigsys.disableEventPropagation(a);this.isDragMode=!0;this.lastDragPositionOffset="portrait"==this.orientation?a.clientY:a.clientX},mouseMoveHandler:function(a){this.isDragMode&&this.drag(a)},disableDragHandler:function(a){this.isDragMode=!1},clickHandler:function(a){if(this.isAfterDrag)this.isAfterDrag=!1;else{ImageControler.currentImageControl.resetFastNavigation();ImajnetUI.stopSwipeNavigation();var b=0,b="portrait"==this.orientation?a.offsetY:a.offsetX;this.goToClickedPoint(b);
Nigsys.disableEventPropagation(a);return!1}},mouseWheelHandler:function(a,b){if(!Nigsys.scrollDeltaIsValid(b))return!1;b=Nigsys.getDelta(a,b);this.resetZoom();this.zoom(a,b);"function"===typeof a.preventDefault&&a.preventDefault()},positionTop:function(){if(ImajnetUI.docking.imageLRSGUI&&!Nigsys.getCookie("IMAJNET","DOCKING_imageLRSGUI_position")){var a=(ImajnetUI.imageContainer.height()-this.containerHeight-55)/2;0>a&&(a=0);ImajnetUI.docking.imageLRSGUI.positionOnTop(a)}},resizeHeight:function(){var a=
parseInt(.6*ImajnetUI.imageContainer.height());a<this.containerMinHeight&&(a=this.containerMinHeight);return this.containerHeight!=a?(this.containerHeight=a,this.positionTop(),!0):!1},redraw:function(){ImageControler.currentGraphic.clearLRSGUI(this);this.container&&(this.container.html(""),this.LRSGUISVG=null);this.init();this.redrawRoad=!0;this.LRSResponse&&this.draw(this.LRSResponse)},onResize:function(){"undefined"===typeof keepDockingInsideParent||this.resizeHeight()?("object"===typeof ImajnetUI&&
"object"===typeof ImajnetUI.LRSGUI&&this===ImajnetUI.LRSGUI&&ImajnetUI.initLRSGUIDocking(this.containerWidth,this.containerHeight),this.redraw()):keepDockingInsideParent()},firstTouch:null,lastTouch:null,getTouchPosition:function(a){return[a.originalEvent.touches[0].pageY,a.originalEvent.touches[1].pageY]},initSize:function(a){this.container&&(this.isZoomMode=this.isDragMode=!1,this.container.width(a.width),this.dragContainer.width(a.width),this.container.height(a.height),this.dragContainer.height(a.height),
"imajnetLRSGUI"==this.containerId&&this.dragContainer.css("top",-a.height),a=this.containerHeight,this.roadStrokeWidth=a/66,10<this.roadStrokeWidth&&(this.roadStrokeWidth=10),this.roadXOffset=parseInt(this.containerWidth/3),this.orientationSize=a/26,this.PRLineLineIndicatorWidth=a/9,this.PRTextLineIndicatorWidth=a/20,this.PRDivisionOffset=parseInt(this.containerWidth/4),this.PRDivisionsFontSize=this.PRFontSize)},removeLRSGUI:function(){this.LRSGUISVG&&(this.LRSGUISVG.remove(),this.LRSGUISVG=null)},
init:function(){this.container=jQuery('div[id\x3d"'+this.containerId+'"]');this.dragContainer=jQuery('div[id\x3d"'+this.dragContainerId+'"]');this.dragContainer.css("background-color","transparent");this.dragContainer.css("z-index",3);this.dragContainer.css("position","relative");this.dragContainer.css("left",0);this.initSize(ImajnetLRSGUICommon.getContainerSize(this.orientation,this.containerWidth,this.containerHeight));Graphic.initLRSGUI(this);var a=this,b=this.container;this.dragContainer&&this.dragContainer.length&&
(b=this.dragContainer);if(Nigsys.onMobile())b.off().on({tap:function(h){a.isAfterDrag=!1;var b=jQuery(h.target).offset();h.offsetX=h.clientX-b.left;h.offsetY=h.clientY-b.top;a.clickHandler(h,{LRSObject:a})}}),b.swipe({swipe:function(b,k,c,d,f){Nigsys.disableEventPropagationFull(b);1<f||(a.isDragMode=!0,b.clientX=b.changedTouches[0].clientX,b.clientY=b.changedTouches[0].clientY,d=1,"down"==k&&(d=-1),a.lastDragPositionOffset="portrait"==a.orientation?b.clientY+d*c:b.clientX+d*c,a.mouseMoveHandler(b))},
threshold:10,pinchIn:function(b,c,g,d,f,e,l){a.isDragMode=!1;b.clientX=b.changedTouches[0].clientX;b.clientY=b.changedTouches[0].clientY;b.originalEvent={clientX:b.changedTouches[0].screenX,clientY:b.changedTouches[0].screenY};a.mouseWheelHandler(b,1)},pinchOut:function(b,c,g,d,f,e,l){a.isDragMode=!1;b.clientX=b.changedTouches[0].clientX;b.clientY=b.changedTouches[0].clientY;b.originalEvent={clientX:b.changedTouches[0].screenX,clientY:b.changedTouches[0].screenY};a.mouseWheelHandler(b,-1)},fingers:jQuery.fn.swipe.fingers.ALL});
else b.off().on({vmousedown:function(b){a.mouseDownHandler(b)},vmousemove:function(b){a.mouseMoveHandler(b)},vmouseup:function(b){a.disableDragHandler(b)},vmouseout:function(b){a.disableDragHandler(b)},click:function(b){a.clickHandler(b,{LRSObject:a})},"mousewheel DOMMouseScroll":function(b,c){c=Nigsys.getDelta(b,c);if(!Nigsys.scrollDeltaIsValid(c))return!1;a.mouseWheelHandler(b,c)}})},drag:function(a){Nigsys.disableEventPropagationFull(a);this.resetZoom();this.isAfterDrag=!0;this.dragZoomLevel=this.currentZoomLevel;
var b=0;this.dragPositionOffset=b="portrait"==this.orientation?a.clientY:a.clientX;a=this.dragPositionOffset-this.lastDragPositionOffset;5<a?this.getPROffset(0)>=this.minBound+this.prSize||(this.dragOffset+=a,this.drawRoad(-a),this.lastDragPositionOffset=this.dragPositionOffset):-5>a&&!(this.getPROffset(this.prLength-1)<=this.maxBound-5)&&(this.dragOffset+=a,this.drawRoad(-a),this.lastDragPositionOffset=this.dragPositionOffset)},getZoomRatio:function(){return this.currentZoomLevel<this.lastZoomLevel?
Nigsys.zoomMap[this.lastZoomLevel]/Nigsys.zoomMap[this.currentZoomLevel]:Nigsys.zoomMap[this.currentZoomLevel]/Nigsys.zoomMap[this.lastZoomLevel]},getCurrentZoomFactor:function(){return Math.pow(this.getZoomRatio(),this.currentZoomLevel)},getCurrentZoomFactorOnSamePosition:function(){return Math.pow(this.getZoomRatio(),this.zoolLevelOnSamePosition)},getMinZoomLevel:function(a){a=null;for(var b in Nigsys.zoomMap)if(Nigsys.zoomMap[b]*(this.prLength-1)>this.containerHeight){a=b;break}return parseInt(a)},
resetZoom:function(){this.zoolLevelOnSamePosition=0;this.lastSign=this.sign;this.lastZoomOffset=0;this.roadRedraw||(this.lastZoomOffset=this.zoomOffset*this.getCurrentZoomFactorOnSamePosition());this.currentZoomLevel!=this.dragZoomLevel&&(this.maxBoundOffset=this.minBoundOffset=this.dragOffset=0)},zoom:function(a,b){var h=this.currentZoomLevel-1;if(!(this.currentZoomLevel!=this.lastZoomLevel&&0>b&&0>this.containerHeight*(Math.pow(this.getZoomRatio(),h)*(1-1/this.prLength)-1)+this.prSize+5)){this.isZoomMode=
!0;var c=h=0;"portrait"==this.orientation?(h=a.originalEvent.clientY,c=this.container.offset().top):(h=a.originalEvent.clientX,c=this.container.offset().left);this.zoomPositionOffset=h-c;this.zoomPositionOffset<this.prSize&&this.getPROffset(0)>=this.minBound+this.prSize&&(this.zoomPositionOffset=this.prSize,this.resetZoom());this.zoomPositionOffset>this.containerHeight-5&&this.getPROffset(this.prLength-1)<=this.maxBound-5&&(this.zoomPositionOffset=this.containerHeight-5,this.resetZoom());this.lastZoomPositionOffset==
this.zoomPositionOffset&&lastZoomDelta!=b&&this.resetZoom();this.lastZoomPositionOffset=this.zoomPositionOffset;lastZoomDelta=b;this.zoolLevelOnSamePosition++;0>b?this.zoomOut():this.zoomIn();this.isZoomMode=!1;"undefined"!==typeof LRSSchematic&&LRSSchematic.LRSGUI&&Nigsys.refreshComboboxContainer(jQuery("#LRSSchematicZoomSelect"),LRSSchematic.LRSGUI.currentZoomLevel+" ("+(1E3/Nigsys.zoomMap[LRSSchematic.LRSGUI.currentZoomLevel]*10/10).toFixed(2)+"m/px)")}},zoomIn:function(){this.currentZoomLevel>=
this.maxZoomLevel||(this.lastZoomLevel=this.currentZoomLevel,this.currentZoomLevel++,this.zoomPositionOffset>this.containerHeight/2?(this.zoomPositionOffset=this.containerHeight-this.zoomPositionOffset,this.sign=1):this.sign=-1,0<this.zoolLevelOnSamePosition&&(this.zoomOffset=this.lastSign?this.sign*this.lastSign*this.lastZoomOffset*this.getCurrentZoomFactorOnSamePosition():this.lastZoomOffset*this.getCurrentZoomFactorOnSamePosition()),this.zoomOffset+=(this.getCurrentZoomFactorOnSamePosition()-1)*
(this.containerHeight/2-this.zoomPositionOffset)-this.sign*(this.dragOffset-this.minBoundOffset+this.maxBoundOffset)*this.getCurrentZoomFactorOnSamePosition(),this.drawRoad(this.sign*this.zoomOffset))},zoomOut:function(){this.currentZoomLevel<=this.maxZoomLevel-this.zeroBasedMaxZoomLevel||this.currentZoomLevel<=this.getMinZoomLevel(0)||(this.lastZoomLevel=this.currentZoomLevel,this.currentZoomLevel--,this.zoomPositionOffset>this.containerHeight/2?(this.zoomPositionOffset=this.containerHeight-this.zoomPositionOffset,
this.sign=-1):this.sign=1,0!=this.zoolLevelOnSamePosition&&(this.zoomOffset=this.lastSign?this.sign*this.lastSign*this.lastZoomOffset/this.getCurrentZoomFactorOnSamePosition():this.lastZoomOffset/this.getCurrentZoomFactorOnSamePosition()),this.zoomOffset+=(1-1/this.getCurrentZoomFactorOnSamePosition())*(this.containerHeight/2-this.zoomPositionOffset)-this.sign*(this.dragOffset-this.minBoundOffset+this.maxBoundOffset)/this.getCurrentZoomFactorOnSamePosition(),this.drawRoad(this.sign*this.zoomOffset))},
getFirstLRS:function(a,b){if(a){var c=null,c=a[0]?a[0]:a;return b?jQuery.extend(b,c):c}return null},getZoomedDimension:function(){return this.containerHeight*this.getCurrentZoomFactor()},KMToPixelZoom:function(){return Nigsys.zoomMap[this.currentZoomLevel]},getCurrentZoomFactorByZoom:function(a){return Math.pow(this.getZoomRatio(),a)},getZoomedDimensionByZoom:function(a){return this.containerHeight*this.getCurrentZoomFactorByZoom(a)},KMToPixelZoomByZoom:function(a){return this.getZoomedDimensionByZoom(a)/
this.prLength},KMToPixel:function(){return this.containerHeight/this.prLength},noOfPixelsInKM:function(){return Nigsys.zoomMap[this.currentZoomLevel]},getPROffset:function(a){return a*this.KMToPixelZoom()},getClickedPosition:function(a,b){if(!ImajnetLRSGUICommon.roadsPRData[this.currentRoadId])return null;for(var c=Object({x:0,y:a}),k=this.KMToPixelZoom(),g=-1,d=-1,f=LRS.getRoadUnitType(this.linearPosition.road.unit),e=0;e<this.prLength;e++){var l=this.getPROffset(e),m=this.getPRNumberCumulatedFromPreviousIndex(this.linearPosition.keyPoint.prNumber,
f);if(l>=this.minBound&&l<=this.maxBound)if(d=l-this.minBound,d>=c.y){g=ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[e-1]?ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[e-1].prNumber:-1;d=m*(1-(d-c.y)/k);break}else g=ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[e].prNumber,d=m*(c.y-d)/k;else if(l>=this.minBound){l=this.getPROffset(e-1);g=ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[e-1]?ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[e-1].prNumber:-1;d=
m*(this.minBound+c.y-l)/k;break}}return-1==g||g==ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[this.prLength-1].prNumber||0>d?null:{prNumber:g,relativeAbscisa:b?LRS.transformToMeters(d,f):d}},getPRNumberIndex:function(a){for(var b=0;b<this.prLength;b++)if(ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[b].prNumber==a)return b;return-1},getPRNumberCumulatedFromPreviousIndex:function(a,b){for(var c=0;c<this.prLength;c++)if(ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[c].prNumber==
a){if(ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[c+1]&&ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[c+1].relativeDistance)return LRS.transformFromMeters(ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[c+1].relativeDistance,b);break}return LRS.transformFromMeters("feet"==b?LRS.metersInAMile:1E3,b)},computeStartEndPR:function(a){if(!this.PRStart||this.PRStart>a)this.PRStart=a;this.PREnd<a&&(this.PREnd=a)},drawRoad:function(a){var b=jQuery.Deferred();if(!ImajnetLRSGUICommon.roadsPRData[this.currentRoadId])return this.hide(),
b.reject(),b;this.show();this.hideOrientation();ImageControler.currentGraphic.initLRSGUI(this);var c=LRS.getRoadUnitType(this.linearPosition.road.unit),k=this.getPRNumberCumulatedFromPreviousIndex(this.linearPosition.keyPoint.prNumber,c),g=this.getPRNumberIndex(this.linearPosition.keyPoint.prNumber);if(-1==g)return this.hide(),b.reject(),b;var d=this.KMToPixelZoom(),f=this.getPROffset(g)+d*this.linearPosition.relativeAbscisa/k;this.roadRedraw=!1;if(this.redrawRoad||!this.minBound||!this.maxBound||
f<this.minBound+10||f>this.maxBound-10||this.isZoomMode||this.isDragMode){this.redrawRoad=!1;this.isDragMode?this.minBound+=a:this.isZoomMode?this.minBound=this.getPROffset(this.zoomBoxIndex)+d*this.centerLinearPosition.relativeAbscisa/k-this.containerHeight/2+a:(this.roadRedraw=!0,this.dragOffset=0,this.minBound=f-this.containerHeight/2,this.centerLinearPosition=Nigsys.cloneObject(this.linearPosition),this.zoomBoxIndex=g,this.zoomOffset=0);this.maxBound=this.minBound+this.containerHeight;a=this.getPROffset(0);
a>this.minBound+this.prSize&&(a=a-this.minBound-this.prSize,this.isDragMode?this.dragOffset-=a:(this.isZoomMode&&(this.dragOffset=0),this.minBoundOffset=a,this.maxBoundOffset=0),this.dragZoomLevel=this.currentZoomLevel,this.minBound+=a,this.maxBound=this.minBound+this.containerHeight);a=this.getPROffset(this.prLength-1);a<this.maxBound-5&&(a=this.maxBound-a-5,this.isDragMode?this.dragOffset+=a:(this.isZoomMode&&(this.dragOffset=0),this.maxBoundOffset=a,this.minBoundOffset=0),this.dragZoomLevel=this.currentZoomLevel,
this.minBound-=a,this.maxBound=this.minBound+this.containerHeight);a=4;if(Nigsys.browserIsOpera()||Nigsys.isWindows())if(a=6,this.PRTextOffset=9,Nigsys.browserIsIE8()||Nigsys.browserIsIE7())this.PRTextOffset=6;ImageControler.currentGraphic.clearLRSGUI(this);ImageControler.currentGraphic.drawLRSGUILine(this);for(f=this.PREnd=this.PRStart=0;f<this.prLength;f++){var e=this.getPROffset(f)-this.minBound,l=ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[f].prNumber,k=this.getPRNumberCumulatedFromPreviousIndex(f,
c);0>e&&0<e+d?(this.computeStartEndPR(l),ImageControler.currentGraphic.drawPRDivisions(this,{x:this.roadXOffset+this.PRDivisionOffset,y:e},d,k)):0<=e&&e<=this.containerHeight+this.prSize&&(this.computeStartEndPR(l),ImageControler.currentGraphic.drawPR(this,{x:this.roadXOffset-this.prSize/2,y:e},l,a),e<=this.containerHeight&&ImageControler.currentGraphic.drawPRDivisions(this,{x:this.roadXOffset+this.PRDivisionOffset,y:e},d,k))}this.PRStart--;this.PREnd++;"undefined"!==typeof LRSSchematic&&LRSSchematic&&
LRSSchematic.LRSGUI&&!LRSSchematic.exportRatio&&(LRSSchematic.LRSGUI.linearPosition.keyPoint||(LRSSchematic.LRSGUI.linearPosition.keyPoint={}),LRSSchematic.LRSGUI.linearPosition.keyPoint.prNumber=Math.ceil(this.PRStart+(this.PREnd-this.PRStart)/2),LRSSchematic.LRSGUI.linearPosition.relativeAbscisa=0);this.isFirstDraw&&(Nigsys.browserIsOpera()||jQuery("svg text tspan:first-child").attr("dy",3),this.isFirstDraw=!1);this.onDrawRoadEnd().done(function(){b.resolve()}).fail(function(){b.reject()})}else b.resolve();
c=this.getPROffset(g)+d*this.linearPosition.relativeAbscisa/k-this.minBound;ImageControler.currentGraphic.drawLRSGUIImageOrientation(this,{x:this.roadXOffset,y:c},g);return b.promise()},computetMiddlePRIfNotDefined:function(){this.linearPosition.keyPoint.prNumber||(ImajnetUI.LRSGUI&&ImajnetUI.LRSGUI.linearPosition&&ImajnetUI.LRSGUI.linearPosition.road.id==this.linearPosition.road.id?(this.linearPosition.keyPoint.prNumber=ImajnetUI.LRSGUI.linearPosition.keyPoint.prNumber,this.linearPosition.relativeAbscisa=
ImajnetUI.LRSGUI.linearPosition.relativeAbscisa):(this.linearPosition.keyPoint.prNumber=ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr[parseInt(ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr.length/2)].prNumber,this.linearPosition.relativeAbscisa=0))},onGetRoadSuccess:function(a,b){if(a.pr)b&&b.LRSObject&&b.LRSObject.resetData(a.pr.length),a.roadId&&a.roadId==b.LRSObject.currentRoadId&&(ImajnetLRSGUICommon.roadsPRData[b.LRSObject.currentRoadId]=a,ImajnetLRSGUICommon.onImajnetImageRoadChange(b.LRSObject),
b.LRSObject.resetZoom(),b.LRSObject.drawRoad(null));else if(b&&b.LRSObject)b.LRSObject.onGetRoadError(a,b)},onGetRoadError:function(a,b){b&&b.LRSObject&&b.LRSObject.hide()},resetData:function(a){this.currentRoadId!=this.lastRoadId&&(this.lastRoadId=this.currentRoadId,this.maxBoundOffset=this.minBoundOffset=this.maxBound=this.minBound=0,this.prLength=a,this.maxZoomLevel=this.zeroBasedMaxZoomLevel,this.startZoomLevel=this.defaultZoomLevel,this.startZoomLevel<this.getMinZoomLevel()&&(this.startZoomLevel=
this.getMinZoomLevel()),this.dragZoomLevel=this.currentZoomLevel=this.startZoomLevel,"undefined"!==typeof LRSSchematic&&LRSSchematic.setZoomLevelsSelectHTML())},draw:function(a){var b=jQuery.Deferred();this.LRSResponse=a;this.linearPosition=this.getFirstLRS(this.LRSResponse.linearPosition,this.linearPosition);if(!this.linearPosition||!this.linearPosition.road||!this.linearPosition.road.id)return b.resolve(),b.promise();this.linearPosition.keyPoint||(this.linearPosition.keyPoint={});this.isFirstDraw=
!0;this.roadType=this.linearPosition.road.type?this.linearPosition.road.type:"1";this.currentRoadId=this.linearPosition.road.id;return ImajnetLRSGUICommon.roadsPRData[this.currentRoadId]?(this.resetData(ImajnetLRSGUICommon.roadsPRData[this.currentRoadId].pr.length),this.resetZoom(),ImajnetLRSGUICommon.onImajnetImageRoadChange(this),this.drawRoad(null),b.resolve(),b.promise()):LRSRequest.getRoad(this.linearPosition.road.id,this.onGetRoadSuccess,this.onGetRoadError,{LRSObject:this})},show:function(){Nigsys.isPositionMode()||
Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()||(this.container&&this.container.show(),this.dragContainer&&this.dragContainer.show(),"undefined"!==typeof ImajnetUI&&ImajnetUI.docking.imageLRSGUI&&this===ImajnetUI.LRSGUI&&ImajnetUI.docking.imageLRSGUI.mainContainer.show())},hide:function(){this.LRSResponse=null;this.container&&this.container.hide();this.dragContainer&&this.dragContainer.hide();"undefined"!==typeof ImajnetUI&&ImajnetUI.docking.imageLRSGUI&&this===ImajnetUI.LRSGUI&&ImajnetUI.docking.imageLRSGUI.mainContainer.hide()},
hideOrientation:function(){ImageControler.currentGraphic.clearLRSGUIImageOrientation(this)}};c.init();return c};
var ImajnetMap={cartographicServerDomains:null,FEATURE_TYPE_IMAGE_ORIENTATION:"imageOrientationFeature",FEATURE_TYPE_LARGE_IMAGE_ORIENTATION:"largeImageOrientationFeature",FEATURE_TYPE_ORIENTED_IMAGES:"orientedImagesFeature",FEATURE_TYPE_IMAGE_SWITCHER:"imageSwitcher",FEATURE_TYPE_SURVEY_TRACE:"surveyTrace",FEATURE_TYPE_PROJECTION:"projectedFeature",MARKER_TYPE_POSITION:"positionFeature",MARKER_TYPE_POLYLIGNE_POSITION:"polylignePositionFeature",FEATURE_TYPE_MEASUREMENT:"measurementFeature",FEATURE_TYPE_POLYLIGNE:"polyligneFeature",
FEATURE_TYPE_POLYGON:"polygonFeature",MARKER_TYPE_IMAJBOX:"imajboxMarker",MARKER_TYPE_TARGET_POINT:"targetPointMarker",MARKER_TYPE_IMAGE_TAG:"imageTag",MARKER_TYPE_CLICKED_POINT:"clickedPoint",CENTER_OBJECTS_ZOOM_LEVEL:17,ADDRESS_ZOOM_LEVEL:12,featureWrappers:[],IMAJNET_MAX_ZOOM:25,IMAJNET_LAYER_Z_INDEX:1E4,imajnetCrs:"EPSG:4326",imajnetProjection:null,map:null,LRSUrl:null,currentPosition:null,imajnetLayer:null,roadLayer:null,roadLayerName:"roads",prLayer:null,prLayerName:"pr",roadWFSLayerName:"sections",
prWFSLayerName:"pr",allWFS:null,allWFSName:"Imajnet WFS",key:"",layerName:"Imajnet",imajnetSurveyTraceLayer:null,imajnetSurveyTraceLayerName:"Imajnet survey trace",imajnetImageSwitcherLayer:null,imajnetImageSwitcherLayerName:"Imajnet image switcher",photogrammetryPositionsLayer:null,photogrammetryPositionsLayerName:"Photogrammetry positions",imajnetOrientationLayer:null,imajnetOrientationLayerName:"Imajnet image orientation",imajnetDragFeaturesLayer:null,imajnetDragFeaturesLayerName:"Image features",
markerLayerZIndex:999,imajnetPOIRequest:null,POIArray:null,imajboxTriangleDimension:130,imajboxOrientedImagesDimension:160,defaultViewAngle:80,markerType:{PIN_POINT:"pinPoint",PHOTOGRAMMETRY_POINT:"photogrammetryPoint",IMAGE_POINT:"imagePoint",CLICK_POSITION_ON_MAP:"clickPositionOnMap",IMAJBOX:"imajbox"},RESOLUTIONS:[156543.0339,78271.51695,39135.758475,19567.8792375,9783.93961875,4891.969809375,2445.9849046875,1222.99245234375,611.496226171875,305.7481130859375,152.87405654296876,76.43702827148438,
38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887,1.1943285667419434,.5971642833709717],viewAngle:80,getImajnetTileUrls:function(){var a=ImajnetProtocol.getUsernameForUrl('/api/tile/%7B"tile":%7B"x":{x},"y":{y},"zoom":{z}%7D,"timeframe":'+JSON.stringify(ImajnetTimeframe.getTimeframe())+"%7D");if(null!==ImajnetMap.cartographicServerDomains){var b=[];ImajnetMap.cartographicServerDomains.forEach(function(c){b.push(c+"/service"+a)});return b}return[Imajnet.serverUrl+
a]},getImajnetTileUrl:function(a){return ImajnetProtocol.getUsernameForUrl(Imajnet.serverUrl+'/api/tile/%7B"tile":%7B"x":{x},"y":{y},"zoom":{z}%7D,"timeframe":'+JSON.stringify(ImajnetTimeframe.getTimeframe())+"%7D")},URL_HASH_FACTOR:(Math.sqrt(5)-1)/2,selectUrl:function(a,b){for(var c=1,d=0,e=a.length;d<e;d++)c=c*a.charCodeAt(d)*ImajnetMap.URL_HASH_FACTOR,c-=Math.floor(c);return b[Math.floor(c*b.length)]},getDefaultZoom:function(a){return ImajnetPlugin.getCurrentZoomLevel()>ImajnetMap.CENTER_OBJECTS_ZOOM_LEVEL?
ImajnetPlugin.getCurrentZoomLevel():ImajnetMap.CENTER_OBJECTS_ZOOM_LEVEL},zoomToDefault:function(a){ImajnetPlugin.zoomMapTo(ImajnetMap.getDefaultZoom())},centerToGeometryAndZoomToDefault:function(a){map.getView().fit(a,{size:map.getSize(),maxZoom:ImajnetMap.getDefaultZoom()})},setImageFromMapClick:function(a,b){Imajnet.clickMode==Imajnet.CLICK_MODE_CLOSEST_IMAGE||b?ImajnetAPI.getClosestPosition(a.lat,a.lon,Imajnet.searchRadius[ImajnetPlugin.getCurrentZoomLevel()],Imajnet.timeSearchRadius[ImajnetPlugin.getCurrentZoomLevel()]).done(function(){jQuery(document).on("keydown.onKeyDown",
ImajnetUI.onKeyDown)}).fail(function(){jQuery(document).on("keydown.onKeyDown",ImajnetUI.onKeyDown)}):Imajnet.clickMode==Imajnet.CLICK_MODE_ORIENTED_IMAGES&&ImajnetClickMode.showOrientedImages(a,ImajnetClickMode.orientedImagesReceived,ImajnetClickMode.orientedImagesError)},doOnMapClick:function(a,b){jQuery(document).off(".onKeyDown");ImajnetMap.currentPosition=null;ImageControler.currentImageControl.resetFastNavigation();ImajnetUI.stopSwipeNavigation(!0,!0);ImajnetAPI.imajnetClosestPositionRequest&&
ImajnetAPI.imajnetClosestPositionRequest.abort();ImajnetClickMode.orientedImagesAjaxRequest&&ImajnetClickMode.orientedImagesAjaxRequest.abort();ImajnetAPI.setImajnetImageDeferred&&"pending"==ImajnetAPI.setImajnetImageDeferred.state()&&!Nigsys.browserIsEdge()?ImajnetAPI.setImajnetImageDeferred.done(function(){ImajnetMap.setImageFromMapClick(a,b)}):ImajnetMap.setImageFromMapClick(a,b)},onMapClick:function(a,b){a&&this.doOnMapClick(a,b)},mapClickHandler:function(a){if(Imajnet.imajnetClosestPositionIsActive()||
Imajnet.imajnetOrientedImagesIsActive())ImajnetMap.onMapClick(a)},mapZoomEndHandler:function(){ImajnetMap.setOrientationMarker(ImajnetMap.currentPosition,ImajnetMap.imajboxTriangleDimension,Nigsys.defaultObjectsColor,-1);if(Imajnet.clickMode!==Imajnet.CLICK_MODE_CLOSEST_IMAGE)ImajnetClickMode.onZoomEnd();ImajnetUrl.changeUrlParam(ImajnetUrl.ZOOM_URL_PARAM_NAME,ImajnetPlugin.getCurrentZoomLevel(),!0)},addToFeatureWrappers:function(a){var b=new FeatureWrapper;jQuery.each(a,function(a,d){b[a]=d});ImajnetMap.addToFeatureWrappersArray(b)},
addToFeatureWrappersArray:function(a){a.getId()&&ImajnetMap.getFeatureWrapperById(a.getId())&&ImajnetMap.clearPhotogrammetryObject(a.getId());ImajnetMap.featureWrappers.push(a)},hideImajboxMarker:function(){if(this.allWFS){var a=this.getFeatureWrappersByType(this.MARKER_TYPE_IMAJBOX);a.length&&(ImajnetPlugin.removeMarkerFeatures(this.allWFS,a),this.deleteFeatureWrapperObject(this.MARKER_TYPE_IMAJBOX))}},hideOrientation:function(){if(this.imajnetOrientationLayer){ImajnetMap.hideLargeImageOrientation();
var a=this.getFeatureWrappersByType(this.FEATURE_TYPE_IMAGE_ORIENTATION);a.length&&(ImajnetPlugin.removeFeatures(this.imajnetOrientationLayer,a),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_IMAGE_ORIENTATION))}},hideLargeImageOrientation:function(){if(this.imajnetOrientationLayer){var a=this.getFeatureWrappersByType(this.FEATURE_TYPE_LARGE_IMAGE_ORIENTATION);a.length&&(ImajnetPlugin.removeFeatures(this.imajnetOrientationLayer,a),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_LARGE_IMAGE_ORIENTATION))}},
getPolyligneFeatureWrapper:function(a){var b=this.getPolyligneFeatureWrappers(a.getId());if(!b)return a;for(a=0;a<b.length;a++)if(b[a].type!=ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION)return b[a]},getFeatureWrapperById:function(a){for(var b=0,c=ImajnetMap.featureWrappers.length;b<c;++b)if(ImajnetMap.featureWrappers[b].id==a)return ImajnetMap.featureWrappers[b];return null},getPolyligneFeatureWrappers:function(a){a=ImajnetPolyligne.getAllObjectsId(a);for(var b=[],c=0;c<a.length;c++){var d=this.getFeatureWrapperById(a[c]);
d&&b.push(d)}return b},getFeatureWrappersByType:function(a){for(var b=[],c=0,d=this.featureWrappers.length;c<d;++c)this.featureWrappers[c].getType()==a&&b.push(this.featureWrappers[c]);return b},deleteFeatureWrapperObject:function(a){for(var b=0;b<this.featureWrappers.length;b++)this.featureWrappers[b].getType()==a&&(this.featureWrappers.splice(b,1),b--)},deleteFeatureWrapperObjectById:function(a){for(var b=0;b<this.featureWrappers.length;b++)if(this.featureWrappers[b].getId()===a){this.featureWrappers.splice(b,
1);break}},hideSurveyTrace:function(){this.imajnetSurveyTraceLayer&&(ImajnetPlugin.removeAllFeatures(this.imajnetSurveyTraceLayer),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_SURVEY_TRACE))},hideImageSwitcher:function(){this.imajnetImageSwitcherLayer&&(ImajnetPlugin.removeAllFeatures(this.imajnetImageSwitcherLayer),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_IMAGE_SWITCHER))},hideOrientedImages:function(){if(this.imajnetDragFeaturesLayer){var a=this.getFeatureWrappersByType(this.FEATURE_TYPE_ORIENTED_IMAGES);
a.length&&(ImajnetPlugin.removeFeatures(this.imajnetDragFeaturesLayer,a),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_ORIENTED_IMAGES))}},cutTriangleMargins:function(a){return a},getPointOnCircle:function(a,b,c){c=c/180*Math.PI;return{x:a.x+Math.cos(c)*b,y:a.y+Math.sin(c)*b}},getTriangleCoordinates:function(a,b,c,d){var e=[];e.push(a);for(var g=d=90-b/2+d;g<=b+d;)e.push(ImajnetMap.getPointOnCircle(a,c,g)),g+=1;e.push(a);return e},getTriangle:function(a,b,c,d){a=Nigsys.transformImajnetOrientationPoint(Object({x:a.lon,
y:a.lat}),new Proj4js.Proj("EPSG:4326"),new Proj4js.Proj("EPSG:900913"));b=this.getTriangleCoordinates(a,c,b,d);c=0;for(d=b.length;c<d-1;++c)b[c]=Nigsys.transformImajnetOrientationPoint(b[c],new Proj4js.Proj("EPSG:900913"),new Proj4js.Proj("EPSG:4326"));return b},setOrientationMarker:function(a,b,c,d){if(a&&a.lon&&a.lat&&a.orientation){var e=a.orientation.viewAngle,g=a.orientation.yaw;if(-1==d){ImajnetMap.hideOrientation();var f=0,f=80;if("FLAT"==ImageControler.currentImageType){if(ImajnetUI.getLargeImageWidthOverflow()?
(ImajnetMap.setOrientationMarker(a,b,"#CCCCCC",-4),ImajnetUI.fullSizeAspectRatio>ImajnetUI.imageAspectRatio&&100>e&&(f=f*ImajnetUI.imageAspectRatio/ImajnetUI.fullSizeAspectRatio),e=0==ImajnetZoom.zoomLevel?f:f*(1-ImajnetZoom.zoomLevel/(ImajnetZoom.maxZoomLevel+1))):(ImajnetMap.setOrientationMarker(a,b,"#CCCCCC",-4),e*=1-ImajnetZoom.zoomLevel/(ImajnetZoom.maxZoomLevel+1)),f=a.orientation.viewAngle-e){var h=0;if(h=ImajnetUI.imajnetImage.width()-ImajnetUI.imajnetImageContainerSize.width)h=1+2*ImajnetUI.imajnetImage.position().left/
h,g+=h*f/2}}else ImajnetMap.setOrientationMarker(a,b,"#CCCCCC",-4),f=ImajnetMap.defaultViewAngle,ImajnetUI.fullSizeAspectRatio>ImajnetUI.imageAspectRatio&&100>e&&(f=f*ImajnetUI.imageAspectRatio/ImajnetUI.fullSizeAspectRatio),e=0==ImajnetZoom.zoomLevel?f:f*(1-ImajnetZoom.zoomLevel/(ImajnetZoom.maxZoomLevel+1)),g-=CubePlugin.yow}else void 0===d&&(d=-1);b=1.1*ImajnetPlugin.getMapScale()/b;a=this.getTriangle(a,b,e,g);-1==d&&(a=ImajnetMap.cutTriangleMargins(a));switch(d){case -4:ImajnetMap.hideLargeImageOrientation();
if(c=ImajnetPlugin.addFeature(ImajnetMap.imajnetOrientationLayer,a,{type:"Polygon",zIndex:0,fillColor:c,fillOpacity:.7,strokeWidth:.5}))c.setType(ImajnetMap.FEATURE_TYPE_LARGE_IMAGE_ORIENTATION),ImajnetMap.addToFeatureWrappersArray(c);break;case -3:if(c=ImajnetPlugin.addFeature(ImajnetMap.imajnetImageSwitcherLayer,a,{type:"Polygon",fillColor:c,strokeWidth:.5}))c.setType(ImajnetMap.FEATURE_TYPE_IMAGE_SWITCHER),ImajnetMap.addToFeatureWrappersArray(c);break;case -2:if(c=ImajnetPlugin.addFeature(ImajnetMap.imajnetSurveyTraceLayer,
a,{type:"Polygon",fillColor:c,strokeWidth:.5}))c.setType(ImajnetMap.FEATURE_TYPE_SURVEY_TRACE),ImajnetMap.addToFeatureWrappersArray(c);break;case -1:if(c=ImajnetPlugin.addFeature(ImajnetMap.imajnetOrientationLayer,a,{type:"Polygon",zIndex:0,fillColor:c,fillOpacity:.5,strokeWidth:.5}))c.setType(ImajnetMap.FEATURE_TYPE_IMAGE_ORIENTATION),ImajnetMap.addToFeatureWrappersArray(c);break;default:if(c=ImajnetPlugin.addFeature(ImajnetMap.imajnetDragFeaturesLayer,a,{type:"Polygon",zIndex:1,fillColor:c,fillOpacity:.5,
strokeWidth:.5}))c.setId(d),c.setType(ImajnetMap.FEATURE_TYPE_ORIENTED_IMAGES),ImajnetMap.addToFeatureWrappersArray(c)}}},setCurrentPosition:function(a){ImajnetAPI.isSameSequence=ImajnetMap.currentPosition&&a&&ImajnetMap.currentPosition.traceId==a.traceId?!0:!1;ImajnetMap.currentPosition=a?a:null;ImajnetAPI.lastNavigationPositionImageId=""},setImajboxMarkerPosition:function(a,b){ImajnetMap.hideImajboxMarker();var c=null,d=null;a.position?(c=a.position.lon,d=a.position.lat):a.parameter&&a.parameter.coordinates&&
(c=a.parameter.coordinates.lon,d=a.parameter.coordinates.lat);if(c&&d){if(c=ImajnetPlugin.addMarker(ImajnetMap.allWFS,{lon:c,lat:d,type:ImajnetMap.markerType.IMAJBOX,imagePath:Imajnet.imajnetPath+"img/imajbox.png?"+Imajnet.version,size:{width:32,height:32}}))c.setType(ImajnetMap.MARKER_TYPE_IMAJBOX),ImajnetMap.addToFeatureWrappersArray(c);b&&(c=a.position?a.position:a.parameter.coordinates)&&(ImajnetZoom.imageIsZoomed()&&ImajnetZoom.resetZoom(),ImajnetMap.setOrientationMarker(c,ImajnetMap.imajboxTriangleDimension,
Nigsys.defaultObjectsColor,-1),ImajnetPlugin.centerMapToPosition(c,!0))}},addClickedPointToMap:function(a){a=ImajnetPlugin.addMarker(ImajnetMap.photogrammetryPositionsLayer,{lon:a.lon,lat:a.lat,type:ImajnetMap.markerType.CLICK_POSITION_ON_MAP,imagePath:Imajnet.imajnetPath+"img/targetIconMarker16x36.png?"+Imajnet.version,size:{width:16,height:36}});a.setId(0);a.setType(ImajnetMap.MARKER_TYPE_TARGET_POINT);ImajnetMap.addToFeatureWrappersArray(a)},clearClickedPointFromMap:function(){if(ImajnetMap.photogrammetryPositionsLayer){var a=
ImajnetMap.getFeatureWrappersByType(ImajnetMap.MARKER_TYPE_TARGET_POINT);a&&a[0]&&ImajnetPlugin.removeMarker(ImajnetMap.photogrammetryPositionsLayer,a[0]);this.deleteFeatureWrapperObject(this.MARKER_TYPE_TARGET_POINT)}},clearPhotogrammetryObject:function(a){var b=this.getFeatureWrapperById(a);if(b){if(0==a)this.clearClickedPointFromMap();else if(b.getType()==ImajnetMap.MARKER_TYPE_POSITION||b.getType()==ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION)ImajnetPlugin.removeMarker(this.photogrammetryPositionsLayer,
b);else if(b.getType()==ImajnetMap.FEATURE_TYPE_MEASUREMENT)ImajnetPlugin.removeFeatures(this.imajnetDragFeaturesLayer,Array(b));else if(-1!==jQuery.inArray(b.getType().replace("Feature",""),ImajnetPolyligne.typesArray)){b=this.getPolyligneFeatureWrappers(a);if(!b)return;for(var c=0;c<b.length;c++)b[c].getType()==ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION?ImajnetPlugin.removeMarker(this.photogrammetryPositionsLayer,b[c]):ImajnetPlugin.removeFeatures(this.imajnetDragFeaturesLayer,Array(b[c])),this.deleteFeatureWrapperObjectById(b[c].getId())}this.deleteFeatureWrapperObjectById(a)}},
clearPhotogrammetryObjects:function(){this.clearClickedPointFromMap();if(this.imajnetDragFeaturesLayer){var a=this.getFeatureWrappersByType(this.FEATURE_TYPE_MEASUREMENT);a.length&&(ImajnetPlugin.removeFeatures(this.imajnetDragFeaturesLayer,a),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_MEASUREMENT));a=this.getFeatureWrappersByType(this.FEATURE_TYPE_POLYLIGNE);a.length&&(ImajnetPlugin.removeFeatures(this.imajnetDragFeaturesLayer,a),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_POLYLIGNE));
a=this.getFeatureWrappersByType(this.FEATURE_TYPE_POLYGON);a.length&&(ImajnetPlugin.removeFeatures(this.imajnetDragFeaturesLayer,a),this.deleteFeatureWrapperObject(this.FEATURE_TYPE_POLYGON))}ImajnetPlugin.removeAllMarkersFromLayer(this.photogrammetryPositionsLayer);this.deleteFeatureWrapperObject(this.MARKER_TYPE_POSITION);ImajnetPlugin.removeAllMarkersFromLayer(this.photogrammetryPositionsLayer);this.deleteFeatureWrapperObject(this.MARKER_TYPE_POLYLIGNE_POSITION)},addLineFeature:function(a,b,c){b=
ImajnetPlugin.addFeature(ImajnetMap.imajnetDragFeaturesLayer,b,{type:"LineString",strokeColor:Nigsys.defaultObjectsColor,strokeWidth:2});b.setId(a);b.setType(c);ImajnetMap.addToFeatureWrappersArray(b);return b},addPolygonFeature:function(a,b,c,d){b=ImajnetPlugin.addFeature(ImajnetMap.imajnetDragFeaturesLayer,b,{type:"MultiPolygon",fillColor:d?d:Nigsys.defaultObjectsColor,strokeWidth:1,strokeColor:"#00FF00"});b.setId(a);b.setType(c);ImajnetMap.addToFeatureWrappersArray(b);return b},addPoint:function(a,
b,c,d){b=!d&&"polyligne"!=b&&"polygon"!=b;c=ImajnetPlugin.addMarker(ImajnetMap.photogrammetryPositionsLayer,{lon:c.lon,lat:c.lat,type:b?ImajnetMap.markerType.PINPOINT:ImajnetMap.markerType.PHOTOGRAMMETRY_POINT,imagePath:Imajnet.imajnetPath+"img/"+(b?"pinpoint":"polyligne")+".png?"+Imajnet.version,size:{width:b?32:7,height:b?32:7}});c.setId(a);d?c.setType(ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION):c.setType(ImajnetMap.MARKER_TYPE_POSITION);ImajnetMap.addToFeatureWrappersArray(c)},drawPolylignePoints:function(a){for(var b=
0;b<a.points.length;b++)ImajnetMap.addPoint(a.points[b].id,a.type,a.points[b].photogrammetryPosition3D.coordinates,a.points[b].linkToNext)},drawPhotogrammetryObjects:function(){for(var a=0;a<ImageControler.currentPhotogrammetry.objects.length;a++)for(var b=0;b<ImageControler.currentPhotogrammetry.objects[a].data.length;b++)if(Nigsys.isPolyligneMode()&&ImajnetMap.clearPhotogrammetryObject(ImageControler.currentPhotogrammetry.objects[a].data[b].id),0==ImageControler.currentPhotogrammetry.objects[a].data[b].id)ImajnetClickMode.redrawClickedPointOnMap();
else if(void 0!==ImageControler.currentPhotogrammetry.objects[a].data[b].photogrammetryPosition3D)ImajnetMap.addPoint(ImageControler.currentPhotogrammetry.objects[a].data[b].id,ImageControler.currentPhotogrammetry.objects[a].data[b].type,ImageControler.currentPhotogrammetry.objects[a].data[b].photogrammetryPosition3D.coordinates,ImageControler.currentPhotogrammetry.objects[a].data[b].linkToNext);else if(void 0!==ImageControler.currentPhotogrammetry.objects[a].data[b].measurementResult)ImajnetMap.addLineFeature(ImageControler.currentPhotogrammetry.objects[a].data[b].id,
[Nigsys.lonLatToXY(ImageControler.currentPhotogrammetry.objects[a].data[b].measurementResult.firstPoint),Nigsys.lonLatToXY(ImageControler.currentPhotogrammetry.objects[a].data[b].measurementResult.secondPoint)],ImajnetMap.FEATURE_TYPE_MEASUREMENT);else if(ImajnetPolyligne.isPolyligneOrPolygon(ImageControler.currentPhotogrammetry.objects[a].data[b].type)&&ImageControler.currentPhotogrammetry.objects[a].data[b].points){for(var c=[],d=0;d<ImageControler.currentPhotogrammetry.objects[a].data[b].points.length;d++)c.push(Nigsys.lonLatToXY(ImageControler.currentPhotogrammetry.objects[a].data[b].points[d].photogrammetryPosition3D.coordinates));
if("polyligne"==ImageControler.currentPhotogrammetry.objects[a].data[b].type){if(2>c.length){ImajnetMap.drawPolylignePoints(ImageControler.currentPhotogrammetry.objects[a].data[b]);continue}ImajnetMap.addLineFeature(ImageControler.currentPhotogrammetry.objects[a].data[b].id,c,ImageControler.currentPhotogrammetry.objects[a].data[b].type+"Feature")}else if("polygon"==ImageControler.currentPhotogrammetry.objects[a].data[b].type){if(2>c.length){ImajnetMap.drawPolylignePoints(ImageControler.currentPhotogrammetry.objects[a].data[b]);
continue}c.push(c[0]);ImajnetMap.addPolygonFeature(ImageControler.currentPhotogrammetry.objects[a].data[b].id,Array(c),ImageControler.currentPhotogrammetry.objects[a].data[b].type+"Feature",Nigsys.defaultPolygonObjectsColor)}ImajnetMap.drawPolylignePoints(ImageControler.currentPhotogrammetry.objects[a].data[b])}this.photogrammetryPositionsLayer&&ImajnetPlugin.setLayerZIndex(this.photogrammetryPositionsLayer,this.markerLayerZIndex)},removeFeatures:function(){this.hideOrientation();this.hideSurveyTrace();
this.hideOrientedImages()},POIImajnetPositionChangeHandler:function(){if(ImajnetMap.POIArray){for(var a="",b=0;b<ImajnetMap.POIArray.length;b++)ImajnetMap.currentPosition&&ImajnetMap.POIArray[b].position.id==ImajnetMap.currentPosition.id&&(a=ImajnetMap.POIArray[b].description);""==a?(jQuery(ImajnetEvents.mappingObject).unbind(ImajnetEvents.positionChangeEventName,ImajnetMap.POIImajnetPositionChangeHandler),Nigsys.refreshComboboxContainer(jQuery("#imajnetPOI"),jQuery.imajnet.map.poi.optionDefault)):
Nigsys.refreshComboboxContainer(jQuery("#imajnetPOI"),a)}},POIChanged:function(a,b){Nigsys.disableEventPropagationFull(a);var c=b.item.value;""!=c&&(c=ImajnetMap.POIArray[c])&&("undefined"!==typeof ImajnetUI&&Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetZoom.left=-1,ImajnetAPI.setImajnetImage({position:c.position}),ImajnetPlugin.centerMapToPosition(c.position),jQuery(ImajnetEvents.mappingObject).bind(ImajnetEvents.positionChangeEventName,ImajnetMap.POIImajnetPositionChangeHandler))},onPOIReceived:function(a){a=
JSON.parse(a);ImajnetUI.showItem(ImajnetUI.imageContainerId);if(!a||!a.poi||1>a.poi.length)jQuery("#imajnetPOI").length&&jQuery("#imajnetPOI").html('\x3coption value\x3d"-1"\x3e'+jQuery.imajnet.map.poi.optionDefault+"\x3c/option\x3e");else if(ImajnetMap.POIArray=a.poi.sort(function(a,b){return Nigsys.compareStringAscending(a,b,"description")}),jQuery("#imajnetPOI").length){a='\x3coption value\x3d"-1"\x3e'+jQuery.imajnet.map.poi.optionDefault+"\x3c/option\x3e";for(var b=0;b<ImajnetMap.POIArray.length;b++)a+=
'\x3coption value\x3d"'+b+'"'+(ImajnetMap.currentPosition&&ImajnetMap.POIArray[b].position.lat==ImajnetMap.currentPosition.lat&&ImajnetMap.POIArray[b].position.lon==ImajnetMap.currentPosition.lon?'selected\x3d"selected"':"")+"\x3e"+ImajnetMap.POIArray[b].description+"\x3c/option\x3e";jQuery("#imajnetPOI").html(a);jQuery("#imajnetPOI").combobox({selected:ImajnetMap.POIChanged});jQuery("#imajnetSettingsMenu .ui-combobox-input").on({keydown:function(a){!a||38!=a.keyCode&&40!=a.keyCode||Nigsys.disableEventPropagationFull(a)}})}ImajnetUrl.getUrlParamValue(ImajnetUrl.LOCATION_URL_PARAM_NAME)||
Nigsys.getUserPosition()},loadPOI:function(){ImajnetAPI.mustAbortRequests&&null!==this.imajnetPOIRequest&&this.imajnetPOIRequest.abort();jQuery(ImajnetEvents.mappingObject).bind(ImajnetEvents.positionChangeEventName,ImajnetMap.POIImajnetPositionChangeHandler);this.imajnetPOIRequest=ImajnetAPI.doImajnetRequest("GET","/api/app/poi/",null,this.onPOIReceived,null)},initLRSUrl:function(){var a="/carto/"+ImajnetMap.key+"/wms";ImajnetMap.LRSUrl=null;if(ImajnetMap.cartographicServerDomains){ImajnetMap.LRSUrl=
[];for(var b in ImajnetMap.cartographicServerDomains)ImajnetMap.LRSUrl[b]=ImajnetMap.cartographicServerDomains[b]+a}else ImajnetMap.LRSUrl=Imajnet.cartographicServerUrl+a},registerToMap:function(){ImajnetMap.imajnetLayer&&(ImajnetPlugin.removeLayerFromMap(ImajnetMap.imajnetLayer),ImajnetMap.imajnetLayer=null);ImajnetMap.imajnetLayer=ImajnetPlugin.addImajnetLayerToMap();ImajnetMap.imajnetSurveyTraceLayer=ImajnetPlugin.addVectorLayerToMap(ImajnetMap.imajnetSurveyTraceLayerName);ImajnetMap.imajnetImageSwitcherLayer=
ImajnetPlugin.addVectorLayerToMap(ImajnetMap.imajnetImageSwitcherLayerName);ImajnetMap.photogrammetryPositionsLayer=ImajnetPlugin.addMarkerLayerToMap(ImajnetMap.photogrammetryPositionsLayerName);ImajnetMap.imajnetDragFeaturesLayer=ImajnetPlugin.addVectorLayerToMap(ImajnetMap.imajnetDragFeaturesLayerName);ImajnetMap.imajnetOrientationLayer=ImajnetPlugin.addVectorLayerToMap(ImajnetMap.imajnetOrientationLayerName);ImajnetUrl.applyUrlParams();ImajnetPlugin.registerMapEvents();ImajnetMap.allWFS||(ImajnetMap.allWFS=
ImajnetPlugin.addVectorLayerToMap(ImajnetMap.allWFSName));ImajnetPlugin.afterImajnetLayersAddedToMap()},unregisterFromMap:function(){this.hideImajboxMarker();this.hideOrientation();"undefined"!==typeof ImajnetClickMode&&ImajnetClickMode.hideOrientedImages(!0);this.imajnetLayer&&(ImajnetPlugin.removeLayerFromMap(this.imajnetLayer),this.imajnetLayer=null);this.imajnetDragFeaturesLayer&&(ImajnetPlugin.removeLayerFromMap(this.imajnetDragFeaturesLayer),this.imajnetDragFeaturesLayer=null);this.roadLayer&&
(ImajnetPlugin.removeLayerFromMap(this.roadLayer),this.roadLayer=null);this.prLayer&&(ImajnetPlugin.removeLayerFromMap(this.prLayer),this.prLayer=null);this.allWFS&&(ImajnetPlugin.removeLayerFromMap(this.allWFS),this.allWFS=null);this.imajnetSurveyTraceLayer&&(ImajnetPlugin.removeLayerFromMap(this.imajnetSurveyTraceLayer),this.imajnetSurveyTraceLayer=null);this.imajnetImageSwitcherLayer&&(ImajnetPlugin.removeLayerFromMap(this.imajnetImageSwitcherLayer),this.imajnetImageSwitcherLayer=null);this.clearPhotogrammetryObjects();
ImageControler.currentPhotogrammetry&&ImageControler.currentPhotogrammetry.clear();this.photogrammetryPositionsLayer&&(ImajnetPlugin.removeLayerFromMap(this.photogrammetryPositionsLayer),this.photogrammetryPositionsLayer=null);this.imajnetOrientationLayer&&(ImajnetPlugin.removeLayerFromMap(this.imajnetOrientationLayer),this.imajnetOrientationLayer=null);ImajnetPlugin.unregisterMapEvents();this.setCurrentPosition(null);ImajnetPlugin.onImajnetDeactivated()}};
var lastLoadedImageId="",ImajnetAPI={imageServerDomains:null,apiServerDomains:null,mustAbortRequests:!1,imageLoadQueue:[],imajnetOrderRequest:null,imajnetClosestPositionRequest:null,PREVIOUS:"previous",NEXT:"next",nextPositionCache:[],previousPositionCache:[],lastNavigationPositionImageId:"",angleWrapper:null,MAX_CACHE_IMAGE_POSITIONS:1E3,imajnetImage:null,stopImageCache:!1,horizontalAngleRequest:null,imajnetClosestPositionDeferred:null,lastOrderType:"",orderedImagesId:[],isSameSequence:null,xhrPool:[],
abortAllRequests:function(){ImajnetClickMode.loadImageDeferred&&(ImajnetClickMode.loadImageDeferred.reject(),ImajnetClickMode.loadImageDeferred=null);console.log(ImajnetAPI.xhrPool.length+" requests aborted");jQuery(ImajnetAPI.xhrPool).each(function(a,c){c.abort();ImajnetAPI.xhrPool.splice(a,1)})},getPreviousImageFromCache:function(a){for(var c=0;c<ImajnetAPI.previousPositionCache.length;c++)if(ImajnetAPI.previousPositionCache[c].imageId==a)return ImajnetAPI.previousPositionCache[c].orderImagePosition;
return null},getNextImageFromCache:function(a){for(var c=0;c<ImajnetAPI.nextPositionCache.length;c++)if(ImajnetAPI.nextPositionCache[c].imageId==a)return ImajnetAPI.nextPositionCache[c].orderImagePosition;return null},buildImageURLWithResolution:function(a,c,b){if(a&&c){a=new ImajnetData.imageParameter(a.id,c,b);a=JSON.stringify(a);a=encodeURI(a);c="";null!==ImajnetAPI.imageServerDomains?(a="/service/api/image/"+a,c=ImajnetMap.selectUrl(a,ImajnetAPI.imageServerDomains)+a):c=Imajnet.serverUrl+"/api/image/"+
a;if(ImajnetAPI.stopImageCache||0==ImajnetAPI.previousPositionCache.length&&0==ImajnetAPI.nextPositionCache.length)c=Nigsys.addRandomToUrl(c);return c}},buildImageURL:function(a,c,b){c=c?c:ImajnetSettings.getImageResolution();return ImajnetAPI.buildImageURLWithResolution(a,c,b)},shouldNavigate:function(){if(!ImajnetMap.currentPosition)return!0;if(ImajnetAPI.lastNavigationPositionImageId==ImajnetMap.currentPosition.id)return!1;ImajnetAPI.lastNavigationPositionImageId=ImajnetMap.currentPosition.id;
return!0},loadDefaultImage:function(a){ImageControler.currentImageControl.setCurrentImage(a);ImajnetUI.appendDefaultImage()},preloadImage:function(a,c,b,d){a.bind({error:d(a,c),load:b(a,c)}).attr("src",c)},loadImageType:function(a){var c=jQuery.Deferred();ImajnetAPI.doImajnetRequestDeferred("GET","/api/sequence/photogrammetryInfo?traceId\x3d"+a.traceId,null,null,null,null,null,!0,null).done(function(a,d){var g=JSON.parse(a);ImageControler.setCurrentImageControl(g);c.resolve(g)}).fail(function(a,d){ImageControler.setCurrentImageControl({imageType:"flat"});
c.resolve(null)});return c.promise()},onSetImajnetImage:function(a,c){var b=jQuery.Deferred();if(!ImajnetUI)return b.resolve(),b.promise();try{ImajnetUI.LRSGUI.hideOrientation()}catch(g){}LRS.hideLRS();"undefined"!==typeof ImajnetUI&&ImajnetUI.hideError();"undefined"!==typeof ImajnetZoom&&(ImajnetZoom.zoomBigImageLoaded=!1);if(a)if(Imajnet.activateImajnet(),a.position)ImajnetMap.setCurrentPosition(a.position),ImageControler.currentPhotogrammetry.init(),ImageControler.currentImageControl.loadImage(a).done(function(){b.resolve()});
else{a.parameter&&a.parameter.coordinates&&ImajnetPlugin.centerMapToPosition(a.parameter.coordinates,!0);ImajnetMap.setCurrentPosition(a&&a.parameter&&a.parameter.order?ImajnetMap.currentPosition:null);var d="";a.parameter&&a.parameter.order?(Nigsys.isPositionMode()?ImajnetPosition.showHidePositionDenied():Nigsys.isMeasurementMode()?ImajnetMeasurement.showHideMeasurementDenied():Nigsys.isPolyligneMode()&&ImajnetPolyligne.showHideDenied(),d=jQuery.imajnet.map.errors.unableToNavigate,b.resolve()):(ImajnetUI.showItem(ImajnetUI.imageContainerId),
ImageControler.currentImageControl.loadImage({position:null}).done(function(){b.resolve()}),d=jQuery.imajnet.map.errors.noImajnetImageAtPosition);ImageControler.currentImageControl.resetFastNavigation();ImajnetUI.stopSwipeNavigation();Nigsys.hideLoading(ImajnetUI.imageContainer);ImajnetUI.showError(d,!1);setTimeout("ImajnetUI.hideError()",3E3)}else ImajnetMap.setCurrentPosition(null),ImajnetMap.setCurrentPosition(a&&a.parameter&&a.parameter.order?ImajnetMap.currentPosition:null),b.resolve();ImajnetUI.showItem(ImajnetUI.imageContainerId);
jQuery(ImajnetEvents.mappingObject).trigger({type:ImajnetEvents.positionChangeEventName});return b.promise()},isImageValid:function(a){if(!ImajnetAPI.lastOrderType)return!0;for(var c=0;c<ImajnetAPI.orderedImagesId.length;c++)if(ImajnetAPI.orderedImagesId[c]==a)return ImajnetAPI.orderedImagesId.splice(0,c+1),!0;return!1},canLoadImageRequests:function(a){return!ImajnetAPI.orderedImagesId.length||position.id==ImajnetAPI.orderedImagesId[ImajnetAPI.orderedImagesId.length-1]},setImajnetImage:function(a,
c){var b=jQuery.Deferred();ImajnetZoom.lastLeftOffset=-Infinity;if(!ImajnetUI.imageContainer)return console.log("Cannot set imajnet image because containerId not set in options"),b.promise();if(!a||!a.position)return ImajnetAPI.orderedImagesId=[],ImageControler.currentImageControl&&(ImageControler.setCurrentImageControl({type:"FLAT"}),ImajnetAPI.setImajnetImageDeferred=ImajnetAPI.onSetImajnetImage(a,c)),b.resolve(),b.promise();a.parameter&&a.parameter.order&&ImajnetAPI.lastOrderType==a.parameter.order?
ImajnetAPI.orderedImagesId.push(a.position.id):(ImajnetAPI.lastOrderType="",ImajnetAPI.orderedImagesId=[]);ImajnetAPI.loadImageType(a.position).done(function(d){d&&(Imajnet.options.archiving&&(d.archivingState&&"Unarchived"!==d.archivingState?ImajnetUI.sequenceIsArchived(d.archivingState):ImajnetUI.sequenceIsNotArchived()),ImajnetZoom.HIGH_RESOLUTION_WIDTH=d.nativeImageSize.width,ImajnetZoom.HIGH_RESOLUTION_HEIGHT=d.nativeImageSize.height,ImajnetUI.fullSizeAspectRatio=ImajnetZoom.HIGH_RESOLUTION_WIDTH/
ImajnetZoom.HIGH_RESOLUTION_HEIGHT,ImajnetZoom.LOW_RESOLUTION_WIDTH=d.lowRezolutionImageSize.width,ImajnetZoom.LOW_RESOLUTION_HEIGHT=d.lowRezolutionImageSize.height,ImajnetZoom.MEDIUM_RESOLUTION_WIDTH=d.mediumRezolutionImageSize.width,ImajnetZoom.MEDIUM_RESOLUTION_HEIGHT=d.mediumRezolutionImageSize.height,Imajnet3dPosition.cameraCalibration=JSON.parse(d.cameraCalibration),Imajnet3dPosition.cameraCalibration&&("ST2"==Imajnet3dPosition.cameraCalibration.camera_type&&(Imajnet3dPosition.cameraCalibration.calibration_parameters.ccx-=
Imajnet3dPosition.cameraCalibration.calibration_parameters.roiLeft,Imajnet3dPosition.cameraCalibration.calibration_parameters.ccy-=Imajnet3dPosition.cameraCalibration.calibration_parameters.roiTop),Imajnet3dPosition.realImageCalibration=Imajnet3dPosition.cameraCalibration.calibration_parameters),Imajnet3dPosition.imageHas3D=d.has3D?Imajnet3dPosition.cameraCalibration?!0:!1:!1);ImajnetAPI.setImajnetImageDeferred=ImajnetAPI.onSetImajnetImage(a,c).done(function(){b.resolve()})});return b.promise()},
onClosestPositionReceived:function(a,c){var b=JSON.parse(a);ImajnetAPI.setImajnetImage(b,c)},getClosestPosition:function(a,c,b,d,g,k,h){ImajnetUI.stopSwipeNavigation(!0);ImajnetZoom.left=-1;ImajnetAPI.mustAbortRequests&&null!==ImajnetAPI.imajnetClosestPositionRequest&&ImajnetAPI.imajnetClosestPositionRequest.abort();"undefined"!==typeof ImajnetUI&&Nigsys.showLoading(ImajnetUI.imageContainer);"undefined"!==typeof ImajnetClickMode&&ImajnetClickMode.hideOrientedImages(!0);var e=jQuery.Deferred();a=new ImajnetData.closestPositionParameter(a,
c,b,d);ImajnetAPI.imajnetClosestPositionRequest=ImajnetAPI.doImajnetRequest("GET","/api/positions/closest/",a,function(a,c){ImajnetAPI.onClosestPositionReceived(a,c);"function"===typeof g&&g(a,c);e.resolve()},function(a,c){ImajnetUI.showItem(ImajnetUI.imageContainerId);ImajnetAPI.onError(a,c);"function"===typeof k&&k(a,c);e.reject()},null,null,null,h);return e.promise()},onError:function(a,c){try{if(ImajnetZoom.left=-1,a&&a.responseText){var b=JSON.parse(a.responseText);b&&b.radius&&!b.position&&
!b.parameter&&(b.parameter=Nigsys.cloneObject(b));ImajnetAPI.setImajnetImage(b,c)}else"abort"!=a.statusText&&ImajnetAPI.setImajnetImage(null,c)}catch(d){try{"abort"==a.statusText||Imajnet.options.sessionType&&"LRS"==Imajnet.options.sessionType||ImajnetAPI.setImajnetImage(null,c)}catch(g){}}},doOnPositionOrderReceived:function(a,c){try{var b=JSON.parse(a);b&&b.position&&b.parameter&&b.parameter.order&&!b.parameter.useCameraOrientation&&(ImajnetAPI.previousPositionCache.length>=ImajnetAPI.MAX_CACHE_IMAGE_POSITIONS&&
(ImajnetAPI.previousPositionCache=[]),ImajnetAPI.nextPositionCache.length>=ImajnetAPI.MAX_CACHE_IMAGE_POSITIONS&&(ImajnetAPI.nextPositionCache=[]),b.parameter.order==ImajnetAPI.NEXT?(ImajnetAPI.nextPositionCache.push({imageId:b.parameter.position.id,orderImagePosition:b.position}),ImajnetAPI.previousPositionCache.push({imageId:b.position.id,orderImagePosition:b.parameter.position})):b.parameter.order==ImajnetAPI.PREVIOUS&&(ImajnetAPI.previousPositionCache.push({imageId:b.parameter.position.id,orderImagePosition:b.position}),
ImajnetAPI.nextPositionCache.push({imageId:b.position.id,orderImagePosition:b.parameter.position})));c&&!1===c.changeImage||ImajnetAPI.setImajnetImage(b)}catch(d){}},positionOrderReceived:function(a,c){ImajnetAPI.doOnPositionOrderReceived(a,c)},getByOrder:function(a,c){ImajnetAPI.mustAbortRequests&&ImajnetAPI.imajnetOrderRequest&&ImajnetAPI.imajnetOrderRequest.abort();if(ImajnetMap.currentPosition&&ImajnetAPI.shouldNavigate()){ImageControler.currentSurveyTrace.clearSurveyTrace();arguments.callee.caller.arguments.callee.caller.name&&
"onDragEnd"!=arguments.callee.caller.arguments.callee.caller.name&&ImajnetUI.stopSwipeNavigation(!1);ImajnetAPI.lastOrderType=a;if(!c){var b=null;a==this.NEXT?b=ImajnetAPI.getNextImageFromCache(ImajnetMap.currentPosition.id):a==this.PREVIOUS&&(b=ImajnetAPI.getPreviousImageFromCache(ImajnetMap.currentPosition.id));if(b){ImajnetAPI.setImajnetImage({position:b,parameter:{order:a}});return}}b=new ImajnetData.imageOrderParameter(ImajnetMap.currentPosition,a,c);ImajnetAPI.imajnetOrderRequest=ImajnetAPI.doImajnetRequest("GET",
"/api/positions/order/",b,this.positionOrderReceived,this.onError)}},getHorizontalAngle:function(a,c){if(a){var b=null,b="CUBE"==ImageControler.currentImageType?CubePlugin.getRealImageCoordinatesFromMousePosition(a.x,a.y):ImajnetZoom.getRealImageCoordinates(a.x,a.y),d={};d.imagePoint={img:c,imgCoord:b};b="/api/photogrammetry/horizontalAngle/"+encodeURIComponent(JSON.stringify(d));ImajnetAPI.horizontalAngleRequest=ImajnetAPI.doImajnetRequest("GET",b,null,this.horizontalAngleReceived,this.horizontalAngleError)}},
horizontalAngleReceived:function(a){if(a=JSON.parse(a)){var c=a.parameter.imagePoint.img,b=c.orientation.yaw,c=Nigsys.transformImajnetOrientationPoint(Object({x:c.lon,y:c.lat}),new Proj4js.Proj("EPSG:4326"),new Proj4js.Proj("EPSG:900913")),d=ImajnetMap.imajboxTriangleDimension,d=ImajnetPlugin.getMapScale()/d*3,d=ImajnetAPI.getHorizontalAngleCoordinates(c,d);Nigsys.rotatePoint(b-a.angle,c,d[1]);for(a=0;a<d.length;++a)d[a]=Nigsys.transformImajnetOrientationPoint(d[a],new Proj4js.Proj("EPSG:900913"),
new Proj4js.Proj("EPSG:4326"));ImajnetAPI.clearHorizontalAngle();ImajnetAPI.angleWrapper=ImajnetPlugin.addFeature(ImajnetMap.imajnetDragFeaturesLayer,d,{type:"LineString",strokeWidth:2,strokeColor:"#00ff00",zIndex:2})}},horizontalAngleError:function(){ImajnetAPI.clearHorizontalAngle()},clearHorizontalAngle:function(){ImajnetAPI.angleWrapper&&(ImajnetPlugin.removeFeatures(ImajnetMap.imajnetDragFeaturesLayer,[ImajnetAPI.angleWrapper]),ImajnetAPI.angleWrapper=null)},getHorizontalAngleCoordinates:function(a,
c){var b=[];b.push(a);b.push({x:a.x,y:a.y+c});return b},getImajnetRequestUrl:function(a){null!==ImajnetAPI.apiServerDomains&&0!==ImajnetAPI.apiServerDomains.length?(a="/service"+a,requestUrl=ImajnetMap.selectUrl(a,ImajnetAPI.apiServerDomains)+a):requestUrl=Imajnet.serverUrl+a;if(a=window.location.hostname)requestUrl=-1===requestUrl.indexOf("?")?requestUrl+"?":requestUrl+"\x26",requestUrl+="param\x3d"+a;return requestUrl},getImajnetRequestParams:function(a,c,b,d,g,k,h,e,f){var l="";h="";b&&(l=JSON.stringify(b),
h=encodeURIComponent(l));b=c;"post"!=a.toLowerCase()&&(b+=h);h=!0;-1!==c.indexOf("/lrs/")&&(Nigsys.browserIsEdge()||Nigsys.browserIsIE())&&(h=!1);return{type:a,url:ImajnetAPI.getImajnetRequestUrl(b),dataType:"json",cache:h,crossDomain:{crossDomain:!0},xhrFields:{withCredentials:!0},beforeSend:function(a){ImajnetProtocol.buildHeaders(a);ImajnetAPI.xhrPool.push(a)},data:"post"==a.toLowerCase()?l:"",timeout:2E5,complete:function(a){var b=ImajnetAPI.xhrPool.indexOf(a);-1<b&&ImajnetAPI.xhrPool.splice(b,
1);void 0!==k&&null!==k&&k(a,e);if(200==a.status)"function"===typeof d?(b=d(a.responseText,e),f&&(b&&jQuery.isFunction(b.promise)?b.done(function(){f.resolve(a.responseText,e)}).fail(function(){f.reject(null,e)}):f.resolve(a.responseText,e))):f&&f.resolve(a.responseText,e);else{if(401!=a.status)if(403==a.status)ImajnetAPI.onError(a,e),"function"===typeof g&&g(a,e);else if("function"===typeof g){if("/api/positions/closest/"==c)ImajnetAPI.onError(a,e);g(a,e)}f&&f.reject(null,e)}}}},doImajnetRequest:function(a,
c,b,d,g,k,h,e,f){a=ImajnetAPI.getImajnetRequestParams(a,c,b,d,g,k,e,f);f&&f.params&&jQuery.extend(a,f.params);return jQuery.ajax(a)},doImajnetRequestDeferred:function(a,c,b,d,g,k,h,e,f){h=jQuery.Deferred();a=ImajnetAPI.getImajnetRequestParams(a,c,b,d,g,k,e,f,h);f&&f.params&&jQuery.extend(a,f.params);jQuery.ajax(a);return h.promise()}};
var ImajnetData={coordinates:function(a,c,b){this.lat=a;this.lon=c;this.height=b},closestPositionParameter:function(a,c,b,d){this.coordinates=new ImajnetData.coordinates(a,c,0);this.radius=b;this.timeframe=ImajnetTimeframe.getTimeframe();this.sequenceType=Imajnet.sequenceType;this.timeRadius=d?d:0},position:function(a){this.id=a},imageParameter:function(a,c,b){this.position=new ImajnetData.position(a);this.resolution=c;b&&(this.face=b)},imageOrderParameter:function(a,c,b){return{position:a,order:c,
useCameraOrientation:b,timeframe:ImajnetTimeframe.getTimeframe()}},sequenceDetailsParameter:function(a){return{image:a}}};
var ImajnetProtocol={loginRememberMe:"notSet",user:null,requestAccessNotificationContainer:null,loginStatus:-1,loginAjaxRequest:null,getUsernameForUrl:function(a){var b=ImajnetUser.getUsername();b||(b=Nigsys.getRandomString());var c=-1==a.indexOf("?")?"?":"\x26";return a+c+"client\x3d"+b},getDataFormat:function(){var a="application/json";"XML"==Imajnet.IMAJNET_DATA_FORMAT&&(a="application/xml");return a},buildHeaders:function(a,b,c,d){var e=ImajnetProtocol.getDataFormat();a.setRequestHeader("Content-Type",
e);a.setRequestHeader("Accept",e);a.setRequestHeader("metadata",Imajnet.metadata);a.setRequestHeader("imajnet-app-key",Imajnet.applicationKey);b&&c&&a.setRequestHeader("Authorization","Basic "+Base64.encode(b+":"+c));d&&Imajnet.options.sessionType&&a.setRequestHeader("sessionType",Imajnet.options.sessionType)},buildImageHeaders:function(a){a.setRequestHeader("metadata",Imajnet.metadata)},loginTimeout:function(){Nigsys.loginNotification&&Nigsys.loginNotification.isOpen&&(Nigsys.showLoginError(jQuery.imajnet.login.error.unknown),
jQuery("#imajnetLoginButton").prop("disabled",!1),jQuery("#imajnetLoginRequestAccess").prop("disabled",!1),jQuery("#imajnetLoginForgotPassword").prop("disabled",!1),jQuery(document).bind("keydown",ImajnetUI.clickLogin))},getErrorMessage:function(a){var b="";return b=(b=a.getResponseHeader("authenticationException"))?b==ImajnetResponse.header.UNAUTHETICATED?jQuery.imajnet.login.error.header.unauthenticated:b==ImajnetResponse.header.UNAUTHORISED?jQuery.imajnet.login.error.header.unauthorized:b==ImajnetResponse.header.ACCOUNT_LOCKED?
jQuery.imajnet.login.error.header.accountLocked:b==ImajnetResponse.header.ACCOUNT_DISABLED?jQuery.imajnet.login.error.header.accountDisabled:b==ImajnetResponse.header.ACCOUNT_EXPIRED?jQuery.imajnet.login.error.header.accountExpired:b==ImajnetResponse.header.CREDENTIALS_EXPIRED?jQuery.imajnet.login.error.header.credentialsExpired:b==ImajnetResponse.header.INVALID_APPLICATION_KEY?jQuery.imajnet.login.error.header.invalidApplicationKey:b==ImajnetResponse.header.INVALID_SESSION_TYPE?jQuery.imajnet.login.error.header.invalidSessionType:
b==ImajnetResponse.header.UNAUTHORIZED_SESSION_TYPE?jQuery.imajnet.login.error.header.unauthorizedSessionType:jQuery.imajnet.login.error.header.unauthenticated:Nigsys.getStatusErrorText(a.status)},imajnetLoginSuccess:function(a){Nigsys.loginNotification&&Nigsys.loginNotification.close();"undefined"!==typeof ImajnetUI&&ImajnetUI&&jQuery(document).unbind("keydown",ImajnetUI.clickLogin);"FULL"==Imajnet.options.sessionType&&(Imajnet.containerId&&(Imajnet.appendImajnetHTMLElements(Imajnet.containerId),
ImajnetUI.initContainers()),"undefined"!==typeof ImajnetUI&&ImajnetUI&&ImajnetUI.init(),(a||"undefined"!==typeof ImajnetUrl&&Imajnet&&ImajnetUrl.getUrlParamValue(ImajnetUrl.LOCATION_URL_PARAM_NAME))&&Imajnet.activateImajnet(),Imajnet.options.goToClosestPointOfInterest&&ImajnetMap.loadPOI());Nigsys.hideLoading(jQuery(Imajnet.containerId))},imajnetLogin:function(a,b,c){var d=jQuery.Deferred();ImajnetUser.resetUserData(!1);if(!Imajnet.serverUrl)return console.log("Imajnet server url not defined"),d.reject(),
d.promise();ImajnetProtocol.loginAjaxRequest=jQuery.ajax({type:"GET",url:ImajnetProtocol.getUsernameForUrl(ImajnetAPI.getImajnetRequestUrl("/api/user/userdetails"+(ImajnetProtocol.loginRememberMe&&"notSet"!=ImajnetProtocol.loginRememberMe?"?remember-me\x3don":""))),cache:!1,async:!1,dataType:"json",timeout:Nigsys.requestsTimeout,crossDomain:{crossDomain:!0},xhrFields:{withCredentials:!0},beforeSend:function(c){ImajnetProtocol.buildHeaders(c,a,b,!0)},complete:function(a,b){ImajnetProtocol.loginStatus=
a.status;if(ImajnetProtocol.loginStatus==ImajnetResponse.OK){Nigsys.onMobile()&&Nigsys.browserIsSafari()&&jQuery("#container").css("position","fixed");var f=JSON.parse(a.responseText);ImajnetUser.setData(f.user);"undefined"!==typeof ImajnetMap&&ImajnetMap&&(ImajnetMap.key=ImajnetUser.data.cartographicKey?ImajnetUser.data.cartographicKey:"imajnet1",ImajnetMap.initLRSUrl());"undefined"!==typeof ImajnetSettings&&ImajnetSettings&&LRS.checkIfLRSAccess().done(function(){ImajnetSettings.init();ImajnetSettings.getSettings().done(function(){"undefined"!==
typeof ImageControler&&"function"===typeof ImageControler.initDefaults&&ImageControler.initDefaults();console.log("Imajnet Logged in");ImajnetPlugin.imajnetLoginSuccess();ImajnetProtocol.imajnetLoginSuccess(c);d.resolve()}).fail(function(){"undefined"!==typeof ImageControler&&"function"===typeof ImageControler.initDefaults&&ImageControler.initDefaults();console.log("Imajnet Logged in");ImajnetPlugin.imajnetLoginSuccess();ImajnetProtocol.imajnetLoginSuccess(c);d.resolve()})})}else ImajnetPlugin.imajnetLoginError(a),
d.reject();Nigsys.deleteCookies("IMAJNET")},error:function(){d.reject()}});return d.promise()},imajnetLogout:function(a){var b=jQuery.Deferred();if("undefined"!==typeof ImajnetPolyligne)ImajnetPolyligne.onFinish();if(!Imajnet.serverUrl)return console.log("Imajnet server url not defined"),b.reject(),b.promise();Nigsys.onMobile()&&Nigsys.browserIsSafari()&&jQuery("#container").css("position","static");ImajnetUser.resetUserData(!0);console.log("Imajnet logout");jQuery.ajax({type:"GET",url:Imajnet.serverUrl+
"/api/logout",cache:!1,async:!1,timeout:Nigsys.requestsTimeout,crossDomain:{crossDomain:!0},xhrFields:{withCredentials:!0},beforeSend:function(a){ImajnetProtocol.buildHeaders(a)},complete:function(){console.log("Imajnet Logged out");ImajnetPlugin.imajnetLogoutComplete();b.resolve()}});a&&"undefined"!==typeof ImajnetUrl&&(ImajnetUrl.deleteUrlParams(),ImajnetUrl.applyUrlParams(!0));ImajnetProtocol.loginStatus!=ImajnetResponse.OK&&b.resolve();return b.promise()},determineImajnetDomainRelativeUrl:function(){return"undefined"===
typeof applicationDomain||-1!=applicationDomain.indexOf(".imajnet.net")?"https://imajnet.net":"http://"+window.location.hostname},forgotPassword:function(){window.open(ImajnetProtocol.determineImajnetDomainRelativeUrl()+"/forgotPassword")},requestAccess:function(){window.open(ImajnetProtocol.determineImajnetDomainRelativeUrl()+"/registration")},doLogin:function(){jQuery(Nigsys.loginNotification.element).hide();jQuery("#imajnetLoginButton").prop("disabled",!0);jQuery("#imajnetLoginRequestAccess").prop("disabled",
!0);jQuery("#imajnetLoginForgotPassword").prop("disabled",!0);"undefined"!==typeof ImajnetUI&&jQuery(document).unbind("keydown",ImajnetUI.clickLogin);Nigsys.errorNotification&&Nigsys.errorNotification.close();Nigsys.showImajnetLoading();if("notSet"==ImajnetProtocol.loginRememberMe){var a=jQuery("#rememberMe");a.length&&(ImajnetProtocol.loginRememberMe=a.is(":checked"))}return ImajnetProtocol.imajnetLogin(jQuery("#username").val(),jQuery("#password").val(),!Imajnet.options||Imajnet.options.activateImajnet)}};
var ImajnetSettings={NO_TIME_RANGE:0,rangeAddress:3E3,timeRangeAddress:500,rangeLRS:30,timeRangeLRS:5,rangeClosestPositionUrl:500,limitImageSwitcher:30,limitSurveyTrace:30,limitOrientedImages:15,IMAJNET_GIS:"IMAJNET_GIS",IMAJNET:"IMAJNET",IMAJNET_LIB:"IMAJNET_LIB",imajnetMode:null,timeframe:null,imajnetImageResolutions:{0:"thumbnail",1:"low",2:"medium",3:"high"},imageRetrievalOptions:{CLOSEST:"CLOSEST",NEWEST:"NEWEST",BEST:"BEST"},defaultImajnetSettings:{imageQuality:2,surveyTrace:30,imageSwitcher:10,
imageRetrievalOptions:"CLOSEST",orientedImages:50,projection:50,toolsRemainActive:!1},imajnetSettings:null,rangeImajnetSettings:{imageQuality:{low:1,high:3},surveyTrace:{low:10,high:100},imageSwitcher:{low:0,high:20},orientedImages:{low:10,high:150},projection:{low:10,high:100}},sliders:{imageQuality:null,surveyTrace:null,imageSwitcher:null,orientedImages:null,projection:null},init:function(){var a=Address.OPTIONS_OSM;a&&"undefined"!==typeof Address&&Address&&(Address.currentSearchOption=a)},getImageResolution:function(){return ImajnetMap.currentPosition&&
-1!==ImajnetZoom.zoomedImagesCache.indexOf(ImajnetMap.currentPosition.id)?this.imajnetImageResolutions[3]:this.imajnetSettings?this.imajnetImageResolutions[this.imajnetSettings.imageQuality]:null},getImajnetSettingsPopupHTML:function(){var a="",b;for(b in ImajnetSettings.imageRetrievalOptions)a+='\x3cdiv\x3e\x3cinput type\x3d"radio" name\x3d"imageRetrievalOptions" value\x3d"'+ImajnetSettings.imageRetrievalOptions[b]+'" /\x3e\x26nbsp;'+jQuery.imajnet.settings.imageOptions[ImajnetSettings.imageRetrievalOptions[b]]+
"\x3c/div\x3e";return'\x3cdiv id\x3d"imageSettings" class\x3d"optionsGroup"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+jQuery.imajnet.settings.imageSectionTitle+'\x3c/span\x3e\x3cdiv style\x3d"margin-top: -10px;"\x3e\x3cdiv class\x3d"left"\x3e\x3cdiv id\x3d"popupContentContainer"\x3e\x3cdiv class\x3d"left settingsSearchLeft"\x3e'+jQuery.imajnet.settings.imageQuality+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cdiv class\x3d"sliderTopTitleSmall"\x3e\x3cdiv class\x3d"left" style\x3d"width: 30px; margin-left: -10px; text-align: center;"\x3e'+
jQuery.imajnet.settings.imageQualityLow+'\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 160px; text-align: center;"\x3e'+jQuery.imajnet.settings.imageQualityMedium+'\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 40px; text-align: center;"\x3e'+jQuery.imajnet.settings.imageQualityHigh+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetSettingsImageQualitySlider" style\x3d"width: 200px;"\x3e\x3cdiv class\x3d"ui-slider-handle"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 5px;"\x3e\x3c/div\x3e\x3cdiv class\x3d"left settingsSearchLeft"\x3e'+
jQuery.imajnet.settings.surveyTrace+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cdiv class\x3d"sliderTopTitleSmall"\x3e\x3cdiv class\x3d"left" style\x3d"width: 30px; margin-left: -10px; text-align: center;"\x3e'+jQuery.imajnet.settings.surveyTraceLow+'\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 150px; text-align: center;"\x3e\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 50px; text-align: center;"\x3e'+jQuery.imajnet.settings.surveyTraceHight+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetSettingsVisibleImagesSlider" style\x3d"width: 200px;"\x3e\x3cdiv class\x3d"ui-slider-handle"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 5px;"\x3e\x3c/div\x3e\x3cdiv class\x3d"left settingsSearchLeft"\x3e'+
jQuery.imajnet.settings.imageSwitcher+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cdiv class\x3d"sliderTopTitleSmall"\x3e\x3cdiv class\x3d"left" style\x3d"width: 30px; margin-left: -10px; text-align: center;"\x3e'+jQuery.imajnet.settings.imageSwitcherLow+'\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 150px; text-align: center;"\x3e\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 50px; text-align: center;"\x3e'+jQuery.imajnet.settings.imageSwitcherHight+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetSettingsImageSwitcherSlider" style\x3d"width: 200px;"\x3e\x3cdiv class\x3d"ui-slider-handle"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 10px;"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"left optionsGroupRight" style\x3d"display: none;"\x3e\x3cdiv style\x3d"text-decoration: underline; margin-bottom: 5px;"\x3e'+
jQuery.imajnet.settings.imageOptions.title+"\x3c/div\x3e"+a+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"margin-left: 10px; width: 170px;"\x3e\x3cdiv class\x3d"optionsGroup"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+jQuery.imajnet.settings.units.title+'\x3c/span\x3e\x3cdiv id\x3d"popupContentContainer" style\x3d"margin-top: -10px;"\x3e\x3cdiv class\x3d"left settingsSearchLeft"\x3e'+jQuery.imajnet.settings.units.unit+
'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cselect id\x3d"imajnetSettingsUnit" style\x3d"margin-top: 12px;"\x3e\x3coption value\x3d"m" title\x3d"'+jQuery.imajnet.settings.units.m+'"\x3em\x3c/option\x3e\x3coption value\x3d"feet" title\x3d"'+jQuery.imajnet.settings.units.feet+'"\x3efeet\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 10px;"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"optionsGroup"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+
jQuery.imajnet.settings.tools.title+'\x3c/span\x3e\x3cdiv id\x3d"popupContentContainer" style\x3d"margin-top: -10px;"\x3e\x3cdiv class\x3d"left settingsSearchLeft" style\x3d"width: 120px;"\x3e'+jQuery.imajnet.settings.tools.remainActive+'\x3c/div\x3e\x3cdiv class\x3d"right"\x3e\x3cinput id\x3d"imajnetSettingsToolsRemainActive" style\x3d"margin-top: 15px; margin-right: 10px;" type\x3d"checkbox"\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 10px;"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3cdiv class\x3d"optionsGroup"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+
jQuery.imajnet.settings.mapSectionTitle+'\x3c/span\x3e\x3cdiv id\x3d"popupContentContainer" style\x3d"margin-top: -10px;"\x3e\x3cdiv class\x3d"left settingsSearchLeft"\x3e'+jQuery.imajnet.settings.orientedImages+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cdiv class\x3d"sliderTopTitle"\x3e\x3cdiv class\x3d"left" style\x3d"width: 30px; margin-left: -10px; text-align: center;"\x3e'+jQuery.imajnet.settings.orientedImagesLow+'\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 355px; text-align: center;"\x3e\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 50px; text-align: center;"\x3e'+
jQuery.imajnet.settings.orientedImagesHight+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetSettingsOrientedImagesSlider" style\x3d"width: 410px;"\x3e\x3cdiv class\x3d"ui-slider-handle"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 10px;"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"optionsGroup"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+jQuery.imajnet.settings.projectionSectionTitle+'\x3c/span\x3e\x3cdiv id\x3d"popupContentContainer" style\x3d"margin-top: -10px;"\x3e\x3cdiv class\x3d"left settingsSearchLeft"\x3e'+
jQuery.imajnet.settings.projection+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cdiv class\x3d"sliderTopTitle"\x3e\x3cdiv class\x3d"left" style\x3d"width: 30px; margin-left: -10px; text-align: center;"\x3e'+jQuery.imajnet.settings.projectionLow+'\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 355px; text-align: center;"\x3e\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left" style\x3d"width: 50px; text-align: center;"\x3e'+jQuery.imajnet.settings.projectionHigh+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetSettingsProjectionSlider" style\x3d"width: 410px;"\x3e\x3cdiv class\x3d"ui-slider-handle"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 10px;"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv style\x3d"text-align: center; margin-top: 3px;"\x3e\x3cinput type\x3d"button" value\x3d"'+
jQuery.imajnet.settings.resetDefaultButton+'" onclick\x3d"ImajnetSettings.resetSettingsToDefault();" class\x3d"dialogButton"\x3e\x3cinput type\x3d"button" value\x3d"'+jQuery.imajnet.settings.saveSettingsButton+'" onclick\x3d"ImajnetSettings.saveSettings();" class\x3d"dialogButton dialogButtonSave"\x3e\x3c/div\x3e'},getSettings:function(){this.getSettingsFromCookie();ImajnetLRSSettings.getLRSSettingsFromCookie();return ImajnetUserSettings.getUserSettings()},resetSettingsToDefault:function(){for(var a in this.defaultImajnetSettings)"imageRetrievalOptions"==
a?Nigsys.setRadioValue(a,this.defaultImajnetSettings[a]):this.sliders[a].slider("value",this.defaultImajnetSettings[a]);jQuery("#imajnetSettingsUnit").val("m");jQuery("#imajnetSettingsToolsRemainActive").prop("checked",!1)},getSettingsFromCookie:function(){this.imajnetSettings=Nigsys.cloneObject(this.defaultImajnetSettings);var a=Nigsys.getCookie("IMAJNET","SETTINGS");if(a){for(var b in a)this.imajnetSettings[b]="imageRetrievalOptions"==b&&this.imageRetrievalOptions[a[b]]||"unit"==b||"toolsRemainActive"==
b||!this.rangeImajnetSettings[b]||!this.rangeImajnetSettings[b].low||!this.rangeImajnetSettings[b].high?a[b]:a[b]>=this.rangeImajnetSettings[b].low&&a[b]<=this.rangeImajnetSettings[b].high?a[b]:this.defaultImajnetSettings[b];"undefined"!==typeof ImajnetUI&&ImajnetUI&&ImajnetUI.computeImageAspectRatio()}else"undefined"!==typeof ImajnetUI&&ImajnetUI&&ImajnetUI.computeImageAspectRatio(),this.imajnetSettings.toolsRemainActive||(this.imajnetSettings.toolsRemainActive=!1)},getSettingsFromPopup:function(){this.imajnetSettings.imageQuality=
this.sliders.imageQuality.slider("value");ImajnetUI.computeImageAspectRatio();this.imajnetSettings.surveyTrace=this.sliders.surveyTrace.slider("value");this.imajnetSettings.imageSwitcher=this.sliders.imageSwitcher.slider("value");this.imajnetSettings.imageRetrievalOptions=Nigsys.getRadioValue("imageRetrievalOptions");this.imajnetSettings.orientedImages=this.sliders.orientedImages.slider("value");this.imajnetSettings.projection=this.sliders.projection.slider("value");this.imajnetSettings.unit=jQuery("#imajnetSettingsUnit").val();
this.imajnetSettings.toolsRemainActive=jQuery("#imajnetSettingsToolsRemainActive").is(":checked")},saveSettings:function(){ImajnetSettings.getSettingsFromPopup();Nigsys.setCookie("IMAJNET","SETTINGS",ImajnetSettings.imajnetSettings);ImageControler.currentPhotogrammetry.redrawClipboard();ImajnetUI.hideItem(ImajnetUI.settingsContainerId)},showImajnetSettings:function(){ImajnetUI.settingsContainer.html("");ImajnetUI.settingsContainer.append(ImajnetSettings.getImajnetSettingsPopupHTML());ImajnetSettings.sliders.imageQuality=
jQuery("#imajnetSettingsImageQualitySlider").slider({min:ImajnetSettings.rangeImajnetSettings.imageQuality.low,max:ImajnetSettings.rangeImajnetSettings.imageQuality.high,value:ImajnetSettings.imajnetSettings.imageQuality,slide:function(a,b){ImajnetSettings.imageQuality=b.value}});ImajnetUI.closeAllMenus();var a=jQuery("\x3cdiv/\x3e").css({position:"absolute",top:27,left:0}).text("").hide();ImajnetSettings.sliders.surveyTrace=jQuery("#imajnetSettingsVisibleImagesSlider").slider({min:ImajnetSettings.rangeImajnetSettings.surveyTrace.low,
max:ImajnetSettings.rangeImajnetSettings.surveyTrace.high,step:10,value:ImajnetSettings.imajnetSettings.surveyTrace,slide:function(b,e){a.text(e.value+"m");a.show()}});ImajnetSettings.sliders.surveyTrace.find(".ui-slider-handle").append(a).hover(function(){a.text(ImajnetSettings.sliders.surveyTrace.slider("value")+"m");a.show()},function(){a.hide()});var b=jQuery("\x3cdiv/\x3e").css({position:"absolute",top:27,left:0}).text("").hide();ImajnetSettings.sliders.imageSwitcher=jQuery("#imajnetSettingsImageSwitcherSlider").slider({min:ImajnetSettings.rangeImajnetSettings.imageSwitcher.low,
max:ImajnetSettings.rangeImajnetSettings.imageSwitcher.high,step:1,value:ImajnetSettings.imajnetSettings.imageSwitcher,slide:function(a,e){b.text(e.value+"m");b.show()}});ImajnetSettings.sliders.imageSwitcher.find(".ui-slider-handle").append(b).hover(function(){b.text(ImajnetSettings.sliders.imageSwitcher.slider("value")+"m");b.show()},function(){a.hide()});Nigsys.setRadioValue("imageRetrievalOptions",ImajnetSettings.imajnetSettings.imageRetrievalOptions);var c=jQuery("\x3cdiv/\x3e").css({position:"absolute",
top:27,left:0}).text("").hide();ImajnetSettings.sliders.orientedImages=jQuery("#imajnetSettingsOrientedImagesSlider").slider({min:ImajnetSettings.rangeImajnetSettings.orientedImages.low,max:ImajnetSettings.rangeImajnetSettings.orientedImages.high,step:10,value:ImajnetSettings.imajnetSettings.orientedImages,slide:function(a,b){c.text(b.value+"m");c.show()}});ImajnetSettings.sliders.orientedImages.find(".ui-slider-handle").append(c).hover(function(){c.text(ImajnetSettings.sliders.orientedImages.slider("value")+
"m");c.show()},function(){c.hide()});var d=jQuery("\x3cdiv/\x3e").css({position:"absolute",top:27,left:0}).text("").hide();ImajnetSettings.sliders.projection=jQuery("#imajnetSettingsProjectionSlider").slider({min:ImajnetSettings.rangeImajnetSettings.projection.low,max:ImajnetSettings.rangeImajnetSettings.projection.high,step:10,value:ImajnetSettings.imajnetSettings.projection,slide:function(a,b){d.text(b.value+"m");d.show()}});ImajnetSettings.sliders.projection.find(".ui-slider-handle").append(d).hover(function(){d.text(ImajnetSettings.sliders.projection.slider("value")+
"m");d.show()},function(){d.hide()});jQuery("#imajnetSettingsUnit").val(Nigsys.getMeasurementUnit());jQuery("#imajnetSettingsToolsRemainActive").prop("checked",ImajnetSettings.imajnetSettings.toolsRemainActive);ImajnetUI.showItem(ImajnetUI.settingsContainerId,Nigsys.browserIsIE7()?530:null);jQuery("#imajnetSettingsUnit").trigger("blur")}};
var ImajnetUserSettings={lrsRoadType:0,mapExtent:null,onUserSettingsReceived:function(a){a=JSON.parse(a);a.options&&(ImajnetUserSettings.lrsRoadType=a.options.lrsRoadType,ImajnetUserSettings.mapExtent=a.options.mapExtent)},getUserSettings:function(){return ImajnetAPI.doImajnetRequestDeferred("GET","/api/user/useroptions",null,this.onUserSettingsReceived,null,null)}};
var ImajnetLRSSettings={ADDRESS_MODE:{FULL:"FULL",CITY:"CITY"},defaultLRSSettings:{display:{addressAndLRS:{imajnetSettingsLRSShowCumulated:!0,imajnetSettingsAddressInLRS:!1,imajnetSettingsAddressDisplayType:"FULL"},map:{showRoads:!0,showPR:!0,showLabels:!0}},search:{road:{relativePoint:1,cumulatedAbscisa:1,relativeAbscisa:1},train:{relativePoint:2,cumulatedAbscisa:1,relativeAbscisa:2}},referential:{road:{relativePoint:1,cumulatedAbscisa:1,relativeAbscisa:1},train:{relativePoint:2,cumulatedAbscisa:1,
relativeAbscisa:2}}},LRSSettings:null,resetLRSSettingsToDefault:function(){for(var a in this.defaultLRSSettings)if("display"!=a)for(var b in this.defaultLRSSettings[a])for(var c in this.defaultLRSSettings[a][b])jQuery("#"+a+"_"+b+"_"+c).val(this.defaultLRSSettings[a][b][c]);jQuery("#display_addressAndLRS_imajnetSettingsLRSShowCumulated").prop("checked",this.defaultLRSSettings.display.addressAndLRS.imajnetSettingsLRSShowCumulated);CommonCore.updateCustomCheckbox(jQuery("#display_addressAndLRS_imajnetSettingsLRSShowCumulated"));
jQuery("#display_addressAndLRS_imajnetSettingsAddressInLRS").prop("checked",this.defaultLRSSettings.display.addressAndLRS.imajnetSettingsAddressInLRS);CommonCore.updateCustomCheckbox(jQuery("#display_addressAndLRS_imajnetSettingsAddressInLRS"));jQuery("#display_addressAndLRS_imajnetSettingsAddressDisplayType").val(this.defaultLRSSettings.display.addressAndLRS.imajnetSettingsAddressDisplayType);jQuery("#display_addressAndLRS_showRoads").prop("checked",this.defaultLRSSettings.display.map.showRoads);
CommonCore.updateCustomCheckbox(jQuery("#display_addressAndLRS_showRoads"));jQuery("#display_addressAndLRS_showPR").prop("checked",this.defaultLRSSettings.display.map.showPR);CommonCore.updateCustomCheckbox(jQuery("#display_addressAndLRS_showPR"));jQuery("#display_addressAndLRS_showLabels").prop("checked",this.defaultLRSSettings.display.map.showLabels);CommonCore.updateCustomCheckbox(jQuery("#display_addressAndLRS_showLabels"))},getLRSSettingsFromCookie:function(){this.LRSSettings=Nigsys.cloneObject(this.defaultLRSSettings);
var a=Nigsys.getCookie("IMAJNET","LRS_SETTINGS");if(a)for(var b in a)for(var c in a[b])for(var d in a[b][c])this.LRSSettings[b][c][d]=a[b][c][d];else ImajnetLRSSettings.LRSSettings.display.addressAndLRS.showRoads=!0,ImajnetLRSSettings.LRSSettings.display.addressAndLRS.showPR=!0,ImajnetLRSSettings.LRSSettings.display.addressAndLRS.showLabels=!0},getLRSSettingsFromPopup:function(){for(var a in this.LRSSettings)if("display"!=a)for(var b in this.LRSSettings[a])for(var c in this.LRSSettings[a][b])this.LRSSettings[a][b][c]=
jQuery("#"+a+"_"+b+"_"+c).val();this.LRSSettings.display.addressAndLRS.imajnetSettingsLRSShowCumulated=jQuery("#display_addressAndLRS_imajnetSettingsLRSShowCumulated").is(":checked");this.LRSSettings.display.addressAndLRS.imajnetSettingsAddressInLRS=jQuery("#display_addressAndLRS_imajnetSettingsAddressInLRS").is(":checked");this.LRSSettings.display.addressAndLRS.imajnetSettingsAddressDisplayType=jQuery("#display_addressAndLRS_imajnetSettingsAddressDisplayType").val();this.LRSSettings.display.addressAndLRS.showRoads=
jQuery("#display_addressAndLRS_showRoads").is(":checked");this.LRSSettings.display.addressAndLRS.showPR=jQuery("#display_addressAndLRS_showPR").is(":checked");this.LRSSettings.display.addressAndLRS.showLabels=jQuery("#display_addressAndLRS_showLabels").is(":checked")},updateSearch:function(){},updateReferential:function(){var a=LRS.getLabelsValueFromSettings(jQuery("#imajnetImageLRSType").val(),"referential");if(a){jQuery("#imajnetImageLRSRoadLabel").html("\x3cb\x3e"+a.roadLabel+"\x3c/b\x3e:\x26nbsp;");
var b=jQuery("#imajnetImageLRSCumulatedAbscisaLabel");b.html("\x3cb\x3e"+a.cumulatedAbscisaLabel+"\x3c/b\x3e:\x26nbsp;");ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsLRSShowCumulated?b.parent().show():b.parent().hide()}},updateLabels:function(){"undefined"!==typeof Address&&(Address.init(),Address.getAddressFromCoordinates(ImajnetMap.currentPosition));LRS.loadLRS(ImajnetMap.currentPosition);this.updateSearch();this.updateReferential()},saveLRSSettings:function(){ImajnetLRSSettings.getLRSSettingsFromPopup();
Nigsys.setCookie("IMAJNET","LRS_SETTINGS",ImajnetLRSSettings.LRSSettings);ImajnetLRSSettings.updateLabels();"undefined"!==typeof ImajnetUI&&ImajnetUI.hideItem(ImajnetUI.settingsLRSContainerId)},showLayersChanged:function(){jQuery("#display_addressAndLRS_showRoads").is(":checked")||jQuery("#display_addressAndLRS_showPR").is(":checked")?jQuery("#display_addressAndLRS_showLabels").prop("disabled",!1):jQuery("#display_addressAndLRS_showLabels").prop("checked",!1).prop("disabled",!0)},getLRSSettingsPopupHTML:function(){var a=
'\x3cdiv id\x3d"'+("undefined"===typeof ImajnetUI?"":ImajnetUI.settingsLRSContainerId)+'"\x3e\x3cdiv class\x3d"LRSSubtitle"\x3e'+jQuery.imajnet.settings.display.title+'\x3c/div\x3e\x3cdiv class\x3d"optionsGroup left LRSSettingsReferentialItemContainer"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+jQuery.imajnet.settings.display.image+'\x3c/span\x3e\x3cdiv\x3e\x3cdiv class\x3d"left"\x3e'+jQuery.imajnet.settings.display.LRSShowCumulated+':\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left showCumulated"\x3e'+
Nigsys.getCheckboxHTML("display_addressAndLRS_imajnetSettingsLRSShowCumulated",null,null,null,ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsLRSShowCumulated)+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"ImjnetLRSSettingsSearchAddressContainer" style\x3d"margin-top: 3px;"\x3e\x3cdiv class\x3d"left"\x3e'+jQuery.imajnet.settings.display.addressInLRS+':\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"checkbox" id\x3d"display_addressAndLRS_imajnetSettingsAddressInLRS"'+
(ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsAddressInLRS?' checked\x3d"checked"':"")+' /\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv style\x3d"margin-top: 3px;"\x3e\x3cdiv class\x3d"left"\x3e'+jQuery.imajnet.settings.display.addressDisplayType.title+':\x26nbsp;\x3c/div\x3e\x3cdiv\x3e\x3cselect id\x3d"display_addressAndLRS_imajnetSettingsAddressDisplayType" style\x3d"margin-left: 3px;"\x3e\x3coption value\x3d"FULL"'+(ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsAddressDisplayType==
this.ADDRESS_MODE.FULL?' selected\x3d"selected"':"")+"\x3e"+jQuery.imajnet.settings.display.addressDisplayType.full+'\x3c/option\x3e\x3coption value\x3d"CITY"'+(ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsAddressDisplayType==this.ADDRESS_MODE.CITY?' selected\x3d"selected"':"")+"\x3e"+jQuery.imajnet.settings.display.addressDisplayType.city+'\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetWebShowRoadsAndPR" class\x3d"optionsGroup left LRSSettingsReferentialItemContainer" style\x3d"margin-left: 5px;"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+
jQuery.imajnet.settings.display.carto+'\x3c/span\x3e\x3cdiv\x3e\x3cdiv class\x3d"left"\x3e'+jQuery.imajnet.settings.display.showRoads+':\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left showCumulated"\x3e'+Nigsys.getCheckboxHTML("display_addressAndLRS_showRoads",null,null,' onchange\x3d"ImajnetLRSSettings.showLayersChanged();"',ImajnetLRSSettings.LRSSettings.display.addressAndLRS.showRoads)+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"ImjnetLRSSettingsSearchAddressContainer" style\x3d"margin-top: 3px;"\x3e\x3cdiv class\x3d"left"\x3e'+
jQuery.imajnet.settings.display.showPR+':\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left showCumulated"\x3e'+Nigsys.getCheckboxHTML("display_addressAndLRS_showPR",null,null,' onchange\x3d"ImajnetLRSSettings.showLayersChanged();"',ImajnetLRSSettings.LRSSettings.display.addressAndLRS.showPR)+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv style\x3d"margin-top: 3px;"\x3e\x3cdiv class\x3d"left"\x3e'+jQuery.imajnet.settings.display.showLabels+':\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left showCumulated"\x3e'+
Nigsys.getCheckboxHTML("display_addressAndLRS_showLabels",null,null,null,ImajnetLRSSettings.LRSSettings.display.addressAndLRS.showLabels)+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e',b=Object.keys(ImajnetLRSSettings.LRSSettings).length,c=0,d;for(d in this.LRSSettings)if("display"!=d)for(var e in this.LRSSettings[d])0==c%2&&(0!=c&&(a+='\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e'),a+='\x3cdiv class\x3d"LRSItemContainer"\x3e\x3cdiv class\x3d"LRSSubtitle"\x3e'+
jQuery.imajnet.settings.LRS[d]+'\x3c/div\x3e\x3cdiv class\x3d"LRSSettingsReferentialContainer"\x3e'),a+=ImajnetLRSSettingType.getSettingHTML(d,e,this.LRSSettings[d][e],c),c==b&&(a+='\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e'),c++;return a+'\x3cdiv id\x3d"ImajnetLRSSettingsSaveButtonsContainer" style\x3d"text-align: center; margin-top: 5px;"\x3e\x3cinput type\x3d"button" value\x3d"'+jQuery.imajnet.settings.resetDefaultButton+'" onclick\x3d"ImajnetLRSSettings.resetLRSSettingsToDefault();" class\x3d"dialogButton"\x3e\x3cinput type\x3d"button" value\x3d"'+
jQuery.imajnet.settings.saveSettingsButton+'" onclick\x3d"ImajnetLRSSettings.saveLRSSettings();" class\x3d"dialogButton dialogButtonSave"\x3e\x3c/div\x3e\x3c/div\x3e'},showImajnetLRSSettings:function(){ImajnetUI.settingsLRSContainer.html(ImajnetLRSSettings.getLRSSettingsPopupHTML());ImajnetLRSSettings.showLayersChanged();CommonCore.bindCustomCheckbox(jQuery('#popupImajnetLRSSettings input[type\x3d"checkbox"]'));ImajnetUI.showItem(ImajnetUI.settingsLRSContainerId,Nigsys.browserIsIE7()?518:null);ImajnetUI.closeAllMenus()}};
var ImajnetLRSSettingType={getSettingHTML:function(c,f,e,a){a='\x3cdiv class\x3d"optionsGroup left LRSSettingsReferentialItemContainer" style\x3d"'+(1==a%2?" margin-left: 5px;":"")+'"\x3e\x3cspan class\x3d"popupContentContainerTitle"\x3e'+jQuery.imajnet.settings.LRS[f]+'\x3c/span\x3e\x3cdiv class\x3d"popupContentContainer"\x3e';var d=0,b;for(b in e){if("referential"!=c||2!=d)"search"==c&&0<d&&(a+='\x3cdiv style\x3d"display: none;"\x3e'),a+='\x3cdiv class\x3d"left settingsLeft"\x3e'+jQuery.imajnet.settings.LRS[b].label+
'\x3c/div\x3e\x3cdiv class\x3d"left settingsRight"\x3e\x3cselect id\x3d"'+c+"_"+f+"_"+b+'"'+("search"==c&&0<d?'disabled\x3d"disabled"':"")+' class\x3d"LRSSettingsSelect"\x3e\x3coption value\x3d"1" '+(1==e[b]?'selected\x3d"selected"':"")+"\x3e"+jQuery.imajnet.settings.LRS[b][1]+'\x3c/option\x3e\x3coption value\x3d"2" '+(2==e[b]?'selected\x3d"selected"':"")+"\x3e"+jQuery.imajnet.settings.LRS[b][2]+'\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft" style\x3d"height: 5px;"\x3e\x3c/div\x3e',
"search"==c&&0<d&&(a+="\x3c/div\x3e");d++}return a+"\x3c/div\x3e\x3c/div\x3e"}};
var ImajnetZoom={imageWasDragged:!1,imageQuality:"MEDIUM_RESOLUTION",width:0,height:0,shiftZoomStart:{x:0,y:0},left:-1,top:0,startScrollLeft:0,startScrollTop:0,zoomLevel:0,zoomRatio:1.2,maxZoomLevel:20,lastZoomLevel:null,firstZoom:!0,HIGH_RESOLUTION_WIDTH:2448,HIGH_RESOLUTION_HEIGHT:2050,MEDIUM_RESOLUTION_WIDTH:1024,MEDIUM_RESOLUTION_HEIGHT:857,LOW_RESOLUTION_WIDTH:512,LOW_RESOLUTION_HEIGHT:428,THUMBNAIL_RESOLUTION_WIDTH:512,THUMBNAIL_RESOLUTION_HEIGHT:428,zKeyPressed:!1,shiftKeyPressed:!1,zoomBigImageLoaded:!1,
orientationTriangleData:null,zoomedImagesCache:[],dragDirection:"",dragDirectionVertical:"",lastLeftOffset:-Infinity,lastTopOffset:-Infinity,dragCount:0,lastLeftPercentage:0,setZoomDimension:function(){this.width=ImajnetUI.imajnetImageContainerInitialSize.width;this.height=ImajnetUI.imajnetImageContainerInitialSize.height},init:function(a,b){ImajnetZoom.setZoomDimension();ImajnetZoom.registerEvents()},imageIsZoomed:function(){return 0!=ImajnetZoom.zoomLevel},moveToTop:function(a){ImajnetUI.imajnetImage.css("top",
parseInt(a))},moveToLeft:function(a){ImajnetUI.imajnetImage.css("left",parseInt(a));ImajnetUI.moveSurveyTraceContainerToLeft(a)},moveToPosition:function(a,b,c){this.width-Math.abs(a)<ImajnetUI.imajnetImageContainerSize.width&&(a=this.width-ImajnetUI.imajnetImageContainerSize.width);this.height-Math.abs(b)<ImajnetUI.imajnetImageContainerSize.height&&(b=this.height-ImajnetUI.imajnetImageContainerSize.height);b=-1*Math.abs(b);a=-1*Math.abs(a);if("right"==ImajnetZoom.dragDirection&&ImajnetZoom.lastLeftOffset>
a||"down"==ImajnetZoom.dragDirectionVertical&&ImajnetZoom.lastTopOffset>b)return!0;ImajnetZoom.left=a;ImajnetZoom.top=b;ImajnetZoom.lastLeftOffset=this.left;ImajnetZoom.lastTopOffset=this.top;isFinite(ImajnetZoom.lastLeftOffset)&&(ImajnetZoom.lastLeftPercentage=Math.ceil(ImajnetZoom.width/Math.abs(ImajnetZoom.lastLeftOffset)));this.moveToLeft(a);this.moveToTop(b);c&&ImajnetMap.setOrientationMarker(ImajnetMap.currentPosition,ImajnetMap.imajboxTriangleDimension,Nigsys.defaultObjectsColor,-1);return!0},
setDimension:function(a,b){ImajnetUI.imajnetImage.css("width",a);ImajnetUI.imajnetImage.css("height",b)},updateProjections:function(a){ImageControler.currentPhotogrammetry.redraw(!1,a)},setDraggableContainment:function(){var a=ImajnetUI.imajnetImageContainer.offset();ImajnetUI.getLargeImageWidthOverflow();var b=parseInt(a.left+ImajnetUI.imajnetImageContainerSize.width-this.width),c=parseInt(a.top+ImajnetUI.imajnetImageContainerSize.height-this.height),e=parseInt(a.left),a=parseInt(a.top);try{ImajnetUI.imajnetImage.draggable("option",
"containment",[b,c,e,a])}catch(d){}},resetZoom:function(a){ImajnetUI.imajnetImage.removeClass("popupImajnetImageZoomed");ImajnetUI.enableSwipeHandlers();ImajnetZoom.setZoomDimension();this.setDimension(this.width,this.height);a=0;1==ImajnetAPI.isSameSequence&&(a=ImajnetUI.imajnetImageContainerInitialSize.width/ImajnetZoom.lastLeftPercentage*-1,isFinite(a)||(a=0,""==ImajnetZoom.dragDirection,ImajnetZoom.dragDirectionVertical="",ImajnetZoom.imageWasDragged=!1));this.moveToPosition(a,0,!0);this.zoomLevel=
0;SurveyTrace.surveyTraceIsActive&&this.lastZoomLevel&&1<=this.lastZoomLevel&&ImageControler.currentSurveyTrace.restoreTrace();this.lastZoomLevel=null;this.setDraggableContainment();this.updateProjections();ImajnetUI.enableImageAllDrag();this.isZoomMode()||(ImajnetZoom.doWhenDeactivateZoom(),ImajnetUI.imajnetImageContainer.off("vmousedown",ImajnetZoom.onShiftZoomStart),CubePlugin.cubeMesh&&(CubePlugin.camera.fov=80))},canZoom:function(){return this.zKeyPressed||this.shiftKeyPressed},getCurrentZoomFactor:function(){return Math.pow(ImajnetZoom.zoomRatio,
ImajnetZoom.zoomLevel)},getRealImageSize:function(){return{width:ImajnetZoom.HIGH_RESOLUTION_WIDTH,height:ImajnetZoom.HIGH_RESOLUTION_HEIGHT}},getRealImageCoordinates:function(a,b){var c=ImajnetZoom.getCoordinatesOnScreen(a,b),e=ImajnetZoom.getRealImageSize();return{x:Math.round(e.width/ImajnetUI.imajnetImageContainerInitialSize.width*c.x),y:Math.round(e.height/ImajnetUI.imajnetImageContainerInitialSize.height*c.y)}},getCoordinatesOnScreen:function(a,b){var c=Math.abs(ImajnetZoom.top)+b,e=Math.abs(ImajnetZoom.left)+
a,d=this.getCurrentZoomFactor();return{x:e/d,y:c/d}},getScreenCoordinatesFromRealCoordinates:function(a){var b=this.getRealImageSize();return{x:a.x/(b.width/ImajnetUI.imajnetImageContainerInitialSize.width),y:a.y/(b.height/ImajnetUI.imajnetImageContainerInitialSize.height)}},getCoordinatesAtCurrentZoom:function(a,b){return{x:a.x*b,y:a.y*b}},getCoordinatesFromRealAtCurrentZoom:function(a){a=this.getCoordinatesAtCurrentZoom(a,this.getCurrentZoomFactor());a=this.getScreenCoordinatesFromRealCoordinates(a);
return{x:parseInt(a.x-Math.abs(this.left)),y:parseInt(a.y-Math.abs(this.top))}},onShiftZoomStart:function(a){if("TEXTAREA"==a.target.tagName)return!0;if(1!=a.which&&!Nigsys.onMobile())return a.preventDefault(),a.stopPropagation(),Nigsys.disableEventPropagation(a),!1;var b=jQuery(a.target).parent();b&&Nigsys.stringContains(b.attr("class"),"imajnetControlsLayerButtonsItem")||!ImajnetMap.currentPosition||(b=ImajnetUI.imajnetImageContainer.offset(),ImajnetZoom.shiftZoomStart.x=a.clientX,ImajnetZoom.shiftZoomStart.y=
a.clientY,ImajnetUI.imajnetZoomOnShiftBoxOffset.x=ImajnetZoom.shiftZoomStart.x-b.left,ImajnetUI.imajnetZoomOnShiftBoxOffset.y=ImajnetZoom.shiftZoomStart.y-b.top,ImajnetUI.imajnetZoomOnShiftBox.css("left",ImajnetUI.imajnetZoomOnShiftBoxOffset.x).css("top",ImajnetUI.imajnetZoomOnShiftBoxOffset.y).show(),ImajnetZoom.imageWasDragged=!0)},imageDragStart:function(a,b){ImajnetUI.isDragMode=!0;Imajnet3dPosition.clearCanvas();ImajnetUI.hideContextMenu(a);ImajnetZoom.dragCount=0;ImajnetZoom.startScrollLeft=
a.clientX;ImajnetZoom.startScrollTop=a.clientY},shiftZoomMouseMove:function(a){if((ImajnetZoom.canZoom()||ImajnetZoom.isZoomMode())&&ImajnetUI.imajnetZoomOnShiftBox.is(":visible")){var b=a.clientX-ImajnetZoom.shiftZoomStart.x;a=a.clientY-ImajnetZoom.shiftZoomStart.y;var c=ImajnetUI.imajnetZoomOnShiftBoxOffset.x;0>b&&(c+=b,b*=-1);var e=ImajnetUI.imajnetZoomOnShiftBoxOffset.y;0>a&&(e+=a,a*=-1);ImajnetUI.imajnetZoomOnShiftBox.css("left",c).css("top",e).css("width",b).css("height",a)}else ImajnetUI.hideShiftBox()},
imageDragOutsideContainer:function(a){var b=ImajnetUI.imajnetImageContainer.offset().left;return 0==ImajnetZoom.zoomLevel&&(a.clientX<b||a.clientX>ImajnetUI.imajnetImageContainer.width()+b)},imageDragRightReachEnd:function(){return ImajnetUI.imajnetImage.position().left+ImajnetUI.imajnetImage.width()<=ImajnetUI.imajnetImageContainerSize.width},imageDragReachEnd:function(){return 0==ImajnetZoom.zoomLevel&&(ImajnetImageSwitcher.dragRightPosition&&ImajnetZoom.imageDragRightReachEnd()||ImajnetImageSwitcher.dragLeftPosition&&
0==ImajnetUI.imajnetImage.position().left)},imageDrag:function(a,b){ImajnetUI.dragImageSliderCount=0;ImajnetZoom.imageDragOutsideContainer(a)||(ImajnetZoom.imageDragRightReachEnd()||0==ImajnetUI.imajnetImage.position().left)&&!ImajnetUI.popupImajnetControlsLayer.hasClass("ui-draggable-dragging")||(0<ImajnetZoom.dragCount&&(ImajnetZoom.dragDirection=a.clientX>ImajnetZoom.startScrollLeft?"right":"left",ImajnetZoom.dragDirectionVertical=a.clientY>ImajnetZoom.startScrollTop?"down":"up"),ImajnetZoom.dragCount++,
this.moveToPosition(ImajnetZoom.left+a.clientX-ImajnetZoom.startScrollLeft,ImajnetZoom.top+a.clientY-ImajnetZoom.startScrollTop,!0)?(ImajnetZoom.startScrollLeft=a.clientX,ImajnetZoom.startScrollTop=a.clientY,this.updateProjections(!0),ImageControler.currentGraphic.mouseMove(a)):(ImajnetZoom.startScrollLeft=a.clientX,ImajnetZoom.startScrollTop=a.clientY))},onImageDragStop:function(a,b){ImajnetZoom.imageDragReachEnd()&&(ImajnetUI.enableDraggable(ImajnetUI.imajnetImageSliderInnerContainer),ImajnetUI.disableImageDrag());
ImageControler.currentPhotogrammetry.redraw(!1)},imageDragStop:function(a,b){ImajnetZoom.dragDirection="";ImajnetZoom.dragDirectionVertical="";ImajnetZoom.dragCount=0;ImajnetZoom.onImageDragStop(a,b);if(ImajnetZoom.imageDragOutsideContainer(a))return!1;ImajnetZoom.left=b.position.left;ImajnetZoom.top=b.position.top;Nigsys.browserIsIE()&&this.updateProjections();this.imageWasDragged=!0},shiftZoomEnd:function(a){if("undefined"!==typeof ImajnetUI&&ImajnetUI&&ImajnetUI.imajnetZoomOnShiftBox){var b=ImajnetUI.imajnetZoomOnShiftBox.width(),
c=ImajnetUI.imajnetZoomOnShiftBox.height();if(!ImajnetZoom.canZoom()&&!ImajnetZoom.isZoomMode()||.5>b||.5>c)ImajnetUI.hideShiftBox(),ImajnetUI.imajnetZoomOnShiftBox.hide();else{var e=ImajnetUI.imajnetImageContainer.offset(),d=ImajnetUI.imajnetZoomOnShiftBox.offset(),f=a.clientX;a=a.clientY;Math.round(d.left)+1<ImajnetZoom.shiftZoomStart.x&&(ImajnetZoom.shiftZoomStart.x=f,ImajnetUI.imajnetZoomOnShiftBoxOffset.x=ImajnetZoom.shiftZoomStart.x-e.left);Math.round(d.top)+1<ImajnetZoom.shiftZoomStart.y&&
(ImajnetZoom.shiftZoomStart.y=a,ImajnetUI.imajnetZoomOnShiftBoxOffset.y=ImajnetZoom.shiftZoomStart.y-e.top);ImajnetUI.hideShiftBox();ImajnetZoom.zoomOnShift(b,c)}}},onZoomAddHighImageSuccess:function(a,b,c){a.unbind({error:ImajnetZoom.onZoomAddHighImageError,load:ImajnetZoom.onZoomAddHighImageSuccess});ImajnetZoom.zoomBigImageLoaded=!0;-1==ImajnetZoom.zoomedImagesCache.indexOf(ImajnetMap.currentPosition.id)&&ImajnetZoom.zoomedImagesCache.push(ImajnetMap.currentPosition.id)},onZoomAddHighImageError:function(a,
b){a.attr("src",ImajnetAPI.buildImageURLWithResolution(ImajnetMap.currentPosition,ImajnetSettings.imajnetImageResolutions[ImajnetSettings.imajnetSettings.imageQuality]));a.unbind({error:ImajnetZoom.onZoomAddHighImageError,load:ImajnetZoom.onZoomAddHighImageSuccess});ImajnetZoom.zoomBigImageLoaded=!0},zoomOnScroll:function(a,b){if(!Nigsys.scrollDeltaIsValid(b)||null!=this.lastZoomLevel&&this.lastZoomLevel==this.zoomLevel&&(ImajnetZoom.zoomLevel!=this.lastZoomLevel||0!=this.zoomLevel))return!1;if(!(0<
b&&this.zoomLevel==this.maxZoomLevel)){ImajnetUI.disableSwipeHandlers();this.imageWasDragged=!1;this.lastZoomLevel=ImajnetZoom.zoomLevel;var c=ImajnetUI.imajnetImageContainer.offset(),e=a.originalEvent.clientX-c.left,c=a.originalEvent.clientY-c.top,d=this.getCoordinatesOnScreen(e,c);if(0<b)-1!==ImajnetUI.imajnetImage.attr("src").indexOf(ImajnetSettings.imajnetImageResolutions[3])||this.zoomBigImageLoaded||ImajnetAPI.preloadImage(ImajnetUI.imajnetImage,ImajnetAPI.buildImageURLWithResolution(ImajnetMap.currentPosition,
ImajnetSettings.imajnetImageResolutions[3]),this.onZoomAddHighImageSuccess,this.onZoomAddHighImageError),ImajnetMap.hideSurveyTrace(),this.zoomLevel++;else{if(1>=this.zoomLevel){this.resetZoom();ImageControler.currentGraphic.mouseMove(a);ImageControler.currentSurveyTrace.hideSequenceTraceMapMarker();return}this.zoomLevel--}ImajnetUI.imajnetImage.addClass("popupImajnetImageZoomed");0<this.zoomLevel&&ImageControler.currentSurveyTrace.hideTrace();var f=this.getCurrentZoomFactor(),d=this.getCoordinatesAtCurrentZoom(d,
f),g=ImajnetUI.imajnetImageContainerInitialSize.height*f;this.width=Math.max(ImajnetUI.imajnetImageContainerInitialSize.width,ImajnetUI.imajnetImageContainerInitialSize.width*f);this.height=Math.max(ImajnetUI.imajnetImageContainerInitialSize.height,g);this.setDimension(this.width,this.height);this.moveToPosition(d.x-e,d.y-c,!0);ImageControler.currentGraphic.mouseMove(a);this.setDraggableContainment();if(a.type&&Imajnet3dPosition.isActive)Imajnet3dPosition.onImageContainerMousemove(a)}},zoomOnShift:function(a,
b){for(var c=ImajnetUI.imajnetZoomOnShiftBoxOffset.x+a/2,e=ImajnetUI.imajnetZoomOnShiftBoxOffset.y+b/2,d=0;d<this.maxZoomLevel;d++){var f=Math.pow(ImajnetZoom.zoomRatio,d+1),g=b*f;if(a*f>=ImajnetUI.imajnetImageContainerSize.width||g>=ImajnetUI.imajnetImageContainerSize.height)break;f=ImajnetUI.imajnetImageContainer.offset();this.zoomOnScroll({originalEvent:{clientX:c+f.left,clientY:e+f.top}},1)}d=ImajnetUI.imajnetImage.position();this.moveToPosition(d.left+(ImajnetUI.imajnetImageContainerSize.width/
2-c),d.top+(ImajnetUI.imajnetImageContainerSize.height/2-e),!0);ImajnetUI.zoomCancel=!0;this.updateProjections()},hideDragDisabledVisual:function(){return!1},bindHideDragDisabledVisual:function(){if(ImajnetUI.imajnetImageSliderInnerContainer)ImajnetUI.imajnetImageSliderInnerContainer.on("dragstart",ImajnetZoom.hideDragDisabledVisual)},unBindHideDragDisabledVisual:function(){ImajnetUI.imajnetImageSliderInnerContainer&&ImajnetUI.imajnetImageSliderInnerContainer.off("dragstart",ImajnetZoom.hideDragDisabledVisual)},
doWhenActivateZoom:function(){ImajnetUI.disableSwipeHandlers();ImajnetZoom.bindHideDragDisabledVisual();ImajnetUI.disableImageAllDrag();ImajnetUI.imajnetImageContainer.on("vmousedown",ImajnetZoom.onShiftZoomStart);ImajnetUI.imajnetImageContainer.on("vmousemove",ImajnetZoom.shiftZoomMouseMove);jQuery(".popupImajnetImage").addClass("zoomCursor")},activateZoom:function(){Nigsys.isPolyligneMode()&&ImajnetPolyligne.finishGeometry(ImajnetPolyligne.type,ImajnetPolyligne.isMeasurementMode(),!0);ImajnetPosition.hidePosition(!0);
ImajnetUI.activeControlButton="zoom";jQuery("#imajnetZoomButtonContainer").addClass("buttonActive");ImajnetZoom.zKeyPressed=!0;ImajnetZoom.doWhenActivateZoom()},doWhenDeactivateZoom:function(){ImajnetZoom.unBindHideDragDisabledVisual()},deactivateZoom:function(){ImajnetZoom.doWhenDeactivateZoom();ImajnetUI.activeControlButton="";jQuery("#imajnetZoomButtonContainer").removeClass("buttonActive");ImajnetZoom.zKeyPressed=!1;0<this.zoomLevel&&ImajnetUI.enableImageAllDrag();jQuery(".popupImajnetImage").removeClass("zoomCursor");
ImajnetUI.clientLogoContainer.show();ImajnetUI.imajnetImageContainer&&(ImajnetUI.imajnetImageContainer.off("vmousedown",ImajnetZoom.onShiftZoomStart),ImajnetUI.imajnetImageContainer.off("vmousemove",ImajnetZoom.shiftZoomMouseMove))},isZoomMode:function(){return jQuery("#imajnetZoomButtonContainer").hasClass("buttonActive")},activateDeactivateZoom:function(a){ImajnetZoom.isZoomMode()?(ImajnetZoom.deactivateZoom(),0==ImajnetZoom.zoomLevel?ImajnetUI.enableDraggable(ImajnetUI.imajnetImageSliderInnerContainer):
(ImajnetUI.enableImageAllDrag(),ImajnetUI.imajnetImageContainer.off("vmousedown",ImajnetZoom.onShiftZoomStart))):ImajnetZoom.activateZoom()},scrollEndTimeout:function(){ImageControler.currentImageControl.resetFastNavigation();ImageControler.currentImageControl.doRequests(ImajnetMap.currentPosition)},zoomOnPinch:function(a,b,c,e){var d=ImajnetUI.imajnetImageContainer.offset();b=Nigsys.getPinchCenter(b[0].start,b[1].start);a.clientX=b.x+d.left;a.clientY=b.y+d.top;e=10*e/ImajnetUI.imajnetImageContainer.height();
for(d=0;d<e;d++)ImajnetZoom.zoomOnScrollHandler(a,c);ImajnetUI.enableImageAllDrag()},zoomOnScrollHandler:function(a,b){if(jQuery("#imajnetImageSliderInnerContainer").hasClass("ui-draggable-dragging")||a.target&&(Nigsys.stringContains(a.target.className,"textareaEditComment")||Nigsys.stringContains(a.target.className,"imajnetImageSwitcherImageItem")||Nigsys.stringContains(a.target.className,"imajnetImageSwitcherOrderedImageItemImage")||Nigsys.stringContains(a.target.className,"orderedImageDate")||
Nigsys.stringContains(a.target.className,"scrollOrderedImagesLeftImage")||Nigsys.stringContains(a.target.className,"scrollOrderedImagesRightImage")||Nigsys.stringContains(a.target.id,"imajnetImageSwitcherCenterImage")))return!1;if(!ImajnetMap.currentPosition)return!0;ImajnetUI.hideContextMenu(a);var c=jQuery(a.target).parent();if(c&&Nigsys.stringContains(c.attr("class"),"imajnetControlsLayerButtonsItem"))return!1;b=Nigsys.getDelta(a,b);ImajnetZoom.canZoom()||ImajnetZoom.isZoomMode()||Nigsys.onMobile()?
(ImajnetZoom.zoomOnScroll(a,b),ImajnetZoom.updateProjections()):(clearTimeout(ImageControler.currentImageControl.fastNavigationTimeout),ImageControler.currentImageControl.setFastNavigation(),ImageControler.currentImageControl.fastNavigationTimeout=setTimeout("ImajnetZoom.scrollEndTimeout()",300),Imajnet3dPosition.isActive&&(Imajnet3dPosition.hidePosition(),Imajnet3dPosition.lastMouseEvent=a),0>b?ImageControler.currentImageControl.getPrevious(!1):ImageControler.currentImageControl.getNext(!1));a.preventDefault();
return!0},registerEvents:function(){ImajnetUI.imajnetImageContainer.on("mousewheel DOMMouseScroll",ImajnetZoom.zoomOnScrollHandler)},getPreviewPanelZoomFactor:function(){return 5}};
var ImajnetClickMode={positions:null,orientedImagesAjaxRequest:null,requestedPosition:null,loadImageDeferred:null,isFromPosition:!1,getPositionByIndexInArray:function(a){var b=null;jQuery.each(this.positions,function(c,d){if(d.wrapperId==a)return b=d,!1});return b},addClickedPointToPhotogrammetry:function(){if(ImajnetMap.currentPosition&&(ImageControler.currentPhotogrammetry.removeMapClickedPoint(),null!==this.requestedPosition)){var a={id:0,position:ImajnetMap.currentPosition,photogrammetryPosition3D:{coordinates:this.requestedPosition},
type:ImajnetMap.MARKER_TYPE_CLICKED_POINT};ImageControler.currentPhotogrammetry.addObject(ImajnetMap.currentPosition,a,!1,!0,!0);ImageControler.currentPhotogrammetry.getObjectLRS(a)}},moveImageToPosition:function(a){ImajnetZoom.left=-1;Nigsys.showLoading(ImajnetUI.imageContainer);a=this.getPositionByIndexInArray(a);ImajnetAPI.setImajnetImage({position:a});ImajnetUI.showItem(ImajnetUI.imageContainerId)},drawOrientedImages:function(a,b){var c=jQuery.Deferred();if(null!==this.positions&&null!==this.requestedPosition){var d=
!0;b&&1==b.isPositionOnly?(a=!0,d=!1,ImajnetClickMode.isFromPosition=!0):ImajnetClickMode.isFromPosition=!1;for(var f=ImageControler.currentPhotogrammetry.getLastObjectId(),g=-1,h=!1,e=0;e<this.positions.length;e++){var k=Nigsys.distanceBetweenPoints(this.requestedPosition,this.positions[e]);!h&&25<k&&(g=0,this.positions[e].wrapperId=f+g+1,d&&ImajnetMap.setOrientationMarker(this.positions[0],ImajnetMap.imajboxOrientedImagesDimension,"#00FF00",this.positions[e].wrapperId),a&&("undefined"!==typeof ImajnetUI&&
(ImajnetUI.showItem(ImajnetUI.imageContainerId),Nigsys.showLoading(ImajnetUI.imageContainer)),ImajnetZoom.left=-1,ImajnetAPI.setImajnetImage({position:this.positions[0]}).done(function(){c.resolve(b)})),h=!0);!h&&4<k&&(g=e,this.positions[e].wrapperId=f+g+1,d&&ImajnetMap.setOrientationMarker(this.positions[e],ImajnetMap.imajboxOrientedImagesDimension,"#00FF00",this.positions[e].wrapperId),a&&("undefined"!==typeof ImajnetUI&&(ImajnetUI.showItem(ImajnetUI.imageContainerId),Nigsys.showLoading(ImajnetUI.imageContainer)),
ImajnetZoom.left=-1,ImajnetAPI.setImajnetImage({position:this.positions[e]}).done(function(){c.resolve(b)})),h=!0);e!=g&&(this.positions[e].wrapperId=f+e+1,d&&ImajnetMap.setOrientationMarker(this.positions[e],ImajnetMap.imajboxOrientedImagesDimension,"#00FF00",this.positions[e].wrapperId))}!h&&a&&("undefined"!==typeof ImajnetUI&&(ImajnetUI.showItem(ImajnetUI.imageContainerId),Nigsys.showLoading(ImajnetUI.imageContainer)),ImajnetZoom.left=-1,ImajnetAPI.setImajnetImage({position:this.positions[0]}).done(function(){c.resolve(b)}))}else c.reject();
return c.promise()},redrawClickedPointOnMap:function(){ImajnetMap.clearClickedPointFromMap();ImajnetClickMode.isFromPosition||null!==this.requestedPosition&&ImajnetMap.addClickedPointToMap(this.requestedPosition)},onZoomStart:function(){ImajnetMap.hideOrientedImages()},onZoomEnd:function(){ImajnetMap.hideOrientedImages();this.addClickMode(!1);ImajnetClickMode.redrawClickedPointOnMap()},redrawOrientedImages:function(){ImajnetMap.hideOrientedImages();this.addClickMode(!1);ImajnetClickMode.redrawClickedPointOnMap()},
addClickMode:function(a,b){var c=jQuery.Deferred();ImajnetClickMode.drawOrientedImages(a,b).done(function(){a&&(ImajnetClickMode.addClickedPointToPhotogrammetry(),ImageControler.currentPhotogrammetry.redraw(!1));jQuery(document).on("keydown.onKeyDown",ImajnetUI.onKeyDown);c.resolve(b)});return c.promise()},orientedImagesReceived:function(a,b){a=JSON.parse(a);var c=b&&1==b.currentSequenceOnly?!1:!0;a.positions?(ImajnetClickMode.positions=a.positions,ImajnetClickMode.addClickMode(c,b).done(function(a){ImajnetPlugin.getCurrentZoomLevel()<
ImajnetMap.CENTER_OBJECTS_ZOOM_LEVEL&&(ImajnetPlugin.zoomMapTo(ImajnetMap.CENTER_OBJECTS_ZOOM_LEVEL),ImajnetPlugin.centerMapToPosition(a.position,!1));ImajnetClickMode.loadImageDeferred.resolve(!0)})):(a.parameter.traceId||(ImajnetPlugin.getCurrentZoomLevel(),ImajnetZoom.left=-1,Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetAPI.setImajnetImage({position:null}),ImajnetClickMode.increaseZoomLevel(a.parameter.position)),ImajnetClickMode.loadImageDeferred.resolve(!1));c&&ImajnetClickMode.redrawClickedPointOnMap();
Imajnet.containerId&&Nigsys.hideLoading(jQuery("#"+Imajnet.containerId))},increaseZoomLevel:function(a){var b=ImajnetPlugin.getCurrentZoomLevel();b<ImajnetMap.CENTER_OBJECTS_ZOOM_LEVEL&&(ImajnetPlugin.zoomMapTo(b+1),ImajnetPlugin.centerMapToPosition(a,!1))},orientedImagesError:function(a,b){jQuery(document).on("keydown.onKeyDown",ImajnetUI.onKeyDown);ImajnetClickMode.redrawClickedPointOnMap();ImajnetMap.hideImajboxMarker();ImajnetMap.hideOrientation();ImajnetZoom.left=-1;ImajnetAPI.setImajnetImage({position:null});
ImajnetClickMode.increaseZoomLevel(b.position);Imajnet.containerId&&Nigsys.hideLoading(jQuery("#"+Imajnet.containerId));ImajnetClickMode.loadImageDeferred.resolve()},getOrientedImages:function(a,b,c,d){null!==this.orientedImagesAjaxRequest&&this.orientedImagesAjaxRequest.abort();var f={position:a,radius:ImajnetSettings.imajnetSettings.orientedImages,limit:ImajnetSettings.limitOrientedImages,timeframe:ImajnetTimeframe.getTimeframe(),sequenceType:Imajnet.sequenceType};d?d.position=a:d={position:a};
d.currentSequenceOnly&&(f.traceId=ImajnetMap.currentPosition.traceId,f.radius=150,f.limit=20);this.orientedImagesAjaxRequest=ImajnetAPI.doImajnetRequest("GET","/api/photogrammetry/image/orientation/",f,b,c,null,null,null,d)},onShowOrientedImages:function(a,b,c,d){ImajnetClickMode.loadImageDeferred=jQuery.Deferred();Imajnet.containerId&&Nigsys.showLoading(jQuery("#"+Imajnet.containerId));this.hideOrientedImages(!0);this.requestedPosition=a;this.getOrientedImages(this.requestedPosition,b,c,d)},showOrientedImages:function(a,
b,c,d){if(ImajnetClickMode.loadImageDeferred)ImajnetClickMode.loadImageDeferred.always(function(){ImajnetClickMode.onShowOrientedImages(a,b,c,d)});else ImajnetClickMode.onShowOrientedImages(a,b,c,d)},hideOrientedImages:function(a){a&&ImajnetMap.clearClickedPointFromMap();this.requestedPosition=this.positions=null;ImajnetMap.hideOrientedImages();ImageControler.currentPhotogrammetry&&ImageControler.currentPhotogrammetry.removeMapClickedPoint()}};
if("undefined"===typeof PngToy)console.log("If need 3D include PngToy library.......");else{var _INVPI=.0174532925199433,_A=6378137,_F=.00335281067598882,_E2=.00669437999013,_PIs180=57.2957795130823;Imajnet3dPosition={isActive:!1,disparityImageCalibration:null,realImageCalibration:null,zMap:[],disparityMap:null,imageHas3D:!1,cachedData:[],canvasCtx:null,mapMarker:null,disparityImageXhr:null,realImageToContainerRatio:1,lastMouseEvent:null,showPosition:function(){ImageControler.currentImageControl.isFastNavigation||
0==ImageControler.currentPhotogrammetry.currentStep%2?Imajnet3dPosition.isActive=!1:(null!==Imajnet3dPosition.disparityImageXhr&&Imajnet3dPosition.disparityImageXhr.abort(),Imajnet3dPosition.getDisparityImage().done(function(){Imajnet3dPosition.isActive=!0}))},hidePosition:function(){Imajnet3dPosition.clearCanvas();Imajnet3dPosition.isActive=!1},showHide3dPosition:function(){jQuery("#imajnet3dPositionButtonContainer").hasClass("buttonActive")?Imajnet3dPosition.hidePosition():Imajnet3dPosition.showPosition()},
onImageContainerMousemove:function(a){if(ImajnetMap.currentPosition&&!ImajnetUI.isDragMode&&!ImageControler.currentImageControl.isFastNavigation){var b=ImajnetUI.imajnetImageContainer.offset(),b=ImajnetZoom.getRealImageCoordinates(a.pageX-b.left,a.pageY-b.top);a=Imajnet3dPosition.disparityImageCalibration;try{var c=Imajnet3dPosition.getZmapPointFromPixelPoint(b);Imajnet3dPosition.getZfromPoint(Imajnet3dPosition.disparityMap,c,a.r,a.t,a.epipole,a.calibFocale,a.calibCcx,a.calibCcy,{width:a.imSizeWidth,
height:a.imSizeHeight},150,4,.02)}catch(e){console.log(e)}Imajnet3dPosition.clearCanvas();if(c){var d=Imajnet3dPosition.zMap[c.y][c.x];0!=d&&(c.z=d,Imajnet3dPosition.getZmapInRadius(c,.5),b=Imajnet3dPosition.getPointLLHFromPixelPoint(b))&&(Imajnet3dPosition.getPointsInRadius(Imajnet3dPosition.disparityMap,null,Imajnet3dPosition.zMap,[],c,b.mPts[0].mOpt_pt,.5,a),c="",c=Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()?Imajnet.imajnetPath+"img/map3dPositionGreen.png?"+Imajnet.version:
Imajnet.imajnetPath+"img/map3dPositionBlue.png?"+Imajnet.version,Imajnet3dPosition.mapMarker=ImajnetPlugin.addMarker(ImajnetMap.imajnetDragFeaturesLayer,{lon:b.mPos_llh[0],lat:b.mPos_llh[1],type:ImajnetMap.markerType.IMAGE_POINT,imagePath:c,size:{width:10,height:10}}))}}},onImageContainerMouseclick:function(a){a=ImajnetUI.imajnetImageContainer.offset();a=ImajnetZoom.getRealImageCoordinates(event.pageX-a.left,event.pageY-a.top);a=Imajnet3dPosition.get3dPointFromPixelPoint(a);console.log(a)},clickToNavigate:function(a,
b){if(!(ImageControler.currentImageControl.isFastNavigation||Nigsys.isPositionMode()||Nigsys.isPolyligneMode()||ImajnetUI.isAfterDrag||ImajnetUI.isAfterSliderDrag)){var c=ImajnetZoom.getRealImageCoordinates(a,b),d=null;Imajnet3dPosition.isActive&&(d=Imajnet3dPosition.getPointLLHFromPixelPoint(c));d&&ImajnetClickMode.showOrientedImages({lon:d.mPos_llh[0],lat:d.mPos_llh[1],height:d.mPos_llh[2]},ImajnetClickMode.orientedImagesReceived,ImajnetClickMode.orientedImagesError,{currentSequenceOnly:!0,isPositionOnly:!0})}},
getGroundPoint:function(a){var b=ImajnetMap.currentPosition.orientation,c=Array(3),d=.017453292519943295*b.pitch,b=.017453292519943295*b.roll;c[0]=-Math.sin(b)*Math.cos(d);c[1]=-Math.cos(b)*Math.cos(d);c[2]=-Math.sin(d);d=Imajnet3dPosition.cameraCalibration;if(!d||120<Imajnet3dPosition.realImageCalibration.view_angle)return null;b=Imajnet3dPosition.undistord_im2opt(Imajnet3dPosition.realImageCalibration,a.mPts[0].mPixel_pt);d.pc={t_sol2optRsol:[-d.y_gpscam/1E3,-d.z_gpscam/1E3,d.x_gpscam/1E3]};c=-(1.6+
d.pc.t_sol2optRsol[0]*c[0]+d.pc.t_sol2optRsol[1]*c[1]+d.pc.t_sol2optRsol[2]*c[2])/(c[0]*b.x+c[1]*b.y+c[2]);a.mPts[0].mOpt_pt={x:c*b.x+d.pc.t_sol2optRsol[2],y:c*b.y+d.pc.t_sol2optRsol[0],z:c+d.pc.t_sol2optRsol[1]};a.mPts[0].mDist=(0<c?1:-1)*Imajnet3dPosition.norm2_3(a.mPts[0].mOpt_pt);if(0>=a.mPts[0].mDist)return null;a.mPrecision=1;c=Imajnet3dPosition.ComputeMoptiqueenu(ImajnetMap.currentPosition.orientation);c=Imajnet3dPosition.Ab3(c,a.mPts[0].mOpt_pt);a.mPos_llh=Imajnet3dPosition.ENU2LLH_(ImajnetMap.currentPosition,
c);return a},getPointLLHFromPixelPoint:function(a){Imajnet3dPosition.get3dPointFromPixelPoint(a);var b=Imajnet3dPosition.disparityImageCalibration,c=Imajnet3dPosition.getZmapPointFromPixelPoint(a);Imajnet3dPosition.getZfromPoint(Imajnet3dPosition.disparityMap,c,b.r,b.t,b.epipole,b.calibFocale,b.calibCcx,b.calibCcy,{width:b.imSizeWidth,height:b.imSizeHeight},150,4,.02);return Imajnet3dPosition.getPosLLHfrom3DMap({mPts:[{mPixel_pt:a}]},Imajnet3dPosition.disparityMap,null,Imajnet3dPosition.zMap,Imajnet3dPosition.disparityImageCalibration)},
position3dObject:function(a,b){var c=ImajnetZoom.getRealImageCoordinates(a,b),d=Imajnet3dPosition.getPointLLHFromPixelPoint(c);if(!d)return!1;c.z=d.mPts[0].mOpt_pt.z;if(isNaN(d.mPts[0].mOpt_pt.x)||isNaN(d.mPts[0].mOpt_pt.y)||isNaN(d.mPts[0].mOpt_pt.z))return!1;var e=Nigsys.isPolyligneMode(),c={linkToNext:e,parameter:{imagePoint:{img1:ImajnetMap.currentPosition,imgCoord1:c}},photogrammetryPosition3D:{coordinates:{lon:d.mPos_llh[0],lat:d.mPos_llh[1],height:d.mPos_llh[2]},precision:1},type:e?ImajnetPolyligne.type:
"position"};e?ImajnetPolyligne.pointPositionSuccess(JSON.stringify(c),{stopImageChange:!0}):ImajnetPosition.pinPointPositionReceived(JSON.stringify(c),{stopImageChange:!0});return!0},get3dPointFromPixelPoint:function(a){var b=Imajnet3dPosition.disparityImageCalibration,c=Imajnet3dPosition.getZmapPointFromPixelPoint(a);Imajnet3dPosition.getZfromPoint(Imajnet3dPosition.disparityMap,c,b.r,b.t,b.epipole,b.calibFocale,b.calibCcx,b.calibCcy,{width:b.imSizeWidth,height:b.imSizeHeight},150,4,.02);return Imajnet3dPosition.getPosLLHfrom3DMap({mPts:[{mPixel_pt:a}]},
Imajnet3dPosition.disparityMap,null,Imajnet3dPosition.zMap,Imajnet3dPosition.disparityImageCalibration)},buildDisparityImageURL:function(a){if(a)return a=JSON.stringify({position:new ImajnetData.position(parseInt(a.id))}),a=encodeURI(a),null!==ImajnetAPI.imageServerDomains?(a="/service/api/photogrammetry/image3Dinfo/"+a,ImajnetMap.selectUrl(a,ImajnetAPI.imageServerDomains)+a+"?param\x3d"+window.location.hostname):Imajnet.serverUrl+"/api/photogrammetry/image3Dinfo/"+a+"?param\x3d"+window.location.hostname},
onDisparityImageReceived:function(a){Imajnet3dPosition.disparityImageCalibration=JSON.parse(a.getResponseHeader("image3dInfo"));Imajnet3dPosition.disparityImageXhr=null},getDisparityImage:function(){var a=jQuery.Deferred(),b=new PngToy;b.fetch(Imajnet3dPosition.buildDisparityImageURL(ImajnetMap.currentPosition)).then(function(c){b.decode(c).then(function(b){Imajnet3dPosition.getZfromPoint=Imajnet3dPosition.disparityImageCalibration&&0!==Imajnet3dPosition.disparityImageCalibration.epipolarRectificationType?
Imajnet3dPosition.getZfromPointNew:Imajnet3dPosition.getZfromPointMono;Imajnet3dPosition.getDisparityImageSuccess(b);a.resolve()},Imajnet3dPosition.getDisparityImageError)},function(){Imajnet3dPosition.getDisparityImageError();a.reject()});return a.promise()},getDisparityImageSuccess:function(a){Imajnet3dPosition.getDisparityMap(a);if(Imajnet3dPosition.lastMouseEvent)Imajnet3dPosition.onImageContainerMousemove(Imajnet3dPosition.lastMouseEvent)},getDisparityImageError:function(){Imajnet3dPosition.disparityImageXhr=
null;Imajnet3dPosition.hidePosition();Imajnet3dPosition.disparityImageCalibration=null},getDisparityMap:function(a){a=a.bitmap;Imajnet3dPosition.disparityMap=[];Imajnet3dPosition.zMap=[];for(var b=0;b<a.length;b+=Imajnet3dPosition.disparityImageCalibration.imSizeWidth){for(var c=[],d=b;d<b+Imajnet3dPosition.disparityImageCalibration.imSizeWidth;d++)a[d]=(a[d]&255)<<8|(a[d]&65280)>>>8,c.push(a[d]&16383);Imajnet3dPosition.disparityMap.push(c);Imajnet3dPosition.zMap.push([])}},getZmapInRadius:function(a,
b){var c=Imajnet3dPosition.disparityImageCalibration,d=Math.ceil(b*c.calibFocale/a.z)+2,e=Math.round(a.x-d);0>e&&(e=0);var f=Math.round(a.y-d);0>f&&(f=0);var h=Math.round(a.x+d);h>=Imajnet3dPosition.disparityMap[0].length&&(h=Imajnet3dPosition.disparityMap[0].length);d=Math.round(a.y+d);d>=Imajnet3dPosition.disparityMap.length&&(d=Imajnet3dPosition.disparityMap.length);for(;f<d;f++)for(var g=e;g<h;g++)"undefined"==typeof Imajnet3dPosition.zMap[f][g]&&Imajnet3dPosition.getZfromPoint(Imajnet3dPosition.disparityMap,
{x:g,y:f},c.r,c.t,c.epipole,c.calibFocale,c.calibCcx,c.calibCcy,{width:c.imSizeWidth,height:c.imSizeHeight},150,4,.02)},placePixelsInCanvas:function(a,b){Nigsys.isPositionMode()||Nigsys.isPolyligneMode()?Imajnet3dPosition.canvasCtx.fillStyle="rgba(0, 255, 0, 0.125)":Imajnet3dPosition.canvasCtx.fillStyle="rgba(0, 0, 255, 0.125)";for(var c=null,d=0;d<a.length;d++)for(var e=0;e<a[d].length;e++)if(1==a[d][e]){var f=Imajnet3dPosition.getPixelPointFromZmapPoint({x:b.x+e,y:b.y+d}),f=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(f);
c||(c=f)}else c&&(f=Imajnet3dPosition.getPixelPointFromZmapPoint({x:b.x+e,y:b.y+d}),f=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(f),Imajnet3dPosition.canvasCtx.fillRect(c.x,c.y,f.x-c.x,ImajnetZoom.getCurrentZoomFactor())),c=null;c=Math.round(a.length/2);f=Imajnet3dPosition.getPixelPointFromZmapPoint({x:b.x+c+1,y:b.y+c+1});f=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(f);c=c*Imajnet3dPosition.realImageToContainerRatio*ImajnetZoom.getCurrentZoomFactor();Imajnet3dPosition.canvasCtx.beginPath();
Imajnet3dPosition.canvasCtx.arc(f.x,f.y,c,0,2*Math.PI);Imajnet3dPosition.canvasCtx.stroke()},setCanvasSize:function(a,b){Imajnet3dPosition.canvasCtx&&(Imajnet3dPosition.canvasCtx.canvas.width=a,Imajnet3dPosition.canvasCtx.canvas.height=b)},clearCanvas:function(){Imajnet3dPosition.canvasCtx.clearRect(0,0,Imajnet3dPosition.canvasCtx.canvas.width,Imajnet3dPosition.canvasCtx.canvas.height);Imajnet3dPosition.mapMarker&&(ImajnetPlugin.removeFeatures(ImajnetMap.imajnetDragFeaturesLayer,[Imajnet3dPosition.mapMarker]),
Imajnet3dPosition.mapMarker=null)},getZfromPoint:function(){},getZfromPointNew:function(a,b){var c=b.y,d=b.x;if("undefined"===typeof Imajnet3dPosition.zMap[c][d]){var e=Imajnet3dPosition.disparityImageCalibration.calibFocale*Imajnet3dPosition.disparityImageCalibration.t[0]*16,f=a[c][d]&16383;Imajnet3dPosition.zMap[c][d]=64>f?0:e/f}},getZfromPointMono:function(a,b,c,d,e,f,h,g,l,m,n,v){l=b.y;var k=b.x;if("undefined"===typeof Imajnet3dPosition.zMap[l][k]&&e){var B=parseFloat(1/f),p,u;p=[b.x,b.y];c?(b=
Array(2),u=Array(9),u=Imajnet3dPosition.Ropt2ccd(c,f,h,g,u),p[0]=k,a=.0625*a[l][k],a<n?Imajnet3dPosition.zMap[l][k]=0:(b=Imajnet3dPosition.ApplyH(u,p,b),n=(c[6]*(k-h)+c[7]*(l-g))*B+c[8],u=b[0]-e[0],c=b[1]-e[1],p=1/Math.sqrt(parseFloat(u*u+c*c)),e=u*p,c*=p,p=d[0]*e+d[1]*c,h=(p-d[2]*((b[0]-h)*e+(b[1]-g)*c)*B)/n,h<v?Imajnet3dPosition.zMap[l][k]=0:(Imajnet3dPosition.zMap[l][k]=parseFloat(f*h/a+d[2]/n),Imajnet3dPosition.zMap[l][k]>m&&(Imajnet3dPosition.zMap[l][k]=0)))):(c=l-e[1],a=.0625*a[l][k],a<n?Imajnet3dPosition.zMap[l][k]=
0:(u=k-e[0],p=1/Math.sqrt(parseFloat(u*u+c*c)),e=u*p,c*=p,p=d[0]*e+d[1]*c,h=p-d[2]*((k-h)*e+(l-g)*c)*B,h<v?Imajnet3dPosition.zMap[l][k]=0:(Imajnet3dPosition.zMap[l][k]=parseFloat(f*h/a+d[2]),Imajnet3dPosition.zMap[l][k]>m&&(Imajnet3dPosition.zMap[l][k]=0))))}},getZFromD:function(a,b,c,d,e,f,h,g,l,m,n,v){for(var k=parseFloat(1/f),B=l.width,p=0;p<l.height;p++){var u,A,r,w,z,q=Array(2);q[1]=p;if(c)for(var t=Array(2),D=Array(9),E,D=Imajnet3dPosition.Ropt2ccd(c,f,h,g,D),C=0;C<B;++C)q[0]=C,z=.0625*a[p][C],
z<n?b[p][C]=0:(t=Imajnet3dPosition.ApplyH(D,q,t),E=(c[6]*(C-h)+c[7]*(p-g))*k+c[8],A=t[0]-e[0],r=t[1]-e[1],u=1/Math.sqrt(parseFloat(A*A+r*r)),A*=u,u*=r,w=d[0]*A+d[1]*u,A=(w-d[2]*((t[0]-h)*A+(t[1]-g)*u)*k)/E,A<v?b[p][C]=0:(b[p][C]=parseFloat(f*A/z+d[2]/E),b[p][C]>m&&(b[p][C]=0)));else{r=p-e[1];for(var C=0;C<B;++C)q[0]=C,z=.0625*a[p][C],z<n?b[p][C]=0:(A=C-e[0],u=1/Math.sqrt(parseFloat(A*A+r*r)),A*=u,u*=r,w=d[0]*A+d[1]*u,A=w-d[2]*((C-h)*A+(p-g)*u)*k,A<v?b[p][C]=0:(b[p][C]=parseFloat(f*A/z+d[2]),b[p][C]>
m&&(b[p][C]=0)))}}return b},computeOrthoDistance:function(a,b,c,d,e,f,h){var g=Nigsys.createMatrix(3,3);h=Array(3);var l=Array(3);c=Imajnet3dPosition.ComputeRt(a.pImage,c,g,h,null,0);g=c.R;h=c.t;c=c.precision;var m=Nigsys.createMatrix(3,4),g=Nigsys.createMatrix(3,4),n=Array(2),v=Array(4),k=Array(4),B=Array(3),p=Array(3),u=Array(2),k=Array(2),A=0;0>=a.mDist&&(A=-1);if(0==A){Imajnet3dPosition.ComputeMenu2opt(a.pImage.mAttitude,m);Imajnet3dPosition.invM(m,g);var r=Imajnet3dPosition.cameraCalibration;
r.pc={t_sol2optRsol:[-r.y_gpscam/1E3,-r.z_gpscam/1E3,r.x_gpscam/1E3]};if(!r)return;B[0]=a.mOpt_pt.x-r.pc.t_sol2optRsol[0];B[1]=a.mOpt_pt.y-r.pc.t_sol2optRsol[1];B[2]=a.mOpt_pt.z-r.pc.t_sol2optRsol[2];Imajnet3dPosition.setArraySubrange(v,0,Imajnet3dPosition.prod(Imajnet3dPosition.trans(Imajnet3dPosition.getMatrixSubrange(m,0,3,0,3)),B));v[3]=1;u=B.map(function(a){return a/B[2]}).slice(0,2);k=v;k[2]+=1;p=Imajnet3dPosition.prod(m,k);k=p.map(function(a){return a/p[2]}).slice(0,2);n=Imajnet3dPosition.arraySubstraction(k,
u);if(null!=f){var w=Array(3),z=Array(4),q=Array(3),k=Array(3),t={},D={};w[0]=n[1];w[1]=-n[0];w[2]=n[0]*u[1]-n[1]*u[0];Imajnet3dPosition.constraintmouse_opt(r.calibration_parameters,w,b,D);z[0]=D.x;z[1]=D.y;z[2]=1;z[3]=1;q=Imajnet3dPosition.prod(g,z);v[0]>v[1]?(k[0]=v[0],k[1]=v[1],k[2]=v[0]/q[0]*q[2]):(k[0]=v[0],k[1]=v[1],k[2]=v[1]/q[1]*q[2]);f.mDist_llh1_llh2=Math.abs(v[2]-k[2]);Imajnet3dPosition.distord_opt2im(r.calibration_parameters,D,t);f.mDist_cursor_pt2=Math.sqrt(Math.pow(b.x-t.x,2)+Math.pow(b.y-
t.y,2));n=Array(3);w=Array(3);n=Imajnet3dPosition.prod(Imajnet3dPosition.getMatrixSubrange(m,0,3,0,3),k);w[0]=n[0]+r.pc.t_sol2optRsol[0];w[1]=n[1]+r.pc.t_sol2optRsol[1];w[2]=n[2]+r.pc.t_sol2optRsol[2];f.mPt2.mPrecision=1;f.mPt2.mPts[0].pImage=a.pImage;f.mPt2.mPts[0].mOpt_pt.x=w[0];f.mPt2.mPts[0].mOpt_pt.y=w[1];f.mPt2.mPts[0].mOpt_pt.z=w[2];f.mPt2.mPts[0].mDist=(0<f.mPt2.mPts[0].mOpt_pt.z?1:-1)*Imajnet3dPosition.norm2_3(f.mPt2.mPts[0].mOpt_pt);Imajnet3dPosition.fillReprojPoint(f.mPt2.mPts[0]);m=Imajnet3dPosition.prod(Imajnet3dPosition.getMatrixSubrange(g,
0,3,0,3),w);Imajnet3dPosition.ENU2LLH_(a.pImage.mPos_llh,m,f.mPt2.mPos_llh)}if(null!=e){var t=Array(2),k=Array(3),n=Array(3),w=Array(3),E=Array(3),t=Array(2),m=Array(4),z=Array(3);f=Array(3);z={};q={};l=h;t=Imajnet3dPosition.arraySubstraction(p,B);Imajnet3dPosition.crossProd3(t,l,k);E=Imajnet3dPosition.arrayAddition(B,k);t=E.map(function(a){return a/E[2]}).slice(0,2);t=Imajnet3dPosition.arraySubstraction(t,u);n[0]=t[1];n[1]=-t[0];n[2]=t[0]*u[1]-t[1]*u[0];Imajnet3dPosition.constraintmouse_opt(r.calibration_parameters,
n,b,q);Imajnet3dPosition.distord_opt2im(r.calibration_parameters,q,z);e.mDist_cursor_pt2=Math.sqrt(Math.pow(b.x-z.x,2)+Math.pow(b.y-z.y,2));e.mPt2.mPrecision=c;var C=(B[2]*k[0]-B[0]*k[2])/(k[0]-k[2]*q.x);0>C?(e.mDist_llh1_llh2=0,e.mPt2.mPos_llh=a.pImage.mPos_llh):(e.mPt2.mPts[0].pImage=a.pImage,w[0]=q.x,w[1]=q.y,w[2]=1,k=w.map(function(a){return a*C}),Imajnet3dPosition.setArraySubrange(m,0,k),m[3]=1,z=Imajnet3dPosition.prod(g,m),e.mDist_llh1_llh2=Math.sqrt(Math.pow(v[0]-z[0],2)+Math.pow(v[1]-z[1],
2)),f[0]=m[0]+r.pc.t_sol2optRsol[0],f[1]=m[1]+r.pc.t_sol2optRsol[1],f[2]=m[2]+r.pc.t_sol2optRsol[2],e.mPt2.mPts[0].mOpt_pt.x=f[0],e.mPt2.mPts[0].mOpt_pt.y=f[1],e.mPt2.mPts[0].mOpt_pt.z=f[2],e.mPt2.mPts[0].mDist=(0<e.mPt2.mPts[0].mOpt_pt.z?1:-1)*Imajnet3dPosition.norm2_3(e.mPt2.mPts[0].mOpt_pt),Imajnet3dPosition.fillReprojPoint(e.mPt2.mPts[0]),m=Array(3),m=Imajnet3dPosition.prod(Imajnet3dPosition.getMatrixSubrange(g,0,3,0,3),f),Imajnet3dPosition.ENU2LLH_(a.pImage.mPos_llh,m,e.mPt2.mPos_llh))}if(null!=
d){var z=Array(2),m=Array(3),k=Array(3),z=Array(3),F=Array(3);f=Array(4);n=Array(3);e=Array(3);n={};w={};l=h;F=B.map(function(a,b){return a+l[b]});z=F.map(function(a){return a/F[2]}).slice(0,2);z=Imajnet3dPosition.arraySubstraction(z,u);m[0]=z[1];m[1]=-z[0];m[2]=z[0]*u[1]-z[1]*u[0];Imajnet3dPosition.constraintmouse_opt(r.calibration_parameters,m,b,w);Imajnet3dPosition.distord_opt2im(r.calibration_parameters,w,n);d.mDist_cursor_pt2=Math.sqrt(Math.pow(b.x-n.x,2)+Math.pow(b.y-n.y,2));d.mPt2.mPrecision=
c;C=(B[2]*l[0]-B[0]*l[2])/(l[0]-l[2]*w.x);0>C?(d.mDist_llh1_llh2=0,d.mPt2.mPos_llh=a.pImage.mPos_llh):(d.mPt2.mPts[0].pImage=a.pImage,k[0]=w.x,k[1]=w.y,k[2]=1,k=k.map(function(a,b){return a*C}),Imajnet3dPosition.setArraySubrange(f,0,k),f[3]=1,n=Imajnet3dPosition.prod(g,f),d.mDist_llh1_llh2=Math.sqrt(Math.pow(v[0]-n[0],2)+Math.pow(v[1]-n[1],2)),e[0]=f[0]+r.pc.t_sol2optRsol[0],e[1]=f[1]+r.pc.t_sol2optRsol[1],e[2]=f[2]+r.pc.t_sol2optRsol[2],d.mPt2.mPts[0].mOpt_pt.x=e[0],d.mPt2.mPts[0].mOpt_pt.y=e[1],
d.mPt2.mPts[0].mOpt_pt.z=e[2],d.mPt2.mPts[0].mDist=(0<d.mPt2.mPts[0].mOpt_pt.z?1:-1)*Imajnet3dPosition.norm2_3(d.mPt2.mPts[0].mOpt_pt),Imajnet3dPosition.fillReprojPoint(d.mPt2.mPts[0]),m=Array(3),m=Imajnet3dPosition.prod(Imajnet3dPosition.getMatrixSubrange(g,0,3,0,3),e),Imajnet3dPosition.ENU2LLH_(a.pImage.mPos_llh,m,d.mPt2.mPos_llh))}}return A},ComputeRt:function(a,b,c,d,e,f){var h=[[0,-1,0],[0,0,-1],[1,0,0]];if(!e||f&&0>=f){e=Nigsys.createMatrix(3,3);c=Nigsys.createMatrix(3,3);var g=Nigsys.createMatrix(3,
3),l=Nigsys.createMatrix(3,3);Nigsys.createMatrix(3,3);d=Array(3);var g=Math.cos(a.mAttitude.roll*_INVPI),l=Math.cos(a.mAttitude.pitch*_INVPI),m=Math.cos(a.mAttitude.yaw*_INVPI),n=Math.sin(a.mAttitude.roll*_INVPI),v=Math.sin(a.mAttitude.pitch*_INVPI),k=Math.sin(a.mAttitude.yaw*_INVPI);e[0][0]=-l*k;e[1][0]=l*m;e[2][0]=-v;e[0][1]=-n*v*k-g*m;e[1][1]=m*n*v-g*k;e[2][1]=l*n;e[0][2]=-g*v*k+m*n;e[1][2]=g*m*v+n*k;e[2][2]=g*l;g=Imajnet3dPosition.prod(h,Imajnet3dPosition.trans(e));e=Math.cos(b.mAttitude.roll*
_INVPI);l=Math.cos(b.mAttitude.pitch*_INVPI);m=Math.cos(b.mAttitude.yaw*_INVPI);n=Math.sin(b.mAttitude.roll*_INVPI);v=Math.sin(b.mAttitude.pitch*_INVPI);k=Math.sin(b.mAttitude.yaw*_INVPI);c[0][0]=-l*k;c[1][0]=l*m;c[2][0]=-v;c[0][1]=-n*v*k-e*m;c[1][1]=m*n*v-e*k;c[2][1]=l*n;c[0][2]=-e*v*k+m*n;c[1][2]=e*m*v+n*k;c[2][2]=e*l;l=Imajnet3dPosition.prod(h,Imajnet3dPosition.trans(c));c=Imajnet3dPosition.prod(l,Imajnet3dPosition.trans(g));h=parseFloat(1-_E2*Math.pow(Math.sin(a.mPos_llh.lat*_INVPI),2));e=_A*
(1-_E2)/Math.pow(h,1.5);d[0]=(_A/Math.pow(h,.5)+(b.mPos_llh.height+a.mPos_llh.height)/2)*Math.cos(a.mPos_llh.lat*_INVPI)*(a.mPos_llh.lon-b.mPos_llh.lon)*_INVPI;d[1]=(e+(b.mPos_llh.height+a.mPos_llh.height)/2)*(a.mPos_llh.lat-b.mPos_llh.lat)*_INVPI;d[2]=a.mPos_llh.height-b.mPos_llh.height;d=Imajnet3dPosition.prod(l,d);null!=f&&(f=-1)}return{R:c,t:d,precision:f}},constraintmouse_opt:function(a,b,c,d){a=Imajnet3dPosition.undistord_im2opt(a,c);return Imajnet3dPosition.projection(b,a,d)},projection:function(a,
b,c){var d=a[0],e=a[1];a=a[2];var f=e*b.x-d*b.y;if(0!=d)c.y=-(d*f+e*a)/(d*d+e*e),c.x=-(a+e*c.y)/d;else if(0!=e)c.x=b.x,c.y=-a/e;else return 1;return 0},fillReprojPoint:function(a){if(0==a.mOpt_pt.z)a.mReproj_pt={x:0,y:0};else{Imajnet3dPosition.distord_opt2im(Imajnet3dPosition.cameraCalibration.calibration_parameters,{x:a.mOpt_pt.x/a.mOpt_pt.z,y:a.mOpt_pt.y/a.mOpt_pt.z},{});var b=Imajnet3dPosition.cameraCalibration,c=a.mOpt_pt,c={x:c.x/c.z,y:c.y/c.z};a.mReproj_pt={};Imajnet3dPosition.distord_opt2im(b.calibration_parameters,
c,a.mReproj_pt)}a.mPixel_pt=a.mReproj_pt},GetPointOnPlane:function(a,b,c,d){var e=Imajnet3dPosition.cameraCalibration;e.pc={t_sol2optRsol:[-e.y_gpscam/1E3,-e.z_gpscam/1E3,e.x_gpscam/1E3]};b=Imajnet3dPosition.arraySubstraction(b.mOpt_pt,e.pc.t_sol2optRsol);c=Imajnet3dPosition.arraySubstraction(c.mOpt_pt,e.pc.t_sol2optRsol);var f=Imajnet3dPosition.arraySubstraction(d.mOpt_pt,e.pc.t_sol2optRsol);d=Array(3);var h=Array(4);Imajnet3dPosition.computePlane(b,c,f,h);if(0!=h[0]||0!=h[1]||0!=h[2]||0!=h[3])return b=
Array(3),Imajnet3dPosition.GetPointOnPlaneReal(a.mPixel_pt,h,e.calibration_parameters,b),a.mOpt_pt=Imajnet3dPosition.arrayAddition(b,e.pc.t_sol2optRsol),a.mReproj_pt={x:a.mPixel_pt.x,y:a.mPixel_pt.y},a.mDist=Imajnet3dPosition.norm2_3(a.mOpt_pt),a.mPrecision=1,e=Array(9),Imajnet3dPosition.ComputeMoptiqueenu(a.pImage.mAttitude,e),Imajnet3dPosition.Ab3(e,a.mOpt_pt,d),Imajnet3dPosition.ENU2LLH_(a.pImage.mPos_llh,d,a.mPos_llh),0},GetPointOnPlaneReal:function(a,b,c,d){var e=Imajnet3dPosition.undistord_im2opt(c,
a,e);a=b[0]*e.x+b[1]*e.y+b[2];if(0==a)return d[0]=0,d[1]=0,d[2]=0,-1;b=-b[3]/a;d[0]=b*e.x;d[1]=b*e.y;d[2]=b;return 0},computePlane:function(a,b,c,d){Imajnet3dPosition.crossProd3(Imajnet3dPosition.arraySubstraction(b,a),Imajnet3dPosition.arraySubstraction(c,a),d);Imajnet3dPosition.normalize2_3(d);d[3]=-(d[0]*a[0]+d[1]*a[1]+d[2]*a[2])},getMatrixSubrange:function(a,b,c,d,e){for(var f=[];b<c;b++)f.push(a[b].slice(d,e));return f},setMatrixSubrange:function(a,b,c,d){for(var e=0;e<d.length;e++)for(var f=
0;f<d[e].length;f++)a[b+e][c+f]=d[e][f]},setArraySubrange:function(a,b,c){a.splice.apply(a,[b,c.length].concat(c))},getMatrixColumn:function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d][b]);return c},setMatrixColumn:function(a,b,c){for(var d=0;d<a.length;d++)a[d][b]=c[d]},arraySubstraction:function(a,b){return a.map(function(a,d){return a-b[d]})},arrayAddition:function(a,b){return a.map(function(a,d){return a+b[d]})},invM:function(a,b){Imajnet3dPosition.setMatrixSubrange(b,0,0,Imajnet3dPosition.trans(Imajnet3dPosition.getMatrixSubrange(a,
0,3,0,3)));Imajnet3dPosition.setMatrixColumn(b,3,-1*Imajnet3dPosition.prod(Imajnet3dPosition.getMatrixSubrange(b,0,3,0,3),Imajnet3dPosition.getMatrixColumn(a,3)))},trans:function(a){return a[0].map(function(b,c){return a.map(function(a){return a[c]})})},prod:function(a,b){a[0].length||(a=a.map(function(a){return[a]}));b[0].length||(b=b.map(function(a){return[a]}));for(var c=a.length,d=a[0].length,e=b[0].length,f=Array(c),h=0;h<c;++h){f[h]=Array(e);for(var g=0;g<e;++g)for(var l=f[h][g]=0;l<d;++l){var m=
a[h][l];isNaN(m)&&(m=0);var n=b[l][g];isNaN(n)&&(n=0);f[h][g]+=m*n}}1==f[0].length&&(f=f.map(function(a){return a[0]}));return f},createMptPoint:function(){return{mPt2:{mPts:[{mOpt_pt:{}}],mPos_llh:[]}}},llh2XYZ:function(a,b,c,d){var e=[];Imajnet3dPosition.LLH2ENU_(a.mPos_llh,b,e,c);b=Array(9);Imajnet3dPosition.ComputeMenuoptique(a.mAttitude,b);Imajnet3dPosition.applytransf(b,e,d,c);return 0},applytransf:function(a,b,c,d){for(var e=0;e<3*d;e+=3)c[e]=a[0]*b[e]+a[1]*b[e+1]+a[2]*b[e+2],c[e+1]=a[3]*b[e]+
a[4]*b[e+1]+a[5]*b[e+2],c[e+2]=a[6]*b[e]+a[7]*b[e+1]+a[8]*b[e+2]},ApplyH:function(a,b,c){var d=a[6]*b[0]+a[7]*b[1]+a[8];c[0]=(a[0]*b[0]+a[1]*b[1]+a[2])/d;c[1]=(a[3]*b[0]+a[4]*b[1]+a[5])/d;return c},Ropt2ccd:function(a,b,c,d,e){e[6]=a[6]/b;e[7]=a[7]/b;e[8]=a[8]-e[6]*c-e[7]*d;e[0]=a[0]+e[6]*c;e[1]=a[1]+e[7]*d;e[2]=a[2]*b-a[0]*c-a[1]*d+e[8]*c;e[3]=a[3]+e[6]*d;e[4]=a[4]+e[7]*c;e[5]=a[5]*b-a[3]*c-a[4]*d+e[8]*d;return e},undistord_im2opt:function(a,b){return Imajnet3dPosition.undistord_opt2opt(a,{x:(b.x-
a.ccx)/a.focal,y:(b.y-a.ccy)/a.focal})},undistord_opt2opt:function(a,b,c){var d=b.x,e=b.y;c={};for(var f=0;5>f;f++)var h=d*d,g=e*e,d=d*e,l=h+g,e=1/(1+((a.k3*l+a.k2)*l+a.k1)*l),g=a.p1*(l+2*g)+2*a.p2*d,d=parseFloat((b.x-(2*a.p1*d+a.p2*(l+2*h)))*e),e=parseFloat((b.y-g)*e);c.x=d;c.y=e;return c},crossProd3:function(a,b,c){c[0]=a[1]*b[2]-a[2]*b[1];c[1]=a[2]*b[0]-a[0]*b[2];c[2]=a[0]*b[1]-a[1]*b[0]},distord_opt2im:function(a,b,c){b=Imajnet3dPosition.distord_opt2opt(a,b);c||(c={});c.x=b.x*a.focal+a.ccx;c.y=
b.y*a.focal+a.ccy;return c},distord_opt2opt:function(a,b,c){c={};var d=b.x;b=b.y;var e=d*d+b*b;if(2>e){var f=1+((a.k3*e+a.k2)*e+a.k1)*e,h=a.p1*(e+2*b*b)+2*a.p2*d*b;c.x=d*f+(2*a.p1*d*b+a.p2*(e+2*d*d));c.y=b*f+h}else c.x=d,c.y=b;return c},normalize2_3:function(a){var b=1/(Imajnet3dPosition.norm2_3(a)+Number.MIN_VALUE);a[0]*=b;a[1]*=b;a[2]*=b},norm2_3:function(a){return a.x?Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z):Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},dist3_2:function(a,b){return Math.pow(a[0]-b[0],2)+
Math.pow(a[1]-b[1],2)+Math.pow(a[2]-b[2],2)},ComputeMenuoptiqueMatrix:function(a,b){var c=Math.cos(a.roll*_INVPI),d=Math.cos(a.pitch*_INVPI),e=Math.cos(a.yaw*_INVPI),f=Math.sin(a.roll*_INVPI),h=Math.sin(a.pitch*_INVPI),g=Math.sin(a.yaw*_INVPI);b[0][0]=-d*g;b[1][0]=d*e;b[2][0]=-h;b[0][1]=-f*h*g-c*e;b[1][1]=e*f*h-c*g;b[2][1]=d*f;b[0][2]=-c*h*g+e*f;b[1][2]=c*e*h+f*g;b[2][2]=c*d},ComputeMenuoptique:function(a,b){var c=Math.cos(a.roll*_INVPI),d=Math.cos(a.pitch*_INVPI),e=Math.cos(a.yaw*_INVPI),f=Math.sin(a.roll*
_INVPI),h=Math.sin(a.pitch*_INVPI),g=Math.sin(a.yaw*_INVPI);b||(b=Array(9));b[0]=f*h*g+c*e;b[1]=-e*f*h+c*g;b[2]=-d*f;b[3]=c*h*g-e*f;b[4]=-c*e*h-f*g;b[5]=-c*d;b[6]=-d*g;b[7]=d*e;b[8]=-h;return b},ComputeMoptiqueenu:function(a,b){var c=Math.cos(a.roll*_INVPI),d=Math.cos(a.pitch*_INVPI),e=Math.cos(a.yaw*_INVPI),f=Math.sin(a.roll*_INVPI),h=Math.sin(a.pitch*_INVPI),g=Math.sin(a.yaw*_INVPI);b||(b=Array(9));b[0]=f*h*g+c*e;b[1]=c*h*g-e*f;b[2]=-d*g;b[3]=-e*f*h+c*g;b[4]=-c*e*h-f*g;b[5]=d*e;b[6]=-d*f;b[7]=-c*
d;b[8]=-h;return b},ComputeMenu2opt:function(a,b){var c=Nigsys.createMatrix(3,3);Imajnet3dPosition.ComputeMenuoptiqueMatrix(a,c);Imajnet3dPosition.setMatrixSubrange(b,0,0,Imajnet3dPosition.prod([[0,-1,0],[0,0,-1],[1,0,0]],Imajnet3dPosition.trans(c)));b[0][3]=0;b[1][3]=0;b[2][3]=0},Ab3:function(a,b,c){c||(c=Array(3));!b.x&&b.length&&(b={x:b[0],y:b[1],z:b[2]});c[0]=a[0]*b.x+a[1]*b.y+a[2]*b.z;c[1]=a[3]*b.x+a[4]*b.y+a[5]*b.z;c[2]=a[6]*b.x+a[7]*b.y+a[8]*b.z;return c},LLH2ENU_:function(a,b,c,d){var e=1-
_E2*Math.pow(Math.sin(a.lat*_INVPI),2),f=(_A/Math.pow(e,.5)+a.height)*Math.cos(a.lat*_INVPI)*_INVPI,e=(_A*(1-_E2)/Math.pow(e,1.5)+a.height)*_INVPI;c||(c=Array(3));for(var h=0;h<3*d;h+=3)c[h]=(b[h]-a.lon)*f,c[h+1]=(b[h+1]-a.lat)*e,c[h+2]=b[h+2]-a.height;return c},ENU2LLH_:function(a,b,c){var d=1-_E2*Math.pow(Math.sin(a.lat*_INVPI),2),e=_A*(1-_E2)/Math.pow(d,1.5),d=_A/Math.pow(d,.5);c||(c=Array(3));c[0]=a.lon+b[0]*_PIs180/((d+a.height)*Math.cos(a.lat*_INVPI));c[1]=a.lat+b[1]*_PIs180/(e+a.height);c[2]=
a.height+b[2];return c},getPointInDisparityMap:function(a){return{x:Math.round(a.x*Imajnet3dPosition.disparityImageCalibration.calibFocale+Imajnet3dPosition.disparityImageCalibration.calibCcx),y:Math.round(a.y*Imajnet3dPosition.disparityImageCalibration.calibFocale+Imajnet3dPosition.disparityImageCalibration.calibCcy)}},getZmapPointFromPixelPoint:function(a){a=Imajnet3dPosition.undistord_im2opt(Imajnet3dPosition.realImageCalibration,a);a=Imajnet3dPosition.getPointInDisparityMap(a);0>a.x&&(a.x=0);
a.x>=Imajnet3dPosition.disparityImageCalibration.imSizeWidth&&(a.x=Imajnet3dPosition.disparityImageCalibration.imSizeWidth-1);0>a.y&&(a.y=0);a.y>=Imajnet3dPosition.disparityImageCalibration.imSizeHeight&&(a.y=Imajnet3dPosition.disparityImageCalibration.imSizeHeight-1);return a},getPixelPointFromZmapPoint:function(a){var b=Imajnet3dPosition.disparityImageCalibration,c;c=(a.x-b.calibCcx)/b.calibFocale;a=(a.y-b.calibCcy)/b.calibFocale;var d=c*c+a*a,b=Imajnet3dPosition.realImageCalibration;if(2>d){var e=
1+((b.k3*d+b.k2)*d+b.k1)*d,f=b.p1*(d+2*a*a)+2*b.p2*c*a;c=c*e+(2*b.p1*c*a+b.p2*(d+2*c*c));a=a*e+f}return{x:c*b.focal+b.ccx,y:a*b.focal+b.ccy}},getPosLLHfrom3DMap:function(a,b,c,d,e){if(0==e.ccx||0==e.ccy||0>e.focale||0==a.mPts.length||0==b.length||0==d.length)return null;c=Imajnet3dPosition.realImageCalibration;var f=Imajnet3dPosition.undistord_im2opt(Imajnet3dPosition.realImageCalibration,a.mPts[0].mPixel_pt),h=Imajnet3dPosition.getPointInDisparityMap(f);if(!(h.x<b.length||h.y<b[0].length)||0>h.x||
0>h.y||!b[h.y])return null;d=d[h.y][h.x];if(0==b[h.y][h.x]||0>=d)return null;a.mPts[0].mOpt_pt={};a.mPts[0].mOpt_pt.x=d*f.x;a.mPts[0].mOpt_pt.y=d*f.y;a.mPts[0].mOpt_pt.z=d;a.mPts[0].mReproj_pt=Imajnet3dPosition.distord_opt2im(c,{x:(h.x-e.calibCcx)/e.calibFocale,y:(h.y-e.calibCcy)/e.calibFocale},{});a.mPts[0].mDist=Imajnet3dPosition.norm2_3(a.mPts[0].mOpt_pt);b=Imajnet3dPosition.ComputeMoptiqueenu(ImajnetMap.currentPosition.orientation);b=Imajnet3dPosition.Ab3(b,a.mPts[0].mOpt_pt);a.mPos_llh=Imajnet3dPosition.ENU2LLH_(ImajnetMap.currentPosition,
b);return a},getPointsInRadius:function(a,b,c,d,e,f,h,g){try{var l=a[0].length,m=a.length;b=h*h;var n=g.calibCcx,v=g.calibCcy,k=1/g.calibFocale,B=Math.ceil(h*g.calibFocale/f.z);h=B*B;g=2*(B+1)+1;d=[];for(var p=0;p<g;p++){for(var u=[],A=0;A<g;A++)0==p||p==g-1||0==A||A==g-1?u.push(-1):u.push(0);d.push(u)}var r=e.x-B-1,w=e.y-B-1;g=e;for(p=[g];0<p.length;){var z=a[g.y][g.x];if(g.x<l-1&&0==d[g.y-w][g.x-r+1]&&0<a[g.y][g.x+1]&&Math.pow(g.x+1-e.x,2)+Math.pow(g.y-e.y,2)<=h&&32>Math.abs(z-a[g.y][g.x+1])){var q=
Array(3),t=Array(3);q[0]=g.x+1;q[1]=g.y;q[2]=1;var D=c[g.y][g.x+1];t[0]=(q[0]-n)*k*D;t[1]=(q[1]-v)*k*D;t[2]=D;Imajnet3dPosition.dist3_2(t,[f.x,f.y,f.z])<b&&(d[g.y-w][g.x-r+1]=1,p.push({x:q[0],y:q[1]}))}0<g.x&&0==d[g.y-w][g.x-r-1]&&0<a[g.y][g.x+1]&&Math.pow(g.x-1-e.x,2)+Math.pow(g.y-e.y,2)<=h&&32>Math.abs(z-a[g.y][g.x-1])&&(q=Array(3),t=Array(3),q[0]=g.x-1,q[1]=g.y,q[2]=1,D=c[g.y][g.x-1],t[0]=(q[0]-n)*k*D,t[1]=(q[1]-v)*k*D,t[2]=D,Imajnet3dPosition.dist3_2(t,[f.x,f.y,f.z])<b&&(d[g.y-w][g.x-r-1]=1,p.push({x:q[0],
y:q[1]})));g.y<m-1&&0==d[g.y-w+1][g.x-r]&&0<a[g.y+1][g.x]&&Math.pow(g.x-e.x,2)+Math.pow(g.y+1-e.y,2)<=h&&32>Math.abs(z-a[g.y+1][g.x])&&(q=Array(3),t=Array(3),q[0]=g.x,q[1]=g.y+1,q[2]=1,D=c[g.y+1][g.x],t[0]=(q[0]-n)*k*D,t[1]=(q[1]-v)*k*D,t[2]=D,Imajnet3dPosition.dist3_2(t,[f.x,f.y,f.z])<b&&(d[g.y-w+1][g.x-r]=1,p.push({x:q[0],y:q[1]})));0<g.y&&0==d[g.y-w-1][g.x-r]&&0<a[g.y-1][g.x]&&Math.pow(g.x-e.x,2)+Math.pow(g.y-1-e.y,2)<=h&&32>Math.abs(z-a[g.y-1][g.x])&&(q=Array(3),t=Array(3),q[0]=g.x,q[1]=g.y-1,
q[2]=1,D=c[g.y-1][g.x],t[0]=(q[0]-n)*k*D,t[1]=(q[1]-v)*k*D,t[2]=D,Imajnet3dPosition.dist3_2(t,[f.x,f.y,f.z])<b&&(d[g.y-w-1][g.x-r]=1,p.push({x:q[0],y:q[1]})));g=p.splice(0,1)[0]}r=e.x-B-1;w=e.y-B-1;Imajnet3dPosition.placePixelsInCanvas(d,{x:r,y:w})}catch(E){console.log(E)}},drawEllipseByCenter:function(a,b,c,d,e){x=b-d/2;y=c-e/2;b=d/2*.5522848;c=e/2*.5522848;var f=x+d,h=y+e;d=x+d/2;e=y+e/2;a.beginPath();a.moveTo(x,e);a.bezierCurveTo(x,e-c,d-b,y,d,y);a.bezierCurveTo(d+b,y,f,e-c,f,e);a.bezierCurveTo(f,
e+c,d+b,h,d,h);a.bezierCurveTo(d-b,h,x,e+c,x,e);a.stroke()}};"undefined"==typeof Promise&&!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b():"function"==typeof define&&define.amd?define(b):b()}(0,function(){function a(){}function b(a){if(!(this instanceof b))throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=0;this._handled=!1;this._value=void 0;this._deferreds=[];h(a,this)}function c(a,c){for(;3===
a._state;)a=a._value;0!==a._state?(a._handled=!0,b._immediateFn(function(){var b=1===a._state?c.onFulfilled:c.onRejected;if(null!==b){var f;try{f=b(a._value)}catch(g){return void e(c.promise,g)}d(c.promise,f)}else(1===a._state?d:e)(c.promise,a._value)})):a._deferreds.push(c)}function d(a,c){try{if(c===a)throw new TypeError("A promise cannot be resolved with itself.");if(c&&("object"==typeof c||"function"==typeof c)){var d=c.then;if(c instanceof b)return a._state=3,a._value=c,void f(a);if("function"==
typeof d)return void h(function(a,b){return function(){a.apply(b,arguments)}}(d,c),a)}a._state=1;a._value=c;f(a)}catch(g){e(a,g)}}function e(a,b){a._state=2;a._value=b;f(a)}function f(a){2===a._state&&0===a._deferreds.length&&b._immediateFn(function(){a._handled||b._unhandledRejectionFn(a._value)});for(var d=0,e=a._deferreds.length;e>d;d++)c(a,a._deferreds[d]);a._deferreds=null}function h(a,b){var c=!1;try{a(function(a){c||(c=!0,d(b,a))},function(a){c||(c=!0,e(b,a))})}catch(f){c||(c=!0,e(b,f))}}var g=
function(a){var b=this.constructor;return this.then(function(c){return b.resolve(a()).then(function(){return c})},function(c){return b.resolve(a()).then(function(){return b.reject(c)})})},l=setTimeout;b.prototype["catch"]=function(a){return this.then(null,a)};b.prototype.then=function(b,d){var e=new this.constructor(a);return c(this,new function(a,b,c){this.onFulfilled="function"==typeof a?a:null;this.onRejected="function"==typeof b?b:null;this.promise=c}(b,d,e)),e};b.prototype["finally"]=g;b.all=
function(a){return new b(function(b,c){function d(a,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(b){d(a,b)},c)}e[a]=g;0==--f&&b(e)}catch(n){c(n)}}if(!a||"undefined"==typeof a.length)throw new TypeError("Promise.all accepts an array");var e=Array.prototype.slice.call(a);if(0===e.length)return b([]);for(var f=e.length,g=0;e.length>g;g++)d(g,e[g])})};b.resolve=function(a){return a&&"object"==typeof a&&a.constructor===b?a:
new b(function(b){b(a)})};b.reject=function(a){return new b(function(b,c){c(a)})};b.race=function(a){return new b(function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,c)})};b._immediateFn="function"==typeof setImmediate&&function(a){setImmediate(a)}||function(a){l(a,0)};b._unhandledRejectionFn=function(a){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",a)};var m=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=
typeof global)return global;throw Error("unable to locate global object");}();m.Promise?m.Promise.prototype["finally"]||(m.Promise.prototype["finally"]=g):m.Promise=b});PngToy.prototype.fetch=function(a){var b=this;b.url=a;b.buffer=b.chunks=b.view=null;b._pos=0;return new Promise(function(c,d){function e(a){var e,f;try{e=new DataView(a),66<a.byteLength&&2303741511===e.getUint32(0)&&218765834===e.getUint32(4)?(f=PngToy._getChunks(a,e,b.doCRC,b.allowInvalid),b.buffer=a,b.view=e,b.chunks=f.chunks||[],
b.chunks||b.allowInvalid?c():d(f.error)):d("Not a PNG file.")}catch(m){d(m.message)}}if("string"===typeof a)try{var f=new XMLHttpRequest;Imajnet3dPosition.disparityImageXhr=f;f.open("GET",a,!0);f.withCredentials=!0;f.responseType="arraybuffer";b.beforeSend(f);f.onerror=function(a){d("Network error. "+a.message)};f.onload=function(){200===f.status?(Imajnet3dPosition.onDisparityImageReceived(f),e(f.response)):d("Loading error:"+f.statusText)};f.send()}catch(h){d(h.message)}else e(ArrayBuffer.isView(a)?
a.buffer:a)})}};
var ImajnetPosition={zoomLevel:null,positionAjaxRequest:null,onPositionClick:function(a,b){ImajnetPlugin.positionImageOnFeature(b.getId())},addPreviewPanel:function(){jQuery("#imajnetPreviewPanel").html('\x3cdiv id\x3d"imajnetPreviewPanelContent"\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetPreviewCheckboxContainer"\x3e\x3cinput type\x3d"checkbox" id\x3d"imajnetPreviewCheckbox"\x3e'+jQuery.imajnet.map.hidePreviewPanel+'\x3c/div\x3e\x3cdiv class\x3d"clear"\x3e\x3c/div\x3e');jQuery("#imajnetPreviewCheckbox").iCheck({checkedCheckboxClass:"checkedCheckbox",
uncheckedCheckboxClass:"uncheckedCheckbox"}).on("ifChanged",function(a){ImajnetUI.disablePreviewPanel()});ImageControler.currentPhotogrammetry.setCurrentPreviewStep();jQuery("#positionDenied").remove();ImajnetUI.popupImajnetControlsLayer.append('\x3cimg id\x3d"positionDenied" src\x3d"'+Imajnet.imajnetPath+"img/measurementDenied.png?"+Imajnet.version+'" width\x3d"100" height\x3d"100" style\x3d"position: absolute; top: '+(ImajnetUI.imajnetImageContainerSize.height-100)/2+"px; left: "+(ImajnetUI.imajnetImageContainerSize.width-
100)/2+'px; display: none;" /\x3e')},addContextmenuHTML:function(){ImajnetUI.contextMenuContainer.hide();ImajnetUI.contextMenuContainer.html('\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImageControler.currentPhotogrammetry.resetGeometry(); Nigsys.disableEventPropagation(event); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.resetGeometry+"\x3c/div\x3e")},showPosition:function(a){ImageControler.currentPhotogrammetry.deletePrevObjects();ImajnetPolyligne.hide(a);ImageControler.currentSurveyTrace.hideTrace();
ImajnetZoom.deactivateZoom();ImajnetUI.activeControlButton="imajnetPosition";this.addPreviewPanel();ImajnetUI.isPreviewPanelDisabled()||jQuery("#imajnetPreviewPanel").fadeIn(150);jQuery("#imajnetPositionButtonContainer").addClass("buttonActive");ImajnetImageSwitcher.hide();ImajnetUI.LRSGUI.hide();ImajnetUI.clientLogoContainer.hide();ImajnetZoom.imageWasDragged=!1;Address.hideAddressContainer();LRS.hideLRSContainer();ImajnetUI.hideDateContainer()},hidePosition:function(a){ImajnetUI.activeControlButton=
"";ImajnetUI.imajnetImageContainer&&ImageControler.currentPhotogrammetry&&ImajnetUI.imajnetImageContainer.unbind("mousemove",ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel);jQuery("#imajnetPreviewPanel").hide();jQuery("#positionDenied").hide();jQuery("#imajnetPositionButtonContainer").removeClass("buttonActive");Address.showAddress();LRS.showLRS();ImajnetUI.clientLogoContainer.show();ImajnetUI.showDateContainer();ImageControler.currentPhotogrammetry.redraw(!1);ImajnetMap.currentPosition&&
LRS.cachedPoints[ImajnetMap.currentPosition.lat+":"+ImajnetMap.currentPosition.lon+":"+ImajnetMap.currentPosition.height]&&ImajnetUI.LRSGUI.draw(LRS.cachedPoints[ImajnetMap.currentPosition.lat+":"+ImajnetMap.currentPosition.lon+":"+ImajnetMap.currentPosition.height]);ImageControler.currentPhotogrammetry&&(ImageControler.currentPhotogrammetry.currentStep=1,ImageControler.currentPhotogrammetry.firstImagePosition=null,ImageControler.currentPhotogrammetry.constraintParameter=null,a?ImageControler.currentSurveyTrace.draw(ImajnetMap.currentPosition):
ImageControler.currentPhotogrammetry.hidePreviewPanel())},showHidePosition:function(){ImajnetUI.stopSwipeNavigation(!0);ImageControler.currentImageControl.resetFastNavigation();jQuery("#imajnetPositionButtonContainer").hasClass("buttonActive")?this.hidePosition(!0):this.showPosition(!0)},showHidePositionDenied:function(){ImageControler.currentPhotogrammetry.photogrammetryIsDenied()&&1!=ImageControler.currentPhotogrammetry.currentStep?jQuery("#positionDenied").show():(jQuery("#positionDenied").hide(),
ImageControler.currentPhotogrammetry.getConstraint())},reload:function(){jQuery("#imajnetPositionButtonContainer").hasClass("buttonActive")&&(this.hidePosition(!1),this.showPosition(!1),ImajnetZoom.imageWasDragged=!1)},pinPointPositionReceived:function(a,b){ImageControler.currentPhotogrammetry.setCurrentPreviewStep();ImajnetSettings.imajnetSettings.toolsRemainActive?ImajnetPosition.reload():(ImajnetPosition.hidePosition(!0),ImageControler.currentPhotogrammetry.redraw(!1));if((a=JSON.parse(a))&&a.parameter&&
a.parameter.imagePoint&&a.parameter.imagePoint.img1){a.type="position";var c=ImageControler.currentPhotogrammetry.addObject(a.parameter.imagePoint.img1,a,!1,!0,!0);b&&b.stopImageChange?ImageControler.currentPhotogrammetry.redraw(!1):ImajnetMap.currentPosition&&(ImajnetMap.currentPosition.id!==a.parameter.imagePoint.img1.id?ImajnetPlugin.positionImageOnFeature(c.id):ImageControler.currentPhotogrammetry.redraw(!1));ImageControler.currentPhotogrammetry.getObjectLRS(a);if(Imajnet.autoPhotogrammetryAdd)ImajnetPlugin.onObjectCreatedDefault({type:"point",
id:c.id,geometry:[{x:a.photogrammetryPosition3D.coordinates.lon,y:a.photogrammetryPosition3D.coordinates.lat,z:a.photogrammetryPosition3D.coordinates.height}]});else ImajnetPlugin.onPinPointCreated({id:c.id,point:a.photogrammetryPosition3D})}else ImajnetUI.showError(jQuery.imajnet.map.position.errorPosition,!0)},pinPointPositionComplete:function(a){200!==a.status&&(ImageControler.currentPhotogrammetry.currentStep=1,ImajnetUI.showError(jQuery.imajnet.map.position.errorPosition,!0,ImajnetPosition.onPositionReceivedError))},
onPositionReceivedError:function(){ImajnetAPI.setImajnetImage({position:ImageControler.currentPhotogrammetry.firstImagePosition}).done(function(){ImageControler.currentPhotogrammetry.setCurrentPreviewStep()})},positionObject:function(a,b,c){if(!(Imajnet3dPosition.isActive&&Imajnet3dPosition.position3dObject(a,b)&&2>ImageControler.currentPhotogrammetry.currentStep)){ImajnetAPI.mustAbortRequests&&null!==this.positionAjaxRequest&&this.positionAjaxRequest.abort();var e=null;c&&c.face&&(e=c.face);switch(ImageControler.currentPhotogrammetry.currentStep){case 1:ImageControler.currentPhotogrammetry.firstImagePosition=
ImajnetMap.currentPosition;ImajnetZoom.imageQuality="HIGH_RESOLUTION";var d=null;"FLAT"==ImageControler.currentImageType?(ImajnetUI.previewImage.attr("src",ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.firstImagePosition,ImajnetUI.getPreviewImageResolution())),d=ImajnetZoom.getRealImageCoordinates(a,b)):(ImajnetUI.previewImage.attr("src",ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.firstImagePosition,ImajnetUI.getPreviewImageResolution()),e),d={x:a,y:b});ImageControler.currentGraphic.clearPreviewPanel();
a=ImajnetZoom.getPreviewPanelZoomFactor();b=ImageControler.currentPhotogrammetry.setPreviewPanelVisibleRegion(d,a);ImageControler.currentGraphic.drawPreviewPanelPoint(d,a,b);ImageControler.currentPhotogrammetry.showPreviewPanel();ImageControler.currentPhotogrammetry.constraintParameter=Object({points:Array(d)});ImageControler.currentImageControl.getPrevious(!0);ImageControler.currentPhotogrammetry.currentStep++;ImageControler.currentPhotogrammetry.setCurrentPreviewStep();ImajnetUI.imajnetImageContainer.bind("mousemove",
ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel);break;case 2:ImageControler.currentPhotogrammetry.hidePreviewPanel(),ImajnetZoom.imageQuality="HIGH_RESOLUTION",d="FLAT"==ImageControler.currentImageType?ImajnetZoom.getRealImageCoordinates(a,b):{x:a,y:b},ImageControler.currentGraphic.clearConstraints(),this.positionAjaxRequest=ImajnetAPI.doImajnetRequest("GET","/api/photogrammetry/position3D/",{imagePoint:{img1:ImageControler.currentPhotogrammetry.firstImagePosition,img2:ImajnetMap.currentPosition,
imgCoord1:{x:ImageControler.currentPhotogrammetry.constraintParameter.points[0].x,y:ImageControler.currentPhotogrammetry.constraintParameter.points[0].y},imgCoord2:{x:d.x,y:d.y}}},this.pinPointPositionReceived,null,this.pinPointPositionComplete,null,null,c),Address.showAddress(),ImageControler.currentPhotogrammetry.currentStep++}2==ImageControler.currentPhotogrammetry.currentStep&&ImageControler.currentPhotogrammetry.setCurrentPreviewStep()}}};
var ImajnetProjection={imajnetProjections:null,userProjections:null,projectedLayers:[],draw:function(){if(!ImajnetMap.currentPosition)return jQuery.Deferred().resolve().promise();var a=jQuery.Deferred();position=ImajnetMap.currentPosition;ImajnetPlugin.getProjectionCandidates(position,ImageControler.currentPhotogrammetry.getProjectionConstraint(position)).done(function(b){ImajnetProjection.projectUserData(position,b).done(function(){a.resolve()})});return a.promise()},getAllProjections:function(a){if(!ImajnetMap.currentPosition||
a&&a.parameter.pointOfView.id!=ImajnetMap.currentPosition.id||a&&null==a.projection)return null;var b=ImageControler.currentPhotogrammetry.getImageIndexInCacheArrayByImageId(ImajnetMap.currentPosition.id);if(!a)return b?{parameter:{pointOfView:{id:b.parameter.pointOfView.id}},projection:b.projection}:null;if(a.projection.pointProjections){for(var c=0;c<a.projection.pointProjections.length;c++)a.projection.pointProjections[c]||(a.projection.pointProjections.splice(c,1),c--);a.projection.pointProjections.length||
delete a.projection.pointProjections}if(a.projection.shapeProjections){for(c=0;c<a.projection.shapeProjections.length;c++)a.projection.shapeProjections[c]||(a.projection.shapeProjections.splice(c,1),c--);a.projection.shapeProjections.length||delete a.projection.shapeProjections}if(b){var d={pointProjections:[],shapeProjections:[]};if((!Nigsys.isPolyligneMode()||1!=ImageControler.currentPhotogrammetry.currentStep%2)&&a.projection.pointProjections)if(b.projection.pointProjections)for(c=0;c<a.projection.pointProjections.length;c++)if(e=
ImageControler.currentPhotogrammetry.getObjectById(a.projection.pointProjections[c].id)){for(var e=!1,f=0;f<b.projection.pointProjections.length;f++)if(b.projection.pointProjections[f]&&b.projection.pointProjections[f].id==a.projection.pointProjections[c].id){e=!0;break}e||(b.projection.pointProjections||(b.projection.pointProjections=[]),b.projection.pointProjections.push(a.projection.pointProjections[c]))}else d.pointProjections.push(a.projection.pointProjections[c]);else for(c=0;c<a.projection.pointProjections.length;c++)(e=
ImageControler.currentPhotogrammetry.getObjectById(a.projection.pointProjections[c].id))?(b.projection.pointProjections||(b.projection.pointProjections=[]),b.projection.pointProjections.push(a.projection.pointProjections[c])):d.pointProjections.push(a.projection.pointProjections[c]);if(a.projection.shapeProjections)if(b.projection.shapeProjections)for(c=0;c<a.projection.shapeProjections.length;c++)if(a.projection.shapeProjections[c]){if(e=ImageControler.currentPhotogrammetry.getObjectById(a.projection.shapeProjections[c].id)){e=
!1;for(f=0;f<b.projection.shapeProjections.length;f++)if(b.projection.shapeProjections[f]&&b.projection.shapeProjections[f].id==a.projection.shapeProjections[c].id&&(e=!0,!Nigsys.isPolyligneMode()||b.projection.shapeProjections[f].id==ImajnetPolyligne.currentAddObjectId)){b.projection.shapeProjections[f]=a.projection.shapeProjections[c];break}e||(b.projection.shapeProjections||(b.projection.shapeProjections=[]),b.projection.shapeProjections.push(a.projection.shapeProjections[c]))}}else d.shapeProjections.push(a.projection.shapeProjections[c]);
else for(c=0;c<a.projection.shapeProjections.length;c++)(e=ImageControler.currentPhotogrammetry.getObjectById(a.projection.shapeProjections[c].id))?(b.projection.shapeProjections||(b.projection.shapeProjections=[]),b.projection.shapeProjections.push(a.projection.shapeProjections[c])):d.shapeProjections.push(a.projection.shapeProjections[c]);b.projection.pointProjections&&(d.pointProjections=b.projection.pointProjections.concat(d.pointProjections));b.projection.shapeProjections&&(d.shapeProjections=
b.projection.shapeProjections.concat(d.shapeProjections));return{parameter:a.parameter,projection:d}}if(!a.projection.pointProjections&&!a.projection.shapeProjections)return null;b={parameter:{pointOfView:{id:a.parameter.pointOfView.id}},projection:{}};a.projection.pointProjections&&(b.projection.pointProjections=a.projection.pointProjections);a.projection.shapeProjections&&(b.projection.shapeProjections=a.projection.shapeProjections);if(!Nigsys.isPolyligneMode()){a=Nigsys.cloneObject(b);if(a.projection.pointProjections){for(c=
0;c<a.projection.pointProjections.length;c++){var e=ImageControler.currentPhotogrammetry.getObjectById(a.projection.pointProjections[c].id);e||(a.projection.pointProjections.splice(c,1),c--)}a.projection.pointProjections.length||delete a.projection.pointProjections}if(a.projection.shapeProjections){for(c=0;c<a.projection.shapeProjections.length;c++)e=ImageControler.currentPhotogrammetry.getObjectById(a.projection.shapeProjections[c].id),e||(a.projection.shapeProjections.splice(c,1),c--);a.projection.shapeProjections.length||
delete a.projection.shapeProjections}(a.projection.pointProjections||a.projection.shapeProjections)&&ImageControler.currentPhotogrammetry.existingProjections.push(a)}return b},projectionReceived:function(a){if((a=ImajnetProjection.getAllProjections(a))&&ImajnetMap.currentPosition&&ImajnetMap.currentPosition.id==a.parameter.pointOfView.id&&void 0!==a.projection){if(a.projection.pointProjections){var b=a.projection.pointProjections;b.sort(function(a,c){return Nigsys.compareAscending(a,c,"id")});for(var c=
0;c<b.length;c++)if(b[c]){var d=parseInt(b[c].id);isNaN(d)||(b[c].id=d);var e=ImajnetMap.getFeatureWrapperById(b[c].id);if(e&&0<=b[c].coordinates.z)if(0==b[c].id)ImajnetClickMode.isFromPosition||ImageControler.currentPhotogrammetry.appendMapMarker(b[c].id,b[c].coordinates);else{if(e.type==ImajnetMap.MARKER_TYPE_POSITION||e.type==ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION){var d=b[c].linkToNext,f=ImageControler.currentPhotogrammetry.getObjectById(b[c].id);d&&(d=ImageControler.currentPhotogrammetry.getImageNextObject(b[c].id))&&
b[c].featureWrapper&&d.type!=f.type&&(d=!1)}ImageControler.currentGraphic.appendPinPoint(b[c].coordinates,e);ImageControler.currentPhotogrammetry.getObjectLRS(f)}}}if(a.projection.shapeProjections)for(c=0;c<a.projection.shapeProjections.length;c++)if(a.projection.shapeProjections[c]){d=parseInt(a.projection.shapeProjections[c].id);isNaN(d)||(a.projection.shapeProjections[c].id=d);e=ImajnetMap.getFeatureWrapperById(a.projection.shapeProjections[c].id);if(d==ImajnetPolyligne.currentAddObjectId&&ImajnetPolyligne.isMeasurementMode()){var g=
ImageControler.currentPhotogrammetry.getObjectById(a.projection.shapeProjections[c].id);g&&1==g.points.length&&ImageControler.currentGraphic.lastClickCoordinates&&(ImageControler.currentGraphic.firstClickCoordinates=a.projection.shapeProjections[c].projections[0].coordinates,f=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(ImageControler.currentGraphic.firstClickCoordinates),ImageControler.currentGraphic.drawIntermediateLine(f.x,f.y,ImageControler.currentGraphic.lastClickCoordinates.x-1,ImageControler.currentGraphic.lastClickCoordinates.y-
1))}a.projection.shapeProjections[c]&&void 0!==a.projection.shapeProjections[c].projections&&0<=a.projection.shapeProjections[c].projections[0].coordinates.z&&(ImageControler.currentPhotogrammetry.drawLine(e,a.projection.shapeProjections[c].projections),ImageControler.currentPhotogrammetry.getObjectLRS(g))}}},projectUserData:function(a,b){if(!b||!b.length)return ImajnetProjection.projectDataRequest(null);for(var c={},d=0;d<b.length;d++)if(b[d].features&&0!=b[d].features.length){var e=b[d].getId();
if(e&&!c[e]){var f=ImajnetProjection.getProjectedLayerById(e);if(f)c[e]={points:[],shapes:[],groundProjection:f.groundProjection,heightOffset:f.heightOffset};else{console.warn("Layer not fount in ImajnetProjection.projectedLayers");continue}}else e||(e="allProjections");"allProjections"!=e||c.allProjections||(c.allProjections={points:[],shapes:[],groundProjection:!0,heightOffset:0});for(f=0;f<b[d].features.length;f++){var g=b[d].features[f].getGeometry();if("point"==b[d].getGeometryType())g[0].height=
g[0].height||ImajnetMap.currentPosition.height-1.5,c[e].points.push({coordinates:g[0],linkToNext:!1,objectId:"PointProjection_"+(e+f+1)});else{for(var k=[],g=b[d].features[f].getGeometry(),h=0;h<g.length;h++)g[h].height=g[h].height||ImajnetMap.currentPosition.height-1.5,k.push({coordinates:g[h],linkToNext:"line"!==b[d].getGeometryType()||h<g.length-1?!0:!1,objectId:"PointProjection_"+(e+f+1).toString()+h.toString()});c[e].shapes.push({id:"LineProjection_"+(e+f+1),points:k})}b[d].features[f].getId()||
b[d].features[f].setId(1==g.length?"PointProjection_"+(e+f+1):"LineProjection_"+(e+f+1));b[d].features[f].setType(ImajnetMap.FEATURE_TYPE_PROJECTION);ImajnetMap.addToFeatureWrappers(b[d].features[f])}}e=[];for(d in c)0==c[d].points.length&&delete c[d].points,0==c[d].shapes.length&&delete c[d].shapes,e.push(c[d]);return ImajnetProjection.projectDataRequest({projectionData:e,pointOfView:a})},projectImajnetDataRequest:function(a){ImajnetProjection.imajnetProjections=null;var b=jQuery.Deferred();if(!a)return b.resolve(),
b.promise();ImajnetAPI.doImajnetRequestDeferred("POST","/api/photogrammetry/projection/",a,null,null,null).done(function(a){a&&(ImajnetProjection.imajnetProjections=JSON.parse(a));b.resolve()}).fail(function(a){b.reject(a)});return b.promise()},projectUserDataRequest:function(){var a=jQuery.Deferred();ImajnetProjection.userProjections=null;ImajnetPlugin.drawUserProjections(ImajnetMap.currentPosition.id).done(function(b,c){c&&jQuery.each(c,function(a,b){if(ImajnetMap.getFeatureWrapperById(b.id))for(var c=
0;c<ImajnetMap.featureWrappers.length;c++)if(ImajnetMap.featureWrappers[c].id==b.id){ImajnetMap.featureWrappers.splice(c,1);break}ImajnetMap.addToFeatureWrappers({feature:b.feature,id:b.id,style:b.style,type:ImajnetMap.FEATURE_TYPE_PROJECTION})});b&&(ImajnetProjection.userProjections=b);a.resolve()}).fail(function(b){a.reject(b)});return a.promise()},projectDataRequest:function(a){var b=jQuery.Deferred();ImageControler.currentPhotogrammetry.imajnetProjectionsDataObject&&(a?a.projectionData=ImageControler.currentPhotogrammetry.imajnetProjectionsDataObject.projectionData.concat(a.projectionData):
a=ImageControler.currentPhotogrammetry.imajnetProjectionsDataObject);Nigsys.waitForAllDeferred([this.projectImajnetDataRequest(a),this.projectUserDataRequest()],function(){var a=ImajnetProjection.imajnetProjections,d=ImajnetProjection.userProjections;if(!a)a=ImajnetProjection.userProjections;else if(d&&(d.projection.pointProjections||d.projection.shapeProjections)){var e=a.projection,d=d.projection;a.projection.pointProjections=e.pointProjections?e.pointProjections.concat(d.pointProjections):d.pointProjections;
a.projection.shapeProjections=e.shapeProjections?e.shapeProjections.concat(d.shapeProjections):d.shapeProjections}ImajnetProjection.projectionReceived(a);b.resolve()});return b.promise()},getProjectedLayers:function(){return this.projectedLayers},getProjectedLayerById:function(a){for(var b=0;b<ImajnetProjection.projectedLayers.length;b++)if(ImajnetProjection.projectedLayers[b].id==a)return ImajnetProjection.projectedLayers[b];return null},addProjectedLayer:function(a){for(var b in a)"object"==typeof a[b]&&
delete a[b];ImajnetProjection.projectedLayers.push(a);Nigsys.setCookie("IMAJNET","PROJECTED_LAYERS",ImajnetProjection.projectedLayers)},updateProjectedLayer:function(a){for(var b in a)"object"==typeof a[b]&&delete a[b];for(b=0;b<ImajnetProjection.projectedLayers.length;b++)ImajnetProjection.projectedLayers[b].id==a.id&&(ImajnetProjection.projectedLayers[b].groundProjection=a.groundProjection,ImajnetProjection.projectedLayers[b].heightOffset=a.heightOffset);Nigsys.setCookie("IMAJNET","PROJECTED_LAYERS",
ImajnetProjection.projectedLayers)},removeProjectedLayerById:function(a){for(var b=0;b<ImajnetProjection.projectedLayers.length;b++)ImajnetProjection.projectedLayers[b].id==a&&ImajnetProjection.projectedLayers.splice(b,1);Nigsys.setCookie("IMAJNET","PROJECTED_LAYERS",ImajnetProjection.projectedLayers)},clearProjectedLayers:function(){ImajnetProjection.projectedLayers=[];Nigsys.setCookie("IMAJNET","PROJECTED_LAYERS",ImajnetProjection.projectedLayers)}};
var OpenLayersForProjection={String:{startsWith:function(a,b){return 0==a.indexOf(b)},trim:function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}},Util:{dotless:/\./g,lastSeqID:0,createUniqueID:function(a){a=null==a?"id_":a.replace(OpenLayersForProjection.Util.dotless,"_");OpenLayersForProjection.Util.lastSeqID+=1;return a+OpenLayersForProjection.Util.lastSeqID},toFloat:function(a,b){null==b&&(b=OpenLayersForProjection.Util.DEFAULT_PRECISION);"number"!==typeof a&&(a=parseFloat(a));return 0===
b?a:parseFloat(a.toPrecision(b))},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},getElement:function(){for(var a=[],b=0,c=arguments.length;b<c;b++){var d=arguments[b];"string"==typeof d&&(d=document.getElementById(d));if(1==arguments.length)return d;a.push(d)}return a}},Class:function(){var a=arguments.length,b=arguments[0],c=arguments[a-1],d="function"==typeof c.initialize?c.initialize:function(){b.prototype.initialize.apply(this,arguments)};1<a?(a=[d,b].concat(Array.prototype.slice.call(arguments).slice(1,
a-1),c),OpenLayersForProjection.inherit.apply(null,a)):d.prototype=c;return d},inherit:function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c;var d,e,c=2;for(d=arguments.length;c<d;c++)e=arguments[c],"function"===typeof e&&(e=e.prototype),OpenLayersForProjection.Util.extend(a.prototype,e)},Number:{decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(a,b){var c=0;0<b&&(c=parseFloat(a.toPrecision(b)));return c},format:function(a,b,c,d){b="undefined"!=typeof b?b:0;c=
"undefined"!=typeof c?c:OpenLayersForProjection.Number.thousandsSeparator;d="undefined"!=typeof d?d:OpenLayersForProjection.Number.decimalSeparator;null!=b&&(a=parseFloat(a.toFixed(b)));var e=a.toString().split(".");1==e.length&&null==b&&(b=0);a=e[0];if(c)for(var f=/(-?[0-9]+)([0-9]{3})/;f.test(a);)a=a.replace(f,"$1"+c+"$2");0==b?b=a:(c=1<e.length?e[1]:"0",null!=b&&(c+=Array(b-c.length+1).join("0")),b=a+d+c);return b},zeroPad:function(a,b,c){for(a=a.toString(c||10);a.length<b;)a="0"+a;return a}}};
OpenLayersForProjection.Date={dateRegEx:/^(?:(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:(?:T(\d{1,2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(?:[+-]\d{1,2}(?::(\d{2}))?)))|Z)?$/,toISOString:function(){return"toISOString"in Date.prototype?function(a){return a.toISOString()}:function(a){return isNaN(a.getTime())?"Invalid Date":a.getUTCFullYear()+"-"+OpenLayersForProjection.Number.zeroPad(a.getUTCMonth()+1,2)+"-"+OpenLayersForProjection.Number.zeroPad(a.getUTCDate(),2)+"T"+OpenLayersForProjection.Number.zeroPad(a.getUTCHours(),
2)+":"+OpenLayersForProjection.Number.zeroPad(a.getUTCMinutes(),2)+":"+OpenLayersForProjection.Number.zeroPad(a.getUTCSeconds(),2)+"."+OpenLayersForProjection.Number.zeroPad(a.getUTCMilliseconds(),3)+"Z"}}(),parse:function(a){var b;if((a=a.match(this.dateRegEx))&&(a[1]||a[7])){b=parseInt(a[1],10)||0;var c=parseInt(a[2],10)-1||0,d=parseInt(a[3],10)||1;b=new Date(Date.UTC(b,c,d));if(c=a[7]){var d=parseInt(a[4],10),e=parseInt(a[5],10),f=parseFloat(a[6]),g=f|0;b.setUTCHours(d,e,g,Math.round(1E3*(f-g)));
"Z"!==c&&(c=parseInt(c,10),a=parseInt(a[8],10)||0,a=-1E3*(3600*c+60*a),b=new Date(b.getTime()+a))}}else b=new Date("invalid");return b}};OpenLayersForProjection.Util=OpenLayersForProjection.Util||{};OpenLayersForProjection.Util.extend=function(a,b){a=a||{};if(b){for(var c in b){var d=b[c];void 0!==d&&(a[c]=d)}"function"==typeof window.Event&&b instanceof window.Event||!b.hasOwnProperty||!b.hasOwnProperty("toString")||(a.toString=b.toString)}return a};
OpenLayersForProjection.Util.Try=function(){for(var a=null,b=0,c=arguments.length;b<c;b++){var d=arguments[b];try{a=d();break}catch(e){}}return a};OpenLayersForProjection.Util.getXmlNodeValue=function(a){var b=null;OpenLayersForProjection.Util.Try(function(){b=a.text;b||(b=a.textContent);b||(b=a.firstChild.nodeValue)},function(){b=a.textContent});return b};
OpenLayersForProjection.Geometry=OpenLayersForProjection.Class({bounds:null,initialize:function(){this.id=OpenLayersForProjection.Util.createUniqueID(this.CLASS_NAME+"_")},getBounds:function(){null==this.bounds&&this.calculateBounds();return this.bounds}});
OpenLayersForProjection.Geometry.Point=OpenLayersForProjection.Class(OpenLayersForProjection.Geometry,{x:null,y:null,initialize:function(a,b){OpenLayersForProjection.Geometry.prototype.initialize.apply(this,arguments);this.x=parseFloat(a);this.y=parseFloat(b)},calculateBounds:function(){this.bounds=new OpenLayersForProjection.Bounds(this.x,this.y,this.x,this.y)},getCentroid:function(){return new OpenLayersForProjection.Geometry.Point(this.x,this.y)},CLASS_NAME:"OpenLayers.Geometry.Point"});
OpenLayersForProjection.Bounds=OpenLayersForProjection.Class({left:null,bottom:null,right:null,top:null,centerLonLat:null,initialize:function(a,b,c,d){OpenLayersForProjection.Util.isArray(a)&&(d=a[3],c=a[2],b=a[1],a=a[0]);null!=a&&(this.left=OpenLayersForProjection.Util.toFloat(a));null!=b&&(this.bottom=OpenLayersForProjection.Util.toFloat(b));null!=c&&(this.right=OpenLayersForProjection.Util.toFloat(c));null!=d&&(this.top=OpenLayersForProjection.Util.toFloat(d))},extend:function(a){if(a)switch(a.CLASS_NAME){case "OpenLayers.LonLat":this.extendXY(a.lon,
a.lat);break;case "OpenLayers.Geometry.Point":this.extendXY(a.x,a.y);break;case "OpenLayers.Bounds":this.centerLonLat=null;if(null==this.left||a.left<this.left)this.left=a.left;if(null==this.bottom||a.bottom<this.bottom)this.bottom=a.bottom;if(null==this.right||a.right>this.right)this.right=a.right;if(null==this.top||a.top>this.top)this.top=a.top}},clone:function(){return new OpenLayersForProjection.Bounds(this.left,this.bottom,this.right,this.top)},intersectsBounds:function(a,b){"boolean"===typeof b&&
(b={inclusive:b});b=b||{};if(b.worldBounds){var c=this.wrapDateLine(b.worldBounds);a=a.wrapDateLine(b.worldBounds)}else c=this;null==b.inclusive&&(b.inclusive=!0);var d=!1,e=c.left==a.right||c.right==a.left||c.top==a.bottom||c.bottom==a.top;if(b.inclusive||!e)var d=a.top>=c.bottom&&a.top<=c.top||c.top>a.bottom&&c.top<a.top,e=a.left>=c.left&&a.left<=c.right||c.left>=a.left&&c.left<=a.right,f=a.right>=c.left&&a.right<=c.right||c.right>=a.left&&c.right<=a.right,d=(a.bottom>=c.bottom&&a.bottom<=c.top||
c.bottom>=a.bottom&&c.bottom<=a.top||d)&&(e||f);if(b.worldBounds&&!d){var g=b.worldBounds,e=g.getWidth(),f=!g.containsBounds(c),g=!g.containsBounds(a);f&&!g?(a=a.add(-e,0),d=c.intersectsBounds(a,{inclusive:b.inclusive})):g&&!f&&(c=c.add(-e,0),d=a.intersectsBounds(c,{inclusive:b.inclusive}))}return d},wrapDateLine:function(a,b){b=b||{};var c=b.leftTolerance||0,d=b.rightTolerance||0,e=this.clone();if(a){for(var f=a.getWidth();e.left<a.left&&e.right-d<=a.left;)e=e.add(f,0);for(;e.left+c>=a.right&&e.right>
a.right;)e=e.add(-f,0);c=e.left+c;c<a.right&&c>a.left&&e.right-d>a.right&&(e=e.add(-f,0))}return e},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},getCenterLonLat:function(){this.centerLonLat||(this.centerLonLat=new OpenLayersForProjection.LonLat((this.left+this.right)/2,(this.bottom+this.top)/2));return this.centerLonLat},CLASS_NAME:"OpenLayersForProjection.Bounds"});
OpenLayersForProjection.LonLat=OpenLayersForProjection.Class({lon:0,lat:0,initialize:function(a,b){OpenLayersForProjection.Util.isArray(a)&&(b=a[1],a=a[0]);this.lon=OpenLayersForProjection.Util.toFloat(a);this.lat=OpenLayersForProjection.Util.toFloat(b)}});
OpenLayersForProjection.Projection=OpenLayersForProjection.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(a,b){OpenLayersForProjection.Util.extend(this,b);this.projCode=a;"object"==typeof Proj4js&&(this.proj=new Proj4js.Proj(a))},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(a){var b=!1;a&&(a instanceof OpenLayersForProjection.Projection||
(a=new OpenLayersForProjection.Projection(a)),"object"==typeof Proj4js&&this.proj.defData&&a.proj.defData?b=this.proj.defData.replace(this.titleRegEx,"")==a.proj.defData.replace(this.titleRegEx,""):a.getCode&&(b=this.getCode(),a=a.getCode(),b=b==a||!!OpenLayersForProjection.Projection.transforms[b]&&OpenLayersForProjection.Projection.transforms[b][a]===OpenLayersForProjection.Projection.nullTransform));return b},transform:function(a,b,c){if(b&&c)if(b instanceof OpenLayers.Projection||(b=new OpenLayers.Projection(b)),
c instanceof OpenLayers.Projection||(c=new OpenLayers.Projection(c)),b.proj&&c.proj)a=Proj4js.transform(b.proj,c.proj,a);else{b=b.getCode();c=c.getCode();var d=OpenLayers.Projection.transforms;if(d[b]&&d[b][c])d[b][c](a)}return a},destroy:function(){delete this.proj;delete this.projCode},CLASS_NAME:"OpenLayers.Projection"});
OpenLayersForProjection.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(a){alert(a)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"OpenLayers.Console"};
OpenLayersForProjection.Feature=OpenLayersForProjection.Class({layer:null,id:null,lonlat:null,data:null,marker:null,popupClass:null,popup:null,initialize:function(a,b,c){this.layer=a;this.lonlat=b;this.data=null!=c?c:{};this.id=OpenLayersForProjection.Util.createUniqueID(this.CLASS_NAME+"_")}});
OpenLayersForProjection.Feature.Vector=OpenLayersForProjection.Class(OpenLayersForProjection.Feature,{fid:null,geometry:null,attributes:null,bounds:null,state:null,style:null,url:null,renderIntent:"default",modified:null,initialize:function(a,b,c){OpenLayersForProjection.Feature.prototype.initialize.apply(this,[null,null,b]);this.lonlat=null;this.geometry=a?a:null;this.state=null;this.attributes={};b&&(this.attributes=OpenLayersForProjection.Util.extend(this.attributes,b));this.style=c?c:null},CLASS_NAME:"OpenLayersForProjection.Feature.Vector"});
OpenLayersForProjection.Size=OpenLayersForProjection.Class({w:0,h:0,initialize:function(a,b){this.w=parseFloat(a);this.h=parseFloat(b)},clone:function(){return new OpenLayersForProjection.Size(this.w,this.h)}});
OpenLayersForProjection.Renderer=OpenLayersForProjection.Class({container:null,root:null,extent:null,locked:!1,size:null,resolution:null,map:null,featureDx:0,initialize:function(a,b){this.container=OpenLayersForProjection.Util.getElement(a);OpenLayersForProjection.Util.extend(this,b)},setExtent:function(a,b){this.extent=a.clone();if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var c=a.getWidth()/this.map.getExtent().getWidth();a=a.scale(1/c);this.extent=a.wrapDateLine(this.map.getMaxExtent()).scale(c)}b&&
(this.resolution=null);return!0},setSize:function(a){this.size=a.clone();this.resolution=null},getResolution:function(){return this.resolution=this.resolution||this.map.getResolution()},drawFeature:function(a,b){null==b&&(b=a.style);if(a.geometry){var c=a.geometry.getBounds();if(c){var d;this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(d=this.map.getMaxExtent());c.intersectsBounds(this.extent,{worldBounds:d})?this.calculateFeatureDx(c,d):b={display:"none"};c=this.drawGeometry(a.geometry,b,a.id);
if("none"!=b.display&&b.label&&!1!==c){d=a.geometry.getCentroid();if(b.labelXOffset||b.labelYOffset){var e=isNaN(b.labelXOffset)?0:b.labelXOffset,f=isNaN(b.labelYOffset)?0:b.labelYOffset,g=this.getResolution();d.move(e*g,f*g)}this.drawText(a.id,b,d)}else this.removeText(a.id);return c}}},calculateFeatureDx:function(a,b){this.featureDx=0;if(b){var c=b.getWidth();this.featureDx=Math.round(((a.left+a.right)/2-(this.extent.left+this.extent.right)/2)/c)*c}},applyDefaultSymbolizer:function(a){var b=OpenLayersForProjection.Util.extend({},
OpenLayersForProjection.Renderer.defaultSymbolizer);!1===a.stroke&&(delete b.strokeWidth,delete b.strokeColor);!1===a.fill&&delete b.fillColor;OpenLayersForProjection.Util.extend(b,a);return b},removeText:function(a){}});OpenLayersForProjection.Renderer.defaultSymbolizer={fillColor:"#000000",strokeColor:"#000000",strokeWidth:2,fillOpacity:1,strokeOpacity:1,pointRadius:0,labelAlign:"cm"};
OpenLayersForProjection.Renderer.symbol={star:[350,75,379,161,469,161,397,215,423,301,350,250,277,301,303,215,231,161,321,161,350,75],cross:[4,0,6,0,6,4,10,4,10,6,6,6,6,10,4,10,4,6,0,6,0,4,4,4,4,0],x:[0,0,25,0,50,35,75,0,100,0,65,50,100,100,75,100,50,65,25,100,0,100,35,50,0,0],square:[0,0,0,1,1,1,1,0,0,0],triangle:[0,10,10,10,5,0,0,10]};
OpenLayersForProjection.Renderer.Elements=OpenLayersForProjection.Class(OpenLayersForProjection.Renderer,{rendererRoot:null,root:null,vectorRoot:null,textRoot:null,xmlns:null,xOffset:0,indexer:null,BACKGROUND_ID_SUFFIX:"_background",LABEL_ID_SUFFIX:"_label",LABEL_OUTLINE_SUFFIX:"_outline",initialize:function(a,b){OpenLayersForProjection.Renderer.prototype.initialize.apply(this,arguments);this.rendererRoot=this.createRenderRoot();this.root=this.createRoot("_root");this.vectorRoot=this.createRoot("_vroot");
this.textRoot=this.createRoot("_troot");this.root.appendChild(this.vectorRoot);this.root.appendChild(this.textRoot);this.rendererRoot.appendChild(this.root);this.container.appendChild(this.rendererRoot);b&&(b.zIndexing||b.yOrdering)&&(this.indexer=new OpenLayersForProjection.ElementsIndexer(b.yOrdering))},destroy:function(){this.clear();this.xmlns=this.root=this.rendererRoot=null;OpenLayersForProjection.Renderer.prototype.destroy.apply(this,arguments)},clear:function(){var a,b=this.vectorRoot;if(b)for(;a=
b.firstChild;)b.removeChild(a);if(b=this.textRoot)for(;a=b.firstChild;)b.removeChild(a);this.indexer&&this.indexer.clear()},setExtent:function(a,b){var c=OpenLayersForProjection.Renderer.prototype.setExtent.apply(this,arguments),d=this.getResolution();if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var e,f=a.getWidth()/this.map.getExtent().getWidth();a=a.scale(1/f);f=this.map.getMaxExtent();f.right>a.left&&f.right<a.right?e=!0:f.left>a.left&&f.left<a.right&&(e=!1);if(e!==this.rightOfDateLine||
b)c=!1,this.xOffset=!0===e?f.getWidth()/d:0;this.rightOfDateLine=e}return c},getNodeType:function(a,b){},drawGeometry:function(a,b,c){var d=a.CLASS_NAME,e=!0;if("OpenLayers.Geometry.Collection"==d||"OpenLayers.Geometry.MultiPoint"==d||"OpenLayers.Geometry.MultiLineString"==d||"OpenLayers.Geometry.MultiPolygon"==d){for(var d=0,f=a.components.length;d<f;d++)e=this.drawGeometry(a.components[d],b,c)&&e;return e}d=e=!1;"none"!=b.display&&(b.backgroundGraphic?this.redrawBackgroundNode(a.id,a,b,c):d=!0,
e=this.redrawNode(a.id,a,b,c));0==e&&(b=document.getElementById(a.id))&&(b._style.backgroundGraphic&&(d=!0),b.parentNode.removeChild(b));d&&(b=document.getElementById(a.id+this.BACKGROUND_ID_SUFFIX))&&b.parentNode.removeChild(b);return e},redrawNode:function(a,b,c,d){c=this.applyDefaultSymbolizer(c);a=this.nodeFactory(a,this.getNodeType(b,c));a._featureId=d;a._boundsBottom=b.getBounds().bottom;a._geometryClass=b.CLASS_NAME;a._style=c;b=this.drawGeometryNode(a,b,c);if(!1===b)return!1;a=b.node;this.indexer?
(c=this.indexer.insert(a))?this.vectorRoot.insertBefore(a,c):this.vectorRoot.appendChild(a):a.parentNode!==this.vectorRoot&&this.vectorRoot.appendChild(a);this.postDraw(a);return b.complete},createNode:function(a,b){},nodeFactory:function(a,b){var c=OpenLayersForProjection.Util.getElement(a);c?this.nodeTypeCompare(c,b)||(c.parentNode.removeChild(c),c=this.nodeFactory(a,b)):c=this.createNode(b,a);return c},drawGeometryNode:function(a,b,c){c=c||a._style;var d={isFilled:void 0===c.fill?!0:c.fill,isStroked:void 0===
c.stroke?!!c.strokeWidth:c.stroke},e;switch(b.CLASS_NAME){case "OpenLayers.Geometry.Point":!1===c.graphic&&(d.isFilled=!1,d.isStroked=!1);e=this.drawPoint(a,b);break;case "OpenLayers.Geometry.LineString":d.isFilled=!1;e=this.drawLineString(a,b);break;case "OpenLayers.Geometry.LinearRing":e=this.drawLinearRing(a,b);break;case "OpenLayers.Geometry.Polygon":e=this.drawPolygon(a,b);break;case "OpenLayers.Geometry.Rectangle":e=this.drawRectangle(a,b)}a._options=d;return 0!=e?{node:this.setStyle(a,c,d,
b),complete:e}:!1},removeText:function(a){var b=document.getElementById(a+this.LABEL_ID_SUFFIX);b&&this.textRoot.removeChild(b);(a=document.getElementById(a+this.LABEL_OUTLINE_SUFFIX))&&this.textRoot.removeChild(a)},drawPoint:function(a,b){},postDraw:function(a){},isComplexSymbol:function(a){return"circle"!=a&&!!a},CLASS_NAME:"OpenLayersForProjection.Renderer.Elements"});
OpenLayersForProjection.Renderer.Canvas=OpenLayersForProjection.Class(OpenLayersForProjection.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(a,b){OpenLayersForProjection.Renderer.prototype.initialize.apply(this,arguments);this.root=document.createElement("canvas");this.container.appendChild(this.root);this.canvas=this.root.getContext("2d");this.features={};this.hitDetection&&(this.hitCanvas=document.createElement("canvas"),
this.hitContext=this.hitCanvas.getContext("2d"))},setExtent:function(){OpenLayersForProjection.Renderer.prototype.setExtent.apply(this,arguments);return!1},eraseGeometry:function(a,b){this.eraseFeatures(this.features[b][0])},supported:function(){return OpenLayersForProjection.CANVAS_SUPPORTED},setSize:function(a){this.size=a.clone();var b=this.root;b.style.width=a.w+"px";b.style.height=a.h+"px";b.width=a.w;b.height=a.h;this.resolution=null;this.hitDetection&&(b=this.hitCanvas,b.style.width=a.w+"px",
b.style.height=a.h+"px",b.width=a.w,b.height=a.h)},drawFeature:function(a,b){var c;if(a.geometry){b=this.applyDefaultSymbolizer(b||a.style);c=a.geometry.getBounds();var d;this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(d=this.map.getMaxExtent());d=c&&c.intersectsBounds(this.extent,{worldBounds:d});(c="none"!==b.display&&!!c&&d)?this.features[a.id]=[a,b]:delete this.features[a.id];this.pendingRedraw=!0}this.pendingRedraw&&!this.locked&&(this.redraw(),this.pendingRedraw=!1);return c},drawGeometry:function(a,
b,c){var d=a.CLASS_NAME;if("OpenLayers.Geometry.Collection"==d||"OpenLayers.Geometry.MultiPoint"==d||"OpenLayers.Geometry.MultiLineString"==d||"OpenLayers.Geometry.MultiPolygon"==d)for(d=0;d<a.components.length;d++)this.drawGeometry(a.components[d],b,c);else switch(a.CLASS_NAME){case "OpenLayers.Geometry.Point":this.drawPoint(a,b,c);break;case "OpenLayers.Geometry.LineString":this.drawLineString(a,b,c);break;case "OpenLayers.Geometry.LinearRing":this.drawLinearRing(a,b,c);break;case "OpenLayers.Geometry.Polygon":this.drawPolygon(a,
b,c)}},drawExternalGraphic:function(a,b,c){var d=new Image,e=b.title||b.graphicTitle;e&&(d.title=e);var f=b.graphicWidth||b.graphicHeight,g=b.graphicHeight||b.graphicWidth,f=f?f:2*b.pointRadius,g=g?g:2*b.pointRadius,h=void 0!=b.graphicXOffset?b.graphicXOffset:-(.5*f),k=void 0!=b.graphicYOffset?b.graphicYOffset:-(.5*g),l=b.graphicOpacity||b.fillOpacity;d.onload=OpenLayersForProjection.Function.bind(function(){if(this.features[c]){var b=this.getLocalXY(a),e=b[0],b=b[1];if(!isNaN(e)&&!isNaN(b)){var e=
e+h|0,b=b+k|0,p=this.canvas;p.globalAlpha=l;var q=OpenLayersForProjection.Renderer.Canvas.drawImageScaleFactor||(OpenLayersForProjection.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);p.drawImage(d,e*q,b*q,f*q,g*q);this.hitDetection&&(this.setHitContextStyle("fill",c),this.hitContext.fillRect(e,b,f,g))}}},this);d.src=b.externalGraphic},drawNamedSymbol:function(a,b,c){var d,e,f,g;f=Math.PI/180;var h=OpenLayersForProjection.Renderer.symbol[b.graphicName];
if(!h)throw Error(b.graphicName+" is not a valid symbol name");if(!(!h.length||2>h.length||(a=this.getLocalXY(a),e=a[0],g=a[1],isNaN(e)||isNaN(g)))){this.canvas.lineCap="round";this.canvas.lineJoin="round";this.hitDetection&&(this.hitContext.lineCap="round",this.hitContext.lineJoin="round");if(b.graphicName in this.cachedSymbolBounds)d=this.cachedSymbolBounds[b.graphicName];else{d=new OpenLayersForProjection.Bounds;for(a=0;a<h.length;a+=2)d.extend(new OpenLayersForProjection.LonLat(h[a],h[a+1]));
this.cachedSymbolBounds[b.graphicName]=d}this.canvas.save();this.hitDetection&&this.hitContext.save();this.canvas.translate(e,g);this.hitDetection&&this.hitContext.translate(e,g);a=f*b.rotation;isNaN(a)||(this.canvas.rotate(a),this.hitDetection&&this.hitContext.rotate(a));f=2*b.pointRadius/Math.max(d.getWidth(),d.getHeight());this.canvas.scale(f,f);this.hitDetection&&this.hitContext.scale(f,f);a=d.getCenterLonLat().lon;d=d.getCenterLonLat().lat;this.canvas.translate(-a,-d);this.hitDetection&&this.hitContext.translate(-a,
-d);g=b.strokeWidth;b.strokeWidth=g/f;if(!1!==b.fill){this.setCanvasStyle("fill",b);this.canvas.beginPath();for(a=0;a<h.length;a+=2)d=h[a],e=h[a+1],0==a&&this.canvas.moveTo(d,e),this.canvas.lineTo(d,e);this.canvas.closePath();this.canvas.fill();if(this.hitDetection){this.setHitContextStyle("fill",c,b);this.hitContext.beginPath();for(a=0;a<h.length;a+=2)d=h[a],e=h[a+1],0==a&&this.canvas.moveTo(d,e),this.hitContext.lineTo(d,e);this.hitContext.closePath();this.hitContext.fill()}}if(!1!==b.stroke){this.setCanvasStyle("stroke",
b);this.canvas.beginPath();for(a=0;a<h.length;a+=2)d=h[a],e=h[a+1],0==a&&this.canvas.moveTo(d,e),this.canvas.lineTo(d,e);this.canvas.closePath();this.canvas.stroke();if(this.hitDetection){this.setHitContextStyle("stroke",c,b,f);this.hitContext.beginPath();for(a=0;a<h.length;a+=2)d=h[a],e=h[a+1],0==a&&this.hitContext.moveTo(d,e),this.hitContext.lineTo(d,e);this.hitContext.closePath();this.hitContext.stroke()}}b.strokeWidth=g;this.canvas.restore();this.hitDetection&&this.hitContext.restore();this.setCanvasStyle("reset")}},
setCanvasStyle:function(a,b){"fill"===a?(this.canvas.globalAlpha=b.fillOpacity,this.canvas.fillStyle=b.fillColor):"stroke"===a?(this.canvas.globalAlpha=b.strokeOpacity,this.canvas.strokeStyle=b.strokeColor,this.canvas.lineWidth=b.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(a){a=Number(a.split("_").pop())+1;16777216<=a&&(this.hitOverflow=a-16777215,a=a%16777216+1);a="000000"+a.toString(16);var b=a.length;return a="#"+a.substring(b-6,b)},setHitContextStyle:function(a,
b,c,d){b=this.featureIdToHex(b);"fill"==a?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=b):"stroke"==a?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=b,"undefined"===typeof d?this.hitContext.lineWidth=c.strokeWidth+2:isNaN(d)||(this.hitContext.lineWidth=c.strokeWidth+2/d)):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(a,b,c){if(!1!==b.graphic)if(b.externalGraphic)this.drawExternalGraphic(a,b,c);else if(b.graphicName&&"circle"!=b.graphicName)this.drawNamedSymbol(a,
b,c);else{var d=this.getLocalXY(a);a=d[0];d=d[1];if(!isNaN(a)&&!isNaN(d)){var e=2*Math.PI,f=b.pointRadius;!1!==b.fill&&(this.setCanvasStyle("fill",b),this.canvas.beginPath(),this.canvas.arc(a,d,f,0,e,!0),this.canvas.fill(),this.hitDetection&&(this.setHitContextStyle("fill",c,b),this.hitContext.beginPath(),this.hitContext.arc(a,d,f,0,e,!0),this.hitContext.fill()));!1!==b.stroke&&(this.setCanvasStyle("stroke",b),this.canvas.beginPath(),this.canvas.arc(a,d,f,0,e,!0),this.canvas.stroke(),this.hitDetection&&
(this.setHitContextStyle("stroke",c,b),this.hitContext.beginPath(),this.hitContext.arc(a,d,f,0,e,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(a,b,c){b=OpenLayersForProjection.Util.applyDefaults({fill:!1},b);this.drawLinearRing(a,b,c)},drawLinearRing:function(a,b,c){!1!==b.fill&&(this.setCanvasStyle("fill",b),this.renderPath(this.canvas,a,b,c,"fill"),this.hitDetection&&(this.setHitContextStyle("fill",c,b),this.renderPath(this.hitContext,a,b,c,"fill")));!1!==
b.stroke&&(this.setCanvasStyle("stroke",b),this.renderPath(this.canvas,a,b,c,"stroke"),this.hitDetection&&(this.setHitContextStyle("stroke",c,b),this.renderPath(this.hitContext,a,b,c,"stroke")));this.setCanvasStyle("reset")},renderPath:function(a,b,c,d,e){b=b.components;c=b.length;a.beginPath();d=this.getLocalXY(b[0]);var f=d[1];if(!isNaN(d[0])&&!isNaN(f)){a.moveTo(d[0],d[1]);for(d=1;d<c;++d)f=this.getLocalXY(b[d]),a.lineTo(f[0],f[1]);"fill"===e?a.fill():a.stroke()}},drawPolygon:function(a,b,c){a=
a.components;var d=a.length;this.drawLinearRing(a[0],b,c);for(var e=1;e<d;++e)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(a[e],OpenLayersForProjection.Util.applyDefaults({stroke:!1,fillOpacity:1},b),c),this.canvas.globalCompositeOperation="source-over",this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(a[e],OpenLayersForProjection.Util.applyDefaults({fill:!1},
b),c)},drawText:function(a,b){var c=this.getLocalXY(a);this.setCanvasStyle("reset");this.canvas.fillStyle=b.fontColor;this.canvas.globalAlpha=b.fontOpacity||1;var d=[b.fontStyle?b.fontStyle:"normal","normal",b.fontWeight?b.fontWeight:"normal",b.fontSize?b.fontSize:"1em",b.fontFamily?b.fontFamily:"sans-serif"].join(" "),e=b.label.split("\n"),f=e.length;if(this.canvas.fillText){this.canvas.font=d;this.canvas.textAlign=OpenLayersForProjection.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[0]]||"center";this.canvas.textBaseline=
OpenLayersForProjection.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[1]]||"middle";var g=OpenLayersForProjection.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]];null==g&&(g=-.5);d=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;c[1]+=d*g*(f-1);for(g=0;g<f;g++)b.labelOutlineWidth&&(this.canvas.save(),this.canvas.globalAlpha=b.labelOutlineOpacity||b.fontOpacity||1,this.canvas.strokeStyle=b.labelOutlineColor,this.canvas.lineWidth=b.labelOutlineWidth,this.canvas.strokeText(e[g],c[0],
c[1]+d*g+1),this.canvas.restore()),this.canvas.fillText(e[g],c[0],c[1]+d*g)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=d;var h=OpenLayersForProjection.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[0]];null==h&&(h=-.5);g=OpenLayersForProjection.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]];null==g&&(g=-.5);d=this.canvas.mozMeasureText("xx");c[1]+=d*(1+g*f);for(g=0;g<f;g++){var k=c[0]+h*this.canvas.mozMeasureText(e[g]),l=c[1]+g*d;this.canvas.translate(k,l);this.canvas.mozDrawText(e[g]);this.canvas.translate(-k,
-l)}}this.setCanvasStyle("reset")},getLocalXY:function(a){var b=this.getResolution(),c=this.extent;return[(a.x-this.featureDx)/b+-c.left/b,c.top/b-a.y/b]},clear:function(){var a=this.root.height,b=this.root.width;this.canvas.clearRect(0,0,b,a);this.features={};this.hitDetection&&this.hitContext.clearRect(0,0,b,a)},getFeatureIdFromEvent:function(a){var b;if(this.hitDetection&&"none"!==this.root.style.display&&!this.map.dragging&&(a=a.xy,a=this.hitContext.getImageData(a.x|0,a.y|0,1,1).data,255===a[3]&&
(a=a[2]+256*(a[1]+256*a[0])))){a="OpenLayers_Feature_Vector_"+(a-1+this.hitOverflow);try{b=this.features[a][0]}catch(c){}}return b},eraseFeatures:function(a){OpenLayersForProjection.Util.isArray(a)||(a=[a]);for(var b=0;b<a.length;++b)delete this.features[a[b].id];this.redraw()},redraw:function(){if(!this.locked){var a=this.root.height,b=this.root.width;this.canvas.clearRect(0,0,b,a);this.hitDetection&&this.hitContext.clearRect(0,0,b,a);var a=[],c,d,e=this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&
this.map.getMaxExtent(),f;for(f in this.features)this.features.hasOwnProperty(f)&&(b=this.features[f][0],c=b.geometry,this.calculateFeatureDx(c.getBounds(),e),d=this.features[f][1],this.drawGeometry(c,d,b.id),d.label&&a.push([b,d]));b=0;for(c=a.length;b<c;++b)f=a[b],this.drawText(f[0].geometry.getCentroid(),f[1])}},CLASS_NAME:"OpenLayersForProjection.Renderer.Canvas"});OpenLayersForProjection.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"};
OpenLayersForProjection.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1};OpenLayersForProjection.Renderer.Canvas.drawImageScaleFactor=null;
OpenLayersForProjection.Renderer.SVG=OpenLayersForProjection.Class(OpenLayersForProjection.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15E3,translationParameters:null,symbolMetrics:null,initialize:function(a){this.supported()&&(OpenLayersForProjection.Renderer.Elements.prototype.initialize.apply(this,arguments),this.translationParameters={x:0,y:0},this.symbolMetrics={})},supported:function(){return document.implementation&&(document.implementation.hasFeature("org.w3c.svg",
"1.0")||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#SVG","1.1")||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1"))},setSize:function(a){OpenLayersForProjection.Renderer.prototype.setSize.apply(this,arguments);this.rendererRoot.setAttributeNS(null,"width",this.size.w);this.rendererRoot.setAttributeNS(null,"height",this.size.h)},setExtent:function(a,b){var c=OpenLayersForProjection.Renderer.Elements.prototype.setExtent.apply(this,
arguments),d=this.getResolution(),e=-a.left/d,d=a.top/d;if(b)return this.left=e,this.top=d,this.rendererRoot.setAttributeNS(null,"viewBox","0 0 "+this.size.w+" "+this.size.h),this.translate(this.xOffset,0),!0;(e=this.translate(e-this.left+this.xOffset,d-this.top))||this.setExtent(a,!0);return c&&e},createRenderRoot:function(){var a=this.nodeFactory(this.container.id+"_svgRoot","svg");a.style.display="block";return a},createNode:function(a,b){var c=document.createElementNS(this.xmlns,a);b&&c.setAttributeNS(null,
"id",b);return c},createRoot:function(a){return this.nodeFactory(this.container.id+a,"g")},translate:function(a,b){if(this.inValidRange(a,b,!0)){var c="";if(a||b)c="translate("+a+","+b+")";this.root.setAttributeNS(null,"transform",c);this.translationParameters={x:a,y:b};return!0}return!1},inValidRange:function(a,b,c){a+=c?0:this.translationParameters.x;b+=c?0:this.translationParameters.y;return a>=-this.MAX_PIXEL&&a<=this.MAX_PIXEL&&b>=-this.MAX_PIXEL&&b<=this.MAX_PIXEL},createImagePattern:function(a,
b,c){if(this.container&&this.container.id){var d=this.container.id+"-"+a.externalGraphic+(a.pointRadius?"-"+a.pointRadius:""),e=OpenLayers.Util.getElement(d);if(!e){var f=new Image;f.onload=OpenLayers.Function.bind(function(){this.defs||(this.defs=this.createDefs());e=this.nodeFactory(d,"pattern");e.setAttributeNS(null,"x","0");e.setAttributeNS(null,"y","0");e.setAttributeNS(null,"height",c);e.setAttributeNS(null,"width",b);e.setAttributeNS(null,"patternUnits","userSpaceOnUse");var f=this.nodeFactory(null,
"image");e.appendChild(f);f.setAttributeNS(this.xlinkns,"href",a.externalGraphic);f.setAttributeNS(null,"height",c);f.setAttributeNS(null,"width",b);f.setAttributeNS(null,"style","opacity: "+(a.graphicOpacity||a.fillOpacity||1));if("undefined"!=typeof a.rotation){var h=OpenLayers.String.format("rotate(${0})",[a.rotation]);f.setAttributeNS(null,"transform",h)}this.defs.appendChild(e)},this);f.src=a.externalGraphic}return d}},setStyle:function(a,b,c){"circle"==a.nodeName&&(b.pointRadius||(b.pointRadius=
6),b.pointerEvents||(b.pointerEvents="visiblePainted"));b=b||a._style;c=c||a._options;var d=b.title||b.graphicTitle;if(d){a.setAttributeNS(null,"title",d);var e=a.getElementsByTagName("title");0<e.length?e[0].firstChild.textContent=d:(e=this.nodeFactory(null,"title"),e.textContent=d,a.appendChild(e))}var e=parseFloat(a.getAttributeNS(null,"r")),d=1,f;if(-1!==a._geometryClass.indexOf("Geometry.Point")&&e){a.style.visibility="";if(!1===b.graphic)a.style.visibility="hidden";else if(b.externalGraphic){f=
this.getPosition(a);b.graphicWidth&&b.graphicHeight&&a.setAttributeNS(null,"preserveAspectRatio","none");var e=b.graphicWidth||b.size||30,g=b.graphicHeight||b.size||30,e=e?e:2*b.pointRadius,g=g?g:2*b.pointRadius,h=void 0!=b.graphicYOffset?b.graphicYOffset:-(.5*g),k=b.graphicOpacity||b.fillOpacity;a.setAttributeNS(null,"x",(f.x+(void 0!=b.graphicXOffset?b.graphicXOffset:-(.5*e))).toFixed());a.setAttributeNS(null,"y",(f.y+h).toFixed());a.setAttributeNS(null,"width",e);a.setAttributeNS(null,"height",
g);a.setAttributeNS(this.xlinkns,"xlink:href",b.externalGraphic);a.setAttributeNS(null,"style","opacity: "+k);a.onclick=OpenLayersForProjection.Event.preventDefault}else if(this.isComplexSymbol(b.graphicName)){var e=3*b.pointRadius,g=2*e,l=null;Nigsys.graphicIsFont(b.graphicName)?(l=StyleEditor.drawRuleFontImageOnWFS(b),d=1,a.setAttributeNS(null,"viewBox","-10 -10 30 30"),a.firstChild&&a.removeChild(a.firstChild),a.appendChild(l)):(l=this.importSymbol(b.graphicName),d=3*this.symbolMetrics[l.id][0]/
g,a.setAttributeNS(null,"viewBox",l.getAttributeNS(null,"viewBox")),a.firstChild&&a.removeChild(a.firstChild),a.appendChild(l.firstChild.cloneNode(!0)));f=this.getPosition(a);h=a.parentNode;k=a.nextSibling;h&&h.removeChild(a);a.setAttributeNS(null,"width",g);a.setAttributeNS(null,"height",g);a.setAttributeNS(null,"x",f.x-e);a.setAttributeNS(null,"y",f.y-e);k?h.insertBefore(a,k):h&&h.appendChild(a)}else a.setAttributeNS(null,"r",b.pointRadius);e=b.rotation;void 0===e&&void 0===a._rotation||!f||(a._rotation=
e,e|=0,"svg"!==a.nodeName?a.setAttributeNS(null,"transform","rotate("+e+" "+f.x+" "+f.y+")"):(f=this.symbolMetrics[l.id])?a.firstChild.setAttributeNS(null,"transform","rotate("+e+" "+f[1]+" "+f[2]+")"):a.firstChild.setAttributeNS(null,"transform","rotate("+e+" 5 5)"))}c.isFilled?b.externalGraphic?(g=b.size?b.size:b.pointRadius,f=OpenLayersForProjection.Renderer.SVG.prototype.createImagePattern(b,g,g),a.setAttributeNS(null,"fill","url(#"+f+")"),a.setAttributeNS(null,"fill-opacity",b.graphicOpacity)):
b.graphicName&&-1!==b.graphicName.indexOf("shape://")&&"OpenLayers.Geometry.Polygon"===a._geometryClass?(OpenLayersForProjection.Console.error("WellKnownName is not yet supported as GraphicFill by the SVG renderer!"),b.externalGraphic=applicationUrl+"resources/img/pattern.png?"+Imajnet.version,f=OpenLayersForProjection.Renderer.SVG.prototype.createImagePattern(b,58,58),a.setAttributeNS(null,"fill","url(#"+f+")"),a.setAttributeNS(null,"fill-opacity",b.patternstrokeOpacity)):(a.setAttributeNS(null,
"fill",b.fillColor),a.setAttributeNS(null,"fill-opacity",b.fillOpacity)):a.setAttributeNS(null,"fill","none");c.isStroked?(a.setAttributeNS(null,"stroke",b.strokeColor),a.setAttributeNS(null,"stroke-opacity",b.strokeOpacity),a.setAttributeNS(null,"stroke-width",b.strokeWidth*d),a.setAttributeNS(null,"stroke-linecap",b.strokeLinecap||"round"),a.setAttributeNS(null,"stroke-linejoin","round"),b.strokeDashstyle&&a.setAttributeNS(null,"stroke-dasharray",this.dashStyle(b,d))):a.setAttributeNS(null,"stroke",
"none");b.pointerEvents&&a.setAttributeNS(null,"pointer-events",b.pointerEvents);null!=b.cursor&&a.setAttributeNS(null,"cursor",b.cursor);return a},drawPoint:function(a,b){return this.drawCircle(a,b,1)},drawCircle:function(a,b,c){var d=this.getResolution(),e=(b.x-this.featureDx)/d+this.left;b=this.top-b.y/d;return this.inValidRange(e,b)?(a.setAttributeNS(null,"cx",e),a.setAttributeNS(null,"cy",b),a.setAttributeNS(null,"r",c),a):!1},importSymbol:function(a){this.defs||(this.defs=this.createDefs());
var b=this.container.id+"-"+a,c=document.getElementById(b);if(null!=c)return c;var d=OpenLayersForProjection.Renderer.symbol[a];if(!d)throw Error(a+" is not a valid symbol name");a=this.nodeFactory(b,"symbol");var e=this.nodeFactory(null,"polygon");a.appendChild(e);for(var c=new OpenLayersForProjection.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),f=[],g,h,k=0;k<d.length;k+=2)g=d[k],h=d[k+1],c.left=Math.min(c.left,g),c.bottom=Math.min(c.bottom,h),c.right=Math.max(c.right,g),c.top=Math.max(c.top,h),
f.push(g,",",h);e.setAttributeNS(null,"points",f.join(" "));d=c.getWidth();e=c.getHeight();a.setAttributeNS(null,"viewBox",[c.left-d,c.bottom-e,3*d,3*e].join(" "));this.symbolMetrics[b]=[Math.max(d,e),c.getCenterLonLat().lon,c.getCenterLonLat().lat];this.defs.appendChild(a);return a},createDefs:function(){if(!this.container||!this.container.id)return null;var a=this.nodeFactory(this.container.id+"_defs","defs");this.rendererRoot.appendChild(a);return a},getPosition:function(a){return{x:parseFloat(a.getAttributeNS(null,
"cx")),y:parseFloat(a.getAttributeNS(null,"cy"))}},getNodeType:function(a,b){var c=null;switch(a.CLASS_NAME){case "OpenLayers.Geometry.Point":c=b.externalGraphic?"image":this.isComplexSymbol(b.graphicName)?"svg":"circle";break;case "OpenLayers.Geometry.Rectangle":c="rect";break;case "OpenLayers.Geometry.LineString":c="polyline";break;case "OpenLayers.Geometry.LinearRing":c="polygon";break;case "OpenLayers.Geometry.Polygon":case "OpenLayers.Geometry.Curve":c="path"}return c},dashStyle:function(a,b){var c=
a.strokeWidth*b,d=a.strokeDashstyle;switch(d){case "solid":return"none";case "dot":return[1,4*c].join();case "dash":return[4*c,4*c].join();case "dashdot":return[4*c,4*c,1,4*c].join();case "longdash":return[8*c,4*c].join();case "longdashdot":return[8*c,4*c,1,4*c].join();default:return OpenLayersForProjection.String.trim(d).replace(/\s+/g,",")}},drawText:function(a,b,c){var d=!!b.labelOutlineWidth;if(d){var e=OpenLayersForProjection.Util.extend({},b);e.fontColor=e.labelOutlineColor;e.fontStrokeColor=
e.labelOutlineColor;e.fontStrokeWidth=b.labelOutlineWidth;b.labelOutlineOpacity&&(e.fontOpacity=b.labelOutlineOpacity);delete e.labelOutlineWidth;this.drawText(a,e,c)}var f=this.getResolution(),e=(c.x-this.featureDx)/f+this.left,g=c.y/f-this.top,d=d?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,f=this.nodeFactory(a+d,"text");f.setAttributeNS(null,"x",e);f.setAttributeNS(null,"y",-g);b.fontColor&&f.setAttributeNS(null,"fill",b.fontColor);b.fontStrokeColor&&f.setAttributeNS(null,"stroke",b.fontStrokeColor);
b.fontStrokeWidth&&f.setAttributeNS(null,"stroke-width",b.fontStrokeWidth);b.fontOpacity&&f.setAttributeNS(null,"opacity",b.fontOpacity);b.fontFamily&&f.setAttributeNS(null,"font-family",b.fontFamily);b.fontSize&&f.setAttributeNS(null,"font-size",b.fontSize);b.fontWeight&&f.setAttributeNS(null,"font-weight",b.fontWeight);b.fontStyle&&f.setAttributeNS(null,"font-style",b.fontStyle);!0===b.labelSelect?(f.setAttributeNS(null,"pointer-events","visible"),f._featureId=a):f.setAttributeNS(null,"pointer-events",
"none");g=b.labelAlign||OpenLayersForProjection.Renderer.defaultSymbolizer.labelAlign;f.setAttributeNS(null,"text-anchor",OpenLayersForProjection.Renderer.SVG.LABEL_ALIGN[g[0]]||"middle");!0===OpenLayersForProjection.IS_GECKO&&f.setAttributeNS(null,"dominant-baseline",OpenLayersForProjection.Renderer.SVG.LABEL_ALIGN[g[1]]||"central");for(var h=b.label.split("\n"),k=h.length;f.childNodes.length>k;)f.removeChild(f.lastChild);for(var l=0;l<k;l++){var m=this.nodeFactory(a+d+"_tspan_"+l,"tspan");!0===
b.labelSelect&&(m._featureId=a,m._geometry=c,m._geometryClass=c.CLASS_NAME);!1===OpenLayersForProjection.IS_GECKO&&m.setAttributeNS(null,"baseline-shift",OpenLayersForProjection.Renderer.SVG.LABEL_VSHIFT[g[1]]||"-35%");m.setAttribute("x",e);if(0==l){var n=OpenLayersForProjection.Renderer.SVG.LABEL_VFACTOR[g[1]];null==n&&(n=-.5);m.setAttribute("dy",n*(k-1)+"em")}else m.setAttribute("dy","1em");m.textContent=""===h[l]?" ":h[l];m.parentNode||f.appendChild(m)}f.parentNode||this.textRoot.appendChild(f)},
CLASS_NAME:"OpenLayersForProjection.Renderer.SVG"});OpenLayersForProjection.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"};OpenLayersForProjection.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1};
OpenLayersForProjection.Renderer.VML=OpenLayersForProjection.Class(OpenLayersForProjection.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(a){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var b=document.createStyleSheet(),c="shape rect oval fill stroke imagedata group textbox".split(" "),d=0,e=c.length;d<e;d++)b.addRule("olv\\:"+c[d],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayersForProjection.Renderer.Elements.prototype.initialize.apply(this,
arguments)}},supported:function(){return!!document.namespaces},setExtent:function(a,b){var c=OpenLayersForProjection.Renderer.Elements.prototype.setExtent.apply(this,arguments),d=this.getResolution(),e=a.left/d|0,d=a.top/d-this.size.h|0;b||!this.offset?(this.offset={x:e,y:d},d=e=0):(e-=this.offset.x,d-=this.offset.y);this.root.coordorigin=e-this.xOffset+" "+d;for(var e=[this.root,this.vectorRoot,this.textRoot],f=0,g=e.length;f<g;++f)d=e[f],d.coordsize=this.size.w+" "+this.size.h;this.root.style.flip=
"y";return c},setSize:function(a){OpenLayersForProjection.Renderer.prototype.setSize.apply(this,arguments);for(var b=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],c=this.size.w+"px",d=this.size.h+"px",e,f=0,g=b.length;f<g;++f)e=b[f],e.style.width=c,e.style.height=d},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createNode:function(a,b){var c=document.createElement(a);b&&(c.id=b);c.unselectable="on";c.onselectstart=OpenLayersForProjection.Function.False;
return c},createRoot:function(a){return this.nodeFactory(this.container.id+a,"olv:group")},setStyle:function(a,b,c,d){b=b||a._style;c=c||a._options;var e=b.fillColor,f=b.title||b.graphicTitle;f&&(a.title=f);if("OpenLayers.Geometry.Point"===a._geometryClass)if(b.externalGraphic){c.isFilled=!0;var e=b.graphicWidth||b.graphicHeight,f=b.graphicHeight||b.graphicWidth,e=e?e:2*b.pointRadius,f=f?f:2*b.pointRadius,g=this.getResolution(),h=void 0!=b.graphicXOffset?b.graphicXOffset:-(.5*e),k=void 0!=b.graphicYOffset?
b.graphicYOffset:-(.5*f);a.style.left=((d.x-this.featureDx)/g-this.offset.x+h|0)+"px";a.style.top=(d.y/g-this.offset.y-(k+f)|0)+"px";a.style.width=e+"px";a.style.height=f+"px";a.style.flip="y";e="none";c.isStroked=!1}else this.isComplexSymbol(b.graphicName)?(f=this.importSymbol(b.graphicName),a.path=f.path,a.coordorigin=f.left+","+f.bottom,f=f.size,a.coordsize=f+","+f,this.drawCircle(a,d,b.pointRadius),a.style.flip="y"):this.drawCircle(a,d,b.pointRadius);c.isFilled?a.fillcolor=e:a.filled="false";
d=a.getElementsByTagName("fill");d=0==d.length?null:d[0];c.isFilled?(d||(d=this.createNode("olv:fill",a.id+"_fill")),d.opacity=b.fillOpacity,"OpenLayers.Geometry.Point"===a._geometryClass&&b.externalGraphic&&(b.graphicOpacity&&(d.opacity=b.graphicOpacity),d.src=b.externalGraphic,d.type="frame",b.graphicWidth&&b.graphicHeight||(d.aspect="atmost")),d.parentNode!=a&&a.appendChild(d)):d&&a.removeChild(d);e=b.rotation;if(void 0!==e||void 0!==a._rotation)a._rotation=e,b.externalGraphic?(this.graphicRotate(a,
h,k,b),d.opacity=0):"OpenLayers.Geometry.Point"===a._geometryClass&&(a.style.rotation=e||0);h=a.getElementsByTagName("stroke");h=0==h.length?null:h[0];c.isStroked?(h||(h=this.createNode("olv:stroke",a.id+"_stroke"),a.appendChild(h)),h.on=!0,h.color=b.strokeColor,h.weight=b.strokeWidth+"px",h.opacity=b.strokeOpacity,h.endcap="butt"==b.strokeLinecap?"flat":b.strokeLinecap||"round",b.strokeDashstyle&&(h.dashstyle=this.dashStyle(b))):(a.stroked=!1,h&&(h.on=!1));"inherit"!=b.cursor&&null!=b.cursor&&(a.style.cursor=
b.cursor);return a},postDraw:function(a){a.style.visibility="visible";var b=a._style.fillColor,c=a._style.strokeColor;"none"==b&&a.fillcolor!=b&&(a.fillcolor=b);"none"==c&&a.strokecolor!=c&&(a.strokecolor=c)},drawPoint:function(a,b){return this.drawCircle(a,b,1)},drawCircle:function(a,b,c){if(!isNaN(b.x)&&!isNaN(b.y)){var d=this.getResolution();a.style.left=((b.x-this.featureDx)/d-this.offset.x|0)-c+"px";a.style.top=(b.y/d-this.offset.y|0)-c+"px";b=2*c;a.style.width=b+"px";a.style.height=b+"px";return a}return!1},
importSymbol:function(a){var b=this.container.id+"-"+a,c=this.symbolCache[b];if(c)return c;c=OpenLayersForProjection.Renderer.symbol[a];if(!c)throw Error(a+" is not a valid symbol name");a=new OpenLayersForProjection.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0);for(var d=["m"],e=0;e<c.length;e+=2){var f=c[e],g=c[e+1];a.left=Math.min(a.left,f);a.bottom=Math.min(a.bottom,g);a.right=Math.max(a.right,f);a.top=Math.max(a.top,g);d.push(f);d.push(g);0==e&&d.push("l")}d.push("x e");c=d.join(" ");d=(a.getWidth()-
a.getHeight())/2;0<d?(a.bottom-=d,a.top+=d):(a.left+=d,a.right-=d);c={path:c,size:a.getWidth(),left:a.left,bottom:a.bottom};return this.symbolCache[b]=c},getNodeType:function(a,b){var c=null;switch(a.CLASS_NAME){case "OpenLayers.Geometry.Point":c=b.externalGraphic?"olv:rect":this.isComplexSymbol(b.graphicName)?"olv:shape":"olv:oval";break;case "OpenLayers.Geometry.Rectangle":c="olv:rect";break;case "OpenLayers.Geometry.LineString":case "OpenLayers.Geometry.LinearRing":case "OpenLayers.Geometry.Polygon":case "OpenLayers.Geometry.Curve":c=
"olv:shape"}return c},CLASS_NAME:"OpenLayersForProjection.Renderer.VML"});
OpenLayersForProjection.Event={observers:!1,KEY_SPACE:32,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(a){return a.target||a.srcElement},isSingleTouch:function(a){return a.touches&&1==a.touches.length},isMultiTouch:function(a){return a.touches&&1<a.touches.length},isLeftClick:function(a){return a.which&&1==a.which||a.button&&1==a.button},isRightClick:function(a){return a.which&&3==a.which||a.button&&2==a.button},stop:function(a,
b){b||OpenLayersForProjection.Event.preventDefault(a);a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},preventDefault:function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},findElement:function(a,b){for(var c=OpenLayersForProjection.Event.element(a);c.parentNode&&(!c.tagName||c.tagName.toUpperCase()!=b.toUpperCase());)c=c.parentNode;return c},observe:function(a,b,c,d){a=OpenLayersForProjection.Util.getElement(a);d=d||!1;"keypress"==b&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||
a.attachEvent)&&(b="keydown");this.observers||(this.observers={});a||(a={});if(!a._eventCacheID){var e="eventCacheID_";a.id&&(e=a.id+"_"+e);a._eventCacheID=OpenLayersForProjection.Util.createUniqueID(e)}e=a._eventCacheID;this.observers[e]||(this.observers[e]=[]);this.observers[e].push({element:a,name:b,observer:c,useCapture:d});a.addEventListener?a.addEventListener(b,c,d):a.attachEvent&&a.attachEvent("on"+b,c)},stopObservingElement:function(a){(a=OpenLayersForProjection.Util.getElement(a))&&this._removeElementObservers(OpenLayersForProjection.Event.observers[a._eventCacheID])},
_removeElementObservers:function(a){if(a)for(var b=a.length-1;0<=b;b--){var c=a[b];OpenLayersForProjection.Event.stopObserving.apply(this,[c.element,c.name,c.observer,c.useCapture])}},stopObserving:function(a,b,c,d){d=d||!1;a=OpenLayersForProjection.Util.getElement(a);var e=a._eventCacheID;"keypress"==b&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||a.detachEvent)&&(b="keydown");var f=!1,g=OpenLayersForProjection.Event.observers[e];if(g)for(var h=0;!f&&h<g.length;){var k=g[h];if(k.name==
b&&k.observer==c&&k.useCapture==d){g.splice(h,1);0==g.length&&delete OpenLayersForProjection.Event.observers[e];f=!0;break}h++}f&&(a.removeEventListener?a.removeEventListener(b,c,d):a&&a.detachEvent&&a.detachEvent("on"+b,c));return f},unloadCache:function(){if(OpenLayersForProjection.Event&&OpenLayersForProjection.Event.observers){for(var a in OpenLayersForProjection.Event.observers)OpenLayersForProjection.Event._removeElementObservers.apply(this,[OpenLayersForProjection.Event.observers[a]]);OpenLayersForProjection.Event.observers=
!1}},CLASS_NAME:"OpenLayersForProjection.Event"};OpenLayersForProjection.Event.observe(window,"unload",OpenLayersForProjection.Event.unloadCache,!1);
OpenLayersForProjection.Events=OpenLayersForProjection.Class({BROWSER_EVENTS:"mouseover mouseout mousedown mouseup mousemove click dblclick rightclick dblrightclick resize focus blur touchstart touchmove touchend keydown".split(" "),listeners:null,object:null,element:null,eventHandler:null,fallThrough:null,includeXY:!1,extensions:null,extensionCount:null,clearMouseListener:null,initialize:function(a,b,c,d,e){OpenLayersForProjection.Util.extend(this,e);this.object=a;this.fallThrough=d;this.listeners=
{};this.extensions={};this.extensionCount={};this._msTouches=[];null!=b&&this.attachToElement(b)},destroy:function(){for(var a in this.extensions)"boolean"!==typeof this.extensions[a]&&this.extensions[a].destroy();this.extensions=null;this.element&&(OpenLayersForProjection.Event.stopObservingElement(this.element),this.element.hasScrollEvent&&OpenLayersForProjection.Event.stopObserving(window,"scroll",this.clearMouseListener));this.eventHandler=this.fallThrough=this.object=this.listeners=this.element=
null},addEventType:function(a){},attachToElement:function(a){this.element?OpenLayersForProjection.Event.stopObservingElement(this.element):(this.eventHandler=OpenLayersForProjection.Function.bindAsEventListener(this.handleBrowserEvent,this),this.clearMouseListener=OpenLayersForProjection.Function.bind(this.clearMouseCache,this));this.element=a;for(var b=!!window.navigator.msMaxTouchPoints,c,d=0,e=this.BROWSER_EVENTS.length;d<e;d++)c=this.BROWSER_EVENTS[d],OpenLayersForProjection.Event.observe(a,c,
this.eventHandler),b&&0===c.indexOf("touch")&&this.addMsTouchListener(a,c,this.eventHandler);OpenLayersForProjection.Event.observe(a,"dragstart",OpenLayersForProjection.Event.stop)},on:function(a){for(var b in a)"scope"!=b&&a.hasOwnProperty(b)&&this.register(b,a.scope,a[b])},register:function(a,b,c,d){a in OpenLayersForProjection.Events&&!this.extensions[a]&&(this.extensions[a]=new OpenLayersForProjection.Events[a](this));if(null!=c){null==b&&(b=this.object);var e=this.listeners[a];e||(e=[],this.listeners[a]=
e,this.extensionCount[a]=0);b={obj:b,func:c};d?(e.splice(this.extensionCount[a],0,b),"object"===typeof d&&d.extension&&this.extensionCount[a]++):e.push(b)}},registerPriority:function(a,b,c){this.register(a,b,c,!0)},un:function(a){for(var b in a)"scope"!=b&&a.hasOwnProperty(b)&&this.unregister(b,a.scope,a[b])},unregister:function(a,b,c){null==b&&(b=this.object);a=this.listeners[a];if(null!=a)for(var d=0,e=a.length;d<e;d++)if(a[d].obj==b&&a[d].func==c){a.splice(d,1);break}},remove:function(a){null!=
this.listeners[a]&&(this.listeners[a]=[])},triggerEvent:function(a,b){var c=this.listeners[a];if(c&&0!=c.length){null==b&&(b={});b.object=this.object;b.element=this.element;b.type||(b.type=a);for(var c=c.slice(),d,e=0,f=c.length;e<f&&(d=c[e],d=d.func.apply(d.obj,[b]),void 0==d||0!=d);e++);this.fallThrough||OpenLayersForProjection.Event.stop(b,!0);return d}},handleBrowserEvent:function(a){var b=a.type,c=this.listeners[b];if(c&&0!=c.length){if((c=a.touches)&&c[0]){for(var d=0,e=0,f=c.length,g,h=0;h<
f;++h)g=this.getTouchClientXY(c[h]),d+=g.clientX,e+=g.clientY;a.clientX=d/f;a.clientY=e/f}this.includeXY&&(a.xy=this.getMousePosition(a));this.triggerEvent(b,a)}},getTouchClientXY:function(a){var b=window.olMockWin||window,c=b.pageXOffset,b=b.pageYOffset,d=a.clientX,e=a.clientY;if(0===a.pageY&&Math.floor(e)>Math.floor(a.pageY)||0===a.pageX&&Math.floor(d)>Math.floor(a.pageX))d-=c,e-=b;else if(e<a.pageY-b||d<a.pageX-c)d=a.pageX-c,e=a.pageY-b;a.olClientX=d;a.olClientY=e;return{clientX:d,clientY:e}},
clearMouseCache:function(){this.element.scrolls=null;this.element.lefttop=null;this.element.offsets=null},getMousePosition:function(a){this.includeXY?this.element.hasScrollEvent||(OpenLayersForProjection.Event.observe(window,"scroll",this.clearMouseListener),this.element.hasScrollEvent=!0):this.clearMouseCache();if(!this.element.scrolls){var b=OpenLayersForProjection.Util.getViewportElement();this.element.scrolls=[window.pageXOffset||b.scrollLeft,window.pageYOffset||b.scrollTop]}this.element.lefttop||
(this.element.lefttop=[document.documentElement.clientLeft||0,document.documentElement.clientTop||0]);this.element.offsets||(this.element.offsets=OpenLayersForProjection.Util.pagePosition(this.element));return new OpenLayersForProjection.Pixel(a.clientX+this.element.scrolls[0]-this.element.offsets[0]-this.element.lefttop[0],a.clientY+this.element.scrolls[1]-this.element.offsets[1]-this.element.lefttop[1])},addMsTouchListener:function(a,b,c){function d(a){c(OpenLayersForProjection.Util.applyDefaults({stopPropagation:function(){for(var a=
e.length-1;0<=a;--a)e[a].stopPropagation()},preventDefault:function(){for(var a=e.length-1;0<=a;--a)e[a].preventDefault()},type:b},a))}var e=this._msTouches;switch(b){case "touchstart":return this.addMsTouchListenerStart(a,b,d);case "touchend":return this.addMsTouchListenerEnd(a,b,d);case "touchmove":return this.addMsTouchListenerMove(a,b,d);default:throw"Unknown touch event type";}},addMsTouchListenerStart:function(a,b,c){var d=this._msTouches;OpenLayersForProjection.Event.observe(a,"MSPointerDown",
function(a){for(var b=!1,g=0,h=d.length;g<h;++g)if(d[g].pointerId==a.pointerId){b=!0;break}b||d.push(a);a.touches=d.slice();c(a)});OpenLayersForProjection.Event.observe(a,"MSPointerUp",function(a){for(var b=0,c=d.length;b<c;++b)if(d[b].pointerId==a.pointerId){d.splice(b,1);break}})},addMsTouchListenerMove:function(a,b,c){var d=this._msTouches;OpenLayersForProjection.Event.observe(a,"MSPointerMove",function(a){if(a.pointerType!=a.MSPOINTER_TYPE_MOUSE||0!=a.buttons)if(1!=d.length||d[0].pageX!=a.pageX||
d[0].pageY!=a.pageY){for(var b=0,g=d.length;b<g;++b)if(d[b].pointerId==a.pointerId){d[b]=a;break}a.touches=d.slice();c(a)}})},addMsTouchListenerEnd:function(a,b,c){var d=this._msTouches;OpenLayersForProjection.Event.observe(a,"MSPointerUp",function(a){for(var b=0,g=d.length;b<g;++b)if(d[b].pointerId==a.pointerId){d.splice(b,1);break}a.touches=d.slice();c(a)})},CLASS_NAME:"OpenLayersForProjection.Events"});
OpenLayersForProjection.Function={bind:function(a,b){var c=Array.prototype.slice.apply(arguments,[2]);return function(){var d=c.concat(Array.prototype.slice.apply(arguments,[0]));return a.apply(b,d)}},bindAsEventListener:function(a,b){return function(c){return a.call(b,c||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}};
OpenLayersForProjection.Format=OpenLayersForProjection.Class({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(a){OpenLayersForProjection.Util.extend(this,a);this.options=a},destroy:function(){},read:function(a){throw Error("Read not implemented.");},write:function(a){throw Error("Write not implemented.");},CLASS_NAME:"OpenLayers.Format"});
OpenLayersForProjection.Format.XML=OpenLayersForProjection.Class(OpenLayersForProjection.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(a){window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"));OpenLayersForProjection.Format.prototype.initialize.apply(this,[a]);this.namespaces=OpenLayersForProjection.Util.extend({},this.namespaces);this.namespaceAlias={};for(var b in this.namespaces)this.namespaceAlias[this.namespaces[b]]=
b},destroy:function(){this.xmldom=null;OpenLayersForProjection.Format.prototype.destroy.apply(this,arguments)},setNamespace:function(a,b){this.namespaces[a]=b;this.namespaceAlias[b]=a},read:function(a){var b=a.indexOf("\x3c");0<b&&(a=a.substring(b));b=OpenLayersForProjection.Util.Try(OpenLayersForProjection.Function.bind(function(){var b;b=window.ActiveXObject&&!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom;b.loadXML(a);return b},this),function(){return(new DOMParser).parseFromString(a,
"text/xml")},function(){var b=new XMLHttpRequest;b.open("GET","data:text/xml;charset\x3dutf-8,"+encodeURIComponent(a),!1);b.overrideMimeType&&b.overrideMimeType("text/xml");b.send(null);return b.responseXML});this.keepData&&(this.data=b);return b},write:function(a){if(this.xmldom)a=a.xml;else{var b=new XMLSerializer;if(1==a.nodeType){var c=document.implementation.createDocument("","",null);c.importNode&&(a=c.importNode(a,!0));c.appendChild(a);a=b.serializeToString(c)}else a=b.serializeToString(a)}return a},
createElementNS:function(a,b){return this.xmldom?"string"==typeof a?this.xmldom.createNode(1,b,a):this.xmldom.createNode(1,b,""):document.createElementNS(a,b)},createDocumentFragment:function(){return this.xmldom?this.xmldom.createDocumentFragment():document.createDocumentFragment()},createTextNode:function(a){"string"!==typeof a&&(a=String(a));return this.xmldom?this.xmldom.createTextNode(a):document.createTextNode(a)},getElementsByTagNameNS:function(a,b,c){var d=[];if(a.getElementsByTagNameNS)d=
a.getElementsByTagNameNS(b,c);else{a=a.getElementsByTagName("*");for(var e,f,g=0,h=a.length;g<h;++g)if(e=a[g],f=e.prefix?e.prefix+":"+c:c,"*"==c||f==e.nodeName)"*"!=b&&b!=e.namespaceURI||d.push(e)}return d},getAttributeNodeNS:function(a,b,c){var d=null;if(a.getAttributeNodeNS)d=a.getAttributeNodeNS(b,c);else{a=a.attributes;for(var e,f,g=0,h=a.length;g<h;++g)if(e=a[g],e.namespaceURI==b&&(f=e.prefix?e.prefix+":"+c:c,f==e.nodeName)){d=e;break}}return d},getAttributeNS:function(a,b,c){var d="";if(a.getAttributeNS)d=
a.getAttributeNS(b,c)||"";else if(a=this.getAttributeNodeNS(a,b,c))d=a.nodeValue;return d},getChildValue:function(a,b){var c=b||"";if(a)for(var d=a.firstChild;d;d=d.nextSibling)switch(d.nodeType){case 3:case 4:c+=d.nodeValue}return c},isSimpleContent:function(a){var b=!0;for(a=a.firstChild;a;a=a.nextSibling)if(1===a.nodeType){b=!1;break}return b},contentType:function(a){var b=!1,c=!1,d=OpenLayersForProjection.Format.XML.CONTENT_TYPE.EMPTY;for(a=a.firstChild;a;a=a.nextSibling){switch(a.nodeType){case 1:c=
!0;break;case 8:break;default:b=!0}if(c&&b)break}if(c&&b)d=OpenLayersForProjection.Format.XML.CONTENT_TYPE.MIXED;else{if(c)return OpenLayersForProjection.Format.XML.CONTENT_TYPE.COMPLEX;if(b)return OpenLayersForProjection.Format.XML.CONTENT_TYPE.SIMPLE}return d},hasAttributeNS:function(a,b,c){var d=!1;return d=a.hasAttributeNS?a.hasAttributeNS(b,c):!!this.getAttributeNodeNS(a,b,c)},setAttributeNS:function(a,b,c,d){if(a.setAttributeNS)a.setAttributeNS(b,c,d);else if(this.xmldom)b?(b=a.ownerDocument.createNode(2,
c,b),b.nodeValue=d,a.setAttributeNode(b)):a.setAttribute(c,d);else throw"setAttributeNS not implemented";},createElementNSPlus:function(a,b){b=b||{};var c=b.uri||this.namespaces[b.prefix];c||(c=a.indexOf(":"),c=this.namespaces[a.substring(0,c)]);c||(c=this.namespaces[this.defaultPrefix]);c=this.createElementNS(c,a);b.attributes&&this.setAttributes(c,b.attributes);var d=b.value;null!=d&&c.appendChild(this.createTextNode(d));return c},setAttributes:function(a,b){var c,d,e;for(e in b)null!=b[e]&&b[e].toString&&
(c=b[e].toString(),d=this.namespaces[e.substring(0,e.indexOf(":"))]||null,this.setAttributeNS(a,d,e,c))},readNode:function(a,b){b||(b={});var c=this.readers[a.namespaceURI?this.namespaceAlias[a.namespaceURI]:this.defaultPrefix];if(c){var d=a.localName||a.nodeName.split(":").pop();(c=c[d]||c["*"])&&c.apply(this,[a,b])}return b},readChildNodes:function(a,b){b||(b={});for(var c=a.childNodes,d,e=0,f=c.length;e<f;++e)d=c[e],1==d.nodeType&&this.readNode(d,b);return b},writeNode:function(a,b,c){var d,e=
a.indexOf(":");0<e?(d=a.substring(0,e),a=a.substring(e+1)):d=c?this.namespaceAlias[c.namespaceURI]:this.defaultPrefix;b=this.writers[d][a].apply(this,[b]);c&&c.appendChild(b);return b},getChildEl:function(a,b,c){return a&&this.getThisOrNextEl(a.firstChild,b,c)},getNextEl:function(a,b,c){return a&&this.getThisOrNextEl(a.nextSibling,b,c)},getThisOrNextEl:function(a,b,c){a:for(;a;a=a.nextSibling)switch(a.nodeType){case 1:if(!(b&&b!==(a.localName||a.nodeName.split(":").pop())||c&&c!==a.namespaceURI))break a;
a=null;break a;case 3:if(/^\s*$/.test(a.nodeValue))break;case 4:case 6:case 12:case 10:case 11:a=null;break a}return a||null},lookupNamespaceURI:function(a,b){var c=null;if(a)if(a.lookupNamespaceURI)c=a.lookupNamespaceURI(b);else a:switch(a.nodeType){case 1:if(null!==a.namespaceURI&&a.prefix===b){c=a.namespaceURI;break a}if(c=a.attributes.length)for(var d,e=0;e<c;++e)if(d=a.attributes[e],"xmlns"===d.prefix&&d.name==="xmlns:"+b){c=d.value||null;break a}else if("xmlns"===d.name&&null===b){c=d.value||
null;break a}c=this.lookupNamespaceURI(a.parentNode,b);break a;case 2:c=this.lookupNamespaceURI(a.ownerElement,b);break a;case 9:c=this.lookupNamespaceURI(a.documentElement,b);break a;case 6:case 12:case 10:case 11:break a;default:c=this.lookupNamespaceURI(a.parentNode,b)}return c},getXMLDoc:function(){OpenLayersForProjection.Format.XML.document||this.xmldom||(document.implementation&&document.implementation.createDocument?OpenLayersForProjection.Format.XML.document=document.implementation.createDocument("",
"",null):!this.xmldom&&window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")));return OpenLayersForProjection.Format.XML.document||this.xmldom},CLASS_NAME:"OpenLayers.Format.XML"});
OpenLayersForProjection.Format.KML=OpenLayersForProjection.Class(OpenLayersForProjection.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"OpenLayers export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,kvpAttributes:!1,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,
maxDepth:0,initialize:function(a){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g};this.externalProjection=new OpenLayersForProjection.Projection("EPSG:4326");OpenLayersForProjection.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){this.features=[];this.styles={};this.fetched={};return this.parseData(a,{depth:0,
styleBaseUrl:this.styleBaseUrl})},parseData:function(a,b){"string"==typeof a&&(a=OpenLayersForProjection.Format.XML.prototype.read.apply(this,[a]));for(var c=["Link","NetworkLink","Style","StyleMap","Placemark"],d=0,e=c.length;d<e;++d){var f=c[d],g=this.getElementsByTagNameNS(a,"*",f);if(0!=g.length)switch(f.toLowerCase()){case "link":case "networklink":this.parseLinks(g,b);break;case "style":this.extractStyles&&this.parseStyles(g,b);break;case "stylemap":this.extractStyles&&this.parseStyleMaps(g,
b);break;case "placemark":this.parseFeatures(g,b)}}return this.features},parseLinks:function(a,b){if(b.depth>=this.maxDepth)return!1;var c=OpenLayersForProjection.Util.extend({},b);c.depth++;for(var d=0,e=a.length;d<e;d++){var f=this.parseProperty(a[d],"*","href");f&&!this.fetched[f]&&(this.fetched[f]=!0,(f=this.fetchLink(f))&&this.parseData(f,c))}},fetchLink:function(a){if(a=OpenLayers.Request.GET({url:a,async:!1}))return a.responseText},parseStyles:function(a,b){for(var c=0,d=a.length;c<d;c++){var e=
this.parseStyle(a[c]);e&&(this.styles[(b.styleBaseUrl||"")+"#"+e.id]=e)}},parseKmlColor:function(a){var b=null;a&&(a=a.match(this.regExes.kmlColor))&&(b={color:"#"+a[4]+a[3]+a[2],opacity:parseInt(a[1],16)/255});return b},parseStyle:function(a){for(var b={},c=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],d,e,f=0,g=c.length;f<g;++f)if(d=c[f],e=this.getElementsByTagNameNS(a,"*",d)[0])switch(d.toLowerCase()){case "linestyle":d=this.parseProperty(e,"*","color");if(d=this.parseKmlColor(d))b.strokeColor=
d.color,b.strokeOpacity=d.opacity;(d=this.parseProperty(e,"*","width"))&&(b.strokeWidth=d);break;case "polystyle":d=this.parseProperty(e,"*","color");if(d=this.parseKmlColor(d))b.fillOpacity=d.opacity,b.fillColor=d.color;"0"==this.parseProperty(e,"*","fill")&&(b.fillColor="none");"0"==this.parseProperty(e,"*","outline")&&(b.strokeWidth="0");break;case "iconstyle":var h=parseFloat(this.parseProperty(e,"*","scale")||1);d=32*h;var k=32*h,l=this.getElementsByTagNameNS(e,"*","Icon")[0];if(l){var m=this.parseProperty(l,
"*","href");if(m){var n=this.parseProperty(l,"*","w"),p=this.parseProperty(l,"*","h");!OpenLayersForProjection.String.startsWith(m,"http://maps.google.com/mapfiles/kml")||n||p||(p=n=64,h/=2);n=n||p;p=p||n;n&&(d=parseInt(n)*h);p&&(k=parseInt(p)*h);if(p=m.match(this.regExes.kmlIconPalette))n=p[1],p=p[2],m=this.parseProperty(l,"*","x"),l=this.parseProperty(l,"*","y"),m="http://maps.google.com/mapfiles/kml/pal"+n+"/icon"+(8*(l?7-l/32:7)+(m?m/32:0))+p;b.graphicOpacity=1;b.externalGraphic=m}}if(e=this.getElementsByTagNameNS(e,
"*","hotSpot")[0])m=parseFloat(e.getAttribute("x")),l=parseFloat(e.getAttribute("y")),n=e.getAttribute("xunits"),"pixels"==n?b.graphicXOffset=-m*h:"insetPixels"==n?b.graphicXOffset=-d+m*h:"fraction"==n&&(b.graphicXOffset=-d*m),e=e.getAttribute("yunits"),"pixels"==e?b.graphicYOffset=-k+l*h+1:"insetPixels"==e?b.graphicYOffset=-(l*h)+1:"fraction"==e&&(b.graphicYOffset=-k*(1-l)+1);b.graphicWidth=d;b.graphicHeight=k;break;case "balloonstyle":(e=OpenLayersForProjection.Util.getXmlNodeValue(e))&&(b.balloonStyle=
e.replace(this.regExes.straightBracket,"${$1}"));break;case "labelstyle":if(d=this.parseProperty(e,"*","color"),d=this.parseKmlColor(d))b.fontColor=d.color,b.fontOpacity=d.opacity}!b.strokeColor&&b.fillColor&&(b.strokeColor=b.fillColor);(a=a.getAttribute("id"))&&b&&(b.id=a);return b},parseStyleMaps:function(a,b){for(var c=0,d=a.length;c<d;c++)for(var e=a[c],f=this.getElementsByTagNameNS(e,"*","Pair"),e=e.getAttribute("id"),g=0,h=f.length;g<h;g++){var k=f[g],l=this.parseProperty(k,"*","key");(k=this.parseProperty(k,
"*","styleUrl"))&&"normal"==l&&(this.styles[(b.styleBaseUrl||"")+"#"+e]=this.styles[(b.styleBaseUrl||"")+k])}},parseFeatures:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],g=this.parseFeature.apply(this,[f]);if(g){this.extractStyles&&g.attributes&&g.attributes.styleUrl&&(g.style=this.getStyle(g.attributes.styleUrl,b));if(this.extractStyles){var h=this.getElementsByTagNameNS(f,"*","Style")[0];h&&(h=this.parseStyle(h))&&(g.style=OpenLayersForProjection.Util.extend(g.style,h))}this.extractTracks?
(f=this.getElementsByTagNameNS(f,this.namespaces.gx,"Track"))&&0<f.length&&(g={features:[],feature:g},this.readNode(f[0],g),0<g.features.length&&c.push.apply(c,g.features)):c.push(g)}else throw"Bad Placemark: "+d;}this.features=this.features.concat(c)},readers:{kml:{when:function(a,b){b.whens.push(OpenLayersForProjection.Date.parse(this.getChildValue(a)))},_trackPointAttribute:function(a,b){var c=a.nodeName.split(":").pop();b.attributes[c].push(this.getChildValue(a))}},gx:{Track:function(a,b){var c=
{whens:[],points:[],angles:[]};if(this.trackAttributes){var d;c.attributes={};for(var e=0,f=this.trackAttributes.length;e<f;++e)d=this.trackAttributes[e],c.attributes[d]=[],d in this.readers.kml||(this.readers.kml[d]=this.readers.kml._trackPointAttribute)}this.readChildNodes(a,c);if(c.whens.length!==c.points.length)throw Error("gx:Track with unequal number of when ("+c.whens.length+") and gx:coord ("+c.points.length+") elements.");var g=0<c.angles.length;if(g&&c.whens.length!==c.angles.length)throw Error("gx:Track with unequal number of when ("+
c.whens.length+") and gx:angles ("+c.angles.length+") elements.");for(var h,e=0,f=c.whens.length;e<f;++e){h=b.feature.clone();h.fid=b.feature.fid||b.feature.id;d=c.points[e];h.geometry=d;"z"in d&&(h.attributes.altitude=d.z);this.internalProjection&&this.externalProjection&&h.geometry.transform(this.externalProjection,this.internalProjection);if(this.trackAttributes)for(var k=0,l=this.trackAttributes.length;k<l;++k)d=this.trackAttributes[k],h.attributes[d]=c.attributes[d][e];h.attributes.when=c.whens[e];
h.attributes.trackId=b.feature.id;g&&(d=c.angles[e],h.attributes.heading=parseFloat(d[0]),h.attributes.tilt=parseFloat(d[1]),h.attributes.roll=parseFloat(d[2]));b.features.push(h)}},coord:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(/\s+/),d=new OpenLayersForProjection.Geometry.Point(c[0],c[1]);2<c.length&&(d.z=parseFloat(c[2]));b.points.push(d)},angles:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(/\s+/);b.angles.push(c)}}},
parseFeature:function(a){for(var b=["MultiGeometry","Polygon","LineString","Point"],c,d,e,f=0,g=b.length;f<g;++f)if(c=b[f],this.internalns=a.namespaceURI?a.namespaceURI:this.kmlns,d=this.getElementsByTagNameNS(a,this.internalns,c),0<d.length){if(b=this.parseGeometry[c.toLowerCase()])e=b.apply(this,[d[0]]),this.internalProjection&&this.externalProjection&&e.transform(this.externalProjection,this.internalProjection);else throw new TypeError("Unsupported geometry type: "+c);break}var h;this.extractAttributes&&
(h=this.parseAttributes(a));c=new OpenLayersForProjection.Feature.Vector(e,h);a=a.getAttribute("id")||a.getAttribute("name");null!=a&&(c.fid=a);return c},getStyle:function(a,b){var c=OpenLayersForProjection.Util.removeTail(a),d=OpenLayersForProjection.Util.extend({},b);d.depth++;d.styleBaseUrl=c;!this.styles[a]&&!OpenLayersForProjection.String.startsWith(a,"#")&&d.depth<=this.maxDepth&&!this.fetched[c]&&(c=this.fetchLink(c))&&this.parseData(c,d);return OpenLayersForProjection.Util.extend({},this.styles[a])},
parseGeometry:{point:function(a){var b=this.getElementsByTagNameNS(a,this.internalns,"coordinates");a=[];if(0<b.length){var c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.removeSpace,"");a=c.split(",")}b=null;if(1<a.length)2==a.length&&(a[2]=null),b=new OpenLayersForProjection.Geometry.Point(a[0],a[1],a[2]);else throw"Bad coordinate string: "+c;return b},linestring:function(a,b){var c=this.getElementsByTagNameNS(a,this.internalns,"coordinates"),d=null;if(0<c.length){for(var c=this.getChildValue(c[0]),
c=c.replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),d=c.split(this.regExes.splitSpace),e=d.length,f=Array(e),g,h,k=0;k<e;++k)if(g=d[k].split(","),h=g.length,1<h)2==g.length&&(g[2]=null),f[k]=new OpenLayersForProjection.Geometry.Point(g[0],g[1],g[2]);else throw"Bad LineString point coordinates: "+d[k];if(e)d=b?new OpenLayersForProjection.Geometry.LinearRing(f):new OpenLayersForProjection.Geometry.LineString(f);else throw"Bad LineString coordinates: "+c;}return d},polygon:function(a){a=
this.getElementsByTagNameNS(a,this.internalns,"LinearRing");var b=a.length,c=Array(b);if(0<b)for(var d=0,e=a.length;d<e;++d)if(b=this.parseGeometry.linestring.apply(this,[a[d],!0]))c[d]=b;else throw"Bad LinearRing geometry: "+d;return new OpenLayersForProjection.Geometry.Polygon(c)},multigeometry:function(a){for(var b,c=[],d=a.childNodes,e=0,f=d.length;e<f;++e)a=d[e],1==a.nodeType&&(b=a.prefix?a.nodeName.split(":")[1]:a.nodeName,(b=this.parseGeometry[b.toLowerCase()])&&c.push(b.apply(this,[a])));
return new OpenLayersForProjection.Geometry.Collection(c)}},parseAttributes:function(a){var b={},c=a.getElementsByTagName("ExtendedData");c.length&&(b=this.parseExtendedData(c[0]));var d,e,f;a=a.childNodes;for(var c=0,g=a.length;c<g;++c)if(d=a[c],1==d.nodeType&&(e=d.childNodes,1<=e.length&&3>=e.length)){switch(e.length){case 1:f=e[0];break;case 2:f=e[0];e=e[1];f=3==f.nodeType||4==f.nodeType?f:e;break;default:f=e[1]}if(3==f.nodeType||4==f.nodeType)if(d=d.prefix?d.nodeName.split(":")[1]:d.nodeName,
f=OpenLayersForProjection.Util.getXmlNodeValue(f))f=f.replace(this.regExes.trimSpace,""),b[d]=f}return b},parseExtendedData:function(a){var b={},c,d,e,f,g=a.getElementsByTagName("Data");c=0;for(d=g.length;c<d;c++){e=g[c];f=e.getAttribute("name");var h={},k=e.getElementsByTagName("value");k.length&&(h.value=this.getChildValue(k[0]));this.kvpAttributes?b[f]=h.value:(e=e.getElementsByTagName("displayName"),e.length&&(h.displayName=this.getChildValue(e[0])),b[f]=h)}a=a.getElementsByTagName("SimpleData");
c=0;for(d=a.length;c<d;c++)h={},e=a[c],f=e.getAttribute("name"),h.value=this.getChildValue(e),this.kvpAttributes?b[f]=h.value:(h.displayName=f,b[f]=h);return b},parseProperty:function(a,b,c){var d;a=this.getElementsByTagNameNS(a,b,c);try{d=OpenLayersForProjection.Util.getXmlNodeValue(a[0])}catch(e){d=null}return d},write:function(a){OpenLayersForProjection.Util.isArray(a)||(a=[a]);for(var b=this.createElementNS(this.kmlns,"kml"),c=this.createFolderXML(),d=0,e=a.length;d<e;++d)c.appendChild(this.createPlacemarkXML(a[d]));
b.appendChild(c);return OpenLayersForProjection.Format.XML.prototype.write.apply(this,[b])},createFolderXML:function(){var a=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var b=this.createElementNS(this.kmlns,"name"),c=this.createTextNode(this.foldersName);b.appendChild(c);a.appendChild(b)}this.foldersDesc&&(b=this.createElementNS(this.kmlns,"description"),c=this.createTextNode(this.foldersDesc),b.appendChild(c),a.appendChild(b));return a},createPlacemarkXML:function(a){var b=this.createElementNS(this.kmlns,
"name"),c=a.style&&a.style.label?a.style.label:a.id;b.appendChild(this.createTextNode(a.attributes.name||c));var d=this.createElementNS(this.kmlns,"description");d.appendChild(this.createTextNode(a.attributes.description||this.placemarksDesc));c=this.createElementNS(this.kmlns,"Placemark");null!=a.fid&&c.setAttribute("id",a.fid);c.appendChild(b);c.appendChild(d);b=this.buildGeometryNode(a.geometry);c.appendChild(b);a.attributes&&(a=this.buildExtendedData(a.attributes))&&c.appendChild(a);return c},
buildGeometryNode:function(a){var b=a.CLASS_NAME,b=b.substring(b.lastIndexOf(".")+1),b=this.buildGeometry[b.toLowerCase()],c=null;b&&(c=b.apply(this,[a]));return c},buildGeometry:{point:function(a){var b=this.createElementNS(this.kmlns,"Point");b.appendChild(this.buildCoordinatesNode(a));return b},multipoint:function(a){return this.buildGeometry.collection.apply(this,[a])},linestring:function(a){var b=this.createElementNS(this.kmlns,"LineString");b.appendChild(this.buildCoordinatesNode(a));return b},
multilinestring:function(a){return this.buildGeometry.collection.apply(this,[a])},linearring:function(a){var b=this.createElementNS(this.kmlns,"LinearRing");b.appendChild(this.buildCoordinatesNode(a));return b},polygon:function(a){var b=this.createElementNS(this.kmlns,"Polygon");a=a.components;for(var c,d,e=0,f=a.length;e<f;++e)c=0==e?"outerBoundaryIs":"innerBoundaryIs",c=this.createElementNS(this.kmlns,c),d=this.buildGeometry.linearring.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},
multipolygon:function(a){return this.buildGeometry.collection.apply(this,[a])},collection:function(a){for(var b=this.createElementNS(this.kmlns,"MultiGeometry"),c,d=0,e=a.components.length;d<e;++d)(c=this.buildGeometryNode.apply(this,[a.components[d]]))&&b.appendChild(c);return b}},buildCoordinatesNode:function(a){var b=this.createElementNS(this.kmlns,"coordinates"),c;if(c=a.components){for(var d=c.length,e=Array(d),f=0;f<d;++f)a=c[f],e[f]=this.buildCoordinates(a);c=e.join(" ")}else c=this.buildCoordinates(a);
c=this.createTextNode(c);b.appendChild(c);return b},buildCoordinates:function(a){this.internalProjection&&this.externalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));return a.x+","+a.y},buildExtendedData:function(a){var b=this.createElementNS(this.kmlns,"ExtendedData"),c;for(c in a)if(a[c]&&"name"!=c&&"description"!=c&&"styleUrl"!=c){var d=this.createElementNS(this.kmlns,"Data");d.setAttribute("name",c);var e=this.createElementNS(this.kmlns,"value");if("object"==
typeof a[c]){if(a[c].value&&e.appendChild(this.createTextNode(a[c].value)),a[c].displayName){var f=this.createElementNS(this.kmlns,"displayName");f.appendChild(this.getXMLDoc().createCDATASection(a[c].displayName));d.appendChild(f)}}else e.appendChild(this.createTextNode(a[c]));d.appendChild(e);b.appendChild(d)}return this.isSimpleContent(b)?null:b},CLASS_NAME:"OpenLayers.Format.KML"});
var ImageControler={currentImageControl:null,currentImageType:null,currentSurveyTrace:null,currentPhotogrammetry:null,currentGraphic:null,getsCurrentImageControlType:function(){return ImageControler.currentImageControl.type?ImageControler.currentImageControl.type:"FLAT"},initDefaults:function(){ImageControler.currentPhotogrammetry=Photogrammetry;ImageControler.currentImageControl=ImageControl;ImageControler.currentSurveyTrace=SurveyTrace;ImageControler.currentGraphic=Graphic},setCurrentImageControl:function(a){a.type&&
"FLAT"!=a.type?"CUBE"==a.type&&(ImageControler.currentImageType="CUBE",ImageControler.currentImageControl=CubeImage,ImageControler.currentSurveyTrace=CubeSurveyTrace,ImageControler.currentPhotogrammetry=CubePhotogrammetry,ImageControler.currentGraphic=CubeGraphic):(ImageControler.currentImageType="FLAT",ImageControler.currentImageControl=FlatImage,ImageControler.currentSurveyTrace=FlatSurveyTrace,ImageControler.currentPhotogrammetry=FlatPhotogrammetry,ImageControler.currentGraphic=FlatGraphic)}};
function animate(){requestAnimationFrame(animate);CubePlugin.update()}
var CubePlugin={container:null,camera:null,scene:null,objectsScene:null,FOV:80,renderer:null,cubeContainer:null,cubeFacesArray:"BACK FRONT UP UP RIGHT LEFT".split(" "),yow:0,onMouseDownYow:0,pitch:0,onMouseDownPitch:0,phi:0,theta:0,cubeMesh:null,target:null,mouse:null,raycaster:null,pinPointsObject:null,offset:null,cubeIsHighRes:!1,maxRotation:{left:-180,right:180},mouseMoved:!1,init:function(){this.target=new THREE.Vector3;this.mouse=new THREE.Vector2;this.raycaster=new THREE.Raycaster;this.pinPointsObject=
new THREE.Object3D;this.container=jQuery("#popupImajnet");this.offset=this.container.parent().offset();this.camera=new THREE.PerspectiveCamera(this.FOV,this.container.innerWidth()/this.container.innerHeight(),1,3201);this.scene=new THREE.Scene;this.objectsScene=new THREE.Scene;this.renderer=new THREE.WebGLRenderer({antialias:!0});this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.setSize(this.container.innerWidth(),this.container.innerHeight());this.renderer.autoClear=!1;this.renderer.domElement.id=
"cubeContainer";this.container.append(this.renderer.domElement);this.cubeContainer=jQuery("#cubeContainer");this.cubeContainer.on("click",this.onDocumentMouseClick);this.cubeContainer.on("mousedown",this.onDocumentMouseDown);this.cubeContainer.on("mousemove",this.onDocumentMouseMove);this.cubeContainer.on("mouseup",this.onDocumentMouseUp);this.cubeContainer.on("mouseleave",this.onDocumentMouseUp);this.cubeContainer.on("wheel",this.onDocumentMouseWheel);var a=document.getElementById("cubeContainer");
a.addEventListener("touchstart",this.onDocumentTouchStart,!1);a.addEventListener("touchmove",this.onDocumentTouchMove,!1);jQuery("#cubeContainer").swipe({swipe:function(a,b,d,e,f){},threshold:10,pinchIn:function(a,b,d,e,f,h,g){b=Nigsys.getPinchCenter(g[0].start,g[1].start);a.originalEvent={offsetX:b.x,offsetY:b.y};d=10*d/jQuery("#cubeContainer").height();for(b=0;b<d;b++)CubePlugin.onDocumentMouseWheel(a,!0,1)},pinchOut:function(a,b,d,e,f,h,g){b=Nigsys.getPinchCenter(g[0].start,g[1].start);a.originalEvent=
{offsetX:b.x,offsetY:b.y};d=10*d/jQuery("#cubeContainer").height();for(b=0;b<d;b++)CubePlugin.onDocumentMouseWheel(a,!0,-1)},fingers:jQuery.fn.swipe.fingers.ALL});this.objectsScene.add(this.pinPointsObject)},addCube:function(a){null!=this.cubeMesh&&this.scene.remove(this.cubeMesh);var c=new THREE.CubeGeometry(3200,3200,3200,10,10,10);this.cubeMesh=new THREE.Mesh(c,a);this.cubeMesh.scale.x=-1;this.cubeMesh.material.side=THREE.DoubleSide;this.scene.add(this.cubeMesh)},loadCubeImages:function(a){for(var c=
this.getFaceOrderFromAngle(),b=0;b<c.length;b++)this.changeFaceImage(c[b],a)},changeFaceImage:function(a,c){if(a){var b=this.cubeFacesArray.indexOf(a);CubePlugin.getMaterialFromUrlDeferred(ImajnetAPI.buildImageURL(ImajnetMap.currentPosition,c,a)).done(function(a){CubePlugin.cubeMesh.material[b].dispose();CubePlugin.cubeMesh.material[b].map.dispose();CubePlugin.cubeMesh.material[b]=a})}},getMaterialFromUrlDeferred:function(a,c){var b=jQuery.Deferred(),d=new THREE.Texture,e=new THREE.MeshBasicMaterial({map:d,
overdraw:.5,side:THREE.DoubleSide}),f=new Image;f.crossOrigin="use-credentials";f.onload=function(){d.image=f;d.needsUpdate=!0;d.minFilter=THREE.LinearFilter;d.dispose();e.dispose();b.resolve(e,c)};f.src=a;return b.promise()},getMaterialFromUrl:function(a){var c=new THREE.Texture,b=new THREE.MeshBasicMaterial({map:c,overdraw:.5,side:THREE.DoubleSide}),d=new Image;d.crossOrigin="use-credentials";d.onload=function(){c.image=d;c.needsUpdate=!0;c.minFilter=THREE.LinearFilter;c.dispose();b.dispose()};
d.src=a;return b},getIntersection:function(a,c,b){var d=new THREE.Vector2;d.x=c/CubePlugin.renderer.domElement.width*2-1;d.y=2*-(b/CubePlugin.renderer.domElement.height)+1;CubePlugin.raycaster.setFromCamera(d,CubePlugin.camera);a=CubePlugin.raycaster.intersectObjects(a.children,!0);if(0<a.length)return a[0]},getRealImageCoordinatesFromCube:function(a,c){if(a&&c){var b=Math.round(a.x),d=Math.round(a.y),e=Math.round(a.z);if("FRONT"==c||"BACK"==c)var f={x:Math.abs(e+b/1600*1600),y:Math.abs(1600-d)};
else if("LEFT"==c||"RIGHT"==c)f={x:Math.abs(b-e/1600*1600),y:Math.abs(1600-d)};else if("UP"==c||"DOWN"==c)f={x:Math.abs(e+d/1600*1600),y:Math.abs(1600-b)};console.log(f);return f}},getRealImageCoordinatesFromEvent:function(a){return CubePlugin.getRealImageCoordinatesFromMousePosition(a.offsetX,a.offsetY)},getRealImageCoordinatesFromMousePosition:function(a,c){var b=CubePlugin.getIntersection(CubePlugin.scene,a,c),d=CubePlugin.getFaceFromPoint(b),b=CubePlugin.getRealImageCoordinatesFromCube(b.point,
d);return{x:b.x,y:b.y,face:d}},getCubeCoordinatesFromImageCoordinates:function(a,c){if(a&&(c=c?c:a.face)){var b=Math.round(a.x),d=Math.round(a.y);a=new THREE.Vector3;switch(c){case "FRONT":a.x=1600;a.y=1600-d;a.z=-1600+b;break;case "RIGHT":a.x=1600-b,a.y=1600-d,a.z=1600;case "LEFT":a.x=-1600+b,a.y=1600-d,a.z=-1600}return a}},getCubeCoordinatesFromEvent:function(a){return(a=CubePlugin.getIntersection(CubePlugin.scene,a.originalEvent.offsetX,a.originalEvent.offsetY))?a.point:null},getFaceFromPoint:function(a){if(a)return this.cubeFacesArray[a.face.materialIndex]},
getFaceOrderFromAngle:function(){var a=Math.ceil(this.yow/90);facesLoadOrder=[];switch(a){case 1:facesLoadOrder="FRONT RIGHT LEFT BACK UP UP".split(" ");break;case -0:facesLoadOrder="FRONT LEFT RIGHT BACK UP UP".split(" ");break;case 2:facesLoadOrder="RIGHT BACK LEFT FRONT UP UP".split(" ");break;case -1:facesLoadOrder="LEFT BACK RIGHT FRONT UP UP".split(" ")}return facesLoadOrder},setRotationLimit:function(a){a&&a.orientation&&(a=a.orientation.viewAngle-this.FOV,this.maxRotation.left=-a/2,this.maxRotation.right=
a/2)},onDocumentMouseClick:function(a){if(1==CubePlugin.mouseMoved)CubePlugin.mouseMoved=!1;else{var c=CubePlugin.getIntersection(CubePlugin.scene,a.offsetX,a.offsetY),b=c.point,d=Math.acos(b.y/Math.hypot(b.x,b.y,b.z)),b=THREE.Math.radToDeg(Math.atan2(b.z,b.x)),d=90-THREE.Math.radToDeg(d);console.log(b,d);d=CubePlugin.getFaceFromPoint(c);c=CubePlugin.getRealImageCoordinatesFromCube(c.point,d);switch(ImajnetUI.activeControlButton){case "imajnetPosition":ImajnetPosition.positionObject(c.x,c.y,{face:d});
break;case "imajnetMeasurement":ImajnetMeasurement.measureObject(c.x,c.y,{face:d});break;case "imajnetPolyligne":ImajnetMeasurement.onClick(c.x,c.y,{face:d})}ImageControler.currentPhotogrammetry.clearCommentTextarea(a)}},onDocumentMouseDown:function(a){a.preventDefault();CubePlugin.isUserInteracting=!0;CubePlugin.onPointerDownPointerX=a.offsetX;CubePlugin.onPointerDownPointerY=a.offsetY;CubePlugin.onPointerDownLon=CubePlugin.yow;CubePlugin.onPointerDownLat=CubePlugin.pitch},onDocumentMouseMove:function(a){if(!0===
CubePlugin.isUserInteracting){CubePlugin.mouseMoved=!0;var c=CubePlugin.cubeContainer.width()/CubePlugin.cubeContainer.height(),c=500/CubePlugin.cubeContainer.width()*c,b=CubePlugin.camera.fov/4,b=.008*b+5E-4*(b-1),d=(CubePlugin.onPointerDownPointerX-a.offsetX)*b*c+CubePlugin.onPointerDownLon;d>=CubePlugin.maxRotation.left&&d<=CubePlugin.maxRotation.right&&(CubePlugin.yow=d);CubePlugin.pitch=(a.offsetY-CubePlugin.onPointerDownPointerY)*b*c+CubePlugin.onPointerDownLat;ImajnetImageSwitcher.rotateImageSwitcher(-CubePlugin.yow);
ImajnetMap.setOrientationMarker(ImajnetMap.currentPosition,ImajnetMap.imajboxTriangleDimension,Nigsys.defaultObjectsColor,-1)}},onDocumentMouseUp:function(a){CubePlugin.isUserInteracting=!1},onDocumentTouchStart:function(a){1==a.touches.length&&(a.preventDefault(),CubePlugin.onPointerDownPointerX=a.touches[0].pageX,CubePlugin.onPointerDownPointerY=a.touches[0].pageY,CubePlugin.onPointerDownLon=CubePlugin.yow,CubePlugin.onPointerDownLat=CubePlugin.pitch)},onDocumentTouchMove:function(a){if(1==a.touches.length){a.preventDefault();
var c=.1*(CubePlugin.onPointerDownPointerX-a.touches[0].pageX)+CubePlugin.onPointerDownLon;c>CubePlugin.maxRotation.left&&c<CubePlugin.maxRotation.right&&(CubePlugin.yow=c);CubePlugin.pitch=.1*(a.touches[0].pageY-CubePlugin.onPointerDownPointerY)+CubePlugin.onPointerDownLat;ImajnetImageSwitcher.rotateImageSwitcher(-CubePlugin.yow);ImajnetMap.setOrientationMarker(ImajnetMap.currentPosition,ImajnetMap.imajboxTriangleDimension,Nigsys.defaultObjectsColor,-1)}},onDocumentMouseWheel:function(a,c,b){b||
(b=Nigsys.getDelta(a,b));if(!c&&!ImajnetZoom.canZoom()&&!ImajnetZoom.isZoomMode())0<b?ImageControler.currentImageControl.getNext(!1):ImageControler.currentImageControl.getPrevious(!1);else if(b){if(a=CubePlugin.getIntersection(CubePlugin.scene,a.originalEvent.offsetX,a.originalEvent.offsetY)){a=a.point;if(0<b){if(ImajnetZoom.zoomLevel>=ImajnetZoom.maxZoomLevel)return;ImajnetZoom.zoomLevel++;if(4==CubePlugin.camera.fov)return;ImajnetZoom.firstZoom&&(CubePlugin.loadCubeImages("high"),ImajnetZoom.firstZoom=
!1);b=Math.hypot(a.x,a.y,a.z);c=Math.acos(a.y/b);b=Math.atan2(a.z,a.x);b=THREE.Math.radToDeg(b);a=90-THREE.Math.radToDeg(c);c=Math.abs(b-CubePlugin.yow);c/=CubePlugin.camera.fov/2;var d=Math.abs(a-CubePlugin.pitch),d=d/(CubePlugin.camera.fov/2),e=.05*Math.ceil(ImajnetZoom.zoomLevel/3);c=.9<c?c*(2.2-e):c*(2.3-e);d=.9<d?d*(2.2-e):d*(2.3-e);CubePlugin.yow=b>CubePlugin.yow?CubePlugin.yow+c:CubePlugin.yow-c;CubePlugin.pitch=a>CubePlugin.pitch?CubePlugin.pitch+d:CubePlugin.pitch-d;CubePlugin.maxRotation.left-=
2;CubePlugin.maxRotation.right+=2;CubePlugin.camera.fov-=4}else{if(80==CubePlugin.camera.fov)return;ImajnetZoom.zoomLevel--;b=Math.hypot(a.x,a.y,a.z);c=Math.acos(a.y/b);b=Math.atan2(a.z,a.x);b=THREE.Math.radToDeg(b);a=90-THREE.Math.radToDeg(c);d=CubePlugin.camera.fov/2;c=Math.abs(b-CubePlugin.yow);c/=d;d=Math.abs(a-CubePlugin.pitch);d/=CubePlugin.camera.fov/2;e=.05*Math.ceil(ImajnetZoom.zoomLevel/3);c=.9<c?c*(2.2-e):c*(2.3-e);d*=2.3-e;CubePlugin.yow=b>CubePlugin.yow?CubePlugin.yow-c:CubePlugin.yow+
c;CubePlugin.pitch=a>CubePlugin.pitch?CubePlugin.pitch-d:CubePlugin.pitch+d;CubePlugin.camera.fov+=4;CubePlugin.maxRotation.left+=2;CubePlugin.maxRotation.right-=2}ImajnetMap.setOrientationMarker(ImajnetMap.currentPosition,ImajnetMap.imajboxTriangleDimension,Nigsys.defaultObjectsColor,-1)}CubePlugin.camera.updateProjectionMatrix()}},onWindowResize:function(){CubePlugin.camera.aspect=this.container.innerWidth()/this.container.innerHeight();CubePlugin.camera.updateProjectionMatrix();CubePlugin.renderer.setSize(this.container.innerWidth(),
this.container.innerHeight())},update:function(){CubePlugin.pitch=Math.max(-85,Math.min(85,CubePlugin.pitch));CubePlugin.phi=THREE.Math.degToRad(90-CubePlugin.pitch);CubePlugin.theta=THREE.Math.degToRad(CubePlugin.yow);CubePlugin.target.x=500*Math.sin(CubePlugin.phi)*Math.cos(CubePlugin.theta);CubePlugin.target.y=500*Math.cos(CubePlugin.phi);CubePlugin.target.z=500*Math.sin(CubePlugin.phi)*Math.sin(CubePlugin.theta);this.camera.lookAt(this.target);this.renderer.clear();this.renderer.render(this.scene,
this.camera);this.renderer.clearDepth();this.renderer.render(this.objectsScene,this.camera)}};
var ImageControl={PREVIOUS:"previous",NEXT:"next",isFastNavigation:!1,fastNavigationTimeout:null,getNext:function(a){ImajnetAPI.getByOrder(this.NEXT,a)},getPrevious:function(a){ImajnetAPI.getByOrder(this.PREVIOUS,a)},doOnLoadImage:function(a,b){var c=jQuery.Deferred();if(!ImajnetAPI.isImageValid(a.id))return c.resolve(!1),c.promise();ImajnetZoom.firstZoom=!0;ImajnetUI.imageSwitcherImage.hide();ImajnetUI.imageSwitcherImageContainer.hide();a&&a.timestamp?Imajnet.addImageDate(a.timestamp):ImajnetUI.hideDateContainer();
c.resolve(!0);return c.promise()},loadImage:function(a){},loadDefaultImage:function(a){this.setCurrentImage(a);ImajnetUI.appendDefaultImage()},imageChange:function(a){if(a)ImajnetPlugin.onImageChange(a)},setFastNavigation:function(){ImageControler.currentImageControl.isFastNavigation=!0},resetFastNavigation:function(){ImageControler.currentImageControl.isFastNavigation=!1},doRequests:function(a){ImajnetUI.fastNavigationLoadImagesQueue=[];ImageControler.currentImageControl.isFastNavigation||a&&ImajnetAPI.lastLoadedImageId!==
a.id||(a.lon&&a.lat&&ImajnetUrl.changeUrlParam(ImajnetUrl.LOCATION_URL_PARAM_NAME,a.lat+","+a.lon),ImageControler.currentSurveyTrace.draw(a),Address.getAddressFromCoordinates(a),LRS.loadLRS(a),jQuery.when(ImageControler.currentSurveyTrace.surveyTraceAjaxRequest,LRSRequest.LRSAjaxRequest).always(function(){ImajnetUI.onImageResize(!0);ImajnetAPI.lastLoadedImageId=a.id}),Nigsys.isPositionMode()?(ImageControler.currentPhotogrammetry.firstImagePosition&&ImajnetMap.currentPosition&&ImageControler.currentPhotogrammetry.firstImagePosition.traceId!=
ImajnetMap.currentPosition.traceId?ImajnetPosition.reload():ImajnetPosition.showHidePositionDenied(),ImajnetImageSwitcher.initSliderImagesDimension()):Nigsys.isMeasurementMode()?ImageControler.currentPhotogrammetry.firstImagePosition&&ImajnetMap.currentPosition&&ImageControler.currentPhotogrammetry.firstImagePosition.traceId!=ImajnetMap.currentPosition.traceId?ImajnetMeasurement.reload():ImajnetMeasurement.showHideMeasurementDenied():Nigsys.isPolyligneMode()?ImageControler.currentPhotogrammetry.firstImagePosition&&
ImajnetMap.currentPosition&&ImageControler.currentPhotogrammetry.firstImagePosition.traceId!=ImajnetMap.currentPosition.traceId&&1!=ImageControler.currentPhotogrammetry.currentStep?(ImageControler.currentPhotogrammetry.hidePreviewPanel(),ImageControler.currentPhotogrammetry.currentStep=1):1!=ImageControler.currentPhotogrammetry.currentStep%2&&ImajnetPolyligne.showHideDenied():ImajnetImageSwitcher.show(),ImajnetImageSwitcher.loadImageSwitcher(a),ImajnetUI.docking.imageButtons&&ImajnetUI.docking.imageButtons.mainContainer.show(),
Imajnet3dPosition.imageHas3D?Imajnet3dPosition.showPosition():Imajnet3dPosition.hidePosition())},setCurrentImage:function(a,b){a&&(ImajnetAPI.lastLoadedImageId=a.id);ImajnetAPI.clearHorizontalAngle();ImageControler.currentPhotogrammetry.clear();ImajnetMap.hideImageSwitcher();ImajnetImageSwitcher.clearImageSwitcher();ImajnetAPI.clearHorizontalAngle();Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()||ImajnetZoom.deactivateZoom();ImajnetPlugin.onImageChange(a);ImajnetPolyligne.constraintMeasurementData=
null;ImajnetPolyligne.isConstraint&&ImajnetPolyligne.getConstraintMeasurementData();a?(b&&(b.requestUrl&&ImajnetUI.appendImage(b.requestUrl),b.materials&&CubePlugin.addCube(b.materials)),ImajnetUI.showImajnetControls(),ImageControler.currentImageControl.doRequests(a)):(ImajnetUI.hideImageElements(),ImajnetMap.hideOrientation());Nigsys.hideLoading(ImajnetUI.imageContainer);ImajnetMap.setImajboxMarkerPosition({position:a},!0)}};
var FlatImage=Nigsys.cloneObject(ImageControl);
Nigsys.browserIsEdge()?FlatImage.loadImage=function(a){var c=jQuery.Deferred(),d="",b=a.position;if(b)d=ImajnetAPI.buildImageURL(b);else return ImajnetUI.imajnetImageContainer.css({"background-image":"none"}),ImajnetAPI.loadDefaultImage(null),c.resolve(),c.promise();a=ImajnetUI.imajnetImage.attr("src");-1==a.indexOf("noVideo.png")&&ImajnetUI.imajnetImageContainer.css({"background-image":"url("+a+")","background-size":"cover"});a=new Image;a.onerror=function(a){b&&ImajnetMap.currentPosition&&b.id==
ImajnetMap.currentPosition.id&&FlatImage.loadDefaultImage(b);c.resolve()};a.onload=function(){var a=new Date;ImajnetAPI.lastLoadedImageTime&&100>a-ImajnetAPI.lastLoadedImageTime?ImajnetAPI.lastLoadedImageId=b.id:(ImajnetAPI.lastLoadedImageTime=a,ImageControler.currentImageControl.doOnLoadImage(b,{requestUrl:d}).done(function(){c.resolve()}))};a.src=d;ImageControler.currentImageControl.isFastNavigation&&ImajnetUI.fastNavigationLoadImagesQueue.push(a);return c.promise()}:FlatImage.loadImage=function(a){var c=
jQuery.Deferred(),d="",b=a.position;if(b)d=ImajnetAPI.buildImageURL(b);else return ImajnetAPI.loadDefaultImage(null),c.resolve(),c.promise();a=new Image;a.onerror=function(a){b&&ImajnetMap.currentPosition&&b.id==ImajnetMap.currentPosition.id&&FlatImage.loadDefaultImage(b);c.resolve()};a.onload=function(){ImageControler.currentImageControl.doOnLoadImage(b,{requestUrl:d}).done(function(){c.resolve()})};a.src=d;ImageControler.currentImageControl.isFastNavigation&&ImajnetUI.fastNavigationLoadImagesQueue.push(a);
return c.promise()};FlatImage.doOnLoadImage=function(a,c){var d=jQuery.Deferred();ImageControl.doOnLoadImage(a,c).done(function(b){b?(CubeImage.hidecubeContainer(),FlatImage.showImageSliderContainer(),ImajnetImageSwitcher.rotateImageSwitcher(0),FlatImage.setCurrentImage(a,c)):Nigsys.hideLoading(ImajnetUI.imageContainer);d.resolve()});return d.promise()};FlatImage.showImageSliderContainer=function(){ImajnetUI.imajnetImageSliderContainer.show()};FlatImage.hideImageSliderContainer=function(){ImajnetUI.imajnetImageSliderContainer.hide()};
var CubeImage=Nigsys.cloneObject(ImageControl);
CubeImage.loadImage=function(a){var b=jQuery.Deferred(),c=a.position;if(!c)return ImajnetAPI.loadDefaultImage(null),b.resolve(),b.promise();if(CubePlugin.cubeMesh)CubePlugin.loadCubeImages();else{CubePlugin.init();animate();var d=Array(6),e=[];for(a=0;a<CubePlugin.cubeFacesArray.length;a++)e.push(CubePlugin.getMaterialFromUrlDeferred(ImajnetAPI.buildImageURL(c,null,CubePlugin.cubeFacesArray[a]),{position:a}).done(function(a,b){d[b.position]=a}))}e?jQuery.when.apply(jQuery,e).then(function(){ImageControler.currentImageControl.doOnLoadImage(c,
{materials:d}).done(function(){b.resolve()})},function(a){console.log("error");b.resolve()}):this.doOnLoadImage(c).done(function(){b.resolve()});return b.promise()};CubeImage.doOnLoadImage=function(a,b){var c=jQuery.Deferred();ImageControl.doOnLoadImage(a,b).done(function(d){d?(CubePlugin.setRotationLimit(a),FlatImage.hideImageSliderContainer(),CubeImage.showcubeContainer(),ImageControler.currentImageControl.setCurrentImage(a,b),c.resolve()):Nigsys.hideLoading(ImajnetUI.imageContainer)});return c.promise()};
CubeImage.getNext=function(){90>=CubePlugin.yow&&-90<=CubePlugin.yow?ImajnetAPI.getByOrder(this.NEXT,!1):ImajnetAPI.getByOrder(this.PREVIOUS,!1)};CubeImage.getPrevious=function(){90<CubePlugin.yow||-90>CubePlugin.yow?ImajnetAPI.getByOrder(this.NEXT,!1):ImajnetAPI.getByOrder(this.PREVIOUS,!1)};CubeImage.showcubeContainer=function(){CubePlugin.cubeContainer.show()};CubeImage.hidecubeContainer=function(){CubePlugin.cubeContainer&&CubePlugin.cubeContainer.hide()};
var SurveyTrace={positions:null,surveyTraceIsActive:!1,mustClearSequenceTraceMapMarker:!1,realImageSize:null,visibleSize:null,PINPOINT_DISTANCE_FACTOR:1.5,DIFFERENT_SEQUENCE_HEIGHT:2,colors:"#D60047 #27d949 #c2d927 #c24427 #c227ae #5f68dc #dc5fc9 #4bb7b1 #6fb74b #fd0505 #3bbfe5 #cfe53b #a900dc".split(" "),viewerCurrentPosition:null,container:null,sequenceTraceTitleContainer:null,projections:null,currentPositionId:null,currentSurveyTraceHTML:null,currentSurveyTraceResponse:null,surveyTraceAjaxRequest:null,
customDraw:function(){},moveImageToClickPosition:!0,draw:function(a){this.hideTrace();this.currentPositionId=null;a&&(!SurveyTrace.surveyTraceIsActive||Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()||this.getSurveyTrace(a.id,{draw:!0}),this.currentPositionId=a.id,this.viewerCurrentPosition=a,ImageControler.currentSurveyTrace.customDraw())},showHideSurveyTrace:function(){SurveyTrace.surveyTraceIsActive?(this.hideTrace(),jQuery("#imajnetTraceSurveyButtonContainer").removeClass("buttonActive")):
this.getSurveyTrace(this.currentPositionId,{draw:!0});SurveyTrace.surveyTraceIsActive=!SurveyTrace.surveyTraceIsActive;ImajnetUrl.changeUrlParam(ImajnetUrl.SURVEY_TRACE_URL_PARAM_NAME,SurveyTrace.surveyTraceIsActive?ImajnetUrl.SURVEY_TRACE_ACTIVE_PARAM_VALUE:"",!0)},restoreTrace:function(){},hideTrace:function(){},getSurveyTrace:function(a,b){if(!(Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode())&&(ImajnetZoom.deactivateZoom(),ImajnetAPI.mustAbortRequests&&null!==this.surveyTraceAjaxRequest&&
this.surveyTraceAjaxRequest.abort(),a)){jQuery("#imajnetTraceSurveyButtonContainer").addClass("buttonActive");var c={position:{id:a},radius:ImajnetSettings.imajnetSettings.surveyTrace,limit:ImajnetSettings.limitSurveyTrace,timeframe:ImajnetTimeframe.getTimeframe()};this.surveyTraceAjaxRequest=ImajnetAPI.doImajnetRequest("GET","/api/photogrammetry/image/visible/",c,this.surveyTraceReceived,this.surveyTraceError,null,null,!0,b)}},surveyTraceReceived:function(a,b){(a=JSON.parse(a))&&a.size?(SurveyTrace.realImageSize=
{width:a.size.width,height:a.size.height},"FLAT"==ImageControler.currentImageType&&(SurveyTrace.visibleSize={width:ImageControler.currentSurveyTrace.container.width(),height:ImageControler.currentSurveyTrace.container.height()}),b.draw?ImageControler.currentSurveyTrace.drawSurveyTrace(a):(ImageControler.currentSurveyTrace.projections=a.projections,ImageControler.currentSurveyTrace.positions=a.positions,ImageControler.currentSurveyTrace.goToClickPosition(b.event))):ImageControler.currentSurveyTrace.surveyTraceError()},
surveyTraceError:function(){ImageControler.currentSurveyTrace.hideTrace()},drawSurveyTrace:function(a){},getDistanceSizeFactor:function(a){return 0>=a?1:25<a?.16:1-a/30},getSequenceColor:function(a){return this.colors[a%(this.colors.length-1)]},computeImageAngle:function(a,b){360<a&&(a=360);0>a&&(a=360+a);360<b&&(b=360);0>b&&(b=360+b);var c=a-b;0>c&&(c=360+c);return c},calculateOrientationIndex:function(a,b){var c=this.computeImageAngle(a,b),c=Math.round(c/45);return 8==c?0:c},getPositionByIndexInArray:function(a){var b=
null;jQuery.each(this.positions,function(c,d){if(c==a)return b=d,!1});return b},moveImageToPosition:function(a){ImajnetZoom.left=-1;a=this.getPositionByIndexInArray(a);ImajnetAPI.setImajnetImage({position:a})},onImageResize:function(a,b){SurveyTrace.surveyTraceIsActive&&(SurveyTrace.visibleSize={width:a,height:b},ImageControler.currentSurveyTrace&&ImageControler.currentSurveyTrace.drawSurveyTrace())},showSequenceTraceMapMarker:function(a,b,c,d,e,f){a=this.getPositionByIndexInArray(a);ImajnetMap.setOrientationMarker(a,
ImajnetMap.imajboxOrientedImagesDimension,b,-2);this.mustClearSequenceTraceMapMarker=!0;ImageControler.currentSurveyTrace.sequenceTraceTitleContainer.html(c);ImajnetUI.showAndPositionInsideNear(this.container,{top:parseInt(d),left:parseInt(e),height:parseInt(f)},ImageControler.currentSurveyTrace.sequenceTraceTitleContainer);jQuery(this).addClass("opacity100")},hideSequenceTraceMapMarker:function(){ImajnetMap.hideSurveyTrace();this.mustClearSequenceTraceMapMarker=!1;ImageControler.currentSurveyTrace.sequenceTraceTitleContainer&&
ImageControler.currentSurveyTrace.sequenceTraceTitleContainer.hide();jQuery(".sequenceTraceTitleItem").hide();jQuery(this).removeClass("opacity100")},clearSurveyTraceMapMarkerIfNeeded:function(){this.mustClearSequenceTraceMapMarker&&this.hideSequenceTraceMapMarker()},clearSurveyTrace:function(){}};
var FlatSurveyTrace=Nigsys.cloneObject(SurveyTrace);FlatSurveyTrace.customDraw=function(){this.container=jQuery("#imajnetSurveyTraceLayer")};FlatSurveyTrace.restoreTrace=function(){!this.container||!ImajnetMap.currentPosition||Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()||(this.container.html(this.currentSurveyTraceHTML),ImageControler.currentSurveyTrace.sequenceTraceTitleContainer=jQuery("#sequenceTraceTitleContainer"),jQuery("#imajnetTraceSurveyButtonContainer").addClass("buttonActive"))};
FlatSurveyTrace.hideTrace=function(){null!==this.container&&(""!=this.container.html()&&(this.currentSurveyTraceHTML=this.container.html()),this.container.html(""))};FlatSurveyTrace.clearTrace=function(){this.sequenceTraceData=[];this.container&&this.container.html("");this.clearSurveyTraceMapMarkerIfNeeded()};
FlatSurveyTrace.drawSurveyTrace=function(a){if(!(Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode())&&ImajnetMap.currentPosition&&(this.container&&this.container.html(""),void 0===a?(this.currentSurveyTraceResponse&&ImajnetMap.currentPosition.id==this.currentSurveyTraceResponse.parameter.position.id&&(a=this.currentSurveyTraceResponse),this.currentSurveyTraceHTML=""):this.currentSurveyTraceResponse=a,SurveyTrace.realImageSize&&a&&a.projections&&a.positions)){var f=SurveyTrace.visibleSize.width/
SurveyTrace.realImageSize.width,k=SurveyTrace.visibleSize.height/SurveyTrace.realImageSize.height;this.projections=a.projections;this.positions=a.positions;for(a=0;a<this.projections.length;a++){if(0<=this.projections[a].coordinates.z){var c=this.projections[a].coordinates.x,d=this.projections[a].coordinates.y;if(0>c||c>SurveyTrace.realImageSize.width||0>d||d>SurveyTrace.realImageSize.height)return!1;var e=this.getSequenceColor(this.positions[a].traceId),b=60*this.getDistanceSizeFactor(this.projections[a].coordinates.z),
l=Imajnet.imajnetPath+"img/orientation/"+["A1_up.png?"+Imajnet.version,"A1_right_up.png?"+Imajnet.version,"A1_right.png?"+Imajnet.version,"A1_right_down.png?"+Imajnet.version,"A1_down.png?"+Imajnet.version,"A1_Left_down.png?"+Imajnet.version,"A1_Left.png?"+Imajnet.version,"A1_Left_up.png?"+Imajnet.version][this.calculateOrientationIndex(this.viewerCurrentPosition.orientation.yaw,this.positions[a].orientation.yaw)],b=150,h=this.projections[a].coordinates.z,g=b/h*2,b=b/2/h*2,d=Math.min(Math.max(d*k,
0+b/2),this.container.height()-b/2)-.6*b/2,c=Math.min(Math.max(c*f,0+g/2),this.container.width()-g/2)-g/2,h=jQuery.imajnet.map.surveyTrace.distance+": "+this.projections[a].coordinates.z.toFixed(2)+" "+jQuery.imajnet.map.surveyTrace.meters+(this.viewerCurrentPosition.traceId!=this.positions[a].traceId?" | "+jQuery.imajnet.map.surveyTrace.date+": "+this.positions[a].timestamp:"");this.container.append('\x3cdiv id\x3d"imageSurveyTrace_'+a+'" class\x3d"imageSurveyTrace opacity60" '+('onclick\x3d"ImageControler.currentSurveyTrace.moveImageToPosition('+
a+');" onmouseover\x3d"ImageControler.currentSurveyTrace.showSequenceTraceMapMarker('+a+",'"+e+"', '"+h+"', '"+d+"', '"+c+"', '"+b+'\');" onmouseout\x3d"ImageControler.currentSurveyTrace.hideSequenceTraceMapMarker();"')+(' style\x3d"position: absolute; top: '+d+"px; left: "+c+"px; width: "+g+"px; height:"+b+"px; background-color: "+e+'; z-index: 2;"')+'\x3e\x3cimg src\x3d"'+l+'" align\x3d"left" width\x3d"'+g+'" height\x3d"'+b+'" /\x3e\x3c/div\x3e')}this.container.append('\x3cdiv class\x3d"sequenceTraceTitleItem" id\x3d"sequenceTraceTitleContainer"\x3e\x3c/div\x3e');
ImageControler.currentSurveyTrace.sequenceTraceTitleContainer=jQuery("#sequenceTraceTitleContainer")}0<ImajnetZoom.zoomLevel&&this.hideTrace()}};FlatSurveyTrace.clearSurveyTrace=function(){this.sequenceTraceData=[];this.container&&this.container.html("");this.clearSurveyTraceMapMarkerIfNeeded()};
FlatSurveyTrace.onImageDbClick=function(a){SurveyTrace.surveyTraceIsActive?ImageControler.currentSurveyTrace.goToClickPosition(a):ImageControler.currentSurveyTrace.getSurveyTrace(ImajnetMap.currentPosition.id,{event:a})};
FlatSurveyTrace.goToClickPosition=function(a){if(ImageControler.currentSurveyTrace.positions){var f=ImajnetUI.imajnetImageContainer.offset();a=ImajnetZoom.getRealImageCoordinates(a.clientX-f.left,a.clientY-f.top);for(var f=ImajnetZoom.getRealImageSize().height,k=ImajnetMap.currentPosition.traceId,c=null,d=999999,e=0;e<ImageControler.currentSurveyTrace.positions.length;e++)if(k==ImageControler.currentSurveyTrace.positions[e].traceId){var b=Math.abs(ImageControler.currentSurveyTrace.projections[e].coordinates.y-
a.y);!(b>f)&&b<d&&(c=ImageControler.currentSurveyTrace.positions[e],d=b)}ImajnetAPI.setImajnetImage({position:c})}};
var CubeSurveyTrace=Nigsys.cloneObject(SurveyTrace);CubeSurveyTrace.customDraw=function(){};
var Photogrammetry={objects:[],currentStep:1,firstImagePosition:null,existingProjections:[],projectionAjaxRequest:null,timerItemClipboardClick:null,currentConstraintData:null,constraintParameter:null,constraintAjaxRequest:null,clipboardActive:!0,imajnetProjectionsDataObject:null,exportToItemContent:"",currentHoverObjectId:"",onFeatureMouseOver:function(a,b,c){var d=ImajnetPolyligne.isPolyligneObject(a.getId());d&&(a=ImajnetMap.getPolyligneFeatureWrapper(a));d||a.getType()!=ImajnetMap.MARKER_TYPE_POSITION&&
a.getType()!=ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION&&a.getType()!=ImajnetMap.MARKER_TYPE_TARGET_POINT?(ImajnetPlugin.selectFeature(ImajnetMap.imajnetDragFeaturesLayer,a),ImajnetPlugin.selectPolygonFeature(ImajnetMap.imajnetDragFeaturesLayer,a),ImajnetPlugin.setFeatureColor(ImajnetMap.imajnetDragFeaturesLayer,a,Nigsys.hoverObjectsColor),ImajnetPlugin.setFeatureStrokeColor(ImajnetMap.imajnetDragFeaturesLayer,a,Nigsys.hoverObjectsColor)):ImajnetPlugin.selectMarker(ImajnetMap.photogrammetryPositionsLayer,
a);ImajnetPlugin.onFeatureMouseOver(a,b,c)},onFeatureMouseOut:function(a){if(a){var b=ImajnetPolyligne.isPolyligneObject(a.getId());b&&(a=ImajnetMap.getPolyligneFeatureWrapper(a));b||a.getType()!=ImajnetMap.MARKER_TYPE_POSITION&&a.getType()!=ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION&&a.getType()!=ImajnetMap.MARKER_TYPE_TARGET_POINT?(ImajnetPlugin.unselectFeature(ImajnetMap.imajnetDragFeaturesLayer,a),ImajnetPlugin.unselectPolygonFeature(ImajnetMap.imajnetDragFeaturesLayer,a),ImajnetPlugin.setFeatureColor(ImajnetMap.imajnetDragFeaturesLayer,
a,Nigsys.defaultObjectsColor),ImajnetPlugin.setFeatureStrokeColor(ImajnetMap.imajnetDragFeaturesLayer,a,Nigsys.defaultObjectsColor)):ImajnetPlugin.unselectMarker(ImajnetMap.photogrammetryPositionsLayer,a);ImajnetPlugin.onFeatureMouseOut(a)}},onImageTagMouseOver:function(a,b,c,d){ImageControler.currentPhotogrammetry.showLRS(b,d,a,c)},onImageTagMouseOut:function(a){jQuery('div[id\x3d"imajnetPhotogrammetryLRS_'+a+'"]').hide()},onPhotogrammetryItemMouseOver:function(a,b,c,d){var e=ImajnetMap.getFeatureWrapperById(a);
e&&(ImageControler.currentPhotogrammetry.currentHoverObjectId=a,ImageControler.currentPhotogrammetry.showLRS(b,d,a,c),ImajnetPlugin.highlightFeatureOnImage(e),ImageControler.currentPhotogrammetry.onFeatureMouseOver(e,b,d))},onPhotogrammetryItemMouseOut:function(a){var b=ImajnetMap.getFeatureWrapperById(a);b&&(jQuery("#imajnetPhotogrammetryLRS_"+a).hide(),jQuery("#textareaEditComment_"+a).is(":visible")||(ImageControler.currentPhotogrammetry.currentHoverObjectId="",ImajnetPlugin.unHighlightFeatureOnImage(b),
ImageControler.currentPhotogrammetry.onFeatureMouseOut(b)))},onPhotogrammetryItemClick:function(a){if(a=ImajnetMap.getFeatureWrapperById(a))ImajnetPlugin.zoomMapToFeatureWrapper(a),ImajnetPlugin.onFeatureClick(a)},init:function(){if(!ImageControler.currentPhotogrammetry.objects.length&&(ImageControler.currentPhotogrammetry.clipboardEmpty(),Photogrammetry.clipboardActive)){var a=Nigsys.getCookie("IMAJNET","CLIPBOARD");Nigsys.setCookie("IMAJNET","CLIPBOARD",null);if(a){for(var b=[],c=0;c<a.length;c++)for(var d=
0;d<a[c].data.length;d++)if(-1===jQuery.inArray(a[c].data[d].type,ImajnetPolyligne.typesArray)||a[c].data[d].points&&0!=a[c].data[d].points.length){if(a[c].data[d].objectId){if(-1!==jQuery.inArray(a[c].data[d].type,ImajnetPolyligne.typesArray)){a[c].data.splice(d,1);d--;continue}a[c].data[d].id=a[c].data[d].objectId}try{ImageControler.currentPhotogrammetry.addObject(ImageControler.currentPhotogrammetry.getPositionFromObject(a[c].data[d]),a[c].data[d],!1,!1,!1,!0),ImageControler.currentPhotogrammetry.getObjectLRS(a[c].data[d]),
b.push(ImageControler.currentPhotogrammetry.getObjectClipboardHTML(a[c].data[d]))}catch(e){console.warn(e)}}else{a[c].data.splice(d,1);try{ImageControler.currentPhotogrammetry.deletePhotogrammetryItem(a[c].data[d].id)}catch(e){}d--}jQuery("#"+ImajnetUI.clipboardContainerId+"Content").on("click",function(a,b){Nigsys.stringContains(a.target.className,"textAreaEditClipboardComment")||(jQuery(".imajnetClipboardTextareaComment").hide(),jQuery(".imajnetClipboardCommentContainer").show())});a.length&&(jQuery("#"+
ImajnetUI.clipboardContainerId+"Content").html(b.join("")),jQuery("#popupImajnetClipboardClearButton").prop("disabled",!1),jQuery("#popupImajnetClipboardExportButton").prop("disabled",!1));ImajnetMap.drawPhotogrammetryObjects();this.updateCache()}}},enableClipboard:function(){Photogrammetry.clipboardActive=!0},disableClipboard:function(){Photogrammetry.clipboardActive=!1;ImageControler.currentPhotogrammetry&&ImageControler.currentPhotogrammetry.deletePhotogrammetryObjects()},getExportContent:function(){return'\x3cdiv\x3e\x3cdiv class\x3d"popupContentContainer optionsGroup"\x3e\x3cdiv class\x3d"popupContentContainerTitle"\x3e'+
jQuery.imajnet.map.clipboard.popupExport.email+'\x3c/div\x3e\x3cdiv\x3e\x3cdiv class\x3d"leftLabel left"\x3e'+jQuery.imajnet.map.clipboard.popupExport.from+':\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"imajnetExportFrom" value\x3d"'+ImajnetUser.getEmail()+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetExportToContainer"\x3e\x3cb\x3e'+this.exportToItemContent+'\x3c/b\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"button" value\x3d"+" onclick\x3d"ImageControler.currentPhotogrammetry.exportAddToItem();" /\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"popupContentContainerTitle"\x3e'+
jQuery.imajnet.map.clipboard.popupExport.message+'\x3c/div\x3e\x3cdiv\x3e\x3ctextarea id\x3d"imajnetExportMessage" rows\x3d"5" cols\x3d"45"\x3e\x3c/textarea\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"popupContentContainer optionsGroup"\x3e\x3cdiv class\x3d"popupContentContainerTitle" style\x3d"top: -13px;"\x3e'+jQuery.imajnet.map.clipboard.popupExport.fileType+'\x3c/div\x3e\x3cinput type\x3d"radio" name\x3d"imajnetExportType" value\x3d"kml" /\x3eKML\x26nbsp;\x3cinput type\x3d"radio" name\x3d"imajnetExportType" value\x3d"kmz" checked\x3d"checked" /\x3eKMZ\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"popupContentContainer optionsGroup"\x3e\x3cdiv class\x3d"popupContentContainerTitle" style\x3d"top: -11px;"\x3e'+
jQuery.imajnet.map.clipboard.popupExport.exportStatus+'\x3c/div\x3e\x3cdiv id\x3d"imajnetExportStatus"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetExportButtons"\x3e\x3cinput disabled type\x3d"button" value\x3d"'+jQuery.imajnet.map.clipboard.popupExport.send+'" onclick\x3d"ImageControler.currentPhotogrammetry.exportObjects(true);" id\x3d"exportSendButton" class\x3d"dialogButton buttonSend" /\x3e\x26nbsp;\x3cinput type\x3d"button" value\x3d"'+jQuery.imajnet.map.clipboard.popupExport.download+
'" onclick\x3d"ImageControler.currentPhotogrammetry.exportObjects(false);" class\x3d"dialogButton buttonDownload" /\x3e\x3c/div\x3e\x3c/div\x3e'},getImageObjectList:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)if(void 0!==a&&ImageControler.currentPhotogrammetry.objects[b].positionId==a.id)return ImageControler.currentPhotogrammetry.objects[b].data;return null},getImagePreviousObject:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=
0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(-1!==jQuery.inArray(ImageControler.currentPhotogrammetry.objects[b].data[c].type,ImajnetPolyligne.typesArray)&&ImageControler.currentPhotogrammetry.objects[b].data[c].id==a-1)return ImageControler.currentPhotogrammetry.objects[b].data[c];return null},getImageNextObject:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(-1!==
jQuery.inArray(ImageControler.currentPhotogrammetry.objects[b].data[c].type,ImajnetPolyligne.typesArray)&&ImageControler.currentPhotogrammetry.objects[b].data[c].id==a+1)return ImageControler.currentPhotogrammetry.objects[b].data[c];return null},getImageObjectLinkToNext:function(a,b){for(var c=[],d=0;d<ImageControler.currentPhotogrammetry.objects.length;d++)for(var e=0;e<ImageControler.currentPhotogrammetry.objects[d].data.length;e++)-1!==jQuery.inArray(ImageControler.currentPhotogrammetry.objects[d].data[e].type,
ImajnetPolyligne.typesArray)&&ImageControler.currentPhotogrammetry.objects[d].data[e].type==b&&(ImageControler.currentPhotogrammetry.objects[d].data[e].id==a+1?c.push(ImageControler.currentPhotogrammetry.objects[d].data[e]):ImageControler.currentPhotogrammetry.objects[d].data[e].id==a-1&&c.push(ImageControler.currentPhotogrammetry.objects[d].data[e]));return c},getMesurementValueById:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(ImageControler.currentPhotogrammetry.objects[b].data[c].id==
a&&ImageControler.currentPhotogrammetry.objects[b].data[c].measurementResult&&ImageControler.currentPhotogrammetry.objects[b].data[c].measurementResult.measurement)return ImageControler.currentPhotogrammetry.objects[b].data[c].measurementResult.measurement;return""},objectIsMeasurement:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(ImageControler.currentPhotogrammetry.objects[b].data[c].id==
a&&ImageControler.currentPhotogrammetry.objects[b].data[c].photogrammetryPosition3D)return!0;return!1},objectIsDifferentTracePinPointProjection:function(a){if(ImajnetMap.currentPosition){for(var b=0;b<this.existingProjections.length;b++)if(this.existingProjections[b].parameter.pointOfView.id==ImajnetMap.currentPosition.id&&this.existingProjections[b].projection.shapeProjections)for(var c=0;c<this.existingProjections[b].projection.shapeProjections.length;c++)if(this.existingProjections[b].projection.shapeProjections[c]&&
this.existingProjections[b].projection.shapeProjections[c].id==a&&this.existingProjections[b].projection.shapeProjections[c].projections)return!0;return!1}},getPanelCoordinatesFromHighCoordinates:function(a){var b=ImajnetUI.previewImageContainer.width(),c=ImajnetUI.previewImageContainer.height();return{x:a.x/(ImajnetZoom.HIGH_RESOLUTION_WIDTH/b),y:a.y/(ImajnetZoom.HIGH_RESOLUTION_HEIGHT/c)}},getPreviewPanelPoint:function(a,b,c){a=ImajnetZoom.getCoordinatesAtCurrentZoom(this.getPanelCoordinatesFromHighCoordinates(a),
b);return{x:a.x-Math.abs(c.left),y:a.y-Math.abs(c.top)}},getImageIndexInCacheArrayByImageId:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.existingProjections.length;b++)if(ImageControler.currentPhotogrammetry.existingProjections[b].parameter.pointOfView.id==a)return ImageControler.currentPhotogrammetry.existingProjections[b];return null},getPinPoints:function(){var a=null;jQuery.each(ImageControler.currentPhotogrammetry.objects,function(b,c){void 0!=c.photogrammetryPosition3D&&(a=
c.data)});return a},getMeasurements:function(){var a=null;jQuery.each(ImageControler.currentPhotogrammetry.objects,function(b,c){void 0!=c.photogrammetryPosition3D&&(a=c.data)});return a},getMeasurementTextPosition:function(a,b){var c=(a.x+b.x)/2,d=(a.y+b.y)/2;if(a.x==b.x)return{x:c+3,y:d-3};var e=(b.y-a.y)/(b.x-a.x);0<e&&(30<Math.abs(a.y-b.y)?(c-=35,d-=5):(c-=10,d-=20));0>e&&(c+=2);0==e&&(c-=5,d+=2);return{x:Math.round(c),y:Math.round(d)}},getPositionFromObject:function(a){return 0==a.id||void 0!==
a.coordinates?a.position:a.parameter.imagePoint?a.parameter.imagePoint.img1:a.parameter.imagePoint1.img1},getObjectById:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(ImageControler.currentPhotogrammetry.objects[b].data[c].id==a)return ImageControler.currentPhotogrammetry.objects[b].data[c];return null},setRedStep:function(a){for(var b=1;3>=b;b++)b==a?(jQuery("#imajnetPreviewPanelItem"+
b).addClass("redStep"),jQuery("#imajnetPreviewPanelItemArrow"+b).css("background-image","url('"+Imajnet.imajnetPath+"img/imageIcons/arrowRight.png')")):(jQuery("#imajnetPreviewPanelItem"+b).removeClass("redStep"),jQuery("#imajnetPreviewPanelItemArrow"+b).css("background-image","url('"+Imajnet.imajnetPath+"img/imageIcons/arrowRightTransparent.png')"))},setCurrentPreviewStep:function(){if(!ImajnetUI.isPreviewPanelDisabled()){var a=Nigsys.isPositionMode()?"position":ImajnetPolyligne.type,a=jQuery.imajnet.map[a]["step"+
(0==ImageControler.currentPhotogrammetry.currentStep%2?2:ImageControler.currentPhotogrammetry.currentStep)+"Content"];jQuery("#imajnetPreviewPanelContent").html(a)}},setIdByPosition:function(a){var b="",c=ImageControler.currentPhotogrammetry.getImageObjectList(a);if(null!==c)for(var d=c.length-1;-1<d;d--){var e=null;void 0!==c[d].photogrammetryPosition3D?e=c[d].photogrammetryPosition3D.coordinates:void 0!==c[d].measurementResult?e=Nigsys.getClosestPoint(ImajnetMap.currentPosition,c[d].measurementResult.firstPoint,
c[d].measurementResult.secondPoint):void 0!==c[d].position&&(e=c[d].position);if(null!==e&&e.lon==a.lon&&e.lat==a.lat&&e.height==a.height){b=c[d].id;break}}return b},setPreviewPanelVisibleRegion:function(a,b){var c=ImajnetUI.previewImageContainer.width(),d=ImajnetUI.previewImageContainer.height(),e=c*b,f=d*b,g=this.getPanelCoordinatesFromHighCoordinates(a),g=ImajnetZoom.getCoordinatesAtCurrentZoom(g,b),h=g.x-c/2;e-Math.abs(h)<c&&(h=e-c);var k=g.y-d/2;f-Math.abs(k)<d&&(k=f-d);k=-1*Math.abs(Math.round(k));
h=-1*Math.abs(Math.round(h));g.x<c/2&&(h=0);g.y<d/2&&(k=0);ImajnetUI.previewImage.css("width",Math.round(e)+"px");ImajnetUI.previewImage.css("height",Math.round(f)+"px");ImajnetUI.previewImage.css("top",k+"px");ImajnetUI.previewImage.css("left",h+"px");return{top:k,left:h}},photogrammetryIsDenied:function(){return this.firstImagePosition&&ImajnetMap.currentPosition&&ImajnetMap.currentPosition.id==this.firstImagePosition.id&&!Nigsys.isPolyligneMode()&&0==this.currentStep%2},onResize:function(a,b){var c=
Math.round(b/2)-50,d=Math.round(a/2)-50;jQuery("#positionDenied").css("top",c);jQuery("#positionDenied").css("left",d);jQuery("#measurementDenied").css("top",c);jQuery("#measurementDenied").css("left",d);jQuery("#polyligneDenied").css("top",c);jQuery("#polyligneDenied").css("left",d);Nigsys.isMeasurementMode()?(ImajnetMeasurement.onImageResize(),this.drawConstraints()):Nigsys.isPositionMode()&&this.drawConstraints();this.redraw(!1)},showLRS:function(a,b,c,d){var e=jQuery('div[id\x3d"imajnetPhotogrammetryLRS_'+
c+'"]');if(!e.length||""!=e.html())if(d==ImajnetUI.clipboardContainerId){var f=jQuery("#LRSClipboard_"+c);0!=f.length?(Nigsys.positionExistingElement(a,b,d,f),f.show()):(c='\x3cdiv id\x3d"LRSClipboard_'+c+'" class\x3d"photogrammetryClipboardPopup"\x3e'+e.html()+"\x3c/div\x3e",Nigsys.addElement(a,b,ImajnetUI.clipboardContainerId,c))}else Nigsys.positionExistingElement(a,b,d,e),e.show()},addImageTag:function(a){var b=ImajnetUI.imajnetImageContainer.offset();a={position:ImajnetMap.currentPosition,coordinates:ImajnetZoom.getRealImageCoordinates(a.clientX-
b.left,a.clientY-b.top),type:ImajnetMap.MARKER_TYPE_IMAGE_TAG,linkToNext:!1};b=this.addObject(ImajnetMap.currentPosition,a,!1,!0,!0);this.getObjectLRS({id:b.id,photogrammetryPosition3D:{coordinates:ImajnetMap.currentPosition}});ImageControler.currentPhotogrammetry.appendImageTag(b.id,a.coordinates)},showComment:function(a,b,c,d,e){if(!(0==c||isNaN(c)&&-1!==c.indexOf("Projection"))){var f=jQuery("#LRSDoubleClickComment_"+c),f=0!=f.length?f.html():"";Nigsys.addElement(a,b,d,'\x3ctextarea id\x3d"'+e+
c+'" class\x3d"textareaEditComment" onkeydown\x3d"ImageControler.currentPhotogrammetry.saveComment(event, \''+c+"', '"+e+'\');" cols\x3d"25" style\x3d"height: 28px;"\x3e'+f+"\x3c/textarea\x3e");jQuery("textarea#"+e+c).focus().enableSelection();Nigsys.disableEventPropagation(a)}},showCommentInClipboard:function(a,b){ImajnetUI.clipboardOpenCommentId=b;jQuery(".imajnetClipboardTextareaComment").hide();jQuery(".imajnetClipboardCommentContainer").show();jQuery("#imajnetClipboardComment_"+b).hide();var c=
jQuery("#LRSDoubleClickComment_"+b),d=0!=c.length?c.html():"",c=jQuery("textarea#textAreaEditClipboardComment_"+b);c.val(d);d=c.parent().parent().offset();c.css("top",d.top).css("left",d.left);jQuery("#imajnetClipboardTextareaComment_"+b).show();c.focus()},appendCommentOnPhotogrammetryItemContainer:function(a,b){b||(b="");ImageControler.currentPhotogrammetry.getObjectById(a).comment=b;jQuery(".LRSDoubleClickMessage_"+a).html('\x3cdiv id\x3d"LRSDoubleClickComment_'+a+'" class\x3d"LRSDoubleClickComment"\x3e'+
b+"\x3c/div\x3e"+jQuery.imajnet.map.clipboard.doubleClick);jQuery("#imajnetClipboardCommentContainer_"+a).html(b);var c=jQuery('div[id\x3d"imajnetPhotogrammetryLRS_'+a+'"]').html();jQuery("#LRSClipboard_"+a).html(c?c:"")},saveComment:function(a,b,c){var d=a.keyCode?a.keyCode:a.which;13==d?(ImageControler.currentPhotogrammetry.appendCommentOnPhotogrammetryItemContainer(b,jQuery("textarea#"+c+b).val()),ImageControler.currentPhotogrammetry.updateCache(),"textareaEditComment_"==c?(jQuery("#"+c+b).remove(),
ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOut(b)):ImageControler.currentPhotogrammetry.closeTextarea(b)):27==d&&(ImageControler.currentPhotogrammetry.closeTextarea(b),Nigsys.disableEventPropagation(a))},imageMouseMovePreviewPanel:function(a){var b=ImajnetUI.imajnetImageContainer.offset();!(Nigsys.isPositionMode()&&2==ImageControler.currentPhotogrammetry.currentStep||Nigsys.isMeasurementMode()&&2==ImageControler.currentPhotogrammetry.currentStep||Nigsys.isPolyligneMode()&&0==ImageControler.currentPhotogrammetry.currentStep%
2)||a.clientX-b.left>=ImajnetUI.imajnetImageContainerSize.width-ImajnetUI.previewImageContainer.width()&&a.clientY-b.top>=ImajnetUI.imajnetImageContainerSize.height-ImajnetUI.previewImageContainer.height()?ImajnetUI.previewImageContainer.hide():ImageControler.currentPhotogrammetry.showPreviewPanel()},previewPanelMouseOver:function(){ImajnetUI.previewImageContainer.hide()},clearCommentTextarea:function(a){if(!a||!Nigsys.stringContains(a.target.className,"textareaEditComment")){jQuery(".textareaEditComment").hide();
a=jQuery(".textareaEditComment");for(var b=0;b<a.length;b++)ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOut(a[b].id.replace("textareaEditComment_",""));jQuery(".textareaEditComment").remove()}},closeTextarea:function(a){ImajnetUI.clipboardOpenCommentId="";jQuery("#imajnetClipboardTextareaComment_"+a).hide();jQuery("#imajnetClipboardComment_"+a).show()},updateCache:function(){if(Photogrammetry.clipboardActive){for(var a=[],b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++){for(var c=
{positionId:ImageControler.currentPhotogrammetry.objects[b].positionId,data:[]},d=0;d<ImageControler.currentPhotogrammetry.objects[b].data.length;d++)ImageControler.currentPhotogrammetry.objects[b].data[d].type!=ImajnetMap.MARKER_TYPE_CLICKED_POINT&&c.data.push(ImageControler.currentPhotogrammetry.objects[b].data[d]);c.data.length&&a.push(c)}Nigsys.setCookie("IMAJNET","CLIPBOARD",a)}else Nigsys.setCookie("IMAJNET","CLIPBOARD",null)},deletePrevObjects:function(){Photogrammetry.clipboardActive||ImageControler.currentPhotogrammetry.deletePhotogrammetryObjects()},
getLastObjectId:function(){for(var a=1,b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(ImageControler.currentPhotogrammetry.objects[b].data[c].id>=a&&(a=ImageControler.currentPhotogrammetry.objects[b].data[c].id+1),ImageControler.currentPhotogrammetry.objects[b].data[c].points)for(var d=0;d<ImageControler.currentPhotogrammetry.objects[b].data[c].points.length;d++)ImageControler.currentPhotogrammetry.objects[b].data[c].points[d].id>=
a&&(a=ImageControler.currentPhotogrammetry.objects[b].data[c].points[d].id+1);for(b=0;b<ImajnetMap.featureWrappers.length;b++)a<=ImajnetMap.featureWrappers[b].getId()&&(a=ImajnetMap.featureWrappers[b].getId()+1);return a},addObject:function(a,b,c,d,e,f){b.id||0==b.id||(b.id=this.getLastObjectId());ImajnetPolyligne.isPolyligneObject(b.id)||(b.measurement=ImageControler.currentPhotogrammetry.getMeasurement(b));0!=b.id||b.photogrammetryPosition3D.coordinates.height||(b.photogrammetryPosition3D.coordinates.height=
0);var g=this.getImageObjectList(a);null===g?ImageControler.currentPhotogrammetry.objects.push({positionId:0==b.id?"":b.position&&b.position.id?b.position.id:a.id,data:Array(b)}):g.push(b);0<b.id&&!f&&this.updateCache();c||f||this.drawObjectClipboard(b,d);e&&ImajnetMap.drawPhotogrammetryObjects();return b},appendLRSContainer:function(a,b){var c=0==b?0:this.setIdByPosition(a);c||(c=b);if(jQuery("#imajnetPhotogrammetryLRS_"+c).length)return c;jQuery("#popupImajnetControlsLayer").append('\x3cdiv id\x3d"imajnetPhotogrammetryLRS_'+
c+'" class\x3d"photogrammetryPopup"\x3e'+(0==c?"":'\x3cdiv class\x3d"LRSDoubleClickMessage LRSDoubleClickMessage_'+c+'"\x3e'+jQuery.imajnet.map.clipboard.doubleClick+"\x3c/div\x3e")+"\x3c/div\x3e");LRS.getLRSForPosition(a,b);Nigsys.browserIsIE7()||Nigsys.browserIsIE8()||jQuery('div[id\x3d"imajnetPhotogrammetryLRS_'+c+'"]').corner();return c},getObjectLRS:function(a){if(a&&ImajnetMap.currentPosition){if(a.coordinates||a.photogrammetryPosition3D&&a.photogrammetryPosition3D.coordinates){var b="",b=a.position?
a.position.id:a.parameter?a.parameter.imagePoint.img1.id:a.photogrammetryPosition3D.coordinates.id,b={id:b,traceId:ImajnetMap.currentPosition.traceId,height:a.position?a.position.height:a.photogrammetryPosition3D.coordinates.height,lat:a.position?a.position.lat:a.photogrammetryPosition3D.coordinates.lat,lon:a.position?a.position.lon:a.photogrammetryPosition3D.coordinates.lon};this.appendLRSContainer(b,a.id)}else if(void 0!==a.measurementResult&&void 0!==a.measurementResult.firstPoint&&void 0!==a.measurementResult.secondPoint){if(!a.parameter)return;
b=Nigsys.getClosestPoint(a.parameter.imagePoint1.img1,a.measurementResult.firstPoint,a.measurementResult.secondPoint);b={id:a.parameter.imagePoint1.img1.id,traceId:ImajnetMap.currentPosition.traceId,height:b.height,lat:b.lat,lon:b.lon};this.appendLRSContainer(b,a.id)}else"polyligne"==a.type?(b=ImajnetPolyligne.getCurrentObjectMiddlePoint(a),this.appendLRSContainer({id:b.id,traceId:b.traceId,height:b.height,lat:b.lat,lon:b.lon},a.id)):"polygon"==a.type&&(b=ImajnetPolyligne.getCurrentObjectMiddlePoint(a),
this.appendLRSContainer({id:b.id,traceId:b.traceId,height:b.height,lat:b.lat,lon:b.lon},a.id));ImageControler.currentPhotogrammetry.appendCommentOnPhotogrammetryItemContainer(a.id,a.comment)}},draw:function(a){jQuery(".photogrammetryPopup").hide();this.drawPhotogrammetryObjects();a&&0!=ImageControler.currentPhotogrammetry.currentStep%2||this.getImajnetObjectsToProject()},redraw:function(a,b){(Nigsys.isPositionMode()||Nigsys.isPolyligneMode())&&this.drawConstraints();this.clear();this.draw(b);a&&ImajnetMap.drawPhotogrammetryObjects();
ImajnetProjection.draw();return jQuery.Deferred().resolve().promise()},appendMapMarker:function(a,b){ImajnetUI.popupImajnetControlsLayer.append(marker)},appendImageTag:function(a,b){},drawLine:function(a,b,c,d,e){},openImageWithPhotogrammetryObject:function(a){ImageControler.currentPhotogrammetry.goToImage(a)},drawConstraints:function(){ImageControler.currentGraphic.clearConstraints();if(this.currentConstraintData&&jQuery.isArray(this.currentConstraintData)&&this.firstImagePosition&&!this.photogrammetryIsDenied()&&
(!Nigsys.isPolyligneMode()||1!=ImageControler.currentPhotogrammetry.currentStep%2))for(var a=0;a<this.currentConstraintData.length;a++)this.currentConstraintData[a].point&&0!=this.currentConstraintData[a].length&&ImageControler.currentGraphic.drawConstraint(this.currentConstraintData[a])},constraintReceived:function(a){try{if((a=JSON.parse(a))&&a.parameter&&a.parameter.targetImage&&a.parameter.targetImage.id==ImajnetMap.currentPosition.id&&a.constraints&&jQuery.isArray(a.constraints)){ImageControler.currentGraphic.clearConstraints();
ImageControler.currentPhotogrammetry.currentConstraintData=[];for(var b=0;b<a.constraints.length;b++)ImageControler.currentPhotogrammetry.currentConstraintData.push(a.constraints[b]),ImageControler.currentGraphic.drawConstraint(a.constraints[b])}}catch(c){}},getConstraint:function(){ImageControler.currentGraphic.clearConstraints();this.constraintAjaxRequest&&this.constraintAjaxRequest.abort();this.constraintParameter&&ImajnetMap.currentPosition&&this.firstImagePosition.id!=ImajnetMap.currentPosition.id&&
(this.constraintParameter.density=1,this.constraintParameter.sourceImage=this.firstImagePosition,this.constraintParameter.targetImage=ImajnetMap.currentPosition,this.constraintAjaxRequest=ImajnetAPI.doImajnetRequest("GET","/api/photogrammetry/constraint/",this.constraintParameter,this.constraintReceived,null,null,null,!0))},computeDistanceBetweenPoints:function(a,b){return Math.sqrt(Math.pow(Nigsys.distanceBetweenPoints(a,b),2)+Math.pow(Math.abs(b.height-a.height),2))},getMeasurementInUnitsByObjectId:function(a,
b){var c=ImageControler.currentPhotogrammetry.getObjectById(a);if(!c)return"";c.measurement&&c.points&&2==c.points.length||(c.measurement=ImageControler.currentPhotogrammetry.getMeasurement(c));if(0==c.measurement)return 0;if(!c.measurement)return"";var d=0;return d=c.type==ImajnetMap.FEATURE_TYPE_POLYGON?ImageControler.currentPhotogrammetry.getMeasurementInUnits(c.measurement,!0):ImageControler.currentPhotogrammetry.getMeasurementInUnits(c.measurement,!1)},getMeasurementArray:function(a){if(a.measurementResult)return a.measurementResult.measurement;
if(a.points){if("polygon"==a.type&&2<a.points.length){for(var b=[],c=0;c<a.points.length;c++)b.push({x:a.points[c].photogrammetryPosition3D.coordinates.lon,y:a.points[c].photogrammetryPosition3D.coordinates.lat,z:a.points[c].photogrammetryPosition3D.coordinates.height});b.push({x:a.points[a.points.length-1].photogrammetryPosition3D.coordinates.lon,y:a.points[a.points.length-1].photogrammetryPosition3D.coordinates.lat,z:a.points[a.points.length-1].photogrammetryPosition3D.coordinates.height});return b}return ImajnetPolyligne.getTotalDistance(a)}return null},
getMeasurement:function(a){return a?"polygon"==a.type&&a.points&&2<a.points.length?Nigsys.getGeodesicArea(ImageControler.currentPhotogrammetry.getMeasurementArray(a)):ImageControler.currentPhotogrammetry.getMeasurementArray(a):""},getMeasurementInUnits:function(a,b){return a?b?Nigsys.getHighestSquareUnit(LRS.transformFromSquareMeters(a,Nigsys.getMeasurementUnit()),Nigsys.getMeasurementUnit()):LRS.transformFromMeters(a,Nigsys.getMeasurementUnit())+Nigsys.getUnitText(Nigsys.getMeasurementUnit()):""},
drawPhotogrammetryObjects:function(){if(null!==ImajnetMap.currentPosition){Nigsys.isPolyligneMode()||Nigsys.isPositionMode()||ImajnetImageSwitcher.show();var a=ImageControler.currentPhotogrammetry.getImageObjectList(ImajnetMap.currentPosition);ImajnetPolyligne.isMeasurementMode()&&!a&&(a=(a=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId))?[a]:null);if(null!=a){var b=0;a:for(;b<a.length;b++){var c=ImajnetMap.getFeatureWrapperById(a[b].id);if(a[b].coordinates)ImageControler.currentPhotogrammetry.appendImageTag(a[b].id,
a[b].coordinates);else if(void 0!==a[b].photogrammetryPosition3D)0!=a[b].id&&ImageControler.currentGraphic.appendPinPoint(a[b].parameter.imagePoint.imgCoord1,c);else if(ImajnetPolyligne.objectIsPolyligneOrPolygon(a[b].id)){for(var d=!0,e=[],f=0;f<a[b].points.length;f++){if(a[b].points[f].parameter.imagePoint.img1.id!==ImajnetMap.currentPosition.id)if(ImajnetPolyligne.isMeasurementMode())d=!1;else continue a;e.push({id:a[b].points[f].id,coordinates:a[b].points[f].parameter.imagePoint.imgCoord1})}d&&
ImageControler.currentPhotogrammetry.drawLine(c,e);ImajnetPolyligne.isMeasurementMode()&&-1!=ImajnetPolyligne.currentAddObjectId&&ImajnetPolyligne.currentAddObjectId==a[b].id&&(1==e.length&&d&&(ImageControler.currentGraphic.firstClickCoordinates=e[0].coordinates),2==e.length&&ImajnetPolyligne.finishGeometry(ImajnetPolyligne.type,ImajnetPolyligne.isMeasurementMode()));ImageControler.currentPhotogrammetry.getObjectLRS(a[b])}}}}},objectFromCurrentImage:function(a,b){if(ImageControler.currentPhotogrammetry.objects[a].positionId!=
ImajnetMap.currentPosition.id)return!1;if(!ImajnetPolyligne.isPolyligneOrPolygon(ImageControler.currentPhotogrammetry.objects[a].data[b].type))return!0;for(var c=0;c<ImageControler.currentPhotogrammetry.objects[a].data[b].points.length;c++)if(ImageControler.currentPhotogrammetry.objects[a].data[b].points[c].parameter.imagePoint.img1.id!=ImajnetMap.currentPosition.id)return!1;return!0},getDifferentTracePointObject:function(a,b){return[{objectId:a.toString(),linkToNext:!0,coordinates:{lon:b.lon,lat:b.lat,
height:b.height-1}},{objectId:a.toString(),linkToNext:!1,coordinates:{lon:b.lon,lat:b.lat,height:b.height+1}}]},getImajnetObjectsToProject:function(){ImajnetAPI.mustAbortRequests&&null!==this.projectionAjaxRequest&&this.projectionAjaxRequest.abort();if(null!=ImajnetMap.currentPosition&&0<ImageControler.currentPhotogrammetry.objects.length){for(var a=[],b=[],c=[],d=ImageControler.currentPhotogrammetry.getImageIndexInCacheArrayByImageId(ImajnetMap.currentPosition.id),e=0;e<ImageControler.currentPhotogrammetry.objects.length;e++)for(var f=
0;f<ImageControler.currentPhotogrammetry.objects[e].data.length;f++)if(!this.objectFromCurrentImage(e,f)){var g=!1;if(ImageControler.currentPhotogrammetry.objects[e].data[f].photogrammetryPosition3D&&-1===jQuery.inArray(ImageControler.currentPhotogrammetry.objects[e].data[f].type,ImajnetPolyligne.typesArray)){if(d&&d.projection&&d.projection.pointProjections)for(var h=0;h<d.projection.pointProjections.length;h++)if(d.projection.pointProjections[h]&&d.projection.pointProjections[h].id==ImageControler.currentPhotogrammetry.objects[e].data[f].id){g=
!0;break}!g&&void 0!==ImageControler.currentPhotogrammetry.objects[e].data[f].photogrammetryPosition3D.coordinates&&Nigsys.distanceBetweenPoints(ImajnetMap.currentPosition,ImageControler.currentPhotogrammetry.objects[e].data[f].photogrammetryPosition3D.coordinates)<=(ImageControler.currentPhotogrammetry.objects[e].data[f].type==ImajnetMap.MARKER_TYPE_CLICKED_POINT?ImajnetSettings.imajnetSettings.orientedImages:ImajnetSettings.imajnetSettings.projection)&&(0==ImageControler.currentPhotogrammetry.objects[e].data[f].id?
c.push({objectId:ImageControler.currentPhotogrammetry.objects[e].data[f].id.toString(),linkToNext:!1,coordinates:ImageControler.currentPhotogrammetry.objects[e].data[f].photogrammetryPosition3D.coordinates}):a.push({objectId:ImageControler.currentPhotogrammetry.objects[e].data[f].id.toString(),linkToNext:ImageControler.currentPhotogrammetry.objects[e].data[f].linkToNext?ImageControler.currentPhotogrammetry.objects[e].data[f].linkToNext:!1,coordinates:ImageControler.currentPhotogrammetry.objects[e].data[f].photogrammetryPosition3D.coordinates,
imagePointReference:{image:{id:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint.img1.id},imageCoordinates:{x:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint.imgCoord1.x,y:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint.imgCoord1.y}}}))}else if(ImageControler.currentPhotogrammetry.objects[e].data[f].measurementResult){if(d&&d.projection&&d.projection.shapeProjections)for(h=0;h<d.projection.shapeProjections.length;h++)if(d.projection.shapeProjections[h]&&
d.projection.shapeProjections[h].projections&&d.projection.shapeProjections[h].id==ImageControler.currentPhotogrammetry.objects[e].data[f].id&&0<=d.projection.shapeProjections[h].projections[0].coordinates.z){g=!0;break}g||Nigsys.distanceBetweenPoints(ImajnetMap.currentPosition,ImageControler.currentPhotogrammetry.objects[e].data[f].measurementResult.firstPoint)>ImajnetSettings.imajnetSettings.projection||(g=[],g.push({linkToNext:!0,coordinates:ImageControler.currentPhotogrammetry.objects[e].data[f].measurementResult.firstPoint,
imagePointReference:{image:{id:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint1.img1.id},imageCoordinates:{x:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint1.imgCoord1.x,y:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint1.imgCoord1.y}}}),g.push({linkToNext:!1,coordinates:ImageControler.currentPhotogrammetry.objects[e].data[f].measurementResult.secondPoint,imagePointReference:{image:{id:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint2.img1.id},
imageCoordinates:{x:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint2.imgCoord1.x,y:ImageControler.currentPhotogrammetry.objects[e].data[f].parameter.imagePoint2.imgCoord1.y}}}),b.push({id:ImageControler.currentPhotogrammetry.objects[e].data[f].id.toString(),points:g}))}else if(-1!==jQuery.inArray(ImageControler.currentPhotogrammetry.objects[e].data[f].type,ImajnetPolyligne.typesArray)){if(d&&d.projection&&d.projection.shapeProjections&&d.projection.shapeProjections.length){for(var k=
null,h=0;h<d.projection.shapeProjections.length;h++)if(d.projection.shapeProjections[h].id==ImageControler.currentPhotogrammetry.objects[e].data[f].id){k=d.projection.shapeProjections[h].projections;break}g=!0;for(h=0;h<ImageControler.currentPhotogrammetry.objects[e].data[f].points.length;h++)if(!(Nigsys.distanceBetweenPoints(ImajnetMap.currentPosition,ImageControler.currentPhotogrammetry.objects[e].data[f].points[h].parameter.imagePoint.img1)>ImajnetSettings.imajnetSettings.projection)){var m=!1;
if(k)for(var l=0;l<k.length;l++)if(k[l].id==ImageControler.currentPhotogrammetry.objects[e].data[f].points[h].id){m=!0;break}if(!m){g=!1;break}}}if(!g){g=[];for(k=h=0;k<ImageControler.currentPhotogrammetry.objects[e].data[f].points.length;k++)Nigsys.distanceBetweenPoints(ImajnetMap.currentPosition,ImageControler.currentPhotogrammetry.objects[e].data[f].points[k].parameter.imagePoint.img1)>ImajnetSettings.imajnetSettings.projection&&h++,g.push({objectId:ImageControler.currentPhotogrammetry.objects[e].data[f].points[k].id.toString(),
linkToNext:k<ImageControler.currentPhotogrammetry.objects[e].data[f].points.length-1||"polygon"==ImageControler.currentPhotogrammetry.objects[e].data[f].points[k].type,coordinates:ImageControler.currentPhotogrammetry.objects[e].data[f].points[k].photogrammetryPosition3D.coordinates,imagePointReference:{image:{id:ImageControler.currentPhotogrammetry.objects[e].data[f].points[k].parameter.imagePoint.img1.id},imageCoordinates:{x:ImageControler.currentPhotogrammetry.objects[e].data[f].points[k].parameter.imagePoint.imgCoord1.x,
y:ImageControler.currentPhotogrammetry.objects[e].data[f].points[k].parameter.imagePoint.imgCoord1.y}}});g.length&&h<g.length&&b.push({id:ImageControler.currentPhotogrammetry.objects[e].data[f].id.toString(),points:g})}}}d=[];0<c.length&&d.push({groundProjection:!0,heightOffset:0,points:c});if(0<a.length||0<b.length)c={groundProjection:!1,heightOffset:0},0<a.length&&(c.points=a),0<b.length&&(c.shapes=b),d.push(c);d.length?this.imajnetProjectionsDataObject={projectionData:d,pointOfView:ImajnetMap.currentPosition}:
ImajnetProjection.projectionReceived(null)}},goToImage:function(a){ImageControler.currentImageControl.resetFastNavigation();ImajnetUI.stopSwipeNavigation();for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(ImageControler.currentPhotogrammetry.objects[b].data[c].id==a||a>=ImageControler.currentPhotogrammetry.objects[b].data[c].id&&ImageControler.currentPhotogrammetry.objects[b].data[c].points&&a<=ImageControler.currentPhotogrammetry.objects[b].data[c].id+
ImageControler.currentPhotogrammetry.objects[b].data[c].points.length){ImajnetZoom.left=-1;var d=ImageControler.currentPhotogrammetry.getPositionFromObject(ImageControler.currentPhotogrammetry.objects[b].data[c]);ImajnetAPI.setImajnetImage({position:d}).done(function(){ImajnetMap.zoomToDefault();ImajnetPlugin.centerMapToPosition(d,!1)});return}},deleteItemAtIndex:function(a,b,c,d){a&&(a[c]&&(1==a[c][b].length?a.splice(c,1):a[c][b].splice(d,1)),"data"==b&&1==a.length&&1==a[0][b].length&&0==a[0][b][0].id&&
this.clipboardEmpty())},deleteProjectionItem:function(a){for(var b=0;b<ImageControler.currentPhotogrammetry.existingProjections.length;b++)if(ImageControler.currentPhotogrammetry.existingProjections[b].projection){var c=!1;if(ImageControler.currentPhotogrammetry.existingProjections[b].projection.pointProjections)for(var d=0;d<ImageControler.currentPhotogrammetry.existingProjections[b].projection.pointProjections.length;d++)if(ImageControler.currentPhotogrammetry.existingProjections[b].projection.pointProjections[d]&&
ImageControler.currentPhotogrammetry.existingProjections[b].projection.pointProjections[d].id==a){ImageControler.currentPhotogrammetry.existingProjections[b].projection.pointProjections.splice(d,1);c=!0;break}if(!c&&ImageControler.currentPhotogrammetry.existingProjections[b].projection.shapeProjections)for(d=0;d<ImageControler.currentPhotogrammetry.existingProjections[b].projection.shapeProjections.length;d++)if(ImageControler.currentPhotogrammetry.existingProjections[b].projection.shapeProjections[d]&&
ImageControler.currentPhotogrammetry.existingProjections[b].projection.shapeProjections[d].id==a){ImageControler.currentPhotogrammetry.existingProjections[b].projection.shapeProjections.splice(d,1);break}}},onDeletePhotogrammetryItem:function(a,b,c){ImageControler.currentPhotogrammetry.clearItem(a.id);ImajnetMap.clearPhotogrammetryObject(a.id);this.deleteProjectionItem(a.id);this.deleteItemAtIndex(ImageControler.currentPhotogrammetry.objects,"data",b,c);this.updateCache()},deletePhotogrammetryItem:function(a){if(ImageControler.currentPhotogrammetry.objects&&
ImageControler.currentPhotogrammetry.objects.length)for(var b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)if(ImageControler.currentPhotogrammetry.objects[b].data[c].id==a){this.onDeletePhotogrammetryItem(ImageControler.currentPhotogrammetry.objects[b].data[c],b,c);this.redraw(!0);(0==ImageControler.currentPhotogrammetry.objects.length||1==ImageControler.currentPhotogrammetry.objects.length&&ImageControler.currentPhotogrammetry.objects[b]&&
ImageControler.currentPhotogrammetry.objects[b].data[c]&&1==ImageControler.currentPhotogrammetry.objects[b].data.length&&ImageControler.currentPhotogrammetry.objects[b].data[0].id==ImajnetPolyligne.currentAddObjectId)&&this.clipboardEmpty();return}},deleteLastPhotogrammetryItem:function(){ImageControler.currentPhotogrammetry.objects&&ImageControler.currentPhotogrammetry.objects.length&&this.deletePhotogrammetryItem(ImageControler.currentPhotogrammetry.objects[ImageControler.currentPhotogrammetry.objects.length-
1].data[ImageControler.currentPhotogrammetry.objects[ImageControler.currentPhotogrammetry.objects.length-1].data.length-1].id)},getClipboardEmptyContent:function(){return'\x3cdiv style\x3d"width: 100%; text-align: center; margin-top: 10px;"\x3e'+jQuery.imajnet.map.clipboard.noItems+"\x3c/div\x3e"},clipboardEmpty:function(){ImajnetUI.hideItem(ImajnetUI.clipboardExportContainerId);jQuery("#"+ImajnetUI.clipboardContainerId+"Content").html(this.getClipboardEmptyContent());jQuery("#popupImajnetClipboardClearButton").prop("disabled",
!0);jQuery("#popupImajnetClipboardExportButton").prop("disabled",!0)},deletePhotogrammetryObjects:function(){if(ImageControler.currentPhotogrammetry.objects&&ImageControler.currentPhotogrammetry.objects.length){Nigsys.isPositionMode()&&ImajnetPosition.reload();Nigsys.isPolyligneMode()&&ImajnetPolyligne.reload();ImageControler.currentPhotogrammetry.clear();ImajnetMap.clearClickedPointFromMap();ImajnetPlugin.removeAllFeatures(ImajnetMap.photogrammetryPositionsLayer);ImajnetPlugin.removeAllFeatures(ImajnetMap.imajnetDragFeaturesLayer);
for(var a=0;a<ImageControler.currentPhotogrammetry.objects.length;a++)for(var b=0;b<ImageControler.currentPhotogrammetry.objects[a].data.length;b++){var c=ImageControler.currentPhotogrammetry.objects[a].data[b].id;ImajnetMap.getFeatureWrapperById(c)&&ImajnetMap.deleteFeatureWrapperObjectById(c);jQuery("#textareaEditComment_"+c).remove();jQuery("#imajnetPhotogrammetryLRS_"+c).remove();jQuery("#LRSClipboard_"+c).remove();jQuery("#measurementText_"+c).remove()}jQuery(".LRSDoubleClickComment").remove();
ImageControler.currentPhotogrammetry.existingProjections=[];ImageControler.currentPhotogrammetry.objects=[];ImageControler.currentPhotogrammetry.updateCache();jQuery("#"+ImajnetUI.clipboardContainerId+"Content").html("");this.redraw(!0);this.clipboardEmpty()}},exportAddToItem:function(){jQuery("#imajnetExportToContainer").append(this.exportToItemContent+'\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e')},showExport:function(){ImajnetUI.clipboardExportContainer.html(this.getExportContent());ImajnetUI.showItem(ImajnetUI.clipboardExportContainerId,
Nigsys.browserIsIE7()?460:null)},onExportSuccess:function(a){a=JSON.parse(a);var b=jQuery.imajnet.map.clipboard.popupExport.exportComplete;a&&a.exportResult&&a.exportResult.link&&"ok"!=a.exportResult.link.toString().toLowerCase()&&(b+=':\x26nbsp;\x3cb\x3e\x3ca href\x3d"'+Imajnet.serverUrl+a.exportResult.link+'" target\x3d"_blank"\x3e'+jQuery.imajnet.map.clipboard.popupExport.donwloadFile+"\x3c/a\x3e\x3c/b\x3e");jQuery("#imajnetExportStatus").html(b)},onExportError:function(){jQuery("#imajnetExportStatus").html('\x3cdiv class\x3d"errors"\x3e'+
jQuery.imajnet.map.clipboard.popupExport.exportError+"\x3c/div\x3e")},getDataToExport:function(){var a=[],b=[],c=[],d=[];jQuery.each(ImageControler.currentPhotogrammetry.objects,function(e,g){jQuery.each(g.data,function(e,f){if(void 0!==f.coordinates)a.push(f);else if(f.photogrammetryPosition3D)0!=f.id&&b.push({position:f.parameter.imagePoint.img1,imageCoordinates:f.parameter.imagePoint.imgCoord1,coordinates:f.photogrammetryPosition3D.coordinates,precision:f.photogrammetryPosition3D.precision,comment:f.comment});
else if(f.measurementResult)c.push({position:f.parameter.imagePoint1.img1,firstPoint:{position:f.parameter.imagePoint1.img1,coordinates:f.measurementResult.firstPoint,imageCoordinates:f.parameter.imagePoint1.imgCoord1,precision:f.measurementResult.firstPoint.precision},secondPoint:{position:f.parameter.imagePoint1.img1,coordinates:f.measurementResult.secondPoint,imageCoordinates:f.parameter.imagePoint2.imgCoord1,precision:f.measurementResult.secondPoint.precision},measurement:f.measurementResult.measurement,
precision:f.measurementResult.precision,comment:f.comment});else if(-1!==jQuery.inArray(f.type,ImajnetPolyligne.typesArray)){for(var g=[],l=0;l<f.points.length;l++)g.push({position:f.points[l].parameter.imagePoint.img1,imageCoordinates:f.points[l].parameter.imagePoint.imgCoord1,coordinates:f.points[l].photogrammetryPosition3D.coordinates,precision:f.points[l].photogrammetryPosition3D.precision});g={comment:f.comment,position:f.points[0].parameter.imagePoint.img1,isPolygone:"polygon"==f.type?!0:!1,
points:g};f.measurement&&("polygon"==f.type?g.surface=f.measurement:g.length=f.measurement);d.push(g)}})});var e={};0<a.length&&(e.imagetag=a);0<b.length&&(e.pinpoint=b);0<c.length&&(e.freemeasurement=c);0<d.length&&(e.shape=d);return e},exportObjects:function(a){jQuery("#imajnetExportStatus").html(jQuery.imajnet.map.clipboard.popupExport.exportProgress);var b="",c=null,d="",e=jQuery('input[name\x3d"imajnetExportType"]:checked').val();void 0!==a&&null!==a&&a&&(b=jQuery("#imajnetExportFrom").val(),
c=[],jQuery.each(jQuery(".imajnetExportTo"),function(a,b){var d=b.value;""!=d&&c.push(d)}),d=jQuery("textarea#imajnetExportMessage").val());a={exportData:this.getDataToExport(),fromEmail:b,recipients:c,message:d,locale:Imajnet.locale,unit:Nigsys.getMeasurementUnit()};ImajnetAPI.doImajnetRequest("POST","/api/export/"+e+"/",a,this.onExportSuccess,this.onExportError,null,"data")},onExportToItemKeyup:function(){var a=!1;jQuery.each(jQuery(".imajnetExportTo"),function(b,c){""!=c.value&&(a=!0)});a?jQuery("#exportSendButton").prop("disabled",
!1):jQuery("#exportSendButton").prop("disabled",!0)},redrawClipboard:function(){if(Photogrammetry.clipboardActive){for(var a=[],b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var c=0;c<ImageControler.currentPhotogrammetry.objects[b].data.length;c++)ImageControler.currentPhotogrammetry.objects[b].data[c].objectId&&(ImageControler.currentPhotogrammetry.objects[b].data[c].id=ImageControler.currentPhotogrammetry.objects[b].data[c].objectId),ImageControler.currentPhotogrammetry.objects[b].data[c].id!=
ImajnetPolyligne.currentAddObjectId&&a.push(ImageControler.currentPhotogrammetry.getObjectClipboardHTML(ImageControler.currentPhotogrammetry.objects[b].data[c]));jQuery("#"+ImajnetUI.clipboardContainerId+"Content").html(a.join(""))}},drawObjectClipboard:function(a,b){if(Photogrammetry.clipboardActive&&void 0!==a&&null!==a&&0!=a.id){var c="",d="";if(a.photogrammetryPosition3D||a.measurementResult){var e=void 0!==a.photogrammetryPosition3D?a.photogrammetryPosition3D.precision:void 0!==a.measurementResult?
a.measurementResult.precision:-1;if(0>e||1<e)d='\x3cdiv title\x3d"'+jQuery.imajnet.map.clipboard.precisionUnknown+'"\x3e?\x3c/div\x3e';else for(var e=Math.round(5*e),f=0;5>f;f++)d+="\x3cdiv style\x3d\"background-image: url('"+Imajnet.imajnetPath+"img/"+(f<e?"ratingFullStar":"ratingEmptyStar")+'.png\');" class\x3d"left imajnetClipboardStarImage" title\x3d"'+jQuery.imajnet.map.clipboard.precisionRating+'"\x3e\x3c/div\x3e'}e="";e=ImajnetPolyligne.objectIsPolyligneOrPolygon(a.id)?jQuery.imajnet.map.clipboard.titleItem[a.type]+
" ("+ImageControler.currentPhotogrammetry.getMeasurementInUnitsByObjectId(a.id,"measurementClipboardText_")+")":void 0!==a.coordinates?jQuery.imajnet.map.clipboard.imageTag:void 0!==a.photogrammetryPosition3D?jQuery.imajnet.map.clipboard.position3D:ImageControler.currentPhotogrammetry.getMeasurementInUnitsByObjectId(a.id,"measurementClipboardText_");f=void 0!==a.comment?a.comment:"";c+='\x3cdiv id\x3d"imajnetClipboardItem_'+a.id+'" class\x3d"imajnetClipboardItem'+(1==a.id%2?" imajnetClipboardItemEven":
"")+'" onclick\x3d"ImajnetPlugin.positionImageOnFeature('+a.id+', event);"\x3e\x3cdiv onmousemove\x3d"ImageControler.currentPhotogrammetry.showLRS(event, null, '+a.id+", '"+ImajnetUI.clipboardContainerId+"');\" onmouseout\x3d\"jQuery('#LRSClipboard_"+a.id+'\').hide();"\x3e\x3cdiv class\x3d"imajnetClipboardItemImage left"\x3e\x3cimg src\x3d"'+ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.getPositionFromObject(a))+'" width\x3d"35" height\x3d"32" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left imajnetClipboardComment"\x3e\x3cdiv id\x3d"imajnetClipboardComment_'+
a.id+'" class\x3d"imajnetClipboardCommentContainer" style\x3d"width: '+(void 0===a.coordinates?180:270)+'px;" ondblclick\x3d"ImageControler.currentPhotogrammetry.showCommentInClipboard(event, '+a.id+');"\x3e\x3cdiv id\x3d"measurementClipboardText_'+a.id+'"\x3e\x3cb\x3e'+e+'\x3c/b\x3e\x3c/div\x3e\x3cdiv\x3e\x3cdiv class\x3d"left"\x3e\x3cb\x3e'+jQuery.imajnet.map.clipboard.comment+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv id\x3d"imajnetClipboardCommentContainer_'+a.id+'" class\x3d"left imajnetClipboardCommentContainer" style\x3d"width: '+
(void 0===a.coordinates?95:180)+'px;"\x3e'+f+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetClipboardTextareaComment_'+a.id+'" class\x3d"imajnetClipboardTextareaComment" style\x3d"display: none;"\x3e\x3ctextarea id\x3d"textAreaEditClipboardComment_'+a.id+'" class\x3d"textAreaEditClipboardComment" onkeydown\x3d"ImageControler.currentPhotogrammetry.saveComment(event, '+a.id+", 'textAreaEditClipboardComment_');\" cols\x3d\""+(void 0===a.coordinates?
21:34)+'"\x3e\x3c/textarea\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"right imajnetClipboardDelete"\x3e\x3cimage src\x3d"'+Imajnet.imajnetPath+"img/buttons/removeLayerFeatures.png?"+Imajnet.version+'" class\x3d"deleteClipboardItem" onclick\x3d"ImageControler.currentPhotogrammetry.deletePhotogrammetryItem('+a.id+');" width\x3d"20" height\x3d"20" style\x3d"margin-top: 5px;" title\x3d"'+jQuery.imajnet.map.clipboard.deleteItem+'" /\x3e\x3c/div\x3e'+(void 0===a.coordinates?'\x3cdiv class\x3d"right imajnetClipboardPrecision"\x3e'+
d+'\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e':"")+'\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e';jQuery("#"+ImajnetUI.clipboardContainerId+"Content").on("click",function(a,b){Nigsys.stringContains(a.target.className,"textAreaEditClipboardComment")||(jQuery(".imajnetClipboardTextareaComment").hide(),jQuery(".imajnetClipboardCommentContainer").show())});jQuery("#"+ImajnetUI.clipboardContainerId+"Content").html()==this.getClipboardEmptyContent()&&jQuery("#"+ImajnetUI.clipboardContainerId+
"Content").html("");b&&(ImajnetUI.showNotificationInfo(jQuery.imajnet.map.clipboard.notify.title,jQuery.imajnet.map.clipboard.notify.text,"rightBottom",null,null,function(){ImajnetUI.showItem(ImajnetUI.clipboardContainerId,Nigsys.browserIsIE7()?350:null)}),setTimeout("ImajnetUI.hideNotificationInfoOk()",3E3));jQuery("#"+ImajnetUI.clipboardContainerId+"Content").append(c);jQuery("#popupImajnetClipboardClearButton").prop("disabled",!1);jQuery("#popupImajnetClipboardExportButton").prop("disabled",!1)}},
getObjectClipboardHTML:function(a){if(Photogrammetry.clipboardActive&&void 0!==a&&null!==a&&0!=a.id){var b="",c="";if(a.photogrammetryPosition3D||a.measurementResult){var d=void 0!==a.photogrammetryPosition3D?a.photogrammetryPosition3D.precision:void 0!==a.measurementResult?a.measurementResult.precision:-1;if(0>d||1<d)c='\x3cdiv title\x3d"'+jQuery.imajnet.map.clipboard.precisionUnknown+'"\x3e?\x3c/div\x3e';else for(var d=Math.round(5*d),e=0;5>e;e++)c+="\x3cdiv style\x3d\"background-image: url('"+
Imajnet.imajnetPath+"img/"+(e<d?"ratingFullStar":"ratingEmptyStar")+'.png\');" class\x3d"left imajnetClipboardStarImage" title\x3d"'+jQuery.imajnet.map.clipboard.precisionRating+'"\x3e\x3c/div\x3e'}d="";d=ImajnetPolyligne.objectIsPolyligneOrPolygon(a.id)?jQuery.imajnet.map.clipboard.titleItem[a.type]+" ("+ImageControler.currentPhotogrammetry.getMeasurementInUnitsByObjectId(a.id,"measurementClipboardText_")+")":void 0!==a.coordinates?jQuery.imajnet.map.clipboard.imageTag:void 0!==a.photogrammetryPosition3D?
jQuery.imajnet.map.clipboard.position3D:ImageControler.currentPhotogrammetry.getMeasurementInUnitsByObjectId(a.id,"measurementClipboardText_");e=void 0!==a.comment?a.comment:"";return b+='\x3cdiv id\x3d"imajnetClipboardItem_'+a.id+'" class\x3d"imajnetClipboardItem'+(1==a.id%2?" imajnetClipboardItemEven":"")+'" onclick\x3d"ImajnetPlugin.positionImageOnFeature('+a.id+', event);"\x3e\x3cdiv onmousemove\x3d"ImageControler.currentPhotogrammetry.showLRS(event, null, '+a.id+", '"+ImajnetUI.clipboardContainerId+
"');\" onmouseout\x3d\"jQuery('#LRSClipboard_"+a.id+'\').hide();"\x3e\x3cdiv class\x3d"imajnetClipboardItemImage left"\x3e\x3cimg src\x3d"'+ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.getPositionFromObject(a))+'" width\x3d"35" height\x3d"32" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left imajnetClipboardComment"\x3e\x3cdiv id\x3d"imajnetClipboardComment_'+a.id+'" class\x3d"imajnetClipboardCommentContainer" style\x3d"width: '+(void 0===a.coordinates?180:270)+'px;" ondblclick\x3d"ImageControler.currentPhotogrammetry.showCommentInClipboard(event, '+
a.id+');"\x3e\x3cdiv id\x3d"measurementClipboardText_'+a.id+'"\x3e\x3cb\x3e'+d+'\x3c/b\x3e\x3c/div\x3e\x3cdiv\x3e\x3cdiv class\x3d"left"\x3e\x3cb\x3e'+jQuery.imajnet.map.clipboard.comment+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv id\x3d"imajnetClipboardCommentContainer_'+a.id+'" class\x3d"left imajnetClipboardCommentContainer" style\x3d"width: '+(void 0===a.coordinates?95:180)+'px;"\x3e'+e+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetClipboardTextareaComment_'+
a.id+'" class\x3d"imajnetClipboardTextareaComment" style\x3d"display: none;"\x3e\x3ctextarea id\x3d"textAreaEditClipboardComment_'+a.id+'" class\x3d"textAreaEditClipboardComment" onkeydown\x3d"ImageControler.currentPhotogrammetry.saveComment(event, '+a.id+", 'textAreaEditClipboardComment_');\" cols\x3d\""+(void 0===a.coordinates?21:34)+'"\x3e\x3c/textarea\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"right imajnetClipboardDelete"\x3e\x3cimage src\x3d"'+Imajnet.imajnetPath+"img/buttons/removeLayerFeatures.png?"+
Imajnet.version+'" class\x3d"deleteClipboardItem" onclick\x3d"ImageControler.currentPhotogrammetry.deletePhotogrammetryItem('+a.id+');" width\x3d"20" height\x3d"20" style\x3d"margin-top: 5px;" title\x3d"'+jQuery.imajnet.map.clipboard.deleteItem+'" /\x3e\x3c/div\x3e'+(void 0===a.coordinates?'\x3cdiv class\x3d"right imajnetClipboardPrecision"\x3e'+c+'\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e':"")+'\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e'}},clearClipboard:function(){jQuery("#"+
ImajnetUI.clipboardContainerId+"Content").html("");ImajnetUI.hideItem(ImajnetUI.clipboardExportContainerId);ImajnetUI.hideItem(ImajnetUI.clipboardContainerId)},removeMapClickedPoint:function(){this.deletePhotogrammetryItem(0)},clearItem:function(a){},clearImageObjects:function(){},hideObjects:function(){this.hideImageObjects();ImageControler.currentGraphic.hideGraphicObjects();jQuery("#imajnetPreviewPanel").hide()},showObjects:function(){this.showImageObjects();ImageControler.currentGraphic.showGraphicObjects();
ImajnetUI.isPreviewPanelDisabled()||!Nigsys.isPositionMode()&&!Nigsys.isPolyligneMode()||jQuery("#imajnetPreviewPanel").show()},clear:function(){this.imajnetProjectionsDataObject&&(this.lastImajnetProjectionsDataObject=Nigsys.cloneObject(this.imajnetProjectionsDataObject));this.imajnetProjectionsDataObject=null;ImajnetProjection.userProjections=null;ImageControler.currentGraphic?ImageControler.currentGraphic.firstClickCoordinates=null:(Graphic.firstClickCoordinates=null,Graphic.lastClickCoordinates=
null);Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()||this.hidePreviewPanel();this.clearCommentTextarea(null);this.clearImageObjects();ImageControler.currentGraphic.clearGraphicObjects();if(ImageControler.currentPhotogrammetry.currentHoverObjectId)ImageControler.currentPhotogrammetry.onFeatureMouseOut(ImajnetMap.getFeatureWrapperById(ImageControler.currentPhotogrammetry.currentHoverObjectId))},showPreviewPanel:function(){Address.hideAddress();ImajnetUI.previewImageContainer.show()},
hidePreviewPanel:function(){ImageControler.currentGraphic?(ImageControler.currentGraphic.clearConstraints(),ImageControler.currentGraphic.clearPreviewPanel()):(Graphic.clearConstraints(),Graphic.clearPreviewPanel());jQuery(".zoomImageClickedPoint").remove();ImajnetUI.previewImage&&(ImajnetUI.previewImage.attr("src",""),ImajnetUI.previewImageContainer.hide());ImajnetMap.currentPosition&&Address.showAddress()},getProjectionConstraint:function(a){if(ImajnetMap.currentPosition)return ImajnetMap.getTriangle(a,
ImajnetSettings.imajnetSettings.projection,ImajnetMap.currentPosition.orientation.viewAngle,ImajnetMap.currentPosition.orientation.yaw)},setContextMenuHTML:function(){var a="";if(Nigsys.isPositionMode())2==ImageControler.currentPhotogrammetry.currentStep&&(a+='\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImageControler.currentPhotogrammetry.resetGeometry(); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.resetGeometry+"\x3c/div\x3e"),a+='\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImajnetPosition.showHidePosition(); ImajnetUI.hideContextMenu(event)"\x3e'+
jQuery.imajnet.map.contextMenu.closeTool+"\x3c/div\x3e";else{var b=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);if(b){if(2<=b.points.length||1==b.points.length&&2==ImageControler.currentPhotogrammetry.currentStep)a+='\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImageControler.currentPhotogrammetry.deleteLastPoint(); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.deleteLastPoint+"\x3c/div\x3e";0<b.points.length&&(a+='\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImajnetPolyligne.finishGeometry(\''+
ImajnetPolyligne.type+"', "+ImajnetPolyligne.isMeasurementMode()+'); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.finishGeometry+"\x3c/div\x3e",a+='\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImageControler.currentPhotogrammetry.resetGeometry(); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.resetGeometry+"\x3c/div\x3e")}else a+='\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImajnetPolyligne.showHide(\''+ImajnetPolyligne.type+"', "+ImajnetPolyligne.isMeasurementMode()+
'); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.closeTool+"\x3c/div\x3e"}ImajnetUI.contextMenuContainer.html(a)},isObjectInImage:function(a){return jQuery("#photogrammetryPath_"+a).is(":visible")},resetGeometry:function(){Imajnet3dPosition.imageHas3D&&2==ImageControler.currentPhotogrammetry.currentStep&&(ImageControler.currentPhotogrammetry.currentStep--,Imajnet3dPosition.showPosition());if(Nigsys.isPolyligneMode()){if(2>ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId).points.length){var a=
ImajnetMap.getPolyligneFeatureWrappers(ImajnetPolyligne.currentAddObjectId)[0];a&&(a.getType()==ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION?ImajnetPlugin.removeMarker(ImajnetMap.photogrammetryPositionsLayer,a):ImajnetPlugin.removeFeatures(ImajnetMap.imajnetDragFeaturesLayer,Array(a)))}}else 2==ImageControler.currentPhotogrammetry.currentStep&&(ImageControler.currentPhotogrammetry.hidePreviewPanel(),ImageControler.currentPhotogrammetry.currentStep=1,ImajnetAPI.setImajnetImage({position:ImageControler.currentPhotogrammetry.firstImagePosition}).done(function(){}));
ImajnetPosition.reload();ImajnetMeasurement.reload();ImajnetPolyligne.reload()},deleteLastPoint:function(){var a=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);if(a)if(2==ImageControler.currentPhotogrammetry.currentStep)ImageControler.currentPhotogrammetry.hidePreviewPanel(),ImageControler.currentPhotogrammetry.currentStep=1,ImajnetAPI.setImajnetImage({position:a.points[a.points.length-1].parameter.imagePoint.img1}).done(function(){});else if(2>a.points.length)ImageControler.currentPhotogrammetry.currentStep=
1,ImageControler.currentPhotogrammetry.resetGeometry();else{var b=a.points.splice(-2),c=b[0];delete c.distance;a.measurement="";ImajnetMap.clearPhotogrammetryObject(b[0].id);ImajnetMap.clearPhotogrammetryObject(b[1].id);if(0<a.points.length)for(b=0;b<ImageControler.currentPhotogrammetry.objects.length;b++)for(var d=0;d<ImageControler.currentPhotogrammetry.objects[b].data.length;d++)ImageControler.currentPhotogrammetry.objects[b].data[d].id==ImajnetPolyligne.currentAddObjectId&&(ImageControler.currentPhotogrammetry.objects[b].data[d]=
a);else ImageControler.currentPhotogrammetry.deleteLastPhotogrammetryItem(),ImajnetPolyligne.currentAddObjectId=-1;ImajnetPolyligne.pointPositionSuccess(JSON.stringify(c),{stopImageChange:!0})}}};
var FlatPhotogrammetry=Nigsys.cloneObject(Photogrammetry);FlatPhotogrammetry.hideImageObjects=function(){jQuery(".photogrammetryItem").hide()};
FlatPhotogrammetry.appendImageTag=function(a,b){var c=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(b);ImajnetUI.popupImajnetControlsLayer.append('\x3cdiv id\x3d"photogrammetryItem_'+a+'" class\x3d"photogrammetryItem" style\x3d"top: '+Math.round(c.y-16)+"px; left: "+Math.round(c.x-20)+'px; width: 20px; height: 16px; position: absolute; z-index: 1;" onmouseover\x3d"ImageControler.currentPhotogrammetry.onImageTagMouseOver(\''+a+"', event, 'imajnetImageLayer', jQuery(this))\" onmouseout\x3d\"ImageControler.currentPhotogrammetry.onImageTagMouseOut('"+
a+'\');"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/imageTag.png?"+Imajnet.version+'" width\x3d"20" height\x3d"16" /\x3e\x3c/div\x3e');jQuery("#photogrammetryItem_"+a).dblclick({id:a},function(a){ImageControler.currentPhotogrammetry.showComment(a,jQuery(this),a.data.id,"popupImajnetControlsLayer","textareaEditComment_")})};
FlatPhotogrammetry.drawLine=function(a,b){if(1==b.length){var c=ImajnetMap.getFeatureWrapperById(b[0].id);ImageControler.currentGraphic.appendPinPoint(b[0].coordinates,c)}else{b=Nigsys.cloneObject(b);a&&a.type==ImajnetMap.FEATURE_TYPE_POLYGON&&b.push(b[0]);for(var f="",e=[],d=0;d<b.length;d++){b[d].virtual||a&&!ImajnetPolyligne.isPolyligneOrPolygon(a.type.replace("Feature",""))||(c=ImajnetMap.getFeatureWrapperById(b[d].id),ImageControler.currentGraphic.appendPinPoint(b[d].coordinates,c));var c="",
g=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(b[d].coordinates);e.push(g);c=0==d||b[d-1]&&0==b[d-1].linkToNext?" M":" L";f+=c+g.x+" "+g.y}a&&(a.style||(a.style=Array({strokeColor:Nigsys.defaultObjectsColor})),a.getType()==ImajnetMap.FEATURE_TYPE_POLYGON?jQuery.each(a.style,function(b,c){ImageControler.currentGraphic.drawPolygon(f,a,c)}):jQuery.each(a.style,function(b,c){ImageControler.currentGraphic.drawLine(f,a,c)}),d=ImageControler.currentPhotogrammetry.getMeasurementInUnitsByObjectId(a.getId(),
"measurementText_"))&&(e=ImageControler.currentPhotogrammetry.getMeasurementTextPosition({x:e[0].x,y:e[0].y},{x:e[1].x,y:e[1].y}),c=ImajnetZoom.shiftKeyPressed&&a.getId()!==ImajnetPolyligne.currentAddObjectId?"none":"block",-1<ImajnetPolyligne.currentAddObjectId&&a.getId()>ImajnetPolyligne.currentAddObjectId&&(c="block"),ImajnetUI.popupImajnetControlsLayer.append('\x3cdiv id\x3d"measurementText_'+a.getId()+'" class\x3d"measurementText" style\x3d"display:'+c+"; top: "+e.y+"px; left:"+e.x+'px;" onclick\x3d"ImageControler.currentPhotogrammetry.onPhotogrammetryItemClick(\''+
a.getId()+"');\" onmouseover\x3d\"ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOver('"+a.getId()+"', event, 'imajnetImageLayer', jQuery(this));\" onmouseout\x3d\"ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOut('"+a.getId()+"');\" ondblclick\x3d\"ImageControler.currentPhotogrammetry.showComment(event, jQuery(this), '"+a.getId()+"', 'popupImajnetControlsLayer', 'textareaEditComment_');\"\x3e"+d+"\x3c/div\x3e"))}};
FlatPhotogrammetry.clearItem=function(a){var b=ImajnetMap.getFeatureWrapperById(a);if(b)if(-1!==jQuery.inArray(b.getType().replace("Feature",""),ImajnetPolyligne.typesArray)){if(a=ImajnetMap.getPolyligneFeatureWrappers(a))for(b=0;b<a.length;b++)ImageControler.currentGraphic.clearItem(a[b].getId())}else ImageControler.currentGraphic.clearItem(a);else ImageControler.currentGraphic.clearItem(a)};
var CubePhotogrammetry=Nigsys.cloneObject(Photogrammetry);
var Graphic={svg:null,constraintSVG:null,previewPanelSVG:null,canShowPopup:!1,firstClickCoordinates:null,lastClickCoordinates:null,defaultStrokeWidth:2,renderers:["SVG","VML","Canvas"],cubeObjects:null,LRSGUIPRDivisionsMinLength:50,initSVG:function(a,b){if(b)return b;b=Raphael(a,"100%","100%");jQuery(b.canvas).css("position","absolute");jQuery(b.canvas).css("top","0");jQuery(b.canvas).css("top","0");jQuery(b.canvas).css("z-index","1");return b},init:function(){},initConstraint:function(){this.constraintSVG=
this.initSVG("popupImajnetControlsLayer",this.constraintSVG);if(!Nigsys.isPolyligneMode())jQuery(this.constraintSVG.canvas).on("click",ImajnetUI.onImageClick)},previewPanelGraphicInit:function(){this.previewPanelSVG=this.initSVG("imajnetPhotogrammetryZoomedImageContainer",this.previewPanelSVG);jQuery(this.previewPanelSVG.canvas).attr("onmouseover","ImageControler.currentPhotogrammetry.previewPanelMouseOver();")},showPreviewPanelSVG:function(){},drawPreviewPanelPoint:function(a,b,d){a=ImageControler.currentPhotogrammetry.getPreviewPanelPoint(a,
b,d);a='\x3cdiv class\x3d"zoomImageClickedPoint" style\x3d"position: absolute; top: '+(a.y-3)+"px; left: "+(a.x-3)+'px; width: 6px; height: 6px;"\x3e\x3c/div\x3e';ImajnetUI.previewImageContainer.append(a)},drawPreviewPanelLine:function(a,b){},drawLine:function(a,b,d,c,e,g){},drawLineBetweenPoints:function(a,b,d,c,e){},drawPolygon:function(a,b,d){},drawIntermediateLine:function(a,b,d,c){},getConstraintColor:function(a){var b=0,b=.75<a?parseInt(127+512*(1-a)/3):parseInt(1020*a/3);return"rgb("+Math.min(parseInt(340*
(1-a)),255)+", "+b+", 0)"},drawConstraintLine:function(a,b){},drawConstraint:function(a,b){},highlightFeatureOnImage:function(a){},unHighlightFeatureOnImage:function(a){},clear:function(){this.lastClickCoordinates=this.firstClickCoordinates=null;this.clearGraphicObjects()},clearItem:function(a){},clearGraphicObjects:function(){},clearConstraints:function(){},hideAllLayersProjections:function(){},showAllLayersProjections:function(){},clearPreviewPanel:function(){null!==this.previewPanelSVG&&(this.previewPanelSVG.remove(),
this.previewPanelSVG=null)},mouseMove:function(a){},initLRSGUI:function(a){if(!a.LRSGUISVG){var b=ImajnetLRSGUICommon.getContainerSize(a.orientation,a.containerWidth,a.containerHeight);a.LRSGUISVG=Raphael(a.containerId,b.width,b.height);a.LRSGUISVG.canvas.id=a.canvasId}},getPoint:function(a,b){return"portrait"==a.orientation?b:{x:b.y,y:b.x}},drawLRSGUIRoad:function(a){var b=[this.getPoint(a,{x:a.roadXOffset,y:0}),this.getPoint(a,{x:a.roadXOffset,y:a.containerHeight})];"portrait"==a.orientation?(startX=
a.roadXOffset,startY=0,endX=a.roadXOffset,endY=a.containerHeight):(startX=0,startY=a.roadXOffset,endX=a.containerHeight,endY=a.roadXOffset);a.LRSGUISVG.path("M "+b[0].x+" "+b[0].y+" L "+b[1].x+" "+b[1].y).attr({stroke:"#FFFFFF",stroke:"2"==a.roadType?"#000000":"#FFFFFF","stroke-width":"2"==a.roadType?a.trainStrokeWidth:a.roadStrokeWidth})},drawLRSGUILine:function(a,b,d,c,e){b="";if("1"==a.roadType)this.drawLRSGUIRoad(a);else if("2"==a.roadType){this.drawLRSGUIRoad(a);e=c=null;for(d=0;d<a.containerHeight;d+=
20)c=this.getPoint(a,{x:a.roadXOffset-7,y:d}),e=this.getPoint(a,{x:a.roadXOffset+7,y:d}),b+="M "+c.x+" "+c.y+" L "+e.x+" "+e.y+" ";a.LRSGUISVG.path(b).attr({stroke:"#000000","stroke-width":a.trainStrokeWidth})}else if(3==a.roadType){c=this.getPoint(a,{x:a.roadXOffset,y:0});b="M "+c.x+" "+c.y+" ";for(d=0;d<a.containerHeight;d+=40)c=[this.getPoint(a,{x:a.roadXOffset-10,y:d+20}),this.getPoint(a,{x:a.roadXOffset+10,y:d+40-20}),this.getPoint(a,{x:a.roadXOffset,y:d+40})],b+="C "+c[0].x+" "+c[0].y+" "+c[1].x+
" "+c[1].y+" "+c[2].x+" "+c[2].y+" ";a.LRSGUISVG.path(b).attr({stroke:"#0000FF","stroke-width":a.roadStrokeWidth,"stroke-opacity":1})}},drawPRTop:function(a,b){var d=null,d="portrait"==a.orientation?[{x:b.x,y:Math.round(b.y-a.prSize/2)},{x:b.x,y:b.y-a.prSize},{x:b.x+a.prSize,y:b.y-a.prSize},{x:b.x+a.prSize,y:Math.round(b.y-a.prSize/2)}]:[{x:Math.round(b.y-a.prSize/2),y:b.x},{x:Math.round(b.y-a.prSize/4),y:Math.round(b.x-a.prSize/2)},{x:Math.round(b.y+a.prSize/4),y:Math.round(b.x-a.prSize/2)},{x:Math.round(b.y+
a.prSize/2),y:b.x}];a.LRSGUISVG.path("M "+d[0].x+" "+d[0].y+"C "+d[1].x+" "+d[1].y+" "+d[2].x+" "+d[2].y+" "+d[3].x+" "+d[3].y).attr({fill:"#AAAAAA",stroke:"#000000","stroke-width":1})},drawPR:function(a,b,d,c){c=[this.getPoint(a,{x:b.x-a.PRLineLineIndicatorWidth/6,y:b.y}),this.getPoint(a,{x:Math.round(b.x+a.prSize/2+a.PRDivisionOffset),y:b.y})];a.LRSGUISVG.path("M "+c[0].x+" "+c[0].y+" L "+c[1].x+" "+c[1].y).attr({stroke:"#FFFFFF","stroke-width":a.lineIndicatorStrokeWidth});c="portrait"==a.orientation?
[{x:b.x,y:Math.round(b.y-a.prSize/2)},{x:b.x,y:b.y+2},{x:b.x+a.prSize,y:b.y+2},{x:b.x+a.prSize,y:Math.round(b.y-a.prSize/2)}]:[{x:Math.round(b.y-a.prSize/2),y:b.x},{x:Math.round(b.y-a.prSize/2),y:b.x+a.prSize},{x:Math.round(b.y+a.prSize/2),y:b.x+a.prSize},{x:Math.round(b.y+a.prSize/2),y:b.x}];a.LRSGUISVG.path("M "+c[0].x+" "+c[0].y+" L "+c[1].x+" "+c[1].y+" L "+c[2].x+" "+c[2].y+" L "+c[3].x+" "+c[3].y+" Z").attr({fill:"#FFFFFF",stroke:"#000000","stroke-width":1});this.drawPRTop(a,b);b=this.getPoint(a,
{x:Math.round(b.x+a.prSize/2),y:Math.round(b.y-a.prSize/4+("landscape"==a.orientation?a.prSize/4:0))});a.LRSGUISVG.text(b.x,b.y,d).attr({"font-size":a.PRFontSize,"text-anchor":"middle","font-weight":"bold"})},getDivisionStep:function(a,b){var d=b/a;if(d<=Graphic.LRSGUIPRDivisionsMinLength)return Graphic.LRSGUIPRDivisionsMinLength;var c=d%Graphic.LRSGUIPRDivisionsMinLength;return d=c<Graphic.LRSGUIPRDivisionsMinLength/2?d-c:d+(Graphic.LRSGUIPRDivisionsMinLength-c)},getPRDivisions:function(a,b,d){var c=
0;0==a?c=1:1==a?c=2:2==a?c=2:3==a?c=2:4==a?c=3:5==a?c=3:6==a?c=4:7==a?c=5:8==a?c=5:9==a?c=7:10==a?c=7:11==a?c=10:12==a?c=11:13==a?c=11:14==a?c=11:15==a?c=22:16==a?c=27:17==a?c=28:18==a?c=33:19==a?c=34:20==a?c=37:21==a?c=40:22==a?c=43:23==a?c=46:24==a?c=49:25==a&&(c=52);a=Graphic.getDivisionStep(c*d,b);return{count:Math.round(b/a),step:a}},drawPRDivisions:function(a,b,d,c){var e=a.KMToPixelZoomByZoom(1)/25;1>e&&(e=1);c=Graphic.getPRDivisions(a.currentZoomLevel-(a.maxZoomLevel-a.zeroBasedMaxZoomLevel),
c,e);for(e=0;e<c.count;e++){var g=e*c.step,f=Math.round(b.y+d/c.count*e);0>f||f>a.containerHeight||(f=this.getPoint(a,{x:b.x,y:f-0}),g=a.LRSGUISVG.text(f.x,f.y,"- "+g).attr({fill:"#FFFFFF","font-size":12,"text-anchor":"start"}),"landscape"==a.orientation&&(a.PRDivisionWidth=g.getBBox().width,g.transform("t-"+a.PRDivisionWidth/2+",0R90")))}},onDrawLRSGUIImageOrientation:function(a,b){var d=this.getPoint(a,b);a.LRSGUISVG.circle(d.x,d.y,a.positionCircleRadius).data({identifier:"imageOrientation"}).attr({fill:"#00FF00",
"fill-opacity":.5,stroke:"#000000","stroke-width":1});var d=this.getPoint(a,{x:b.x+a.PRDivisionOffset-("portrait"==a.orientation?0:a.PRDivisionWidth/2),y:b.y}),c=this.getPoint(a,{x:a.containerWidth,y:b.y});a.LRSGUISVG.path("M "+d.x+" "+d.y+" L "+c.x+" "+c.y).data({identifier:"imageOrientation"}).attr({stroke:"#FF0000","stroke-width":a.lineIndicatorStrokeWidth,"stroke-opacity":1})},drawLRSGUIImageOrientation:function(a,b,d){a!=ImajnetUI.LRSGUI?"undefined"!==typeof LRSSchematic&&LRSSchematic.drawImajnetImagePosition():
("undefined"!==typeof LRSSchematic&&LRSSchematic.drawImajnetImagePosition({PRIndexInArray:d,currentRoadId:a.currentRoadId,relativeAbscisa:a.linearPosition.relativeAbscisa,roadType:a.linearPosition.road.type,unit:a.linearPosition.road.unit}),this.onDrawLRSGUIImageOrientation(a,b))},onClearLRSGUIImageOrientation:function(a){var b=[];a.LRSGUISVG.forEach(function(a){"imageOrientation"==a.data("identifier")&&b.push(a)});jQuery.each(b,function(a,b){b.remove()})},clearLRSGUIImageOrientation:function(a){"undefined"!==
typeof LRSSchematic&&a===ImajnetUI.LRSGUI&&(LRSSchematic.imajnetImageData=null);if(a&&a.LRSGUISVG){if(a===ImajnetUI.LRSGUI&&"undefined"!==typeof LRSSchematic&&LRSSchematic.LRSGUI&&!LRSSchematic.isMinimized()&&a.currentRoadId==LRSSchematic.LRSGUI.currentRoadId)this.onClearLRSGUIImageOrientation(LRSSchematic.LRSGUI);this.onClearLRSGUIImageOrientation(a)}},clearLRSGUI:function(a){a.LRSGUISVG&&a.LRSGUISVG.clear()},drawLRSSchematicLine:function(a,b,d,c){return a.LRSGUISVG.path("M "+b.x+" "+b.y+" L "+d.x+
" "+d.y).attr(c)},drawRoadBoundsAndCenterLine:function(a){var b=0,d=0;"portrait"==LRSSchematic.orientation?(b=LRSSchematic.itemWidth,d=LRSSchematic.itemHeight):(b=LRSSchematic.itemHeight,d=LRSSchematic.itemWidth);var c=[this.getPoint(a,{x:0,y:0}),this.getPoint(a,{x:0,y:d})];this.drawLRSSchematicLine(a,c[0],c[1],{stroke:"#FFFFFF","stroke-width":1,"stroke-dasharray":"-"});b=parseInt(b/2);c=[this.getPoint(a,{x:b,y:0}),this.getPoint(a,{x:b,y:d})];this.drawLRSSchematicLine(a,c[0],c[1],{stroke:"#FFFFFF",
"stroke-width":1})},drawFeatureDefaultPoint:function(a,b,d){a=a.LRSGUISVG.circle(b.x,b.y,LRSSchematic.featurePointSize/2).attr({fill:"#00FF00","fill-opacity":.5,stroke:"#000000"});a[0].id="featureGraphicElements_"+d.replace(".","_");return a},drawFeaturePoint:function(a,b,d,c,e){b=this.getPoint({orientation:LRSSchematic.orientation},{x:b.x,y:b.y});e?(c.featureSize=LRSSchematic.featurePointSize,c.layerStyle=d,StyleEditor.drawFeaturePoint(d,c,b)):LRSSchematic.pushDraggableFeature({layerName:d,featureId:c.getId(),
container:this.drawFeatureDefaultPoint(a,b,c.getId())[0],isLineEnd:""})},drawFeatureLinePoint:function(a,b){return a.LRSGUISVG.circle(b.x,b.y,7).attr({fill:Nigsys.hoverObjectsColor})},drawFeatureImage:function(a){},recalculateWithRotation:function(a){return Math.sqrt(2*Math.pow(a,2))-a},recalculateInCaseOfRotation:function(a){var b=a.rotation;b&&0!==b%90&&(b=parseInt(b)/90,.5<b&&(b=1-b),a.pointRadius-=b*this.recalculateWithRotation(a.pointRadius)+2,a.strokeWidth&&(a.strokeWidth-=2*b*this.recalculateWithRotation(a.strokeWidth)))},
appendPinPoint:function(a,b){},createRenderer:function(a,b,d){}};
var FlatGraphic=Nigsys.cloneObject(Graphic);FlatGraphic.init=function(){this.svg=this.initSVG("popupImajnetControlsLayer",this.svg)};FlatGraphic.showPreviewPanelSVG=function(){null!==this.previewPanelSVG&&jQuery(this.previewPanelSVG.canvas).show()};FlatGraphic.drawPreviewPanelLine=function(a,b){this.previewPanelSVG.path("M "+a.x+" "+a.y+" L "+b.x+" "+b.y).attr({stroke:Nigsys.defaultObjectsColor,"stroke-width":2})};
FlatGraphic.drawLineBetweenPoints=function(a,b,c,d,g){this.init();this.svg.path("M "+a+" "+b+" L "+c+" "+d).attr({stroke:g?g:Nigsys.defaultObjectsColor,"stroke-width":1})};
FlatGraphic.drawIntermediateLine=function(a,b,c,d){this.init();jQuery("#photogrammetryPath_"+ImajnetPolyligne.currentAddObjectId).remove();a=this.svg.path("M "+a+" "+b+" L "+c+" "+d);a.attr({stroke:Nigsys.defaultObjectsColor,"stroke-width":2}).data("object",{id:ImajnetPolyligne.currentAddObjectId});Nigsys.browserIsIE7()&&a.mouseover(function(a){ImajnetZoom.imageWasDragged=!1});a.node.id="photogrammetryPath_"+ImajnetPolyligne.currentAddObjectId};
FlatGraphic.drawConstraintLine=function(a,b){this.constraintSVG.path(a).attr({stroke:b,"stroke-width":1}).node.setAttribute("id","constraintLine")};FlatGraphic.drawConstraint=function(a,b){this.initConstraint();for(var c=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(a.point[0]),d="M "+c.x+" "+c.y,g=1;g<a.point.length-1;g++)c=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(a.point[g]),d+=" L "+c.x+" "+c.y;this.drawConstraintLine(d,this.getConstraintColor(a.precision))};
FlatGraphic.highlightFeatureOnImage=function(a){a&&(a.getType()==ImajnetMap.MARKER_TYPE_POSITION||a.getType()==ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION||a.getType()==ImajnetMap.MARKER_TYPE_TARGET_POINT?jQuery('div[id\x3d"photogrammetryItem_'+a.getId()+'"]').removeClass("opacity100").addClass("opacity60"):(a.getType()==ImajnetMap.FEATURE_TYPE_PROJECTION&&jQuery('div[id\x3d"photogrammetryItem_'+a.getId()+'"]').removeClass("opacity100").addClass("opacity60"),null!==this.svg&&this.svg.forEach(function(b){var c=
ImajnetMap.getFeatureWrapperById(b.data("object").id);c&&c.getId()==a.getId()&&b.attr("stroke-opacity",.4)})))};
FlatGraphic.unHighlightFeatureOnImage=function(a){a&&(a.getType()==ImajnetMap.MARKER_TYPE_POSITION||a.getType()==ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION||a.getType()==ImajnetMap.MARKER_TYPE_TARGET_POINT?jQuery('div[id\x3d"photogrammetryItem_'+a.getId()+'"]').removeClass("opacity60").addClass("opacity100"):(a.getType()==ImajnetMap.FEATURE_TYPE_PROJECTION&&jQuery('div[id\x3d"photogrammetryItem_'+a.getId()+'"]').removeClass("opacity60").addClass("opacity100"),null!==this.svg&&this.svg.forEach(function(b){var c=
ImajnetMap.getFeatureWrapperById(b.data("object").id);c&&c.getId()==a.getId()&&b.attr("stroke-opacity",1)})))};
FlatGraphic.drawLine=function(a,b,c){this.init();var d={stroke:c.strokeColor?c.strokeColor:Nigsys.defaultObjectsColor,"stroke-width":c.strokeWidth||0==c.strokeWidth?c.strokeWidth:2};c.strokeDashstyle&&(d["stroke-dasharray"]="-");c.fillColor&&(d.fill=c.fillColor);jQuery("#photogrammetryPath_"+b.getId()).remove();c=ImajnetZoom.shiftKeyPressed&&b.getId()!==ImajnetPolyligne.currentAddObjectId?"hidden":"visible";a=this.svg.path(a);a.attr(d).data("object",{id:b.getId()}).mouseover(function(a){ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOver(this.data("object").id,
a,"imajnetImageLayer",null)}).mouseout(function(){ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOut(this.data("object").id)}).click(function(){ImageControler.currentPhotogrammetry.onPhotogrammetryItemClick(this.data("object").id)}).dblclick(function(a){ImageControler.currentPhotogrammetry.showComment(a,null,this.data("object").id,"popupImajnetControlsLayer","textareaEditComment_")});a.node.id="photogrammetryPath_"+b.getId();"hidden"==c&&jQuery(a.node).hide()};
FlatGraphic.drawPolygon=function(a,b,c){c.fillColor||(c.fillColor=Nigsys.defaultPolygonObjectsColor);this.drawLine(a,b,c)};FlatGraphic.clearConstraints=function(){null!==this.constraintSVG&&(this.constraintSVG.remove(),this.constraintSVG=null)};
FlatGraphic.clearItem=function(a){jQuery("#photogrammetryItem"+a).parent().remove();jQuery("#photogrammetryItem"+a).remove();jQuery("#textareaEditComment_"+a).remove();jQuery('div[id\x3d"imajnetPhotogrammetryLRS_'+a+'"]').remove();jQuery("#LRSClipboard_"+a).remove();jQuery("#imajnetClipboardItem_"+a).remove();jQuery("#measurementText_"+a).remove();if(this.svg){var b=[];this.svg.forEach(function(c){var d=c.data("object");d&&d.id==a&&b.push(c)});jQuery.each(b,function(a,b){b.remove()})}};
FlatPhotogrammetry.showImageObjects=function(){jQuery(".photogrammetryItem").show()};FlatGraphic.showGraphicObjects=function(){jQuery(".measurementText").show();this.svg&&this.svg.forEach(function(a){jQuery(a.node).show()})};FlatGraphic.hideGraphicObjects=function(){jQuery(".measurementText").hide();if(this.svg){var a=[];this.svg.forEach(function(b){b.data().object.id!==ImajnetPolyligne.currentAddObjectId&&a.push(b)});jQuery.each(a,function(a,c){jQuery(c.node).hide()})}};
FlatPhotogrammetry.clearImageObjects=function(){jQuery(".photogrammetryItem").remove()};FlatGraphic.clearGraphicObjects=function(){jQuery(".measurementText").remove();if(this.svg){var a=[];this.svg.forEach(function(b){a.push(b)});jQuery.each(a,function(a,c){c.remove()})}};FlatGraphic.hideAllLayersProjections=function(){if(this.svg){var a=[];this.svg.forEach(function(b){a.push(b)});jQuery.each(a,function(a,c){c.hide()})}};
FlatGraphic.showAllLayersProjections=function(){if(this.svg){var a=[];this.svg.forEach(function(b){a.push(b)});jQuery.each(a,function(a,c){c.show()})}};
FlatGraphic.mouseMove=function(a){if(a&&ImageControler.currentGraphic.firstClickCoordinates){var b=ImajnetUI.imajnetImageContainer.offset();ImageControler.currentGraphic.lastClickCoordinates={x:a.originalEvent.pageX-b.left,y:a.originalEvent.pageY-b.top};if(ImajnetPolyligne.isConstraint){var c=ImajnetPolyligne.getConstraintPoints(ImageControler.currentGraphic.lastClickCoordinates.x,ImageControler.currentGraphic.lastClickCoordinates.y);if(c){var d=c.secondPoint;a=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(d.mPt2.mPts[0].mPixel_pt);
b=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(c.firstPoint.mPixel_pt);c=c.firstPoint.coordinates;ImageControler.currentGraphic.drawIntermediateLine(b.x,b.y,a.x-1,a.y-1);d=ImageControler.currentPhotogrammetry.getMeasurementInUnits(ImageControler.currentPhotogrammetry.computeDistanceBetweenPoints(c,{lon:d.mPt2.mPos_llh[0],lat:d.mPt2.mPos_llh[1],height:d.mPt2.mPos_llh[2]}));a=ImageControler.currentPhotogrammetry.getMeasurementTextPosition({x:b.x,y:b.y},{x:a.x,y:a.y});jQuery("#measurementText_Constraint").remove();
ImajnetUI.popupImajnetControlsLayer.append('\x3cdiv id\x3d"measurementText_Constraint" class\x3d"measurementText" style\x3d"top: '+a.y+"px; left:"+a.x+'px;" \x3e'+d+"\x3c/div\x3e")}}else b=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(ImageControler.currentGraphic.firstClickCoordinates),ImageControler.currentGraphic.drawIntermediateLine(b.x,b.y,ImageControler.currentGraphic.lastClickCoordinates.x-1,ImageControler.currentGraphic.lastClickCoordinates.y-1)}};
FlatGraphic.onDrawFeatureImage=function(a,b,c){if(b.style){var d=Nigsys.cloneObject(b.style),g=0,f=!1;jQuery.each(d,function(a,c){style=c;style.externalGraphic&&(style.strokeWidth=0,f=!0,delete style.graphicXOffset,delete style.graphicYOffset);if(style&&"none"!=style.display){style.strokeWidth&&(style.stroke=!0);if(!style.stroke||style.stroke&&!style.strokeWidth)style.strokeWidth=0;var d=(2*parseFloat(style.pointRadius)+(style.strokeWidth?parseFloat(style.strokeWidth):0))/b.featureSize;d>g&&(g=d)}});
var k=this.createRenderer("photogrammetryItem_"+b.featureId,{width:b.featureSize,height:b.featureSize},f&&(Nigsys.browserIsWebkit()||Nigsys.browserIsIE9())?"Canvas":"");k&&jQuery.each(d,function(d,f){var e=b.featureOL;if("application/chart"==f.graphicFormat)return!0;if(f.label&&c){var n=jQuery('div[id\x3d"labelOnFeature_'+b.featureId+'"]');jQuery.each(f,function(a,b){if("label"!=a&&"fill"!=a){var c=a,d=b;"fontSize"==c?(c="font-size",d="10px"):"fillColor"==c?c="color":"fontWeight"==c?c="font-weight":
"fontStyle"==c&&(c="font-style");n.css(c,d)}});e=f.label.replace("${","").replace("}","").trim();n.attr("title",e);n.html(c[e]);return!0}e=new OpenLayersForProjection.Geometry.Point(0,0);e=new OpenLayersForProjection.Feature.Vector(e,c,null);e.style=f;if(1>=g){e.style.pointRadius=parseFloat(e.style.pointRadius);e.style.strokeWidth=parseFloat(e.style.strokeWidth);var h=2*e.style.pointRadius/b.featureSize,l=2*e.style.strokeWidth/b.featureSize,q=(h+l)/g,m=0<l?h/l:h;l>h&&(m=l/h);h=(1-g)*b.featureSize/
(2*(0==e.style.strokeWidth?m:m+1));e.style.pointRadius=e.style.pointRadius+q*h*m-2;isNaN(e.style.pointRadius)&&(e.style.pointRadius=0);e.style.strokeWidth&&(e.style.strokeWidth+=q*h)}else e.style.pointRadius/=g,e.style.strokeWidth&&(e.style.strokeWidth/=g);ImageControler.currentGraphic.recalculateInCaseOfRotation(e.style);if(Nigsys.graphicIsFont(e.style.graphicName))return a.children(0).append(StyleEditor.drawRuleFontImageOnImajnetImage(e.style)),!0;k.drawFeature(e)})}};
FlatGraphic.drawFeatureImage=function(a){var b=jQuery('div[id\x3d"photogrammetryItem_'+a.featureId+'"]');if(a&&0!=b.length)this.onDrawFeatureImage(b,a,null)};FlatGraphic.recalculateWithRotation=function(a){return Math.sqrt(2*Math.pow(a,2))-a};FlatGraphic.recalculateInCaseOfRotation=function(a){var b=a.rotation;b&&0!==b%90&&(b=parseInt(b)/90,.5<b&&(b=1-b),a.pointRadius-=b*this.recalculateWithRotation(a.pointRadius)+2,a.strokeWidth&&(a.strokeWidth-=2*b*this.recalculateWithRotation(a.strokeWidth)))};
FlatPhotogrammetry.appendMapMarker=function(a,b){var c=b.z?40-b.z/2.5:40,c=12<c?c:12,d=void 0===b.z?120+b.z/4:120,g=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(b);ImajnetUI.popupImajnetControlsLayer.append('\x3cdiv id\x3d"photogrammetryItem_'+a+'" class\x3d"photogrammetryItem" style\x3d"z-index: 1; position: absolute; top: '+Math.round(g.y-d)+"px; left: "+Math.round(g.x-c/2)+'px;" onclick\x3d"ImageControler.currentPhotogrammetry.onPhotogrammetryItemClick(\''+a+"');\" onmouseover\x3d\"ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOver('"+
a+"',event,  'imajnetImageLayer', jQuery(this));\" onmouseout\x3d\"ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOut('"+a+"', jQuery(this));\" ondblclick\x3d\"ImageControler.currentPhotogrammetry.showComment(event, jQuery(this), '"+a+"', 'popupImajnetControlsLayer', 'textareaEditComment_');\"\x3e\x3cimg src\x3d\""+Imajnet.imajnetPath+"img/targetIconMarker16x36.png?"+Imajnet.version+'" width\x3d"'+c+'" height\x3d"'+d+'" /\x3e\x3c/div\x3e')};
FlatGraphic.appendPinPoint=function(a,b){if(b){var c=b.getId(),d=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(a),g=0,f=0;b.getType()!=ImajnetMap.FEATURE_TYPE_PROJECTION?b.getType()==ImajnetMap.MARKER_TYPE_POSITION?(f=a.z?32-Math.round(a.z/3):32,g=d.y-f):(f=5,g=d.y-f/2):(f=52,a.z&&(f=a.z/1.5>f-6?6:Math.round(f-a.z/1.5)),g=d.y-f/2);jQuery("#pinPointContainer_"+c).remove();var k='\x3cdiv id\x3d"photogrammetryItem_'+c+'" style\x3d"width: '+f+"px; height: "+f+'px;"\x3e'+(b.getType()!=ImajnetMap.FEATURE_TYPE_PROJECTION?
'\x3cimg style\x3d"display:block" src\x3d"'+Imajnet.imajnetPath+"img/"+(b.getType()==ImajnetMap.MARKER_TYPE_POSITION?"pinpoint":"polyligne")+".png?"+Imajnet.version+'" width\x3d"'+f+'" height\x3d"'+f+'"  /\x3e':"")+"\x3c/div\x3e",p=ImajnetZoom.shiftKeyPressed&&c!==ImajnetPolyligne.currentAddObjectId?"none":"block";-1<ImajnetPolyligne.currentAddObjectId&&c>ImajnetPolyligne.currentAddObjectId&&(p="block");var r='\x3cdiv id\x3d"labelOnFeature_'+c+'" class\x3d"left" style\x3d"padding-top: '+f/3+'px;"\x3e\x3c/div\x3e';
ImajnetUI.popupImajnetControlsLayer.append('\x3cdiv id\x3d"pinPointContainer_'+c+'" onmouseover\x3d"ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOver(\''+b.id+"', event, 'imajnetImageLayer', jQuery(this));\" onmouseout\x3d\"ImageControler.currentPhotogrammetry.onPhotogrammetryItemMouseOut('"+b.id+"');\" onclick\x3d\"ImageControler.currentPhotogrammetry.onPhotogrammetryItemClick('"+b.id+'\');" class\x3d"photogrammetryItem" style\x3d"display:'+p+"; position: absolute; width: "+f+"px; height: "+
f+"px; top: "+Math.round(g)+"px; left: "+Math.round(d.x-f/2)+"px; z-index: "+(b.getType()==ImajnetMap.FEATURE_TYPE_PROJECTION?Math.round(2*ImajnetSettings.imajnetSettings.projection-a.z):1)+';"\x3e'+k+r+"\x3c/div\x3e");b.getType()!=ImajnetMap.FEATURE_TYPE_PROJECTION?jQuery("#photogrammetryItem_"+c).dblclick({id:c},function(a){ImageControler.currentPhotogrammetry.showComment(a,jQuery(this),a.data.id,"popupImajnetControlsLayer","textareaEditComment_")}):(b.featureSize=f,b.zIndex=a.z,b.featureId=c,this.drawFeatureImage(b))}else console.error("Null featureWrapper: ")};
FlatGraphic.createRenderer=function(a,b,c){var d=null;c&&(c=OpenLayersForProjection.Renderer[c])&&c.prototype.supported()&&(d=new c(a));if(!d)for(var g=0,f=this.renderers.length;g<f;++g)if((c=OpenLayersForProjection.Renderer[this.renderers[g]])&&c.prototype.supported()){try{d=new c(a)}catch(k){return null}break}d.map={getResolution:function(){return 1}};b&&(d.setSize(new OpenLayersForProjection.Size(b.width,b.height)),d.setExtent(new OpenLayersForProjection.Bounds(-b.width/2,-b.height/2,b.width/2,
b.height/2),!0));return d};
var CubeGraphic=Nigsys.cloneObject(Graphic);CubeGraphic.init=function(){this.cubeObjects||(this.cubeObjects=new THREE.Object3D);CubePlugin.objectsScene.add(this.cubeObjects)};CubeGraphic.showPreviewPanelSVG=function(){null!==this.previewPanelSVG&&jQuery(this.previewPanelSVG.canvas).show()};CubeGraphic.drawPreviewPanelLine=function(a,b){this.previewPanelSVG.path("M "+a.x+" "+a.y+" L "+b.x+" "+b.y).attr({stroke:Nigsys.defaultObjectsColor,"stroke-width":2})};
CubeGraphic.drawLine=function(a,b,c,d,e,f){this.init();this.svg.path("M "+a+" "+b+" L "+c+" "+d).attr({stroke:f?f:Nigsys.defaultObjectsColor,"stroke-width":this.defaultStrokeWidth}).data("id",e).mouseover(function(a){var b=this.attr();this.objectIdToHighlight=this.data("id");ImageControler.currentPhotogrammetry.showLRS(a,null,this.objectIdToHighlight,"imajnetImageLayer");b.stroke==Nigsys.differentTracePinPointColor?(ImageControler.currentPhotogrammetry.highlightPinPoint(this.objectIdToHighlight),
this.attr({stroke:Nigsys.differentTracePinPointHoverColor})):(ImageControler.currentPhotogrammetry.highlightMeasurement(this.objectIdToHighlight),this.attr({stroke:Nigsys.hoverObjectsColor}))}).mouseout(function(){var a=this.attr();jQuery('div[id\x3d"imajnetPhotogrammetryLRS_'+this.data("id")+'"]').hide();a.stroke==Nigsys.differentTracePinPointHoverColor?(ImageControler.currentPhotogrammetry.deselectHighlightPinPoint(this.objectIdToHighlight),this.attr({stroke:Nigsys.differentTracePinPointColor})):
(ImageControler.currentPhotogrammetry.deselectHighlightMeasurement(this.objectIdToHighlight),this.attr({stroke:Nigsys.defaultObjectsColor}));this.objectIdToHighlight=""}).mousedown(function(){ImageControler.currentPhotogrammetry.onPhotogrammetryItemClick(this.data("id"))}).dblclick(function(a){ImageControler.currentPhotogrammetry.showComment(a,null,this.data("id"),"popupImajnetControlsLayer","textareaEditComment_")})};
CubeGraphic.drawIntermediateLine=function(a,b){if(a&&b){var c=[a,b],d=new THREE.LineBasicMaterial({color:65280,linewidth:2}),e=new THREE.Geometry;e.vertices=c;line=new THREE.Line(e,d);line.name="Intermediate Line";this.cubeObjects.add(line)}};CubeGraphic.drawConstraintLine=function(a,b){this.constraintSVG.path(a).attr({stroke:b,"stroke-width":1})};
CubeGraphic.drawConstraint=function(a,b){this.initConstraint();for(var c=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(a.point[0]),d="M "+c.x+" "+c.y,e=1;e<a.point.length-1;e++)c=ImajnetZoom.getCoordinatesFromRealAtCurrentZoom(a.point[e]),d+=" L "+c.x+" "+c.y;this.drawConstraintLine(d,this.getConstraintColor(a.precision))};CubeGraphic.clearGraphicObjects=function(){this.cubeObjects&&(this.cubeObjects.children=[])};
CubeGraphic.clearConstraints=function(){null!==this.constraintSVG&&(this.constraintSVG.remove(),this.constraintSVG=null)};CubeGraphic.clearAllLayersProjections=function(){if(this.svg){var a=[];this.svg.forEach(function(b){void 0!==b.data("object")&&a.push(b)});jQuery.each(a,function(a,c){c.remove()})}};CubeGraphic.hideAllLayersProjections=function(){if(this.svg){var a=[];this.svg.forEach(function(b){a.push(b)});jQuery.each(a,function(a,c){c.hide()})}};
CubeGraphic.showAllLayersProjections=function(){if(this.svg){var a=[];this.svg.forEach(function(b){a.push(b)});jQuery.each(a,function(a,c){c.show()})}};
CubeGraphic.mouseMove=function(a){a&&(ImageControler.currentGraphic.clearGraphicObjects(),ImageControler.currentGraphic.lastClickCoordinates=CubePlugin.getCubeCoordinatesFromEvent(a),a=CubePlugin.getCubeCoordinatesFromImageCoordinates(ImageControler.currentGraphic.firstClickCoordinates),ImageControler.currentGraphic.lastClickCoordinates&&a&&ImageControler.currentGraphic.drawIntermediateLine(a,ImageControler.currentGraphic.lastClickCoordinates))};
CubeGraphic.recalculateWithRotation=function(a){return Math.sqrt(2*Math.pow(a,2))-a};CubeGraphic.recalculateInCaseOfRotation=function(a){var b=a.rotation;b&&0!==b%90&&(b=parseInt(b)/90,.5<b&&(b=1-b),a.pointRadius-=b*this.recalculateWithRotation(a.pointRadius)+2,a.strokeWidth&&(a.strokeWidth-=2*b*this.recalculateWithRotation(a.strokeWidth)))};
CubeGraphic.createRenderer=function(a,b,c){var d=null;c&&(c=OpenLayersForProjection.Renderer[c])&&c.prototype.supported()&&(d=new c(a));if(!d)for(var e=0,f=this.renderers.length;e<f;++e)if((c=OpenLayersForProjection.Renderer[this.renderers[e]])&&c.prototype.supported()){d=new c(a);break}d.map={getResolution:function(){return 1}};b&&(d.setSize(new OpenLayersForProjection.Size(b.width,b.height)),d.setExtent(new OpenLayersForProjection.Bounds(-b.width/2,-b.height/2,b.width/2,b.height/2),!0));return d};
var ImajnetMeasurement={zoomLevel:null,firstImageClick1:null,firstImageClick2:null,secondImageClick1:null,noOfClickedPoints:1,measurementAjaxRequest:null,onMeasurementClick:function(a){ImajnetPlugin.positionImageOnFeature(a.getId())},addPreviewPanel:function(){jQuery("#imajnetPreviewPanel").html('\x3cdiv id\x3d"imajnetPreviewPanelContent"\x3e\x3cdiv class\x3d"imajnetPreviewPanelItem imageTrace" id\x3d"imajnetPreviewPanelItem1"\x3e\x3cb\x3e'+jQuery.imajnet.map.measurement.step+"\x26nbsp;1\x3c/b\x3e\x3cbr/\x3e"+
jQuery.imajnet.map.measurement.step1Content+'\x3c/div\x3e\x3cdiv class\x3d"imajnetPreviewPanelItemArrow" id\x3d"imajnetPreviewPanelItemArrow1"\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetPreviewPanelItem imageTrace" id\x3d"imajnetPreviewPanelItem2"\x3e\x3cb\x3e'+jQuery.imajnet.map.measurement.step+"\x26nbsp;2\x3c/b\x3e\x3cbr/\x3e"+jQuery.imajnet.map.measurement.step2Content+'\x3c/div\x3e\x3cdiv class\x3d"imajnetPreviewPanelItemArrow" id\x3d"imajnetPreviewPanelItemArrow2"\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetPreviewPanelItem imageTrace" id\x3d"imajnetPreviewPanelItem3"\x3e\x3cb\x3e'+
jQuery.imajnet.map.measurement.step+"\x26nbsp;3\x3c/b\x3e\x3cbr/\x3e"+jQuery.imajnet.map.measurement.step3Content+"\x3c/div\x3e\x3c/div\x3e");Nigsys.browserIsIE7()||Nigsys.browserIsIE8()||jQuery(".imajnetPreviewPanelItem").corner("5px");ImajnetUI.popupImajnetControlsLayer.append('\x3cimg id\x3d"measurementDenied" src\x3d"'+Imajnet.imajnetPath+"img/measurementDenied.png?"+Imajnet.version+'" width\x3d"100" height\x3d"100" style\x3d"position: absolute; top: '+(ImajnetUI.imajnetImageContainerSize.height-
100)/2+"px; left: "+(ImajnetUI.imajnetImageContainerSize.width-100)/2+'px; display: none;" /\x3e')},showMeasurement:function(a){ImageControler.currentPhotogrammetry.deletePrevObjects();ImajnetPosition.hidePosition(a);ImajnetPolyligne.hide(a);ImageControler.currentSurveyTrace.hideTrace();ImajnetZoom.deactivateZoom();ImajnetUI.activeControlButton="imajnetMeasurement";this.addPreviewPanel();jQuery("#imajnetPreviewPanel").show();jQuery("#imajnetMeasurementButtonContainer").addClass("buttonActive");ImageControler.currentPhotogrammetry.clear();
ImajnetImageSwitcher.hide();ImajnetUI.LRSGUI.hide();ImajnetZoom.imageWasDragged=!1;Address.hideAddressContainer();LRS.hideLRSContainer();ImajnetUI.hideDateContainer();FlatGraphic.svg&&FlatGraphic.svg.canvas.setAttribute("class","noMouseEvents")},hideMeasurement:function(a){FlatGraphic.svg&&FlatGraphic.svg.canvas.setAttribute("class",null);ImajnetUI.activeControlButton="";ImajnetUI.imajnetImageContainer&&ImageControler.currentPhotogrammetry&&!Nigsys.onMobile()&&ImajnetUI.imajnetImageContainer.unbind("mousemove",
ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).unbind("mousemove",ImageControler.currentGraphic.mouseMove);jQuery("#imajnetPreviewPanel").hide();jQuery("#measurementDenied").hide();jQuery("#imajnetMeasurementButtonContainer").removeClass("buttonActive");ImageControler.currentPhotogrammetry&&(this.noOfClickedPoints=ImageControler.currentPhotogrammetry.currentStep=1,ImageControler.currentPhotogrammetry.setRedStep(ImageControler.currentPhotogrammetry.currentStep-1),ImageControler.currentPhotogrammetry.firstImagePosition=
null,ImageControler.currentPhotogrammetry.constraintParameter=null,a?(ImageControler.currentPhotogrammetry.redraw(!1),ImageControler.currentSurveyTrace.draw(ImajnetMap.currentPosition)):ImageControler.currentPhotogrammetry.hidePreviewPanel())},showHideMeasurement:function(){jQuery("#imajnetMeasurementButtonContainer").hasClass("buttonActive")?(this.hideMeasurement(!0),LRS.cachedPoints[ImajnetMap.currentPosition.lat+":"+ImajnetMap.currentPosition.lon+":"+ImajnetMap.currentPosition.height]&&ImajnetUI.LRSGUI.draw(LRS.cachedPoints[ImajnetMap.currentPosition.lat+
":"+ImajnetMap.currentPosition.lon+":"+ImajnetMap.currentPosition.height]),Address.showAddress(),LRS.showLRS(),ImajnetUI.showDateContainer(),ImageControler.currentPhotogrammetry.redraw(!1)):this.showMeasurement(!0)},showHideMeasurementDenied:function(){this.noOfClickedPoints=1;ImageControler.currentPhotogrammetry.photogrammetryIsDenied()?jQuery("#measurementDenied").show():(jQuery("#measurementDenied").hide(),Nigsys.onMobile()||ImajnetUI.imajnetImageContainer.bind("mousemove",ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).bind("mousemove",
ImageControler.currentGraphic.mouseMove),ImageControler.currentPhotogrammetry.getConstraint())},reload:function(a){jQuery("#imajnetMeasurementButtonContainer").hasClass("buttonActive")&&(this.hideMeasurement(!1),this.showMeasurement(!1),ImajnetZoom.imageWasDragged=!1)},getPreviewPanelZoomFactor:function(a,c){return Math.max(.65*Math.min(ImajnetZoom.HIGH_RESOLUTION_WIDTH/Math.abs(c.x-a.x),ImajnetZoom.HIGH_RESOLUTION_HEIGHT/Math.abs(c.y-a.y)),1)},drawPreviewPanelLine:function(a,c,b,d){ImageControler.currentGraphic.previewPanelGraphicInit();
a=ImageControler.currentPhotogrammetry.getPreviewPanelPoint(a,b,d);c=ImageControler.currentPhotogrammetry.getPreviewPanelPoint(c,b,d);ImageControler.currentGraphic.drawPreviewPanelLine(a,c)},onImageResize:function(a){Nigsys.isMeasurementMode()&&ImageControler.currentGraphic.firstClickCoordinates&&ImageControler.currentGraphic.mouseMove(a)},measurementReceived:function(a){ImageControler.currentPhotogrammetry.setRedStep(ImageControler.currentPhotogrammetry.currentStep);ImajnetMeasurement.showHideMeasurement();
if((a=JSON.parse(a))&&a.parameter&&a.parameter.imagePoint1&&a.parameter.imagePoint1.img1){a.type="measurement";var c=ImageControler.currentPhotogrammetry.addObject(a.parameter.imagePoint1.img1,a,!1,!0,!0);ImajnetAPI.setImajnetImage({position:a.parameter.imagePoint1.img1});ImageControler.currentPhotogrammetry.getObjectLRS(a);ImajnetPlugin.onMeasurementCreated({id:c.id,measurement:a.measurementResult})}else ImajnetUI.showError(jQuery.imajnet.map.measurement.errorMeasurement,!0)},measurementComplete:function(a){200!==
a.status&&(ImajnetMeasurement.showHideMeasurement(),ImageControler.currentPhotogrammetry.redraw(!1),ImajnetUI.showError(jQuery.imajnet.map.measurement.errorMeasurement,!0))},drawPreviewPanelLineAgain:function(){if(null!==ImajnetMeasurement.firstImageClick1&&null!==ImajnetMeasurement.firstImageClick2){ImageControler.currentGraphic.clearPreviewPanel();var a={x:this.firstImageClick1.x==this.firstImageClick2.x?this.firstImageClick1.x:Math.abs(this.firstImageClick1.x+this.firstImageClick2.x)/2,y:this.firstImageClick1.y==
this.firstImageClick2.y?this.firstImageClick1.y:Math.abs(this.firstImageClick1.y+this.firstImageClick2.y)/2},c=this.getPreviewPanelZoomFactor(this.firstImageClick1,this.firstImageClick2),a=ImageControler.currentPhotogrammetry.setPreviewPanelVisibleRegion(a,c);ImajnetMeasurement.drawPreviewPanelLine(this.firstImageClick1,this.firstImageClick2,c,a)}},measureObject:function(a,c,b){if(jQuery("#imajnetMeasurementButtonContainer").hasClass("buttonActive")){ImajnetAPI.mustAbortRequests&&null!==this.measurementAjaxRequest&&
this.measurementAjaxRequest.abort();var d=null;b&&b.face&&(d=b.face);ImajnetZoom.imageQuality="HIGH_RESOLUTION";b=null;"FLAT"==ImageControler.currentImageType?(ImajnetUI.previewImage.attr("src",ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.firstImagePosition,ImajnetUI.getPreviewImageResolution())),b=ImajnetZoom.getRealImageCoordinates(a,c)):(ImajnetUI.previewImage.attr("src",ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.firstImagePosition,ImajnetUI.getPreviewImageResolution()),
d),b={x:a,y:c});switch(ImageControler.currentPhotogrammetry.currentStep){case 1:switch(this.noOfClickedPoints){case 1:ImageControler.currentGraphic.firstClickCoordinates={x:b.x,y:b.y,face:d};ImageControler.currentPhotogrammetry.firstImagePosition=ImajnetMap.currentPosition;this.firstImageClick1={imageId:ImageControler.currentPhotogrammetry.firstImagePosition.id,x:b.x,y:b.y};this.noOfClickedPoints++;ImageControler.currentGraphic.init();Nigsys.onMobile()||("FLAT"==ImageControler.currentImageType?ImajnetUI.imajnetImageContainer.bind("mousemove",
ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).bind("mousemove",ImageControler.currentGraphic.mouseMove):CubePlugin.cubeContainer.bind("mousemove",ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).bind("mousemove",ImageControler.currentGraphic.mouseMove));break;case 2:ImajnetUI.previewImage.attr("src",ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.firstImagePosition,ImajnetUI.getPreviewImageResolution())),c={x:this.firstImageClick1.x==b.x?this.firstImageClick1.x:
Math.abs(this.firstImageClick1.x+b.x)/2,y:this.firstImageClick1.y==b.y?this.firstImageClick1.y:Math.abs(this.firstImageClick1.y+b.y)/2},a=this.getPreviewPanelZoomFactor(this.firstImageClick1,b),c=ImageControler.currentPhotogrammetry.setPreviewPanelVisibleRegion(c,a),this.drawPreviewPanelLine(this.firstImageClick1,b,a,c),ImageControler.currentPhotogrammetry.showPreviewPanel(),ImageControler.currentPhotogrammetry.setRedStep(ImageControler.currentPhotogrammetry.currentStep),this.firstImageClick2={imageId:ImageControler.currentPhotogrammetry.firstImagePosition.id,
x:b.x,y:b.y},ImageControler.currentPhotogrammetry.constraintParameter=Object({points:[Object({x:this.firstImageClick1.x,y:this.firstImageClick1.y}),Object({x:this.firstImageClick2.x,y:this.firstImageClick2.y})]}),this.noOfClickedPoints=1,ImageControler.currentPhotogrammetry.currentStep++,ImageControler.currentImageControl.getPrevious(!0),ImageControler.currentGraphic.firstClickCoordinates=null}break;case 2:switch(this.noOfClickedPoints){case 1:ImageControler.currentGraphic.init();ImageControler.currentGraphic.firstClickCoordinates=
{x:b.x,y:b.y,face:d};this.secondImageClick1={imageId:ImajnetMap.currentPosition.id,x:b.x,y:b.y};this.noOfClickedPoints++;break;case 2:Nigsys.onMobile()||("FLAT"==ImageControler.currentImageType?ImajnetUI.imajnetImageContainer.unbind("mousemove",ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).unbind("mousemove",ImageControler.currentGraphic.mouseMove):CubePlugin.cubeContainer.unbind("mousemove",ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).unbind("mousemove",ImageControler.currentGraphic.mouseMove)),
ImageControler.currentPhotogrammetry.setRedStep(ImageControler.currentPhotogrammetry.currentStep),ImageControler.currentGraphic.clearConstraints(),this.measurementAjaxRequest=ImajnetAPI.doImajnetRequest("GET","/api/photogrammetry/measurement/free/",{imagePoint1:{img1:ImageControler.currentPhotogrammetry.firstImagePosition,img2:ImajnetMap.currentPosition,imgCoord1:{x:this.firstImageClick1.x,y:this.firstImageClick1.y},imgCoord2:{x:this.secondImageClick1.x,y:this.secondImageClick1.y}},imagePoint2:{img1:ImageControler.currentPhotogrammetry.firstImagePosition,
img2:ImajnetMap.currentPosition,imgCoord1:{x:this.firstImageClick2.x,y:this.firstImageClick2.y},imgCoord2:{x:b.x,y:b.y}}},this.measurementReceived,null,this.measurementComplete),Address.showAddress(),this.noOfClickedPoints=1,ImageControler.currentPhotogrammetry.currentStep++}}}}};
var ImajnetPolyligne={type:"",typesArray:["polyligne","polygon"],currentAddObjectId:-1,isConstraint:!1,constraintMeasurementData:null,isPolyligneObject:function(b){return b?(b=ImageControler.currentPhotogrammetry.getObjectById(b))?-1!==jQuery.inArray(b.type,ImajnetPolyligne.typesArray)||b.points:!1:!1},addPreviewPanel:function(){jQuery("#imajnetPreviewPanel").html('\x3cdiv id\x3d"imajnetPreviewPanelContent"\x3e\x3c/div\x3e\x3cdiv id\x3d"imajnetPreviewCheckboxContainer"\x3e\x3cinput type\x3d"checkbox" id\x3d"imajnetPreviewCheckbox"\x3e'+
jQuery.imajnet.map.hidePreviewPanel+'\x3c/div\x3e\x3cdiv class\x3d"clear"\x3e\x3c/div\x3e');jQuery("#imajnetPreviewCheckbox").iCheck({checkedCheckboxClass:"checkedCheckbox",uncheckedCheckboxClass:"uncheckedCheckbox"}).on("ifChanged",function(b){ImajnetUI.disablePreviewPanel()});ImageControler.currentPhotogrammetry.setCurrentPreviewStep();ImajnetUI.popupImajnetControlsLayer.append('\x3cimg id\x3d"polyligneDenied" src\x3d"'+Imajnet.imajnetPath+"img/measurementDenied.png?"+Imajnet.version+'" width\x3d"100" height\x3d"100" style\x3d"position: absolute; top: '+
(ImajnetUI.imajnetImageContainerSize.height-100)/2+"px; left: "+(ImajnetUI.imajnetImageContainerSize.width-100)/2+'px; display: none;" /\x3e')},addContextmenuHTML:function(){ImajnetUI.contextMenuContainer.hide();ImajnetUI.contextMenuContainer.html('\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImageControler.currentPhotogrammetry.resetGeometry(); Nigsys.disableEventPropagation(event); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.resetGeometry+'\x3c/div\x3e\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImageControler.currentPhotogrammetry.deleteLastPoint(); Nigsys.disableEventPropagationFull(event); ImajnetUI.hideContextMenu(event)"\x3e'+
jQuery.imajnet.map.contextMenu.deleteLastPoint+'\x3c/div\x3e\x3cdiv class\x3d"contextMenuItem" onclick\x3d"ImajnetPolyligne.finishGeometry(\''+ImajnetPolyligne.type+"', "+ImajnetPolyligne.isMeasurementMode()+'); Nigsys.disableEventPropagationFull(event); ImajnetUI.hideContextMenu(event)"\x3e'+jQuery.imajnet.map.contextMenu.finishGeometry+"\x3c/div\x3e")},getConstraintMeasurementData:function(){ImajnetPolyligne.constraintMeasurementData=ImajnetAPI.getPreviousImageFromCache(ImajnetMap.currentPosition.id)||
ImajnetAPI.getNextImageFromCache(ImajnetMap.currentPosition.id);if(!ImajnetPolyligne.constraintMeasurementData){var b=new ImajnetData.imageOrderParameter(ImajnetMap.currentPosition,"next",!1);ImajnetAPI.imajnetOrderRequest=ImajnetAPI.doImajnetRequestDeferred("GET","/api/positions/order/",b,ImajnetAPI.positionOrderReceived,ImajnetAPI.onError,null,null,!0,{changeImage:!1}).done(function(){ImajnetAPI.imajnetOrderRequest=null;ImajnetPolyligne.constraintMeasurementData=ImajnetAPI.getNextImageFromCache(ImajnetMap.currentPosition.id)})}},
show:function(b,c,a){ImageControler.currentPhotogrammetry.deletePrevObjects();ImajnetPosition.hidePosition(b);ImageControler.currentSurveyTrace.hideTrace();ImajnetZoom.deactivateZoom();ImajnetUI.activeControlButton="imajnetPolyligne";a?(ImajnetPolyligne.getConstraintMeasurementData(),ImajnetPolyligne.isConstraint=!0):ImajnetPolyligne.isConstraint=!1;this.currentAddObjectId=-1;jQuery("#imajnetPolyligneButtonContainermeasurement").removeClass("buttonActive");ImajnetPolyligne.getButtonContainer(c,a).addClass("buttonActive");
this.addContextmenuHTML();ImajnetImageSwitcher.hide();ImajnetUI.LRSGUI.hide();ImajnetUI.clientLogoContainer.hide();ImajnetZoom.imageWasDragged=!1;Address.hideAddressContainer();LRS.hideLRSContainer();ImajnetUI.hideDateContainer();this.addPreviewPanel();ImajnetUI.isPreviewPanelDisabled()||jQuery("#imajnetPreviewPanel").fadeIn(150);ImajnetUI.imajnetImageContainer&&ImageControler.currentPhotogrammetry&&!Nigsys.onMobile()&&ImajnetPolyligne.isMeasurementMode()&&(ImajnetUI.imajnetImageContainer.bind("mousemove",
ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).bind("mousemove",ImageControler.currentGraphic.mouseMove),FlatGraphic.svg&&FlatGraphic.svg.canvas.setAttribute("class","noMouseEvents"))},hide:function(b,c,a,d){ImajnetUI.imajnetImageContainer&&ImageControler.currentPhotogrammetry&&!Nigsys.onMobile()&&ImajnetPolyligne.isMeasurementMode()&&(ImajnetUI.imajnetImageContainer.unbind("mousemove",ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel).unbind("mousemove",ImageControler.currentGraphic.mouseMove),
FlatGraphic.svg&&FlatGraphic.svg.canvas.setAttribute("class",null));if(ImajnetPolyligne.type)ImajnetPolyligne.onFinish(c);ImajnetUI.activeControlButton="";jQuery("#imajnetPreviewPanel").hide();jQuery("#polyligneDenied").hide();jQuery("#imajnetPolyligneButtonContainerpolygon").removeClass("buttonActive");jQuery("#imajnetPolyligneButtonContainerpolyligne").removeClass("buttonActive");jQuery("#imajnetPolyligneButtonContainermeasurement").removeClass("buttonActive");jQuery("#imajnetPolyligneButtonContainermeasurementConstraint").removeClass("buttonActive");
ImajnetPolyligne.type="";ImajnetPolyligne.isConstraint=!1;Address.showAddress();LRS.showLRS();ImajnetUI.showDateContainer();ImajnetUI.clientLogoContainer.show();ImageControler.currentPhotogrammetry.redraw(!1);ImajnetMap.currentPosition&&LRS.cachedPoints[ImajnetMap.currentPosition.lat+":"+ImajnetMap.currentPosition.lon+":"+ImajnetMap.currentPosition.height]&&ImajnetUI.LRSGUI.draw(LRS.cachedPoints[ImajnetMap.currentPosition.lat+":"+ImajnetMap.currentPosition.lon+":"+ImajnetMap.currentPosition.height]);
ImageControler.currentPhotogrammetry&&(ImageControler.currentPhotogrammetry.currentStep=1,ImageControler.currentPhotogrammetry.firstImagePosition=null,ImageControler.currentPhotogrammetry.constraintParameter=null,b?ImageControler.currentSurveyTrace.draw(ImajnetMap.currentPosition):ImageControler.currentPhotogrammetry.hidePreviewPanel())},showHide:function(b,c,a){ImajnetUI.stopSwipeNavigation(!0);ImageControler.currentImageControl.resetFastNavigation();ImajnetPolyligne.type&&b!=ImajnetPolyligne.type||
!ImajnetPolyligne.getButtonContainer(c,a).hasClass("buttonActive")?(this.hide(!1,!1,c),ImajnetPolyligne.type=b,this.show(!0,c,a)):this.hide(!0,!1,c)},getButtonContainer:function(b,c){var a=null;return a=b?ImajnetPolyligne.isConstraint&&c?jQuery("#imajnetPolyligneButtonContainermeasurementConstraint"):jQuery("#imajnetPolyligneButtonContainermeasurement"):jQuery("#imajnetPolyligneButtonContainer"+ImajnetPolyligne.type)},isMeasurementMode:function(){return jQuery("#imajnetPolyligneButtonContainermeasurement").hasClass("buttonActive")||
jQuery("#imajnetPolyligneButtonContainermeasurementConstraint").hasClass("buttonActive")},getType:function(){return ImajnetPolyligne.isMeasurementMode()?"measurement":ImajnetPolyligne.type},showHideDenied:function(){ImageControler.currentPhotogrammetry.photogrammetryIsDenied()?jQuery("#polyligneDenied").show():(jQuery("#polyligneDenied").hide(),Nigsys.isPolyligneMode()&&0==ImageControler.currentPhotogrammetry.currentStep%2&&ImageControler.currentPhotogrammetry.getConstraint())},reload:function(b){b=
ImajnetPolyligne.isMeasurementMode();var c=ImajnetPolyligne.isConstraint;if(jQuery("#imajnetPolyligneButtonContainer"+ImajnetPolyligne.type).hasClass("buttonActive")||b){this.deleteLastSessionObjects();var a=ImajnetPolyligne.type;this.hide(!1,!1,b,c);ImajnetPolyligne.type=a;this.show(!1,b,c);ImajnetZoom.imageWasDragged=!1}},getAllObjectsId:function(b){for(var c=[],a=0;a<ImageControler.currentPhotogrammetry.objects.length;a++)for(var d=0;d<ImageControler.currentPhotogrammetry.objects[a].data.length;d++)if(-1!==
jQuery.inArray(ImageControler.currentPhotogrammetry.objects[a].data[d].type,ImajnetPolyligne.typesArray)){c.push(ImageControler.currentPhotogrammetry.objects[a].data[d].id);var e=!1;ImageControler.currentPhotogrammetry.objects[a].data[d].id==b&&(e=!0);for(var f=0;f<ImageControler.currentPhotogrammetry.objects[a].data[d].points.length;f++)c.push(ImageControler.currentPhotogrammetry.objects[a].data[d].points[f].id),ImageControler.currentPhotogrammetry.objects[a].data[d].points[f].id==b&&(e=!0);if(e)return c;
c=[]}return c},getTotalDistance:function(b){for(var c=0,a=0;a<b.points.length;a++)"undefined"===typeof b.points[a].distance||isNaN(b.points[a].distance)||(c+=b.points[a].distance);return c},getCurrentObjectMiddlePoint:function(b){var c=ImajnetPolyligne.getTotalDistance(b)/2;if(0==c)return b.points[0].photogrammetryPosition3D.coordinates;for(var a=0,d=0;d<b.points.length;d++)if("undefined"!==typeof b.points[d].distance&&!isNaN(b.points[d].distance)){if(a+b.points[d].distance>c)return!b.points[d+1]||
a+b.points[d].distance/2>c?b.points[d].photogrammetryPosition3D.coordinates:b.points[d+1].photogrammetryPosition3D.coordinates;a+=b.points[d].distance}},deleteLastSessionObjects:function(){-1!=ImajnetPolyligne.currentAddObjectId&&ImageControler.currentPhotogrammetry.deletePhotogrammetryItem(ImajnetPolyligne.currentAddObjectId)},isPolyligneOrPolygon:function(b){return-1!==jQuery.inArray(b,ImajnetPolyligne.typesArray)},objectIsPolyligneOrPolygon:function(b){b=ImageControler.currentPhotogrammetry.getObjectById(b);
return-1!==jQuery.inArray(b.type,ImajnetPolyligne.typesArray)},pointPositionSuccess:function(b,c){c&&c.stopNextStep||(ImageControler.currentPhotogrammetry.currentStep=1,ImageControler.currentPhotogrammetry.setCurrentPreviewStep());if((b=JSON.parse(b))&&b.parameter&&b.parameter.imagePoint&&b.parameter.imagePoint.img1){b.type=ImajnetPolyligne.type;b.linkToNext=!0;if(-1===ImajnetPolyligne.currentAddObjectId){var a=ImageControler.currentPhotogrammetry.addObject(b.parameter.imagePoint.img1,{parameter:b.parameter,
type:ImajnetPolyligne.type},!0,!0,!1);ImajnetPolyligne.currentAddObjectId=a.id;a=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);b.id=ImageControler.currentPhotogrammetry.getLastObjectId();a.points=Array(b)}else{a=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);b.id=ImageControler.currentPhotogrammetry.getLastObjectId();var d=a.points.length-1;a.points[d].distance=ImageControler.currentPhotogrammetry.computeDistanceBetweenPoints(a.points[d].photogrammetryPosition3D.coordinates,
b.photogrammetryPosition3D.coordinates);a.points.push(b)}ImajnetMap.drawPhotogrammetryObjects();c&&c.stopImageChange||ImajnetMap.currentPosition&&ImajnetAPI.setImajnetImage({position:b.parameter.imagePoint.img1}).done(function(){});ImageControler.currentPhotogrammetry.redraw(!1)}else ImajnetUI.showError(jQuery.imajnet.map.position.errorPosition,!0)},pointPositionError:function(b){ImageControler.currentPhotogrammetry.currentStep--},onPositionReceivedError:function(){ImajnetAPI.setImajnetImage({position:ImageControler.currentPhotogrammetry.firstImagePosition}).done(function(){ImageControler.currentPhotogrammetry.setCurrentPreviewStep()})},
pointPositionComplete:function(b){200!==b.status&&(ImajnetPolyligne.pointPositionError(),ImajnetUI.showError(jQuery.imajnet.map.position.errorPosition,!0,ImajnetPolyligne.onPositionReceivedError))},positionObject:function(b,c,a){if(!Imajnet3dPosition.isActive||!Imajnet3dPosition.position3dObject(b,c)){ImajnetAPI.mustAbortRequests&&null!==this.positionAjaxRequest&&this.positionAjaxRequest.abort();var d=null;a&&a.face&&(d=a.face);if(1==ImageControler.currentPhotogrammetry.currentStep%2){ImageControler.currentPhotogrammetry.firstImagePosition=
ImajnetMap.currentPosition;ImajnetZoom.imageQuality="HIGH_RESOLUTION";var e=null;"FLAT"==ImageControler.currentImageType?(ImajnetUI.previewImage.attr("src",ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.firstImagePosition,ImajnetUI.getPreviewImageResolution())),e=ImajnetZoom.getRealImageCoordinates(b,c)):(ImajnetUI.previewImage.attr("src",ImajnetAPI.buildImageURL(ImageControler.currentPhotogrammetry.firstImagePosition,ImajnetUI.getPreviewImageResolution()),d),e={x:b,y:c});ImageControler.currentGraphic.clearPreviewPanel();
b=ImajnetZoom.getPreviewPanelZoomFactor();c=ImageControler.currentPhotogrammetry.setPreviewPanelVisibleRegion(e,b);ImageControler.currentGraphic.drawPreviewPanelPoint(e,b,c);ImageControler.currentPhotogrammetry.showPreviewPanel();ImageControler.currentPhotogrammetry.constraintParameter=Object({points:Array(e)});ImageControler.currentImageControl.getPrevious(!0);ImageControler.currentPhotogrammetry.currentStep++;ImajnetUI.imajnetImageContainer.bind("mousemove",ImageControler.currentPhotogrammetry.imageMouseMovePreviewPanel);
ImageControler.currentPhotogrammetry.setCurrentPreviewStep()}else ImageControler.currentPhotogrammetry.hidePreviewPanel(),ImajnetZoom.imageQuality="HIGH_RESOLUTION",e="FLAT"==ImageControler.currentImageType?ImajnetZoom.getRealImageCoordinates(b,c):{x:b,y:c},ImageControler.currentPhotogrammetry.constraintParameter||(ImageControler.currentPhotogrammetry.constraintParameter=Object({points:Array(e)})),ImageControler.currentGraphic.clearConstraints(),Address.showAddress(),this.positionAjaxRequest=ImajnetAPI.doImajnetRequest("GET",
"/api/photogrammetry/position3D/",{imagePoint:{img1:ImageControler.currentPhotogrammetry.firstImagePosition,img2:ImajnetMap.currentPosition,imgCoord1:{x:ImageControler.currentPhotogrammetry.constraintParameter.points[0].x,y:ImageControler.currentPhotogrammetry.constraintParameter.points[0].y},imgCoord2:{x:e.x,y:e.y}}},this.pointPositionSuccess,null,this.pointPositionComplete,null,null,a)}},onFinishClick:function(){ImajnetPolyligne.showHide(ImajnetPolyligne.type)},onFinish:function(b){if(Imajnet.imajnetIsActive()&&
-1!=ImajnetPolyligne.currentAddObjectId){ImageControler.currentPhotogrammetry&&ImageControler.currentPhotogrammetry.setCurrentPreviewStep();var c=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);if(c)if(1==c.points.length){var a=ImajnetMap.getFeatureWrapperById(c.id+1);ImajnetPlugin.removeFeatures(ImajnetMap.photogrammetryPositionsLayer,[a]);ImageControler.currentPhotogrammetry.deletePhotogrammetryItem(c.id);c=c.points[0];c.linkToNext=!1;delete c.id;ImageControler.currentPhotogrammetry.deleteLastPoint();
ImageControler.currentPhotogrammetry.updateCache();ImajnetPosition.pinPointPositionReceived(JSON.stringify(c),{stopNextStep:!0,stopImageChange:b})}else{a=!1;"polygon"==ImajnetPolyligne.type&&2==c.points.length&&(a=!0,c.type="polyligne");ImageControler.currentPhotogrammetry.getObjectLRS(c);for(var d=[],e=0;e<c.points.length;e++)d.push({x:c.points[e].photogrammetryPosition3D.coordinates.lon,y:c.points[e].photogrammetryPosition3D.coordinates.lat,z:c.points[e].photogrammetryPosition3D.coordinates.height}),
a&&(c.points[e].type=c.type);"polygon"==ImajnetPolyligne.type&&(c.points[c.points.length-1].distance=ImageControler.currentPhotogrammetry.computeDistanceBetweenPoints(c.points[c.points.length-1].photogrammetryPosition3D.coordinates,c.points[0].photogrammetryPosition3D.coordinates),d.push(d[0]));c.measurement||(c.measurement=ImageControler.currentPhotogrammetry.getMeasurement(c));if(Imajnet.autoPhotogrammetryAdd)ImajnetPlugin.onObjectCreatedDefault({type:"polyligne"==ImajnetPolyligne.type||4>d.length?
"line":"polygon",id:c.id,geometry:d});else if(ImajnetPolyligne.isMeasurementMode())ImajnetPlugin.onMeasurementCreated({firstPoint:d[0],secondPoint:d[1],id:ImajnetPolyligne.currentAddObjectId,measurement:c.measurement});else ImajnetPlugin.onPolyligneCreated({id:ImajnetPolyligne.currentAddObjectId,geometry:d,type:"polyligne"==ImajnetPolyligne.type||4>d.length?"line":"polygon"});ImajnetPolyligne.currentAddObjectId=-1;ImageControler.currentPhotogrammetry.drawObjectClipboard(c,!0);ImageControler.currentPhotogrammetry.updateCache();
ImageControler.currentPhotogrammetry.isObjectInImage(c.id)||!ImajnetMap.currentPosition||b||ImajnetPlugin.positionImageOnFeature(c.id)}}},finishGeometry:function(b,c,a){var d=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);d&&2>d.points.length&&(d=ImajnetMap.getPolyligneFeatureWrappers(ImajnetPolyligne.currentAddObjectId)[0])&&(d.getType()==ImajnetMap.MARKER_TYPE_POLYLIGNE_POSITION?ImajnetPlugin.removeMarker(ImajnetMap.photogrammetryPositionsLayer,d):ImajnetPlugin.removeFeatures(ImajnetMap.imajnetDragFeaturesLayer,
Array(d)));!ImajnetSettings.imajnetSettings.toolsRemainActive||a?ImajnetPolyligne.showHide(b,c,ImajnetPolyligne.isConstraint):(ImajnetPolyligne.onFinish(!1),ImajnetPolyligne.reload())},positionPointOnPlane:function(b,c){var a=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);if(!a||3>a.points.length)return!1;for(var d=[],e=0;e<a.points.length;e++)d.push(a.points[e].photogrammetryPosition3D.coordinates.lon,a.points[e].photogrammetryPosition3D.coordinates.lat,a.points[e].photogrammetryPosition3D.coordinates.height);
var a={mAttitude:ImajnetMap.currentPosition.orientation,mPos_llh:{lat:ImajnetMap.currentPosition.lat,lon:ImajnetMap.currentPosition.lon,height:ImajnetMap.currentPosition.height}},f=[];Imajnet3dPosition.llh2XYZ(a,d,3,f);d={pImage:a,mOpt_pt:f.slice(0,3)};e={pImage:a,mOpt_pt:f.slice(3,6)};f={pImage:a,mOpt_pt:f.slice(6,9)};a={mPixel_pt:ImajnetZoom.getRealImageCoordinates(b,c),pImage:a,mPos_llh:[]};Imajnet3dPosition.GetPointOnPlane(a,d,e,f);if(!a)return!1;d=a.mPixel_pt;d.z=a.mOpt_pt[2];a={linkToNext:!1,
parameter:{imagePoint:{img1:ImajnetMap.currentPosition,imgCoord1:d}},photogrammetryPosition3D:{coordinates:{lon:a.mPos_llh[0],lat:a.mPos_llh[1],height:a.mPos_llh[2]},precision:1},type:ImajnetPolyligne.type};jQuery("#measurementText_Constraint").remove();ImajnetPolyligne.pointPositionSuccess(JSON.stringify(a),{stopImageChange:!0});return!0},getConstraintPoints:function(b,c){if(!ImajnetPolyligne.constraintMeasurementData)return null;var a=ImageControler.currentPhotogrammetry.getObjectById(ImajnetPolyligne.currentAddObjectId);
if(!a||1!=a.points.length)return null;var a=a.points[0].photogrammetryPosition3D.coordinates,d=[],e={mAttitude:ImajnetMap.currentPosition.orientation,mPos_llh:{lat:ImajnetMap.currentPosition.lat,lon:ImajnetMap.currentPosition.lon,height:ImajnetMap.currentPosition.height}};Imajnet3dPosition.llh2XYZ(e,[a.lon,a.lat,a.height],1,d);a={mOpt_pt:{x:d[0],y:d[1],z:d[2]},pImage:e,coordinates:a};Imajnet3dPosition.fillReprojPoint(a);var f=ImajnetZoom.getRealImageCoordinates(b,c),h={mAttitude:ImajnetPolyligne.constraintMeasurementData.orientation,
mPos_llh:{lat:ImajnetPolyligne.constraintMeasurementData.lat,lon:ImajnetPolyligne.constraintMeasurementData.lon,height:ImajnetPolyligne.constraintMeasurementData.height}},d=Imajnet3dPosition.createMptPoint(),e=Imajnet3dPosition.createMptPoint(),g=Imajnet3dPosition.createMptPoint();Imajnet3dPosition.computeOrthoDistance(a,f,h,d,e,g,null);f=null;f=d.mDist_cursor_pt2<e.mDist_cursor_pt2&&d.mDist_cursor_pt2<g.mDist_cursor_pt2?d:e.mDist_cursor_pt2<g.mDist_cursor_pt2&&e.mDist_cursor_pt2<d.mDist_cursor_pt2?
e:g;return f.mPt2.mPts[0].mPixel_pt?{firstPoint:a,secondPoint:f}:null},positionSecondConstraintPoint:function(b,c){var a=ImajnetPolyligne.getConstraintPoints(b,c);if(!a)return!1;var a=a.secondPoint.mPt2,d=a.mPts[0].mPixel_pt;d.z=a.mPts[0].mOpt_pt.z;a={linkToNext:!1,parameter:{imagePoint:{img1:ImajnetMap.currentPosition,imgCoord1:d}},photogrammetryPosition3D:{coordinates:{lon:a.mPos_llh[0],lat:a.mPos_llh[1],height:a.mPos_llh[2]},precision:1},type:ImajnetPolyligne.type};jQuery("#measurementText_Constraint").remove();
ImajnetPolyligne.pointPositionSuccess(JSON.stringify(a),{stopImageChange:!0});return!0}};
var ImajnetImageSwitcher={imageSwitcherContainerId:"popupImageSwitcher",closestImagesAjaxRequest:null,orientedImages:null,orderedImages:[],orderedImagesLength:0,mouseScrollIndex:0,isMouseWheel:!1,ORDERED_IMAGE_WIDTH:60,ORDERED_IMAGE_HEIGHT:50,ORDERED_IMAGE_DATE_HEIGHT:11,ORDERED_IMAGES_NO:3,ARROWS_NO:8,ORDERED_IMAGE_BIG_WIDTH:0,ORDERED_IMAGE_BIG_HEIGHT:0,ORDERED_IMAGE_DATE_BIG_HEIGHT:21,isBigMode:!1,orderedImagesMainContainer:null,orderedImagesContainer:null,initialScrollLeft:0,frontOrientedImages:null,
dragArrowWidth:81,dragLeftPosition:null,dragRightPosition:null,getImageItemHtml:function(a){var b="";switch(a){case 0:b="margin-top: 14px; margin-left: 11px;";break;case 1:b="margin-top: 27px; margin-left: -9px;";break;case 2:b="margin-top: 14px; margin-left: 5px;";break;case 3:b="margin-top: -6px; margin-left: -9px;";break;case 4:b="margin-top: 5px; margin-left: 11px;";break;case 5:b="margin-top: -6px; margin-left: 29px;";break;case 6:b="margin-top: 11px; margin-left: 14px;";break;case 7:b="margin-top: 27px; margin-left: 27px;"}return'\x3cdiv class\x3d"imageSwitcherItem"\x3e'+
(this.orientedImages[a]&&this.orientedImages[a].length?'\x3cimg id\x3d"orientedImage_'+a+'" onclick\x3d"ImajnetImageSwitcher.goToImage('+a+');" onmouseover\x3d"ImajnetImageSwitcher.imageMouseOver('+a+');" onmouseout\x3d"ImajnetImageSwitcher.imageMouseOut();" src\x3d"'+Imajnet.imajnetPath+"img/imageSwitcher/"+a+".png?"+Imajnet.version+'" class\x3d"imajnetImageSwitcherImageItem" style\x3d"'+b+'" /\x3e':"\x26nbsp;")+"\x3c/div\x3e"},getMostRecentOrientedImageIndex:function(a,b){var c=null;0!=a&&(c=ImajnetImageSwitcher.orientedImages[a].slice(0).sort(ImajnetImageSwitcher.compareTimestampDescending)[0]);
for(var d=this.frontOrientedImages.slice(0).sort(ImajnetImageSwitcher.compareTimestampDescending),e=0;e<this.orientedImages[a].length;e++)if(c&&this.orientedImages[a][e].id==c.id||this.orientedImages[a][e].id==d[b].id)return e},getFrontOrientedImageIndex:function(a,b){if(0!=a)return b;for(var c=0;c<this.orientedImages[a].length;c++)if(this.orientedImages[a][c].id==this.frontOrientedImages[b].id)return c},imageMouseScroll:function(a,b){b=Nigsys.getDelta(a,b);var c=a.data;if(!(2>ImajnetImageSwitcher.orientedImages[c].length)){ImajnetImageSwitcher.isMouseWheel=
!0;var d=ImajnetImageSwitcher.orientedImages[c].length;0<b?(ImajnetImageSwitcher.mouseScrollIndex++,ImajnetImageSwitcher.mouseScrollIndex>=d&&(ImajnetImageSwitcher.mouseScrollIndex=0)):(ImajnetImageSwitcher.mouseScrollIndex--,0>ImajnetImageSwitcher.mouseScrollIndex&&(ImajnetImageSwitcher.mouseScrollIndex=d-1));ImajnetImageSwitcher.loadImage(c,ImajnetImageSwitcher.getFrontOrientedImageIndex(c,ImajnetImageSwitcher.mouseScrollIndex))}},compareTimestampAscending:function(a,b){return Nigsys.getDateObject(a.timestamp)-
Nigsys.getDateObject(b.timestamp)},compareTimestampDescending:function(a,b){return Nigsys.getDateObject(b.timestamp)-Nigsys.getDateObject(a.timestamp)},getOneImageFormEachSecquenceTraceTimestampOrdered:function(){if(!this.orientedImages||!this.orientedImages[0])return null;var a=Nigsys.cloneObject(ImajnetMap.currentPosition);a.imageIndex=0;var b=Array(a);jQuery.each(this.orientedImages[0],function(a,d){for(var e=!1,g=0;g<b.length;g++)if(b[g].traceId==d.traceId){e=!0;break}e||d.traceId==ImajnetMap.currentPosition.traceId||
(e=Nigsys.cloneObject(d),e.imageIndex=a,b.push(e))});return b.sort(this.compareTimestampAscending)},loadImageForSlider:function(a,b){var c=ImajnetAPI.buildImageURL(b),d=new Image;jQuery(d).bind("error",function(b){a.parent().addClass("imajnetLayerNoImage")});jQuery(d).load(function(){a.attr("src",c)}).attr("src",c)},loadImage:function(a,b,c){jQuery("body").css("cursor","progress");var d=null,d=c&&0==a&&-1==b?ImajnetMap.currentPosition:this.orientedImages[a][b],e=ImajnetAPI.buildImageURL(d,"medium");
a=new Image;jQuery(a).bind("error",function(a){ImajnetUI.imageSwitcherImageContainer.show();ImajnetUI.imageSwitcherImage.attr("src","").hide();ImajnetUI.imageSwitcherImageContainer.is(":visible")&&ImajnetUI.imageSwitcherImageContainer.addClass("imajnetLayerNoImage");ImajnetMap.currentPosition&&Imajnet.addImageDate(ImajnetMap.currentPosition.timestamp);jQuery("body").css("cursor","default")});ImajnetMap.hideImageSwitcher();ImajnetMap.setOrientationMarker(d,ImajnetMap.imajboxOrientedImagesDimension,
"#FF0000",-3);jQuery(a).load(function(a){var b=parseInt(Math.max(a.target.naturalWidth,ImajnetUI.imajnetImageContainerSize.width)),c=0;a.target.naturalWidth>ImajnetUI.imajnetImageContainerSize.width?c=parseInt((ImajnetUI.imajnetImageContainerSize.width-a.target.naturalWidth)/2):b=ImajnetUI.imajnetImageContainerSize.width;ImajnetUI.imageSwitcherImage.attr("src",e).css({width:b,left:c,position:"relative"});ImajnetUI.imageSwitcherImage.attr("src",e);ImajnetUI.imageSwitcherImage.show();d&&Imajnet.addImageDate(d.timestamp);
ImajnetUI.imageSwitcherImageContainer.show();jQuery("body").css("cursor","default");ImageControler.currentPhotogrammetry.hideImageObjects()}).attr("src",e)},goToImage:function(a){if(!ImajnetZoom.canZoom()){ImajnetZoom.left=-1;var b=this.getMostRecentOrientedImageIndex(a,this.mouseScrollIndex);this.orientedImages[a][b]&&(Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetAPI.setImajnetImage({position:this.orientedImages[a][b]}))}},goToOrderedImage:function(a){ImajnetZoom.left=-1;ImajnetImageSwitcher.hideBigMode();
ImajnetImageSwitcher.orderedImagesMainContainer.hide();ImajnetImageSwitcher.isBigMode=!1;this.orderedImages[a]&&(Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetAPI.stopImageCache=!0,ImajnetAPI.setImajnetImage({position:this.orderedImages[a]}))},imageMouseOver:function(a){this.mouseScrollIndex||this.loadImage(a,ImajnetImageSwitcher.getMostRecentOrientedImageIndex(a,0))},imageMouseOut:function(){this.isMouseWheel=!1;this.mouseScrollIndex=0;ImajnetUI.imageSwitcherImage.attr("src","").hide();ImajnetUI.imageSwitcherImageContainer.hide();
ImajnetMap.currentPosition&&Imajnet.addImageDate(ImajnetMap.currentPosition.timestamp);ImajnetMap.hideImageSwitcher();ImageControler.currentPhotogrammetry.showImageObjects()},getOrderedImageHtml:function(a,b,c,d){return'\x3cdiv class\x3d"left imajnetImageSwitcherOrderedImageItem" style\x3d"width: '+ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH+"px; height: "+(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+2)+'px;"\x3e\x3cdiv class\x3d"imageSwitcherImageItemContainer'+
(-2<a?" imajnetLoading":"")+'" onmouseout\x3d"ImajnetImageSwitcher.imageMouseOut();" style\x3d"height: '+ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+'px;"\x3e\x3cimg class\x3d"imageSwitcherSmall_'+d+' imajnetImageSwitcherOrderedImageItemImage" onclick\x3d"ImajnetImageSwitcher.goToOrderedImage('+d+');" onmouseover\x3d"ImajnetImageSwitcher.orderedImageMouseOver('+a+', jQuery(this));" style\x3d"width: '+ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH+"px; height: "+ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+'px;" src\x3d"'+
(-2==a?b:"")+'" /\x3e\x3c/div\x3e\x3cdiv id\x3d"orderedImageDate_'+a+'" class\x3d"orderedImageDate" style\x3d"width: '+ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH+"px; height: "+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+"px; font-size: "+(ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT-1)+'px;"\x3e'+c+"\x3c/div\x3e\x3c/div\x3e"},applySmallStyleToOrderedImages:function(){jQuery("#scrollOrderedImagesLeft").width(9).height(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT);jQuery(".scrollOrderedImagesLeftImage").width(9).height(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT).css("background-image",
'url("'+Imajnet.imajnetPath+"img/imageIcons/imageSwitcherLeftArrow.png?"+Imajnet.version+'")').css("margin-top",ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT/2-25);jQuery(".scrollOrderedImagesRight").width(9).height(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT);jQuery(".scrollOrderedImagesRightImage").width(9).height(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT).css("background-image",'url("'+Imajnet.imajnetPath+"img/imageIcons/imageSwitcherRightArrow.png?"+Imajnet.version+'")').css("margin-top",ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT/
2-25);var a=1;Nigsys.browserIsIE8()?a=2:Nigsys.browserIsWebkit()&&(a=4);jQuery(".imajnetImageSwitcherOrderedImagesInnerContainer").width(ImajnetImageSwitcher.ORDERED_IMAGES_NO*ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH+2).height(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+a).css("overflow-x","hidden");ImajnetImageSwitcher.orderedImagesMainContainer.width(ImajnetImageSwitcher.ORDERED_IMAGES_NO*ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH+20).height(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+
ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+2);ImajnetImageSwitcher.orderedImagesContainer.height(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+2);jQuery(".orderedImageDate").attr("title",jQuery.imajnet.image.switcher.centerButtonTitle)},centerImageMouseOver:function(){ImajnetImageSwitcher.orderedImagesContainer.html("");jQuery(".scrollOrderedImagesLeftImage").removeClass("opacity0");jQuery(".scrollOrderedImagesRightImage").removeClass("opacity0");ImajnetImageSwitcher.initialScrollLeft=
0;this.orderedImagesLength=this.orderedImages.length;jQuery.each(this.orderedImages,function(a,b){var c=b.imageIndex;b.traceId==ImajnetMap.currentPosition.traceId&&(c=-1,0==a&&ImajnetImageSwitcher.orderedImagesLength<ImajnetImageSwitcher.ORDERED_IMAGES_NO&&(ImajnetImageSwitcher.orderedImagesContainer.append(ImajnetImageSwitcher.getOrderedImageHtml(-2,Imajnet.imajnetPath+"img/imageIcons/imageSwitcherNoImageLeft.png?"+Imajnet.version,"")),ImajnetImageSwitcher.orderedImagesLength++));ImajnetImageSwitcher.orderedImagesContainer.append(ImajnetImageSwitcher.getOrderedImageHtml(c,
"",b.timestamp,a));var d=ImajnetAPI.buildImageURL(b),c=new Image;jQuery(c).bind("error",{id:a,url:d},function(a){jQuery(".imageSwitcherSmall_"+a.data.id).parent().addClass("imajnetSwitcherNoImage")});jQuery(c).load({id:a},function(a){a=jQuery(".imageSwitcherSmall_"+a.data.id);a.attr("src",d);a.parent().removeClass("imajnetLayerNoImage")}).attr("src",d);a==ImajnetImageSwitcher.orderedImages.length-1&&ImajnetImageSwitcher.orderedImagesLength<ImajnetImageSwitcher.ORDERED_IMAGES_NO&&(ImajnetImageSwitcher.orderedImagesContainer.append(ImajnetImageSwitcher.getOrderedImageHtml(-2,
Imajnet.imajnetPath+"img/imageIcons/imageSwitcherNoImageRight.png?"+Imajnet.version,"")),ImajnetImageSwitcher.orderedImagesLength++)});ImajnetImageSwitcher.applySmallStyleToOrderedImages();(Nigsys.browserIsWebkit()||Nigsys.browserIsIE8())&&jQuery(".orderedImageDate").css("padding-top","1px");jQuery(".orderedImageDate").bind("click",function(a){ImajnetImageSwitcher.centerImageClick(a)});ImajnetImageSwitcher.orderedImagesContainer.width(this.orderedImagesLength*this.ORDERED_IMAGE_WIDTH);3<this.orderedImagesLength?
jQuery(".scrollOrderedImagesLeftImage").removeClass("opacity0"):jQuery(".scrollOrderedImagesLeftImage").addClass("opacity0");jQuery(".scrollOrderedImagesRightImage").addClass("opacity0");ImajnetImageSwitcher.orderedImagesMainContainer.show();jQuery(".imajnetImageSwitcherOrderedImagesInnerContainer").scrollLeft(ImajnetImageSwitcher.orderedImagesContainer.width())},centerImageMouseLeave:function(){ImajnetImageSwitcher.orderedImagesMainContainer.hide()},applyBigStyleToOrderedImages:function(){jQuery("#scrollOrderedImagesLeft").width(50).height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT);
jQuery(".scrollOrderedImagesLeftImage").width(50).height(50).css("background-image",'url("'+Imajnet.imajnetPath+"img/imageIcons/imageSwitcherLeftArrow.png?"+Imajnet.version+'")').css("margin-top",ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT/2-25);jQuery(".scrollOrderedImagesRight").width(50).height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT);jQuery(".scrollOrderedImagesRightImage").width(50).height(50).css("background-image",'url("'+Imajnet.imajnetPath+"img/imageIcons/imageSwitcherRightArrow.png?"+
Imajnet.version+'")').css("margin-top",ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT/2-25);jQuery.each(jQuery(".imageSwitcherImageItemContainer"),function(a,b){var e=jQuery(b);e.height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT);e.hasClass("imajnetSwitcherNoImage")&&e.removeClass("imajnetSwitcherNoImage").addClass("imajnetLayerNoImage")});jQuery(".imajnetImageSwitcherOrderedImageItemImage").width(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH).height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT);
var a=jQuery(".orderedImageDate");a.removeAttr("title");a.width(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH).height(ImajnetImageSwitcher.ORDERED_IMAGE_DATE_BIG_HEIGHT).css("font-size",ImajnetImageSwitcher.ORDERED_IMAGE_DATE_BIG_HEIGHT-1);for(var b=0;b<a.length;b++)a[b].innerHTML=Nigsys.formatImajnetImageDate(a[b].innerHTML);jQuery(".imajnetImageSwitcherOrderedImageItem").width(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH).height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_BIG_HEIGHT+
2);ImajnetImageSwitcher.orderedImagesContainer.width(this.orderedImagesLength*this.ORDERED_IMAGE_BIG_WIDTH).height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_BIG_HEIGHT+2);jQuery(".imajnetImageSwitcherOrderedImagesInnerContainer").width(ImajnetImageSwitcher.ORDERED_IMAGES_NO*ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH+2).height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_BIG_HEIGHT+4);ImajnetImageSwitcher.orderedImagesMainContainer.width(ImajnetImageSwitcher.ORDERED_IMAGES_NO*
ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH+60).height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_BIG_HEIGHT+2);jQuery(".imajnetImageSwitcherOrderedImagesInnerContainer").height(ImajnetImageSwitcher.ORDERED_IMAGE_BIG_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_BIG_HEIGHT+16).css("overflow-x","auto")},hideBigMode:function(){jQuery.colorbox.close()},onCenterImagesScroll:function(a){0>=jQuery(a.target).scrollLeft()?jQuery(".scrollOrderedImagesLeftImage").addClass("opacity0"):
jQuery(".scrollOrderedImagesLeftImage").removeClass("opacity0");jQuery(a.target).scrollLeft()==ImajnetImageSwitcher.orderedImagesContainer.width()-ImajnetImageSwitcher.ORDERED_IMAGES_NO*ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH?jQuery(".scrollOrderedImagesRightImage").addClass("opacity0"):jQuery(".scrollOrderedImagesRightImage").removeClass("opacity0")},centerImageClick:function(a){a.relatedTarget||(ImajnetImageSwitcher.isBigMode=!0,ImajnetImageSwitcher.applyBigStyleToOrderedImages(),jQuery.colorbox({html:ImajnetImageSwitcher.orderedImagesMainContainer.html(),
open:!0,onLoad:function(){jQuery("#cboxClose").remove();jQuery("#cboxBottomLeft").height(9).css("background-position","0 -66px");jQuery("#cboxBottomCenter").height(9);jQuery("#cboxBottomRight").height(9).css("background-position","-36px -66px")},onComplete:function(){ImajnetImageSwitcher.orderedImagesMainContainer.hide();ImajnetImageSwitcher.orderedImagesMainContainer=jQuery("#colorbox #imajnetImageSwitcherOrderedImagesContainer");jQuery(".imajnetImageSwitcherOrderedImagesInnerContainer").scrollLeft(ImajnetImageSwitcher.orderedImagesContainer.width());
jQuery("#cboxContent .imajnetImageSwitcherOrderedImagesInnerContainer").on("scroll",ImajnetImageSwitcher.onCenterImagesScroll)},onCleanup:function(){ImajnetImageSwitcher.orderedImagesMainContainer=jQuery("#popupImajnet #imajnetImageSwitcherOrderedImagesContainer");ImajnetImageSwitcher.orderedImagesMainContainer.hide();jQuery("#cboxLoadedContent").html("");ImajnetImageSwitcher.isBigMode=!1;ImajnetMap.hideImageSwitcher()}}))},orderedImageMouseOver:function(a,b){jQuery(".imajnetImageSwitcherOrderedImageItemImage").removeClass("opacity80");
jQuery(".imajnetImageSwitcherOrderedImageItemImage").removeClass("selectedImageBorder");jQuery(".orderedImageDate").css("font-weight","normal");jQuery(".orderedImageDate").removeClass("orderedImageDateBorder");b.parent().removeClass("imajnetLoading");b.addClass("opacity80");b.addClass("selectedImageBorder");jQuery("#orderedImageDate_"+a).css("font-weight","bold");jQuery("#orderedImageDate_"+a).addClass("orderedImageDateBorder");-1>a||(ImajnetImageSwitcher.orderedImagesMainContainer.show(),this.loadImage(0,
a,!0))},orderedImagesMouseOut:function(a,b){ImajnetImageSwitcher.orderedImagesMainContainer.hide()},getImageWidth:function(){return ImajnetImageSwitcher.isBigMode?ImajnetImageSwitcher.ORDERED_IMAGE_BIG_WIDTH:ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH},scrollOrderedImages:function(a){var b=ImajnetImageSwitcher.getImageWidth();if(!(ImajnetImageSwitcher.orderedImagesContainer.width()<=ImajnetImageSwitcher.ORDERED_IMAGES_NO*b)){var c=jQuery(".imajnetImageSwitcherOrderedImagesInnerContainer:visible"),d=
c.scrollLeft();a==ImajnetAPI.PREVIOUS?(d-=b,0>=d&&jQuery(".scrollOrderedImagesLeftImage").addClass("opacity0"),jQuery(".scrollOrderedImagesRightImage").removeClass("opacity0")):(d+=b,d>=ImajnetImageSwitcher.orderedImagesContainer.width()-ImajnetImageSwitcher.ORDERED_IMAGES_NO*b&&jQuery(".scrollOrderedImagesRightImage").addClass("opacity0"),jQuery(".scrollOrderedImagesLeftImage").removeClass("opacity0"));c.scrollLeft(d)}},compareImageId:function(a,b){return parseInt(a.id)-parseInt(b.id)},initSliderImagesDimension:function(){ImajnetUI.setSlidersWidth(ImajnetUI.imajnetImageContainerSize.width);
ImajnetUI.setSliderDraggableContainment()},dragSliderLeft:function(){ImajnetImageSwitcher.dragLeftPosition&&(ImajnetZoom.left=-1,ImajnetUI.imajnetImageSliderInnerContainer.css("left",0),Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetAPI.setImajnetImage({position:ImajnetImageSwitcher.dragLeftPosition}))},dragSliderRight:function(){ImajnetImageSwitcher.dragRightPosition&&(ImajnetZoom.left=-1,ImajnetUI.imajnetImageSliderInnerContainer.css("left",-2*(ImajnetUI.imageContainer.width()+ImajnetImageSwitcher.dragArrowWidth)),
Nigsys.showLoading(ImajnetUI.imageContainer),ImajnetAPI.setImajnetImage({position:ImajnetImageSwitcher.dragRightPosition}))},getImageSwitcherHtml:function(a){if(ImajnetMap.currentPosition){ImajnetImageSwitcher.orientedImages=[];ImajnetImageSwitcher.frontOrientedImages=[];var b=[],c=[],d=null,e=null,g=null,k=null;a.sort(ImajnetImageSwitcher.compareTimestampDescending);jQuery.each(a,function(a,f){if(f.id!=ImajnetMap.currentPosition.id){var h=ImageControler.currentSurveyTrace.calculateOrientationIndex(ImajnetMap.currentPosition.orientation.yaw,
f.orientation.yaw);ImajnetImageSwitcher.orientedImages[h]||(ImajnetImageSwitcher.orientedImages[h]=[]);ImajnetImageSwitcher.orientedImages[h].push(f);0==h?f.traceId==ImajnetMap.currentPosition.traceId?parseInt(f.id)<parseInt(ImajnetMap.currentPosition.id)?b.push(f):ImajnetImageSwitcher.frontOrientedImages.push(f):c.push(f):1!=h||g?2!=h||k?6!=h||e?7!=h||d||(d=f):e=f:k=f:g=f}});d?(ImajnetImageSwitcher.dragLeftPosition=d,jQuery("#imajnetLayerLeftArrowImage").attr("src",Imajnet.imajnetPath+"img/imageSwitcher/7.png?"+
Imajnet.version)):(ImajnetImageSwitcher.dragLeftPosition=e,jQuery("#imajnetLayerLeftArrowImage").attr("src",Imajnet.imajnetPath+"img/imageSwitcher/6.png?"+Imajnet.version));g?(ImajnetImageSwitcher.dragRightPosition=g,jQuery("#imajnetLayerRightArrowImage").attr("src",Imajnet.imajnetPath+"img/imageSwitcher/1.png?"+Imajnet.version)):(ImajnetImageSwitcher.dragRightPosition=k,jQuery("#imajnetLayerRightArrowImage").attr("src",Imajnet.imajnetPath+"img/imageSwitcher/2.png?"+Imajnet.version));ImajnetImageSwitcher.initSliderImagesDimension();
ImajnetImageSwitcher.frontOrientedImages.sort(ImajnetImageSwitcher.compareImageId);for(a=0;a<c.length;a++)ImajnetImageSwitcher.frontOrientedImages.push(c[a]);b.sort(ImajnetImageSwitcher.compareImageId);for(a=0;a<b.length;a++)ImajnetImageSwitcher.frontOrientedImages.push(b[a]);a="";0<this.orientedImages.length&&(a+=this.getImageItemHtml(7)+this.getImageItemHtml(0)+this.getImageItemHtml(1)+this.getImageItemHtml(6)+'\x3cdiv class\x3d"imageSwitcherItem"\x3e\x3cimg id\x3d"imajnetImageSwitcherCenterImage" src\x3d"'+
Imajnet.imajnetPath+"img/imageSwitcher/arrowsPointOfView.png?"+Imajnet.version+'" width\x3d"63" height\x3d"42" class\x3d"opacity30" /\x3e\x3c/div\x3e'+this.getImageItemHtml(2)+this.getImageItemHtml(5)+this.getImageItemHtml(4)+this.getImageItemHtml(3));return a+'\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e'}},onClosestImagesReceived:function(a){ImajnetUI.disableDraggable(ImajnetUI.imajnetImageSliderInnerContainer);ImajnetUI.enableImageDrag();if(a&&(a=JSON.parse(a),a.parameter&&a.positions&&ImajnetMap.currentPosition&&
a.parameter.coordinates.id==ImajnetMap.currentPosition.id)){jQuery("#imajnetImageSwitcher").html(ImajnetImageSwitcher.getImageSwitcherHtml(a.positions));for(a=0;8>a;a++)jQuery("#orientedImage_"+a).on("mousewheel DOMMouseScroll",a,function(a,c){ImajnetImageSwitcher.imageMouseScroll(a,c)});ImajnetImageSwitcher.orderedImages=ImajnetImageSwitcher.getOneImageFormEachSecquenceTraceTimestampOrdered();ImajnetImageSwitcher.orientedImages[0]&&ImajnetImageSwitcher.orderedImages&&1<ImajnetImageSwitcher.orderedImages.length?
jQuery("#imajnetImageSwitcherCenterImage").on({mouseover:function(a){a.relatedTarget&&Nigsys.stringContains(a.relatedTarget.className,"orderedImageDate")||ImajnetImageSwitcher.centerImageMouseOver()},mouseleave:function(a){a.relatedTarget&&(Nigsys.stringContains(a.relatedTarget.className,"orderedImageDate")||Nigsys.stringContains(a.relatedTarget.className,"imajnetImageSwitcherOrderedImagesInnerContainer"))||ImajnetImageSwitcher.centerImageMouseLeave()},click:ImajnetImageSwitcher.centerImageClick}).prop("title",
jQuery.imajnet.image.switcher.centerButtonTitle).removeClass("opacity30"):jQuery("#imajnetImageSwitcherCenterImage").prop("title",ImajnetUI.imageDate);ImajnetUI.imageContainer.append('\x3cdiv id\x3d"imajnetImageSwitcherOrderedImagesContainer" style\x3d"width: '+(ImajnetImageSwitcher.ORDERED_IMAGES_NO*ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH+20)+"px; height: "+(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+2)+'px;"\x3e\x3cdiv id\x3d"scrollOrderedImagesLeft" class\x3d"left" onmouseout\x3d"ImajnetImageSwitcher.orderedImagesMainContainer.hide();"\x3e\x3cdiv class\x3d"scrollOrderedImagesLeftImage" onclick\x3d"ImajnetImageSwitcher.scrollOrderedImages(\''+
ImajnetAPI.PREVIOUS+'\');" onmouseover\x3d"ImajnetImageSwitcher.scrollButtonMouseOver(jQuery(this));" onmouseout\x3d"ImajnetImageSwitcher.scrollButtonMouseOut(jQuery(this));"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"imajnetImageSwitcherOrderedImagesInnerContainer" style\x3d"height: '+(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+1)+'px;"\x3e\x3cdiv id\x3d"imajnetImageSwitcherOrderedImages" style\x3d"width: '+(ImajnetImageSwitcher.ORDERED_IMAGES_NO*ImajnetImageSwitcher.ORDERED_IMAGE_WIDTH-
2)+"px; height: "+(ImajnetImageSwitcher.ORDERED_IMAGE_HEIGHT+ImajnetImageSwitcher.ORDERED_IMAGE_DATE_HEIGHT+2)+'px"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"scrollOrderedImagesRight" class\x3d"left" onmouseout\x3d"ImajnetImageSwitcher.orderedImagesMainContainer.hide();"\x3e\x3cdiv class\x3d"scrollOrderedImagesRightImage" onclick\x3d"ImajnetImageSwitcher.scrollOrderedImages(\''+this.NEXT+'\');" onmouseover\x3d"ImajnetImageSwitcher.scrollButtonMouseOver(jQuery(this));" onmouseout\x3d"ImajnetImageSwitcher.scrollButtonMouseOut(jQuery(this));"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e');
ImajnetImageSwitcher.orderedImagesMainContainer=jQuery("#imajnetImageSwitcherOrderedImagesContainer");ImajnetImageSwitcher.orderedImagesContainer=jQuery("#imajnetImageSwitcherOrderedImages");ImajnetImageSwitcher.orderedImagesMainContainer.mouseleave(function(a){a.relatedTarget&&a.relatedTarget.className&&(Nigsys.stringContains(a.relatedTarget.className,"imajnetImageSwitcherOrderedImagesInnerContainer")||Nigsys.stringContains(a.relatedTarget.className,"imajnetImageSwitcherCenterImage"))||ImajnetImageSwitcher.orderedImagesMouseOut(a)});
(ImajnetImageSwitcher.dragLeftPosition||ImajnetImageSwitcher.dragRightPosition)&&ImajnetUI.enableDraggable(ImajnetUI.imajnetImageSliderInnerContainer);Nigsys.getElementWidth(ImajnetUI.imajnetImage[0])==Nigsys.getElementWidth(ImajnetUI.imajnetImageContainer[0])&&ImajnetUI.disableImageDrag()}},onClosestImagesError:function(){ImajnetImageSwitcher.initSliderImagesDimension();ImajnetUI.disableDraggable(ImajnetUI.imajnetImageSliderInnerContainer);ImajnetUI.enableImageDrag()},loadImageSwitcher:function(a){ImajnetAPI.mustAbortRequests&&
this.closestImagesAjaxRequest&&this.closestImagesAjaxRequest.abort();a={coordinates:a,radius:ImajnetSettings.imajnetSettings.imageSwitcher,limit:ImajnetSettings.limitImageSwitcher,timeframe:ImajnetTimeframe.getTimeframe(),sequenceType:Imajnet.sequenceType};this.closestImagesAjaxRequest=ImajnetAPI.doImajnetRequest("GET","/api/positions/proximity/",a,this.onClosestImagesReceived,this.onClosestImagesError,null,null,!0,null,null)},clearSlider:function(){ImajnetUI.sliderLeftImage&&(ImajnetUI.sliderLeftImage.remove(),
ImajnetUI.sliderLeftImage=null);ImajnetUI.sliderRightImage&&(ImajnetUI.sliderRightImage.remove(),ImajnetUI.sliderRightImage=null);ImajnetImageSwitcher.dragLeftPosition=null;ImajnetImageSwitcher.dragRightPosition=null},clearImageSwitcher:function(){ImajnetImageSwitcher.orientedImages=[];ImajnetImageSwitcher.frontOrientedImages=[];jQuery("#imajnetImageSwitcher").html("");ImajnetUI.imageSwitcherImage&&ImajnetUI.imageSwitcherImage.attr("src","");ImajnetUI.imageSwitcherImageContainer&&(ImajnetUI.imageSwitcherImageContainer.hide(),
ImajnetUI.imageSwitcherImageContainer.removeClass("imajnetLayerNoImage"));ImajnetImageSwitcher.clearSlider();this.clearFrontOrderedImages()},clearFrontOrderedImages:function(){ImajnetImageSwitcher.orderedImagesMainContainer&&ImajnetImageSwitcher.orderedImagesMainContainer.remove()},scrollButtonMouseOver:function(a){a.parent().addClass("opacity80")},scrollButtonMouseOut:function(a){a.parent().removeClass("opacity80")},show:function(){ImajnetMap.currentPosition?jQuery("#imajnetImageSwitcher").show():
this.hide()},hide:function(){jQuery("#imajnetImageSwitcher").hide();ImajnetUI.imageSwitcherImageContainer.removeClass("imajnetLayerNoImage");ImajnetUI.imageSwitcherImage.hide();ImajnetUI.imageSwitcherImageContainer.hide();ImajnetMap.currentPosition&&Imajnet.addImageDate(ImajnetMap.currentPosition.timestamp);ImajnetMap.hideImageSwitcher()},rotateImageSwitcher:function(a){"undefined"!=typeof a&&jQuery("#imajnetImageSwitcher").css({"-webkit-transform":"rotate("+a+"deg)","-moz-transform":"rotate("+a+
"deg)","-ms-transform":"rotate("+a+"deg)",transform:"rotate("+a+"deg)"})}};
var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\x3d",encode:function(b){var a="",c,d,f,g,h,e,k=0;for(b=Base64._utf8_encode(b);k<b.length;)c=b.charCodeAt(k++),d=b.charCodeAt(k++),f=b.charCodeAt(k++),g=c>>2,c=(c&3)<<4|d>>4,h=(d&15)<<2|f>>6,e=f&63,isNaN(d)?h=e=64:isNaN(f)&&(e=64),a=a+this._keyStr.charAt(g)+this._keyStr.charAt(c)+this._keyStr.charAt(h)+this._keyStr.charAt(e);return a},decode:function(b){var a="",c,d,f,g,h,e=0;for(b=b.replace(/[^A-Za-z0-9\+\/\=]/g,
"");e<b.length;)c=this._keyStr.indexOf(b.charAt(e++)),d=this._keyStr.indexOf(b.charAt(e++)),g=this._keyStr.indexOf(b.charAt(e++)),h=this._keyStr.indexOf(b.charAt(e++)),c=c<<2|d>>4,d=(d&15)<<4|g>>2,f=(g&3)<<6|h,a+=String.fromCharCode(c),64!=g&&(a+=String.fromCharCode(d)),64!=h&&(a+=String.fromCharCode(f));return a=Base64._utf8_decode(a)},_utf8_encode:function(b){b=b.replace(/\r\n/g,"\n");for(var a="",c=0;c<b.length;c++){var d=b.charCodeAt(c);128>d?a+=String.fromCharCode(d):(127<d&&2048>d?a+=String.fromCharCode(d>>
6|192):(a+=String.fromCharCode(d>>12|224),a+=String.fromCharCode(d>>6&63|128)),a+=String.fromCharCode(d&63|128))}return a},_utf8_decode:function(b){for(var a="",c=0,d=c1=c2=0;c<b.length;)d=b.charCodeAt(c),128>d?(a+=String.fromCharCode(d),c++):191<d&&224>d?(c2=b.charCodeAt(c+1),a+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=b.charCodeAt(c+1),c3=b.charCodeAt(c+2),a+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return a}},BasicAuthentication={secureStorage:null,initSecureStorage:function(b){try{BasicAuthentication.secureStorage=
new cordova.plugins.SecureStorage(function(){},function(a){BasicAuthentication.secureStorage=null;console.error("cordova-plugin-secure-storage not work! Probably phone don't have screen lock enabled in settings!")},b)}catch(a){console.error("cordova-plugin-secure-storage not added in cordova!")}},setSecureData:function(b,a){BasicAuthentication.secureStorage&&b&&a&&BasicAuthentication.secureStorage.set(function(b){BasicAuthentication.secureStorage.set(function(a){},function(){BasicAuthentication.unsetSecureData("a");
BasicAuthentication.unsetSecureData("b")},"b",a)},function(){BasicAuthentication.unsetSecureData("a");BasicAuthentication.unsetSecureData("b")},"a",b)},unsetSecureData:function(b){BasicAuthentication.secureStorage&&BasicAuthentication.secureStorage.remove(function(a){},function(a){},b)},checkData:function(b,a){var c=jQuery.Deferred();BasicAuthentication.secureStorage?BasicAuthentication.secureStorage.get(function(a){BasicAuthentication.secureStorage.get(function(b){c.resolve({username:a,password:b})},
function(a){c.reject()},"b")},function(a){c.reject()},"a"):c.reject();return c.promise()}};
var ImajnetNews={newsData:null,compareDates:function(a,b){return ImajnetNews.formatServerDate(a.created)<ImajnetNews.formatServerDate(b.created)?-1:ImajnetNews.formatServerDate(a.created)>ImajnetNews.formatServerDate(b.created)?1:0},showTooltip:function(a,b){for(var c=0;c<ImajnetNews.newsData.length;c++)if(ImajnetNews.newsData[c].id==b){Nigsys.showTooltip(a,ImajnetNews.getNewsItemHTML(ImajnetNews.newsData[c],!0,!1));break}},getNewsItemHTML:function(a,b,c,d){return'\x3cdiv class\x3d"newsItemMainContainer'+
(c?" oldNewsItem":"")+(0!==d%2?" itemOdd":"")+'"'+(b?"":" onmouseover\x3d\"ImajnetNews.showTooltip(event, '"+a.id+'\');" onmouseout\x3d"Nigsys.hideTooltip();"')+'\x3e\x3cdiv class\x3d"left newsImageContainer"\x3e\x3cimg src\x3d"'+Imajnet.imajnetPath+"img/news/"+a.type+".png?"+Imajnet.version+'" class\x3d"newsImage" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left newsItemContainer"\x3e\x3cdiv class\x3d"newsTitle'+(b?"":" noOverflow")+'"\x3e'+this.getTitleDate(a.created)+a.title+'\x3c/div\x3e\x3cdiv class\x3d"newsContent'+
(b?"":" noOverflow")+'"\x3e'+a.content+'\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e'},formatServerDate:function(a){if(!a)return new Date(1970);a=a.split(" ");var b=a[0].split("-"),c=null;a[1]&&(c=a[1].split(":"));return c?new Date(b[2],parseInt(b[1])-1,b[0],c[0],c[1],c[2]):new Date(b[2],parseInt(b[1])-1,b[0])},getTitleDate:function(a){a=this.formatServerDate(a);return"["+a.getDate()+" "+Nigsys.getMonthFromNumber((a.getMonth()+1).toString())+" "+a.getFullYear()+
"] "},onNewsReceived:function(a,b){a=JSON.parse(a);var c="",d=!1;if(a.news&&a.news.length){ImajnetNews.newsData=a.news.sort(ImajnetNews.compareDates);var f=null;ImajnetUser.data.lastLogin?f=ImajnetNews.formatServerDate(ImajnetUser.data.lastLogin):d=!0;for(var e=ImajnetNews.newsData.length-1;0<=e;e--){var g=f?f>ImajnetNews.formatServerDate(ImajnetNews.newsData[e].created):!1;g||(d=!0);c+=ImajnetNews.getNewsItemHTML(ImajnetNews.newsData[e],!1,g,e)}}if(!b.isFirstLoad||d)ImajnetUI.newsContainer.html(c?
c:jQuery.imajnet.noNews),b.isFirstLoad&&Imajnet.activateImajnetControl(jQuery("#newsContainerIdButton"),"showNews"),ImajnetUI.showItem(ImajnetUI.newsContainerId,530,500)},checkForNews:function(a){ImajnetAPI.doImajnetRequest("GET","/api/news/latest.json",null,ImajnetNews.onNewsReceived,null,null,null,null,{isFirstLoad:a})},init:function(a){ImajnetUI.hideItem(ImajnetUI.newsContainerId);ImajnetNews.checkForNews(a)},close:function(a){ImajnetUI.hideItem(ImajnetUI.newsContainerId)}};
Address={OPTIONS_OSM:"optionsOSM",OPTIONS_SPECTRUM:"optionsSpectrum",addressRequest:null,currentSearchOption:"",map:null,wgs84Crs:"EPSG:4326",addressContainer:null,initContainers:function(){this.currentSearchOption||(this.currentSearchOption=this.OPTIONS_OSM)},init:function(){if(ImajnetUI.imageContainer){this.initContainers();this.addressContainer||(ImajnetUI.imageContainer.append('\x3cdiv id\x3d"addressContainerDiv" class\x3d"address addressAndLRS"\x3e\x3c/div\x3e'),this.addressContainer=jQuery("#addressContainerDiv"));
var a="";ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsAddressDisplayType==ImajnetLRSSettings.ADDRESS_MODE.FULL?this.addressContainer.removeClass("addressSmall").width(190):this.addressContainer.addClass("addressSmall").width("auto");ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsAddressInLRS?(this.addressContainer.removeClass("addressLeft"),this.addressContainer.addClass("addressRight").width(190),LRS.LRSContainer&&LRS.LRSContainer.is(":visible")&&(a="bottom")):
(this.addressContainer.removeClass("addressRight"),this.addressContainer.addClass("addressLeft"));Nigsys.browserIsIE7()||Nigsys.browserIsIE8()||this.addressContainer.uncorner().corner(a)}},initSearchAddress:function(){this.initContainers();var a='\x3cdiv class\x3d"searchAddressDiv"\x3e\x3cdiv class\x3d"searchAddressTopDiv"\x3e';this.currentSearchOption==this.OPTIONS_OSM?a+='\x3cdiv class\x3d"left" style\x3d"margin: 0 30px 0 10px;"\x3e\x3cinput type\x3d"text" id\x3d"searchAddressInput" size\x3d"37" style\x3d"padding-left: 10px;" /\x3e\x3c/div\x3e':
this.currentSearchOption==this.OPTIONS_SPECTRUM&&(a+='\x3cdiv\x3e\x3cdiv class\x3d"left" style\x3d"width: 100px;"\x3e'+jQuery.imajnet.map.popupSearchAddress.spectrumStreet+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"searchAddressStreetInput" size\x3d"29" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3cdiv\x3e\x3cdiv class\x3d"left" style\x3d"width: 100px;"\x3e'+jQuery.imajnet.map.popupSearchAddress.spectrumCity+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"searchAddressCityInput" size\x3d"29" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3cdiv\x3e\x3cdiv class\x3d"left" style\x3d"width: 100px;"\x3e'+
jQuery.imajnet.map.popupSearchAddress.spectrumCountry+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"searchAddressCountryInput" size\x3d"29" value\x3d"France" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e');a+='\x3cdiv class\x3d"left" style\x3d"margin-bottom: 10px;"\x3e\x3cinput type\x3d"button" id\x3d"searchAddress" value\x3d"'+jQuery.imajnet.map.popupSearchAddress.buttonSearchName+'" onclick\x3d"Address.getAddressFromString();" class\x3d"dialogButton buttonSearch" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"searchResultsDiv" class\x3d"clearLeft light14Blue"\x3e\x3c/div\x3e\x3c/div\x3e';
ImajnetUI.searchAddressContainer.html(a);jQuery("#searchAddressInput").keyup(function(a){13==a.keyCode&&jQuery("#searchAddress").click()});jQuery("#searchAddressCityInput").keyup(function(a){13==a.keyCode&&jQuery("#searchAddress").click()})},showAddress:function(){Address.addressContainer&&""!=Address.addressContainer.html()&&Address.addressContainer.html()!=jQuery.imajnet.loading&&Address.addressContainer.show()},setAddress:function(a,c){a&&""!=jQuery.trim(a)?this.addressContainer&&(this.addressContainer.html(a),
this.addressContainer.attr("title",c?c:a),Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()||jQuery("#imajnetPhotogrammetryZoomedImageContainer").is(":visible")||(this.addressContainer.show(),this.init(),LRS.loadLRS(ImajnetMap.currentPosition))):Address.hideAddress()},getOSMAddress:function(a){},getSpectrumAddress:function(a){Address.addressContainer.html(jQuery.imajnet.loading);ImajnetAPI.mustAbortRequests&&null!==this.addressRequest&&this.addressRequest.abort();this.addressRequest=
jQuery.ajax({type:"POST",url:applicationDomain+"spectrum-services/ReverseGeocodeGlobal.TOMTOM",dataType:"xml",data:'\x3csoapenv:Envelope xmlns:soapenv\x3d"http://schemas.xmlsoap.org/soap/envelope/" xmlns:rev\x3d"http://www.g1.com/services/ReverseGeocodeGlobal.TOMTOM"\x3e\x3csoapenv:Header/\x3e\x3csoapenv:Body\x3e\x3crev:ReverseGeocodeGlobal_TOMTOMRequest\x3e\x3crev:context\x3e\x3crev:account.id\x3evlecamus\x3c/rev:account.id\x3e\x3crev:account.password\x3evlecamus\x3c/rev:account.password\x3e\x3c/rev:context\x3e\x3crev:options\x3e\x3crev:FRA.KeepMultimatch\x3etrue\x3c/rev:FRA.KeepMultimatch\x3e\x3c/rev:options\x3e\x3crev:rows\x3e\x3crev:row\x3e\x3crev:Latitude\x3e'+
a.lat+"\x3c/rev:Latitude\x3e\x3crev:Longitude\x3e"+a.lon+"\x3c/rev:Longitude\x3e\x3crev:Country\x3eFRA\x3c/rev:Country\x3e\x3crev:user_fields\x3e\x3c/rev:user_fields\x3e\x3c/rev:row\x3e\x3c/rev:rows\x3e\x3c/rev:ReverseGeocodeGlobal_TOMTOMRequest\x3e\x3c/soapenv:Body\x3e\x3c/soapenv:Envelope\x3e",contentType:"application/xml",success:function(a,b,e){a=jQuery.xml2json(e.responseText);b=null;b=Nigsys.browserIsIE()?a["soap:Body"].ReverseGeocodeGlobal_TOMTOMResponse.rows.row:a.Body.ReverseGeocodeGlobal_TOMTOMResponse.rows.row;
null!==b?(a=(void 0!==b.AddressLine1?b.AddressLine1+", ":"")+(void 0!==b.City?b.City+", ":"")+(void 0!==b.County?b.County+", ":"")+(void 0!==b.StateProvince?b.StateProvince+", ":"")+"France","France"!=a?Address.setAddress(a):Address.hideAddress()):Address.hideAddress()},error:function(a,b,e){Address.hideAddress()}})},getAddressFromCoordinates:function(a,c){this.currentSearchOption==this.OPTIONS_OSM?Address.getOSMAddress(a):this.currentSearchOption==this.OPTIONS_SPECTRUM&&Address.getSpectrumAddress(a)},
zoomToCoordinates:function(a,c){ImajnetPlugin.centerMapToPosition({lon:a,lat:c});ImajnetPlugin.zoomMapTo(ImajnetMap.ADDRESS_ZOOM_LEVEL)},onAddressClick:function(a,c){Address.zoomToCoordinates(a,c);ImajnetAPI.getClosestPosition(c,a,ImajnetSettings.rangeAddress,ImajnetSettings.timeRangeAddress,null,null,null)},hideAddressContainer:function(){this.addressContainer&&this.addressContainer.hide()},hideAddress:function(){this.hideAddressContainer();!LRS.LRSContainer||Nigsys.browserIsIE7()||Nigsys.browserIsIE8()||
LRS.LRSContainer.corner()},getAddressOSMForString:function(a){ImajnetAPI.mustAbortRequests&&null!==this.addressRequest&&this.addressRequest.abort();this.addressRequest=jQuery.ajax({type:"GET",url:"https://nominatim.openstreetmap.org/search?q\x3d"+a+"\x26format\x3djson\x26polygon\x3d1\x26addressdetails\x3d1",dataType:"json",success:function(a){jQuery("#searchResultsDiv").html("");if(!jQuery.isEmptyObject(a)&&jQuery.isArray(a)){var b=0;jQuery.each(a,function(a,d){""!=d.lon&&""!=d.lat&&jQuery("#searchResultsDiv").append("\x3cdiv onclick\x3d\"Address.onAddressClick('"+
d.lon+"','"+d.lat+"');\""+(0==b%2?' class\x3d"searchAddressItemContainer itemOdd"':' class\x3d"searchAddressItemContainer itemEven"')+'\x3e\x3cdiv class\x3d"searchAddressItemImageContainer left"\x3e\x3cimg src\x3d"'+applicationUrl+"resources/img/buttons/BTN-FF1.PNG?"+Imajnet.version+'" class\x3d"searchAddressItemImage" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left searchAddressItemDescriptionContainer"\x3e'+(void 0!==d.display_name&&""!=jQuery.trim(d.display_name)?'\x3cdiv class\x3d"searchAddressItemDescriptionInnerContainer"\x3e'+
d.display_name+"\x3c/div\x3e":"")+"\x3cdiv\x3e"+jQuery.imajnet.map.popupSearchAddress.longitude+": "+d.lon+"\x3c/div\x3e\x3cdiv\x3e"+jQuery.imajnet.map.popupSearchAddress.latitude+": "+d.lat+'\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e');b++});1==b&&(Address.onAddressClick(a[0].lon,a[0].lat),Address.closeSearchDialog())}else jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+jQuery.imajnet.map.popupSearchAddress.noResultsFound+"\x3c/div\x3e");Nigsys.hideLoading(jQuery("#searchResultsDiv"))},
error:function(a,b,e){jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+jQuery.imajnet.map.popupSearchAddress.error+"\x3c/div\x3e");Nigsys.hideLoading(jQuery("#searchResultsDiv"))}})},getAddressSpectrumForString:function(a,c,b){ImajnetAPI.mustAbortRequests&&null!==this.addressRequest&&this.addressRequest.abort();this.addressRequest=jQuery.ajax({type:"POST",url:applicationDomain+"spectrum-services/GeocodeAddressGlobal.TOMTOM",dataType:"xml",data:'\x3csoapenv:Envelope xmlns:soapenv\x3d"http://schemas.xmlsoap.org/soap/envelope/" xmlns:geoc\x3d"http://www.g1.com/services/GeocodeAddressGlobal.TOMTOM"\x3e\x3csoapenv:Header/\x3e\x3csoapenv:Body\x3e\x3cgeoc:GeocodeAddressGlobal_TOMTOMRequest\x3e\x3cgeoc:context\x3e\x3cgeoc:account.id\x3evlecamus\x3c/geoc:account.id\x3e\x3cgeoc:account.password\x3evlecamus\x3c/geoc:account.password\x3e\x3c/geoc:context\x3e\x3cgeoc:options\x3e\x3c/geoc:options\x3e\x3cgeoc:rows\x3e\x3cgeoc:row\x3e\x3cgeoc:AddressLine1\x3e'+
a+"\x3c/geoc:AddressLine1\x3e\x3cgeoc:City\x3e"+c+"\x3c/geoc:City\x3e\x3cgeoc:Country\x3e"+b+"\x3c/geoc:Country\x3e\x3c/geoc:row\x3e\x3c/geoc:rows\x3e\x3c/geoc:GeocodeAddressGlobal_TOMTOMRequest\x3e\x3c/soapenv:Body\x3e\x3c/soapenv:Envelope\x3e",contentType:"application/xml",success:function(a,b,c){jQuery("#searchResultsDiv").html("");a=jQuery.xml2json(c.responseText);if(jQuery.isEmptyObject(a))jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+jQuery.imajnet.map.popupSearchAddress.noResultsFound+
"\x3c/div\x3e");else{var f=0,k=!1;b=null;b=Nigsys.browserIsIE()?a["soap:Body"].GeocodeAddressGlobal_TOMTOMResponse.rows:a.Body.GeocodeAddressGlobal_TOMTOMResponse.rows;if(null!==b){var g="",h="";jQuery.each(b,function(a,b){if(void 0!=b.Latitude&&""!=b.Longitude&&void 0!=b.Latitude&&""!=b.Latitude){var c=(void 0!==b.AddressLine1&&""!==b.AddressLine1?b.AddressLine1+", ":"")+(void 0!==b.City&&""!==b.City?b.City+", ":"")+(void 0!==b.County&&""!==b.County?b.County+", ":"")+(void 0!==b.StateProvince&&""!==
b.StateProvince?b.StateProvince+", ":"")+(void 0!==b.Country&&""!==b.Country?b.Country+", ":"");jQuery("#searchResultsDiv").append("\x3cdiv onclick\x3d\"Address.onAddressClick('"+b.Longitude+"','"+b.Latitude+"');\""+(0==f%2?' class\x3d"itemOdd"':' class\x3d"itemEven"')+"\x3e"+(""!=jQuery.trim(c)?'\x3cdiv style\x3d"font-weight: bold;"\x3e'+c+"\x3c/div\x3e":"")+"\x3cdiv\x3e"+jQuery.imajnet.map.popupSearchAddress.longitude+": "+b.Longitude+"\x3c/div\x3e\x3cdiv\x3e"+jQuery.imajnet.map.popupSearchAddress.latitude+
": "+b.Latitude+"\x3c/div\x3e\x3c/div\x3e");k=!0}0==f&&(g=b.Longitude,h=b.Latitude);f++});k?g&&h&&(Address.onAddressClick(g,h),Address.closeSearchDialog()):jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+jQuery.imajnet.map.popupSearchAddress.noResultsFound+"\x3c/div\x3e")}else jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+jQuery.imajnet.map.popupSearchAddress.error+"\x3c/div\x3e")}Nigsys.hideLoading(jQuery("#searchResultsDiv"))},error:function(a,b,c){jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+
jQuery.imajnet.map.popupSearchAddress.error+"\x3c/div\x3e");Nigsys.hideLoading(jQuery("#searchResultsDiv"))}})},getAddressFromString:function(a){Nigsys.showLoading(jQuery("#searchResultsDiv"));if(this.currentSearchOption==this.OPTIONS_OSM)a=jQuery.trim(jQuery("#searchAddressInput").val()),""!==a?this.getAddressOSMForString(a):jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+jQuery.imajnet.map.popupSearchAddress.noResultsFound+"\x3c/div\x3e");else if(this.currentSearchOption==this.OPTIONS_SPECTRUM){a=
jQuery.trim(jQuery("#searchAddressStreetInput").val());var c=jQuery.trim(jQuery("#searchAddressCityInput").val()),b=jQuery.trim(jQuery("#searchAddressCountryInput").val());""==a&&""==c&&""==b?jQuery("#searchResultsDiv").html('\x3cdiv class\x3d"error"\x3e'+jQuery.imajnet.map.popupSearchAddress.noResultsFound+"\x3c/div\x3e"):this.getAddressSpectrumForString(a,c,b)}},openSearchDialog:function(){Address.closeSearchDialog();Address.initSearchAddress();ImajnetUI.showItem(ImajnetUI.searchAddressContainerId,
Nigsys.browserIsIE7()?425:null)},closeSearchDialog:function(){ImajnetUI.hideItem(ImajnetUI.searchAddressContainerId)}};
LRS={roadsData:{},currentImageLRS:null,isSearchRelative:!0,cachedPoints:{},LRSContainer:null,roadNameToIdMapping:null,noRoads:!1,metersInAMile:1609.344,feetInAMile:5280,defaultUnit:"m",metersUnits:{m:1,feet:3.2808399},maxRoadsInSelect:100,requestTimer:null,checkIfLRSAccess:function(){var a=jQuery.Deferred();LRSRequest.onGetLRSRoads(0,{afterInit:!0,limit:1},function(b,c){LRS.noRoads=b&&b.roads&&b.roads.length?!1:!0;a.resolve()}).fail(function(){a.resolve()});return a.promise()},getFormattedRelativeAbscisa:function(a,
b){return 0<b?a.toFixed(b):Math.floor(a+.5)},formatRelativeAbscisa:function(a,b,c,d){a=LRS.getFormattedRelativeAbscisa(a,d);return"2"!=b||"m"!=c||100<=a?a:10>a?"00"+a:"0"+a},transformFromMeters:function(a,b){return parseFloat((a*LRS.metersUnits[b]).toFixed(2))},transformFromSquareMeters:function(a,b){return 1==LRS.metersUnits[b]?a:parseFloat((a*Math.pow(LRS.metersUnits[b],2)).toFixed(2))},transformToMeters:function(a,b){return a/LRS.metersUnits[b]},transformToSquareMeters:function(a,b){return a/Math.pow(LRS.metersUnits[b],
2)},getRoadUnitType:function(a){return a?a:LRS.defaultUnit},getRoadType:function(a){if(!LRS.roadsData[0]||!LRS.roadsData[0].roads)return LRS.defaultUnit;for(var b=0;b<LRS.roadsData[0].roads.length;b++)if(LRS.roadsData[0].roads[b].id==a)return LRS.roadsData[0].roads[b].unit;return LRS.defaultUnit},getCachedLRSByObjectId:function(a){for(var b in LRS.cachedPoints)if(LRS.cachedPoints[b].id==a)return LRS.cachedPoints[b];return null},transformReceivedLinearPositionItem:function(a){a&&a.road&&!a.road.unit&&
(a.road.unit=LRS.defaultUnit);a&&a.road&&a.road.unit&&(a.lateralOffset=LRS.transformFromMeters(a.lateralOffset,LRS.getRoadUnitType(a.road.unit)),a.relativeAbscisa=LRS.transformFromMeters(a.relativeAbscisa,LRS.getRoadUnitType(a.road.unit)),a.cumulatedAbscisa=LRS.transformFromMeters(a.cumulatedAbscisa,LRS.getRoadUnitType(a.road.unit)))},transformReceivedLinearPosition:function(a){if(jQuery.isArray(a))for(var b=0;b<a.length;b++)LRS.transformReceivedLinearPositionItem(a[b]);else LRS.transformReceivedLinearPositionItem(a)},
getTopologyRequestData:function(a){var b={prNumber:a.startPR,relativeAbscisa:a.startAbscisa?a.startAbscisa:0},c={prNumber:a.endPR,relativeAbscisa:a.endAbscisa?a.endAbscisa:0};if(b.prNumber>c.prNumber||b.prNumber==c.prNumber&&b.relativeAbscisa>c.relativeAbscisa)var d=b,b=c,c=d;return{roadTopologyDescriptor:Array({enable3D:!1,lateralOffset:parseFloat(a.lateralOffset),roadName:a.roadName,start:b,end:c})}},getSelectedLRSType:function(){var a=ImajnetUserSettings.lrsRoadType;jQuery.each(jQuery("input:image[name\x3dLRSType]"),
function(b,c){if(-1!==c.className.indexOf("opacity60"))return a=c.value,!1});return a},init:function(){this.LRSContainer&&this.LRSContainer.remove();ImajnetUI.imageContainer.append('\x3cdiv id\x3d"LRSContainerDiv" class\x3d"LRS addressAndLRS"\x3e\x3c/div\x3e');this.LRSContainer=jQuery("#LRSContainerDiv");Nigsys.isMobileBrowser()?(this.LRSContainer.on("vmouseover",LRS.onImageLRSMouseHover),this.LRSContainer.on("vmouseout",LRS.onImageLRSMouseOut)):(this.LRSContainer.on("mouseover",LRS.onImageLRSMouseHover),
this.LRSContainer.on("mouseleave",LRS.onImageLRSMouseOut));var a="5",b="";ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsAddressInLRS&&Address.addressContainer&&Address.addressContainer.is(":visible")&&(b="top",a=ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsAddressDisplayType==ImajnetLRSSettings.ADDRESS_MODE.FULL?47:22);this.LRSContainer.height(40);this.LRSContainer.css("bottom",a+"px");Nigsys.browserIsIE7()||Nigsys.browserIsIE8()||this.LRSContainer.uncorner().corner(b)},
initSearchLRS:function(){ImajnetUI.searchLRSContainer.hide()},showLRS:function(){""!=LRS.LRSContainer.html()&&LRS.LRSContainer.html()!=jQuery.imajnet.loading&&LRS.LRSContainer.show()},setImajnetImageLRS:function(a){this.init();var b=LRSRequest.fillLRSContent(a,!0);this.LRSContainer.html(b.HTML);Nigsys.isPositionMode()||Nigsys.isMeasurementMode()||Nigsys.isPolyligneMode()||(ImajnetUI.LRSGUI.draw(a),this.LRSContainer.show(),"undefined"!==typeof Address&&Address.init())},onImageLRSMouseHover:function(a){Nigsys.disableEventPropagationFull(a);
LRS.currentImageLRS&&LRS.LRSContainer.html()!=jQuery.imajnet.loading&&LRS.LRSContainer.html(LRSRequest.getLRSFields(LRS.currentImageLRS).HTML)},onImageLRSMouseOut:function(a){Nigsys.disableEventPropagationFull(a);LRS.currentImageLRS&&LRS.LRSContainer.html()!=jQuery.imajnet.loading&&LRS.LRSContainer.html(LRSRequest.getLRSFieldsCondensed(LRS.currentImageLRS).HTML)},onGetLRSSuccess:function(a,b){if(a&&a.linearPosition){ImajnetUI.LRSGUI.isDragMode=!1;ImajnetUI.LRSGUI.isZoomMode=!1;if(ImajnetUI.isAfterLRSSearch){ImageControler.currentImageControl.resetFastNavigation();
ImajnetUI.stopSwipeNavigation(!0);var c=!0}ImajnetUI.isAfterLRSSearch=!1;a.parameter&&a.parameter.position?(ImajnetMap.currentPosition&&(a.parameter.position.id=ImajnetMap.currentPosition.id),LRS.cachedPoints[a.parameter.position.lat+":"+a.parameter.position.lon+":"+a.parameter.position.height]=Nigsys.cloneObject(a),(c&&"undefined"===typeof ImajnetMap||ImajnetMap.currentPosition&&ImajnetMap.currentPosition.lon==a.parameter.position.lon&&ImajnetMap.currentPosition.lat==a.parameter.position.lat&&ImajnetMap.currentPosition.height==
a.parameter.position.height)&&LRS.setImajnetImageLRS(a)):LRS.hideLRS()}else LRS.onGetLRSError()},onGetLRSError:function(a){LRS.removeLRS()},loadLRS:function(a){if(a)LRS.getLRS(a,LRS.onGetLRSSuccess,LRS.onGetLRSError,{LRSObject:ImajnetUI.LRSGUI});else if("function"==typeof LRS.onGetLRSError)LRS.onGetLRSError()},onBeforeGetLRS:function(){this.LRSContainer&&this.LRSContainer.html(jQuery.imajnet.loading)},getLRS:function(a,b,c,d){this.onBeforeGetLRS();var e=LRS.cachedPoints[a.lat+":"+a.lon+":"+a.height];
void 0!==e&&e?b(e,d):LRSRequest.getLRS(JSON.stringify({position:a,range:ImajnetSettings.rangeLRS,maxResults:1}),b,c,d)},getLRSForGPS:function(a,b,c,d){this.onBeforeGetLRS();var e=LRS.cachedPoints[a.lat+":"+a.lon+":"+a.height];void 0!==e&&e?b(e):(a={position:a,range:ImajnetSettings.rangeLRS},d&&(a.maxResults=d),LRSRequest.getLRSForGPS(JSON.stringify(a),b,c))},getLRSForPosition:function(a,b){void 0===LRS.cachedPoints[a.lat+":"+a.lon+":"+a.height]?LRSRequest.getLRSForPosition(JSON.stringify({position:a,
range:ImajnetSettings.rangeLRS,maxResults:1}),b):LRSRequest.appendLRSForPosition(LRS.cachedPoints[a.lat+":"+a.lon+":"+a.height],b)},hideLRS:function(){jQuery("#imajnetImageLRSInTitle").hide();this.LRSContainer&&this.LRSContainer.html(jQuery.imajnet.loading)},hideLRSContainer:function(){this.LRSContainer&&this.LRSContainer.hide()},removeLRS:function(){jQuery("#imajnetImageLRSInTitle").hide();this.hideLRSContainer();Nigsys.browserIsIE7()||Nigsys.browserIsIE8()||"undefined"===typeof Address||!Address.addressContainer||
Address.addressContainer.corner();ImajnetUI.LRSGUI&&ImajnetUI.LRSGUI.hide()},searchLRSError:function(){Nigsys.showDialogError(ImajnetUI.searchLRSContainerId,jQuery.app.error)},onSearch:function(a,b,c){LRS.getCoordinatesFromLRS(a,c).done(function(a){a.position.lat||a.position.lon?"undefined"===typeof initImajnet?ImajnetAPI.getClosestPosition(a.position.lat,a.position.lon,ImajnetSettings.rangeLRS,ImajnetSettings.timeRangeLRS,null,null,{isFromLRSSearch:!0}):initImajnet(!0,"FULL").done(function(){ImajnetAPI.getClosestPosition(a.position.lat,
a.position.lon,ImajnetSettings.rangeLRS,ImajnetSettings.timeRangeLRS,null,null,{isFromLRSSearch:!0})}):(ImajnetAPI.setImajnetImage({position:null},null),"undefined"!==typeof b&&"function"===typeof b&&b())}).fail(function(){"undefined"!==typeof b&&b()})},search:function(){var a={};a.roadIdentifier=jQuery("#LRSRoadSelect").val();a.roadIdentifier?(ImajnetMap.currentPosition=null,ImageControler.currentImageControl.resetFastNavigation(),ImajnetUI.stopSwipeNavigation(!0,!0),ImajnetUI.isAfterLRSSearch=!0,
setTimeout(function(){a.prNumber=jQuery("#LRSPRSelect").val();a.prNumber||(a.prNumber=0);var b=LRS.getRoadUnitType(LRS.getRoadType(a.roadIdentifier));a.relativeAbscisa=LRS.transformToMeters(jQuery("#LRSSearchRelative").val(),b);a.relativeAbscisa||(a.relativeAbscisa=0);a.cumulatedAbscisa=LRS.transformToMeters(jQuery("#LRSSearchCumulated").val(),b);LRS.onSearch(a,LRS.searchLRSError)},300)):LRS.searchLRSError()},onGetRoadSuccess:function(a){var b=jQuery("#LRSPRSelect"),c='\x3coption value\x3d""\x3e\x3c/option\x3e';
if(a&&a.pr){for(var d="",e="",f=0;f<a.pr.length;f++)0==f?(d=' selected\x3d"selected"',e=a.pr[f].prNumber,LRS.changeLRSPR(a.pr[f].prNumber)):d="",c+='\x3coption value\x3d"'+a.pr[f].prNumber+'"'+d+"\x3e"+a.pr[f].prNumber+"\x3c/option\x3e";Nigsys.getComboboxInputContainer(b).val(e)}else LRS.onGetRoadError();LRS.focusIsFromSelect=!1;b.html(c)},onGetRoadError:function(){var a=jQuery("#LRSPRSelect");Nigsys.getComboboxInputContainer(a).val("");a.html('\x3coption value\x3d""\x3e\x3c/option\x3e');LRS.isSearchRelative=
!1;jQuery("#LRSSearchRelative").prop("disabled",!0);jQuery("#LRSSearchCumulated").val(0);jQuery("#searchLRSSubmit").prop("disabled",!1)},changeLRSRoad:function(a){LRS.focusIsFromSelect=!0;var b=jQuery("#LRSPRSelect");""!==a.val()?(Nigsys.getComboboxInputContainer(b).val(""),b.html('\x3coption value\x3d""\x3e\x3c/option\x3e'),LRSRequest.getRoad(a.val(),this.onGetRoadSuccess,this.onGetRoadError),Nigsys.changeComboboxDisabledState(b,!1),b.prop("disabled",!1),jQuery("#LRSSearchCumulated").prop("disabled",
!1)):(Nigsys.changeComboboxDisabledState(b,!0),b.prop("disabled",!0),jQuery("#LRSSearchRelative").prop("disabled",!0),jQuery("#LRSSearchCumulated").prop("disabled",!0));jQuery("#LRSSearchRelative").val("");jQuery("#LRSSearchCumulated").val("");jQuery("#searchLRSSubmit").prop("disabled",!0)},changeLRSPR:function(a){""!==a?(LRS.isSearchRelative=!0,jQuery("#LRSSearchRelative").val("0"),jQuery("#LRSSearchRelative").prop("disabled",!1),jQuery("#LRSSearchCumulated").val("")):(jQuery("#LRSSearchRelative").val(""),
jQuery("#LRSSearchCumulated").val(""),jQuery("#LRSSearchRelative").prop("disabled",!0));jQuery("#searchLRSSubmit").prop("disabled",!0);""!==jQuery("#LRSSearchRelative").val()&&jQuery("#searchLRSSubmit").prop("disabled",!1)},numbersOnly:function(a,b){jQuery("#searchLRSSubmit").prop("disabled",!1);if("searchRelative"==b)LRS.isSearchRelative=!0;else if("searchCumulated"==b){LRS.isSearchRelative=!1;var c=jQuery("#LRSPRSelect");Nigsys.getComboboxInputContainer(c).val("");c.val("");jQuery("#LRSSearchRelative").val("");
jQuery("#LRSSearchRelative").prop("disabled",!0)}c=a.charCode?a.charCode:a.keyCode;return 8!=c&&(48>c||57<c)?!1:!0},getLabelsValueFromSettings:function(a,b){if(!ImajnetLRSSettings.LRSSettings)return null;var c=jQuery.imajnet.settings.LRS.road,d="road";2==a&&(c=jQuery.imajnet.settings.LRS.train,d="train");return{roadLabel:c,relativePointLabel:jQuery.imajnet.settings.LRS.relativePoint[ImajnetLRSSettings.LRSSettings[b][d].relativePoint],relativeAbscisaLabel:jQuery.imajnet.settings.LRS.relativeAbscisa[ImajnetLRSSettings.LRSSettings[b][d].relativeAbscisa],
cumulatedAbscisaLabel:jQuery.imajnet.settings.LRS.cumulatedAbscisa[ImajnetLRSSettings.LRSSettings[b][d].cumulatedAbscisa]}},changeLRSType:function(a,b){jQuery(".searchLRSType").removeClass("opacity60");jQuery("ul.searchLRSContainerSelectOptions").hide();b.addClass("opacity60");var c=this.getLabelsValueFromSettings(a,"search");jQuery("#LRSRoadLabel").html(c.roadLabel);jQuery("#LRSRelativePointLabel").html(c.relativePointLabel);jQuery("#LRSRelativeAbscisaLabel").html(c.relativeAbscisaLabel);jQuery("#LRSCumulatedAbscisaLabel").html(c.cumulatedAbscisaLabel);
LRSRequest.getLRSRoads(a,null,LRSRequest.onGetLRSRoadsSuccess,LRSRequest.onGetLRSRoadsError);c=jQuery("#LRSPRSelect");Nigsys.getComboboxInputContainer(c).val("");Nigsys.changeComboboxDisabledState(c,!0);c.val("").prop("disabled",!0);jQuery("#LRSSearchRelative").val("");jQuery("#LRSSearchCumulated").val("");jQuery("#LRSSearchRelative").prop("disabled",!0);jQuery("#LRSSearchCumulated").prop("disabled",!0);jQuery("#searchLRSSubmit").prop("disabled",!0)},addLRSDialog:function(){var a=this.getSelectedLRSType(),
b=this.getLabelsValueFromSettings(a,"search");ImajnetUI.searchLRSContainer.html('\x3cdiv class\x3d"searchLRSDiv"\x3e\x3cdiv class\x3d"searchLRSDialogContentHeader dialogBorder"\x3e\x3cdiv class\x3d"dialogContentTitle searchLRSDialogContentHeaderTitle left"\x3e'+jQuery.imajnet.map.popupSearchLRS.type+'\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cdiv class\x3d"left" style\x3d"margin-right: 20px;"\x3e\x3cinput type\x3d"image" src\x3d"'+Imajnet.imajnetPath+'img/surveyAll32.png" name\x3d"LRSType" value\x3d"0" onclick\x3d"LRS.changeLRSType(0, jQuery(this));" class\x3d"searchLRSType'+
(0==a?" opacity60":"")+'" title\x3d"'+jQuery.imajnet.map.popupSearchLRS.typeAny+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left LRSTypeItem"\x3e\x3cinput type\x3d"image" src\x3d"'+Imajnet.imajnetPath+'img/surveyCar32.png" name\x3d"LRSType" value\x3d"1" onclick\x3d"LRS.changeLRSType(1, jQuery(this));" class\x3d"searchLRSType'+(1==a?" opacity60":"")+'" title\x3d"'+jQuery.imajnet.map.popupSearchLRS.typeRoad+'"/\x3e\x3c/div\x3e\x3cdiv class\x3d"left LRSTypeItem"\x3e\x3cinput type\x3d"image" src\x3d"'+Imajnet.imajnetPath+
'img/surveyTrain32.png" name\x3d"LRSType" value\x3d"2" onclick\x3d"LRS.changeLRSType(2, jQuery(this));" class\x3d"searchLRSType'+(2==a?" opacity60":"")+'" title\x3d"'+jQuery.imajnet.map.popupSearchLRS.typeTrain+'" /\x3e\x3c/div\x3e\x3cdiv class\x3d"left LRSTypeItem"\x3e\x3cinput type\x3d"image" src\x3d"'+Imajnet.imajnetPath+'img/surveyBoat32.png" name\x3d"LRSType" value\x3d"3" onclick\x3d"LRS.changeLRSType(3, jQuery(this));" class\x3d"searchLRSType'+(3==a?" opacity60":"")+'" title\x3d"'+jQuery.imajnet.map.popupSearchLRS.typeBoat+
'" /\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"searchLRSDialogContentBody"\x3e\x3cdiv class\x3d"dialogContentTitle"\x3e'+jQuery.imajnet.map.popupSearchLRS.search+'\x3c/div\x3e\x3cdiv class\x3d"searchLRSDialogContentBodyBorder dialogWhite50"\x3e\x3cdiv\x3e\x3cdiv class\x3d"left searchLRSItemName" id\x3d"LRSRoadLabel"\x3e'+b.roadLabel+':\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cselect id\x3d"LRSRoadSelect" placeholder\x3d"Type road name" class\x3d"LRSSelect" \x3e\x3coption value\x3d""\x3e\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"LRSSearchItem"\x3e\x3cdiv class\x3d"left searchLRSItemName" id\x3d"LRSRelativePointLabel"\x3e'+
b.relativePointLabel+':\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cselect id\x3d"LRSPRSelect" class\x3d"LRSSelect" disabled\x3d"disabled"\x3e\x3coption value\x3d""\x3e\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"LRSSearchItem"\x3e\x3cdiv class\x3d"left searchLRSItemName" id\x3d"LRSRelativeAbscisaLabel"\x3e'+b.relativeAbscisaLabel+':\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"LRSSearchRelative" onkeypress\x3d"return LRS.numbersOnly(event, \'searchRelative\');" disabled\x3d"disabled" /\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"LRSSearchItem"\x3e\x3cdiv class\x3d"left searchLRSItemName" id\x3d"LRSCumulatedAbscisaLabel"\x3e'+
b.cumulatedAbscisaLabel+':\x3c/div\x3e\x3cdiv class\x3d"left"\x3e\x3cinput type\x3d"text" id\x3d"LRSSearchCumulated" onkeypress\x3d"return LRS.numbersOnly(event, \'searchCumulated\');" disabled\x3d"disabled" /\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"dialogButtonsContainer dialogBorder"\x3e\x3cinput type\x3d"button" id\x3d"searchLRSSubmit" value\x3d"'+jQuery.imajnet.button.search+'" onclick\x3d"LRS.search();" class\x3d"dialogButton buttonSearch" disabled\x3d"disabled" /\x3e\x3cdiv class\x3d"clearRight"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"searchLRSContainerDialogErrorsContainer" class\x3d"dialogErrorsContainer"\x3e\x3cdiv class\x3d"dialogErrorsInnerContainer"\x3e\x3cdiv class\x3d"left dialogErrorsCloseContainer"\x3e\x3cimg id\x3d"searchLRSContainerDialogErrorsClose" class\x3d"dialogErrorsClose" src\x3d"'+
Imajnet.imajnetPath+'img/buttons/BTN-FF7.PNG"\x3e\x3c/div\x3e\x3cdiv id\x3d"searchLRSContainerErrors" class\x3d"errors errorsText left"\x3e\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e');ImajnetUI.searchLRSContainer.hide();Nigsys.bindClickEvent(jQuery("#searchLRSContainerDialogErrorsClose").parent().parent(),function(a){Nigsys.hideDialogError(ImajnetUI.searchLRSContainerId)});LRS.roadSelectCombobox=jQuery("#LRSRoadSelect").combobox({permisive:!0,selected:function(a,
b){LRS.changeLRSRoad(jQuery(this))}});LRS.bindCustomEventsToLRSCombobox("LRSRoadSelect",LRSRequest.onGetLRSRoadsSuccess,LRSRequest.onGetLRSRoadsError,function(){jQuery(".searchLRSContainerSelectOptions").hide()},!0);jQuery(".ui-combobox-LRSRoadSelect .ui-combobox-input").attr("placeholder",jQuery.imajnet.map.popupSearchLRS.roadInputPlaceholder);jQuery("#LRSPRSelect").combobox({selected:function(a,b){LRS.changeLRSPR(jQuery(this).val())},open:function(){jQuery(".searchLRSContainerSelectOptions").hide()}});
jQuery("#LRSSearchRelative").keyup(function(a){13==a.keyCode&&jQuery("#searchLRSSubmit").click()});jQuery("#LRSSearchCumulated").keyup(function(a){13==a.keyCode&&jQuery("#searchLRSSubmit").click()})},bindCustomEventsToLRSCombobox:function(a,b,c,d,e){if(1===jQuery("#"+a).length){try{var f=Nigsys.getComboboxInputContainer(jQuery("#"+a));f.on({keydown:function(d){13!=d.keyCode&&38!=d.keyCode&&40!=d.keyCode&&(LRS.requestTimer&&clearTimeout(LRS.requestTimer),LRS.requestTimer=setTimeout(function(){LRSRoadsAjaxRequest.abort();
LRSRequest.getLRSRoads("LRSRoadSelect"==this.id?jQuery(".searchLRSType.opacity60").val():0,{nameFilter:d.target.value,selectId:a},function(c,d){"function"==typeof b&&b(c,d);Nigsys.getComboboxInputContainer(jQuery("#"+a)).autocomplete("search")},c)},250))}});if(e)f.on({focus:function(b){LRS.focusIsFromSelect||(jQuery(".ui-combobox-"+a+" a").trigger("click"),LRS.focusIsFromSelect=!1)}})}catch(g){console.log(g)}try{jQuery("#"+a).combobox("option",{open:function(e){Nigsys.getComboboxInputContainer(jQuery("#"+
a)).val(LRSRequest.lastNameFilter[a]);e={selectId:a,nameFilter:Nigsys.getComboboxInputContainer(jQuery("#"+a)).val()};LRSRequest.getLRSRoads("LRSRoadSelect"==this.id?jQuery(".searchLRSType.opacity60").val():0,e,function(c,d){"function"==typeof b&&b(c,d);Nigsys.getComboboxInputContainer(jQuery("#"+a)).autocomplete("search")},c);"function"==typeof d&&d()}})}catch(g){console.log(g)}}},openLRSDialog:function(){this.closeLRSDialog();this.initSearchLRS();ImajnetUI.showItem(ImajnetUI.searchLRSContainerId,
Nigsys.browserIsIE7()?460:450,385)},closeLRSDialog:function(){ImajnetUI.hideItem(ImajnetUI.searchLRSContainerId)},getFirstLRS:function(a){if(!a.linearPosition)return null;var b=a.linearPosition;a.linearPosition&&a.linearPosition[0]&&(b=a.linearPosition[0]);return b},getGeometryFromLRS:function(a,b,c,d){var e=jQuery.Deferred();ImajnetAPI.doImajnetRequestDeferred("POST","/api/lrs/road/topology",LRS.getTopologyRequestData(a),null,null,null,null,null,d).done(function(a,c){a=JSON.parse(a);"function"==
typeof b&&b(a,c);e.resolve(a,c)}).fail(function(a,b){"function"==typeof c&&c(a,b);e.reject(a,b)});return e.promise()},getLRSForPointsHTML:function(a,b,c){var d='\x3cdiv class\x3d"popupContentContainer optionsGroup LRSFeatures"\x3e\x3cdiv class\x3d"popupContentContainerTitle"\x3e'+jQuery.imajnet.settings.LRS.title+'\x3c/div\x3e\x3cdiv class\x3d"featureLRSContentContainer"\x3e';"addFeature"!=a.type||a.feature||(a.feature=new ol.Feature(null));if(!b)return("addFeature"==a.type||"editFeature"==a.type?
d:"")+jQuery.app.notifications.noLRS;Feature.imajnetLRSObjectToFeatureObject(a.feature,b,c);"addFeature"==a.type&&(Feature.addNewFeatureFirstLRS=jQuery.extend(Feature.addNewFeatureFirstLRS,a.feature.getProperties()));a=LRS.getLabelsValueFromSettings(b.road.type,"referential");b.road.name&&(d+='\x3cdiv class\x3d"left LRSFeatureItemName featureLRSRoadLabel"\x3e\x3cb\x3e'+a.roadLabel+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left LRSFeatureItemValue"\x3e'+b.road.name+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e');
c=LRS.getRoadUnitType(b.road.unit);b.cumulatedAbscisa&&(d+='\x3cdiv class\x3d"featureLRSCumulatedAbscisaLabel"'+(ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsLRSShowCumulated?"":' style\x3d"display: none;"')+'\x3e\x3cdiv class\x3d"left LRSFeatureItemName"\x3e\x3cb\x3e'+a.cumulatedAbscisaLabel+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left LRSFeatureItemValue"\x3e'+Math.round(b.cumulatedAbscisa)+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e');
b.relativeAbscisa||(b.relativeAbscisa=0);b.keyPoint&&(b.keyPoint.prNumber||0==b.keyPoint.prNumber)&&(d+='\x3cdiv class\x3d"left LRSFeatureItemName featureLRSRelativePointLabel"\x3e\x3cb\x3e'+a.relativePointLabel+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left LRSFeatureItemValue"\x3e('+b.keyPoint.prNumber+"+"+LRS.formatRelativeAbscisa(b.relativeAbscisa,b.road.type,c,0)+')\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e');return d},getLRSFromCoordinates:function(a,b,c){var d=jQuery.Deferred();
if(!a||!b)return d.resolve(),d.promise();LRSRequest.getLRSForPoints(Array({lon:a,lat:b,height:c}),!0,!0,1).done(function(a){a.linearPosition?d.resolve(a.linearPosition):d.reject()}).fail(function(){d.reject()});return d.promise()},getCoordinatesFromRelativeLRS:function(a,b,c){var d=jQuery.Deferred();a&&b||d.reject();a="/api/lrs/relative/"+encodeURIComponent(JSON.stringify({roadIdentifier:a,prNumber:b,relativeAbscisa:c?c:0}));ImajnetAPI.doImajnetRequest("GET",a,null,null,null,null,null,null,null).done(function(a){a.position?
d.resolve(a.position):d.reject()}).fail(function(){d.reject()});return d.promise()},getCoordinatesFromAbsoluteLRS:function(a,b){var c=jQuery.Deferred();if(!a)return c.resolve(),c.promise();url+=encodeURIComponent(JSON.stringify({roadIdentifier:a,cumulatedAbscisa:b}));ImajnetAPI.doImajnetRequest("GET",url,null,null,null,null,null,null,null).done(function(a){a.position?c.resolve(a.position):c.reject()}).fail(function(){c.reject()});return c.promise()},getCoordinatesFromLRS:function(a,b){var c=jQuery.Deferred();
if(!a||!a.roadIdentifier&&!a.roadName)return c.reject();var d="/api/lrs/",e={};a.roadIdentifier&&(e.roadIdentifier=a.roadIdentifier);e.roadName=a.roadName;LRS.isSearchRelative||b?(e.prNumber=a.prNumber?a.prNumber:0,e.relativeAbscisa=a.relativeAbscisa?a.relativeAbscisa:0,d+="relative/"):(e.cumulatedAbscisa=a.cumulatedAbscisa?a.cumulatedAbscisa:0,d+="absolute/");d+=encodeURIComponent(JSON.stringify(e));searchLRSAjaxRequest=ImajnetAPI.doImajnetRequest("GET",d,null,null,null,null,null,null,{isFromSearch:!0}).done(function(a){a&&
a.position?c.resolve(a):c.reject()}).fail(function(){c.reject()});return c.promise()},getLRSToGeometrySearchObject:function(a,b,c,d,e,f,g){b=parseInt(b);c=parseFloat(c);e=parseFloat(e);d=parseInt(d);g&&b==d&&c==e&&(e+=.1);return{roadName:a,startPR:b,startAbscisa:c,endPR:d,endAbscisa:e,lateralOffset:f?parseFloat(f):0}},getLRSByRoadId:function(a,b){for(var c=0;c<a.length;c++)if(a[c].road.id==b)return a[c];return null}};
LRSRequest={LRSAjaxRequest:null,LRSAjaxRequestQueue:[],LRSPhotogrammetryAjaxRequest:null,LRSFeatureAjaxRequest:null,abortedLRSForGPSRequests:0,abortLRSForGPSRequest:!0,lastNameFilter:{},getLRSFieldsCondensed:function(a,b){b&&(LRS.currentImageLRS=a);if(!a)return{roadName:"",HTML:jQuery.imajnet.map.errors.noLRS};var d=LRS.getRoadUnitType(a.road.unit),d=LRS.formatRelativeAbscisa(a.relativeAbscisa,a.road.type,d,0);b&&jQuery("#imajnetImageLRSInTitle").html(a.road.name+" "+a.keyPoint.prNumber+"+"+d).show();
LRS.getLabelsValueFromSettings(a.road.type,"referential");var c="";a.road.name&&(c+='\x3cdiv class\x3d"LRSImageItemRoad"\x3e'+a.road.name+"\x3c/div\x3e");if(a.relativeAbscisa||0==a.relativeAbscisa)c+='\x3cdiv class\x3d"LRSImageItemPRABS"\x3e'+a.keyPoint.prNumber+"+"+d+"\x3c/div\x3e";c+='\x3cinput type\x3d"hidden" id\x3d"imajnetImageLRSType" value\x3d"'+a.road.type+'" /\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e';return{roadName:a.road.name,HTML:c}},getLRSFields:function(a,b){if(!a)return{roadName:"",
HTML:jQuery.imajnet.map.errors.noLRS};var d=LRS.getRoadUnitType(a.road.unit),d=LRS.formatRelativeAbscisa(a.relativeAbscisa,a.road.type,d,0);b&&jQuery("#imajnetImageLRSInTitle").html(a.road.name+" "+a.keyPoint.prNumber+"+"+d).show();var c=LRS.getLabelsValueFromSettings(a.road.type,"referential"),e="";a.road.name&&(e+='\x3cdiv class\x3d"LRSImageItem"\x3e\x3cdiv id\x3d"imajnetImageLRSRoadLabel" class\x3d"left LRSItemName"\x3e\x3cb\x3e'+c.roadLabel+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left LRSItemValue"\x3e'+
a.road.name+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e');if(a.cumulatedAbscisa||0==a.cumulatedAbscisa)e+='\x3cdiv class\x3d"LRSImageItem"'+(ImajnetLRSSettings.LRSSettings.display.addressAndLRS.imajnetSettingsLRSShowCumulated?"":' style\x3d"display: none;"')+'\x3e\x3cdiv id\x3d"imajnetImageLRSCumulatedAbscisaLabel" class\x3d"left LRSItemName"\x3e\x3cb\x3e'+c.cumulatedAbscisaLabel+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left LRSItemValue"\x3e'+Math.floor(a.cumulatedAbscisa+
.5)+'\x3c/div\x3e\x3cdiv class\x3d"clearLeft"\x3e\x3c/div\x3e\x3c/div\x3e';if(a.relativeAbscisa||0==a.relativeAbscisa)e+='\x3cdiv class\x3d"LRSImageItem"\x3e\x3cdiv class\x3d"left LRSItemName"\x3e\x3cb\x3e'+c.relativePointLabel+'\x3c/b\x3e:\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"left LRSItemValue"\x3e('+a.keyPoint.prNumber+"+"+d+")\x3c/div\x3e\x3c/div\x3e";return{roadName:a.road.name,HTML:e}},getLinearPositionObject:function(a){return a&&a.linearPosition&&a.linearPosition[0]?a.linearPosition[0]:a.linearPosition},
getFirstRoadObjectFromLRSResponse:function(a){return a.linearPosition?a.linearPosition[0]?a.linearPosition[0].road:a.linearPosition:null},fillLRSContent:function(a,b){var d=null;a.linearPosition&&(a.linearPosition[0]?jQuery.each(a.linearPosition,function(a,e){d=LRSRequest.getLRSFieldsCondensed(e,b);return!1}):d=this.getLRSFieldsCondensed(a.linearPosition,b));return d},doLinearPositionRequest:function(a,b,d,c){if(LRS.noRoads)"function"===typeof d&&d(null);else return ImajnetAPI.doImajnetRequest("GET",
"/api/lrs/linearposition/"+encodeURIComponent(a),null,function(a,d){"function"===typeof b&&(a=JSON.parse(a),LRS.transformReceivedLinearPosition(a.linearPosition),b(a,d))},function(a,b){"function"===typeof d&&d(a,status,b)},null,null,!0,c)},getLRS:function(a,b,d,c){var e=jQuery.Deferred();this.LRSAjaxRequest&&this.LRSAjaxRequest.abort();c||(c={});c.timeout=Nigsys.requestsTimeout;this.LRSAjaxRequest=LRSRequest.doLinearPositionRequest(a,function(a,d){"function"!==typeof b?e.resolve():(b(a,d),e.resolve(a,
d))},function(a,b){"function"!==typeof d?e.reject():(d(a,status,b),e.reject(a,b))},c);return e.promise()},getLRSForGPS:function(a,b,d){if(this.abortLRSForGPSRequest&&this.LRSAjaxRequestQueue.length){for(var c=0;c<this.LRSAjaxRequestQueue.length;c++)this.LRSAjaxRequestQueue[c].abort();this.LRSAjaxRequestQueue=[]}a=LRSRequest.doLinearPositionRequest(a,function(a,d){LRSRequest.abortedLRSForGPSRequests=0;LRSRequest.abortLRSForGPSRequest=!0;"function"===typeof b&&b(a)},function(a,b){"abort"==a.statusText||
"timeout"==a.statusText?(LRSRequest.abortedLRSForGPSRequests++,5<LRSRequest.abortedLRSForGPSRequests&&(LRSRequest.abortLRSForGPSRequest=!1)):"function"===typeof d&&d(a,a.status)},{timeout:Nigsys.requestsTimeout});this.abortLRSForGPSRequest&&this.LRSAjaxRequestQueue.push(a)},appendLRSForPosition:function(a,b){if(a.parameter&&a.parameter.position){var d=LRSRequest.fillLRSContent(a,!1),c=ImageControler.currentPhotogrammetry.setIdByPosition(a.parameter.position);c||(c=b);0!=c&&""==jQuery("#LRSDoubleClickMessage_"+
c).html()&&(d.HTML+='\x3cdiv class\x3d"LRSDoubleClickMessage LRSDoubleClickMessage_'+c+'" style\x3d"margin-top: 5px;"\x3e'+jQuery.imajnet.map.clipboard.doubleClick+"\x3c/div\x3e");jQuery('div[id\x3d"imajnetPhotogrammetryLRS_'+c+'"]').append(d.HTML)}},getLRSForPosition:function(a,b){ImajnetAPI.mustAbortRequests&&null!==this.LRSPhotogrammetryAjaxRequest&&this.LRSPhotogrammetryAjaxRequest.abort();this.LRSPhotogrammetryAjaxRequest=LRSRequest.doLinearPositionRequest(a,function(a,c){a.linearPosition&&(a.parameter.position.id=
b,a.id=b,LRS.cachedPoints[a.parameter.position.lat+":"+a.parameter.position.lon+":"+a.parameter.position.height]=a,LRSRequest.appendLRSForPosition(a,b))},null,null)},getLRSForPointsError:function(){jQuery(".LRSLineFeature").hide();jQuery(".loadingLRS").hide()},getLRSForPointRequest:function(a,b,d,c){var e=jQuery.Deferred();if(LRS.noRoads)return e.reject(),e.promise();a={positions:a,range:200};Infinity!=c&&(a.maxResults=c);this.LRSFeatureAjaxRequest=ImajnetAPI.doImajnetRequestDeferred("POST","/api/lrs/linearposition/batch/",
null,null,null,null,null,!1,{params:{data:JSON.stringify(a)}}).done(function(a,c){a=JSON.parse(a);if(!a.linearPosition)return e.reject(),!1;if(d)for(var g=0;g<a.linearPosition.length;g++)LRS.transformReceivedLinearPosition(a.linearPosition[g].linearPosition);b&&a.linearPosition[0]?e.resolve(a.linearPosition[0]):e.resolve(a.linearPosition)}).fail(function(a,b){e.reject()});return e.promise()},getLRSForPoints:function(a,b,d,c){return LRSRequest.getLRSForPointRequest(a,b,d,c)},onGetLRSRoadsSuccess:function(a,
b){var d=jQuery("#LRSRoadSelect");b&&!b.nameFilter&&Nigsys.getComboboxInputContainer(d).val("");var c='\x3coption value\x3d""\x3e\x3c/option\x3e';if(void 0!==a&&null!==a&&void 0!=a.roads&&null!==a.roads)jQuery.each(a.roads,function(a,b){c+='\x3coption value\x3d"'+b.id+'"\x3e'+b.name+"\x3c/option\x3e"}),d.html(c);else LRSRequest.onGetLRSRoadsError()},onGetLRSRoadsError:function(a){a=jQuery("#LRSRoadSelect");(a=Nigsys.getComboboxInputContainer(a.parent()))&&a.val("");jQuery("#LRSRoadSelect").html('\x3coption value\x3d""\x3e\x3c/option\x3e')},
onGetLRSRoads:function(a,b,d,c){var e=jQuery.Deferred();b?b.LRSType=a:b={LRSType:a};var f="";b&&b.afterInit&&(f+="\x26afterInit\x3dtrue");b&&b.nameFilter?(b.selectId&&(LRSRequest.lastNameFilter[b.selectId]=b.nameFilter),f+="\x26nameFilter\x3d"+b.nameFilter):LRSRequest.lastNameFilter[b.selectId]="";f=b&&b.limit?f+("\x26limit\x3d"+b.limit):f+("\x26limit\x3d"+LRS.maxRoadsInSelect);LRSRoadsAjaxRequest=ImajnetAPI.doImajnetRequest("GET",ImajnetProtocol.getUsernameForUrl("/api/lrs/roads/?lrsType\x3d"+a+
f),null,function(a,b){a=JSON.parse(a);LRS.roadsData[b.LRSType]=a;if("function"===typeof d){var c=d(a,b);if(Nigsys.isDeferred(c)){c.done(function(){e.resolve(a,b)}).fail(function(){e.resolve(a,b)});return}}e.resolve(a,b)},function(a,b){"function"===typeof c&&c(a,b);e.reject()},null,null,!0,b);return e.promise()},getLRSRoads:function(a,b,d,c){b||(b={});b.afterInit=!1;return LRSRequest.onGetLRSRoads(a,b,d,c)},onGetRoad:function(a,b,d,c){var e=jQuery.Deferred();ImajnetAPI.doImajnetRequest("GET","/api/lrs/road/pr?roadid\x3d"+
a,null,function(a,c){a=JSON.parse(a);"function"===typeof b&&b(a,c);e.resolve(a,c)},function(a,b){"function"===typeof d&&d(a,b);e.reject(a,b)},null,null,!0,c);return e.promise()},getRoad:function(a,b,d,c){return LRSRequest.onGetRoad(a,b,d,c)}};
